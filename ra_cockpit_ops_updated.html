<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Alignment Cockpit — Ops (Metrics Only)</title>
<style>
  :root { --bg:#0f1115; --panel:#151922; --text:#e6e6e6; --muted:#9aa4b2; --border:#222836; }
  * { box-sizing: border-box; }
  body { margin:0; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
  header { padding:16px 20px; border-bottom:1px solid var(--border); display:flex; align-items:center; gap:12px; }
  h1 { margin:0; font-size:16px; font-weight:700; }
  .chip { padding:4px 8px; border-radius:999px; border:1px solid var(--border); background:#1e2433; font-size:12px; color:#cbd5e1; }
  main { padding:16px; display:grid; grid-template-columns: 1fr; gap:16px; }
  section { background:#151922; border:1px solid var(--border); border-radius:12px; padding:16px; }
  .grid-3 { display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
  .metric { background:#0f1320; border:1px solid #27304a; border-radius:8px; padding:12px; }
  .metric .val { font-size:20px; font-weight:700; }
  .metric .label { font-size:12px; color:var(--muted); }
  table { width:100%; border-collapse: collapse; }
  th, td { padding:8px; border-bottom:1px solid #27304a; font-size:13px; text-align:left; }
  canvas { width:100%; height:120px; background:#0f1320; border:1px solid #27304a; border-radius:8px; }
  .muted { color: var(--muted); font-size:12px; }
</style>
<style>
/* ---- High-Contrast Controls Patch (host-proof) ---- */
:root{--rc-brand:#111827;--rc-ink:#0f172a;--rc-accent:#4f46e5}
@media (prefers-color-scheme: dark){:root{--rc-brand:#e6e6ea;--rc-ink:#e6e6ea;--rc-accent:#8ab4f8}}
button, .btn, a[role="button"], input[type="button"], input[type="submit"]{
  display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
  padding:10px 14px !important; border-radius:12px !important;
  border:3px solid var(--rc-brand) !important;
  background: var(--rc-brand) !important; color:#fff !important;
  font-weight:800 !important; letter-spacing:.2px; cursor:pointer;
}
button:hover, .btn:hover, a[role="button"]:hover{ filter:brightness(1.06) }
button:focus-visible, .btn:focus-visible, a[role="button"]:focus-visible{
  outline:3px solid var(--rc-accent) !important; outline-offset:2px;
}
/* Tabs / pills */
.tab, .pill, .chip{ border-width:2px !important }
</style>
</head>
<body>
<header>
  <h1>Alignment Cockpit — Ops</h1>
  <div class="chip" title="API base used by this cockpit">API: <span id="chip-api">—</span></div>
  <div class="chip" title="HMAC signing status">HMAC: <span id="chip-hmac">OFF</span></div>
</header>

<main>
  <section>
    <div class="muted">Metrics-only panel for day-to-day ops health. No scoring, no floors, no SLRC decisions.</div>
    <div class="grid-3" style="margin-top:12px;">
      <div class="metric"><div class="val" id="m-gmean">—</div><div class="label">rcra_g_mean</div></div>
      <div class="metric"><div class="val" id="m-breach">—</div><div class="label">rcra_tau_breach_total</div></div>
      <div class="metric"><div class="val" id="m-last">—</div><div class="label">last scrape (s)</div></div>
    </div>
    <div style="margin-top:12px;">
      <label class="muted">g-mean sparkline (from /metrics)</label>
      <canvas id="spark"></canvas>
    </div>
    <div class="muted" style="margin-top:6px;">Polling every 2s from <code>/metrics</code></div>
  </section>

  <section>
    <h2 style="margin:0 0 10px 0; font-size:16px;">Drift Status (GET /drift/status)</h2>
    <div style="display:flex; gap:10px; align-items:center; margin-bottom:8px;">
      <button id="btn-drift" style="padding:8px 12px; border-radius:8px; background:#2a3550; border:1px solid #364266; color:#e6e6e6; cursor:pointer;">Refresh</button>
      <span class="muted">Aggregates u★ gain by source.</span>
    </div>
    <table id="drift-table">
      <thead><tr><th>Source</th><th>n</th><th>mean</th><th>std</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
// ---- API base & HMAC settings (read from parent or localStorage) ----
const API_BASE = (window.parent && window.parent.RCRA_API_BASE) || localStorage.getItem('RCRA_API_BASE') || 'http://localhost:8000';
const KEY_ID   = (window.parent && window.parent.RCRA_KEY_ID)   || localStorage.getItem('RCRA_KEY_ID')   || 'dev';
const HMAC_KEY = (window.parent && window.parent.RCRA_HMAC_KEY) || localStorage.getItem('RCRA_HMAC_KEY') || null;

document.getElementById('chip-api').textContent = API_BASE;
document.getElementById('chip-hmac').textContent = HMAC_KEY ? 'ON' : 'OFF';

function API(path){ return `${API_BASE}${path}`; }

async function hmacBase64(keyUtf8, msgUtf8){
  const enc = new TextEncoder();
  const cryptoKey = await crypto.subtle.importKey('raw', enc.encode(keyUtf8), { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']);
  const signature = await crypto.subtle.sign('HMAC', cryptoKey, enc.encode(msgUtf8));
  let bin = ''; const bytes = new Uint8Array(signature);
  for (let i=0;i<bytes.length;i++) bin += String.fromCharCode(bytes[i]);
  return btoa(bin);
}
async function fetchSigned(method, path, bodyObj){
  const url = API(path);
  const body = (method === 'GET' || method === 'HEAD') ? '' : JSON.stringify(bodyObj || {});
  const headers = {'Content-Type':'application/json'};
  const nonce = Math.random().toString(36).slice(2) + Date.now();
  const ts = Math.floor(Date.now()/1000).toString();
  if (HMAC_KEY){
    const toSign = `${method}\n${path}\n${nonce}\n${ts}\n${body}`;
    const sig = await hmacBase64(HMAC_KEY, toSign);
    headers['X-RCRA-Nonce'] = nonce;
    headers['X-RCRA-TS'] = ts;
    headers['X-RCRA-KeyId'] = KEY_ID;
    headers['X-RCRA-Sig'] = sig;
  }
  const init = { method, headers };
  if (body) init.body = body;
  const r = await fetch(url, init);
  if (!r.ok) throw new Error(await r.text());
  const ct = r.headers.get('content-type') || '';
  if (ct.includes('application/json')) return r.json();
  return r.text();
}

// ---- Metrics polling & sparkline ----
const spark = document.getElementById('spark');
const ctx = spark.getContext('2d');
let gMeanHistory = [];
let lastScrape = 0;

function drawSpark() {
  const W = spark.width = spark.clientWidth * devicePixelRatio;
  const H = spark.height = 120 * devicePixelRatio;
  ctx.clearRect(0,0,W,H);
  if (gMeanHistory.length < 2) return;
  const min = Math.min(...gMeanHistory), max = Math.max(...gMeanHistory);
  const pad = 8 * devicePixelRatio;
  const n = gMeanHistory.length;
  ctx.lineWidth = 2 * devicePixelRatio;
  ctx.strokeStyle = '#7aa2f7';
  ctx.beginPath();
  for (let i=0;i<n;i++) {
    const x = pad + (W-2*pad) * (i/(n-1));
    const y = H - pad - (H-2*pad) * ((gMeanHistory[i]-min)/Math.max(1e-6, (max-min)));
    if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  // baseline
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.beginPath(); ctx.moveTo(pad, H-pad); ctx.lineTo(W-pad,H-pad); ctx.stroke();
}

function parseProm(text) {
  const out = {}; 
  text.trim().split(/\n+/).forEach(line => {
    const m = line.match(/^([a-zA-Z_:][a-zA-Z0-9_:]*)\s+(-?\d+(?:\.\d+)?)$/);
    if (m) out[m[1]] = parseFloat(m[2]);
  });
  return out;
}

async function pollMetrics() {
  try {
    // GET /metrics (signed if HMAC is set)
    const text = await fetchSigned('GET', '/metrics');
    const m = typeof text === 'string' ? parseProm(text) : text;
    const gmean = parseFloat(m.rcra_g_mean ?? 'NaN');
    if (!isNaN(gmean)) {
      gMeanHistory.push(gmean);
      if (gMeanHistory.length > 100) gMeanHistory.shift();
      drawSpark();
      document.getElementById('m-gmean').textContent = gmean.toFixed(4);
    }
    document.getElementById('m-breach').textContent = m.rcra_tau_breach_total ?? 0;
    lastScrape = (lastScrape + 2) % 60;
    document.getElementById('m-last').textContent = lastScrape.toFixed(0);
  } catch (e) {
    // ignore transient failures
  } finally {
    setTimeout(pollMetrics, 2000);
  }
}

// ---- Drift table ----
async function refreshDrift() {
  try {
    const d = await fetchSigned('GET', '/drift/status');
    const tbody = document.querySelector('#drift-table tbody');
    tbody.innerHTML = '';
    const keys = Object.keys(d.per_source || {});
    keys.forEach(k => {
      const s = d.per_source[k];
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${k}</td><td>${s.n}</td><td>${s.mean.toFixed(4)}</td><td>${s.std.toFixed(4)}</td>`;
      tbody.appendChild(tr);
    });
  } catch (e) {
    console.warn('Drift fetch failed', e);
  }
}
document.getElementById('btn-drift').addEventListener('click', refreshDrift);

// init
pollMetrics();
refreshDrift();
</script>

<!-- Evaluator Drawer (mock-first; optional live) -->
<style>
#rcDrawerToggle{position:fixed;right:16px;bottom:16px;z-index:9999}
#rcDrawer{position:fixed;right:0;top:0;bottom:0;width:min(520px,96vw);
  transform:translateX(100%);transition:transform .25s ease;z-index:9998;
  background:rgba(255,255,255,.98);color:#0f172a;border-left:4px solid #111827;
  box-shadow:-12px 0 40px rgba(0,0,0,.22);padding:14px;overflow:auto}
@media (prefers-color-scheme: dark){
  #rcDrawer{background:rgba(15,19,26,.98);color:#e6e6ea;border-left:4px solid #e6e6ea}
}
#rcDrawer.open{transform:none}
#rcDrawer h3{margin:4px 0 8px 0}
#rcDrawer .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
#rcDrawer .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 10px;font-size:13px}
#rcClose{position:sticky;top:0;float:right}
#rcFloors{border:1px solid #cbd5e1;border-radius:10px;padding:8px;margin-top:8px}
#rcScores{border:1px solid #cbd5e1;border-radius:10px;padding:8px;margin-top:8px}
#rcRaw{white-space:pre-wrap;font-size:12px;border:1px solid #cbd5e1;border-radius:10px;padding:8px;margin-top:8px}
</style>
<button id="rcDrawerToggle" class="btn">Evaluator</button>
<aside id="rcDrawer" aria-hidden="true">
  <button id="rcClose" class="btn">Close</button>
  <h2 style="margin:6px 0 10px 0;">Evaluator</h2>
  <div class="row">
    <div>
      <label style="font-size:12px">Output</label>
      <textarea id="rcOut" rows="8" placeholder="Paste output here…"
        style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px"></textarea>
      <div class="row" style="margin-top:8px">
        <div><label style="font-size:12px">context_id</label><input id="rcCtx" placeholder="demo"
          style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px"/></div>
        <div><label style="font-size:12px">SLRC</label>
          <select id="rcSlrc" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px">
            <option value="default">default</option>
            <option value="strict">strict</option>
            <option value="lenient">lenient</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label style="font-size:12px">Base URL</label>
          <input id="rcBase" placeholder="http://localhost:8080"
            style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px"/>
        </div>
        <div><label style="font-size:12px">Mode</label>
          <select id="rcMode" style="width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:10px">
            <option value="mock" selected>Mock</option>
            <option value="live">Live</option>
          </select>
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="rcRun" class="btn">Run</button>
      </div>
    </div>
    <div>
      <h3>Floors</h3>
      <div id="rcFloors" class="kv"></div>
      <div id="rcScores" class="kv" style="margin-top:8px"></div>
      <div style="margin-top:8px;font-weight:800">Decision: <span id="rcDecision">—</span></div>
      <div id="rcTags" style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap"></div>
    </div>
  </div>
  <h3>Raw</h3>
  <pre id="rcRaw"></pre>
</aside>
<script>
(function(){
  const $=s=>document.querySelector(s);
  let MODE='mock', BASE='';
  const kv = obj => Object.entries(obj).map(([k,v])=>`<div>${k}</div><div><b>${v}</b></div>`).join('');
  function mockFloors(v){ if(v==='strict')return {tau_v:0.86,tau_L:1.35,sigma_max:0.20,d_min:3};
    if(v==='lenient')return {tau_v:0.80,tau_L:1.20,sigma_max:0.26,d_min:2}; return {tau_v:0.84,tau_L:1.30,sigma_max:0.22,d_min:2}; }
  function mockEval(text,f){ const spec=/\b(maybe|might|probably|guess|assume)\b/i.test(text||'');
    const v=spec?0.84:0.89; const v_net=+(v-(spec?0.03:0)).toFixed(3);
    const lpd=+(v_net/0.001).toFixed(3); const sigma=(text||'').toLowerCase().includes('objective')?0.19:0.25;
    const ok=!(v_net<f.tau_v||lpd<f.tau_L||sigma>f.sigma_max||2<f.d_min);
    return {value:{v:+v.toFixed(3),v_net}, lpd:{lpd,lpd_net:lpd}, sigma, depth:2, ok, tags: spec?[{id:'speculative_language',conf:0.12}]:[], raw:{note:'mock'}}; }
  async function api(path, method='POST', body){ const u=`${BASE}${path}`;
    const res=await fetch(u,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})});
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    const ct=res.headers.get('content-type')||''; return ct.includes('json')?res.json():res.text(); }
  function loadFloors(){ const variant=$('#rcSlrc').value||'default';
    if(MODE==='mock'){ $('#rcFloors').innerHTML=kv(mockFloors(variant)); return; }
    api('/slrc/select','POST', variant).then(j=>$('#rcFloors').innerHTML=kv(j.floors||mockFloors(variant)))
      .catch(()=>$('#rcFloors').innerHTML=kv(mockFloors(variant))); }
  async function run(){ const text=$('#rcOut').value||'Objective: win a 30-day pilot with refund-backed SLA.';
    const ctx=$('#rcCtx').value||'demo'; const policy=$('#rcSlrc').value||'default'; const floors=mockFloors(policy);
    if(MODE==='mock'){ const r=mockEval(text,floors); render(r); $('#rcRaw').textContent=JSON.stringify(r.raw,null,2); return; }
    try{ const j=await api('/detector/eval','POST',{output:text, context_id:ctx, policy}); render({ value:j.value||{}, lpd:j.lpd||{}, sigma:j.sigma, depth:j.depth, ok:!!j.ok, tags:j.tags||[], raw:j }); $('#rcRaw').textContent=JSON.stringify(j,null,2); }
    catch(e){ const r=mockEval(text,floors); render(r); $('#rcRaw').textContent=JSON.stringify({error:e.message, fallback:'mock'},null,2); } }
  function render(r){ $('#rcScores').innerHTML=kv({v:r.value?.v, v_net:r.value?.v_net, lpd:r.lpd?.lpd, lpd_net:r.lpd?.lpd_net, sigma:r.sigma, d:r.depth});
    $('#rcDecision').innerHTML = r.ok?'<span style="color:#166534">BILL</span>':'<span style="color:#b91c1c">REFUND</span>';
    const tags=r.tags||[]; $('#rcTags').innerHTML = tags.length? tags.map(t=>`<span class="chip">${t.id} (${t.conf||t.weight||''})</span>`).join(' '):'<span class="chip">no tags</span>'; }
  document.addEventListener('click', (e)=>{
    if(e.target.id==='rcDrawerToggle'){ $('#rcDrawer').classList.add('open'); }
    if(e.target.id==='rcClose'){ $('#rcDrawer').classList.remove('open'); }
    if(e.target.id==='rcRun'){ run(); }
  });
  $('#rcMode').addEventListener('change', e=>{ MODE=e.target.value; loadFloors(); });
  $('#rcBase').addEventListener('change', e=>{ BASE=e.target.value.trim(); });
  $('#rcSlrc').addEventListener('change', loadFloors);
  loadFloors();
})();
</script>

</body>
</html>
