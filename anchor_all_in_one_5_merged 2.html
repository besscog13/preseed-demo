<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RA/RC Benchmark — Logic‑Per‑Dollar (LPD)</title>
  <style>
    :root {
      --bg: #0b0c10;
      --card: #111217;
      --text: #e6e6ea;
      --muted: #a0a0aa;
      --accent: #7fd1ae;
      --accent-2: #8ab4f8;
      --border: #2a2d36;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #fafafa;
        --card: #ffffff;
        --text: #1b1b1f;
        --muted: #4a4a55;
        --accent: #156d47;
        --accent-2: #2457b3;
        --border: #e8e8ee;
      }
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Inter, 'Helvetica Neue', Arial, 'Noto Sans', 'Apple Color Emoji', 'Segoe UI Emoji'; }
    a { color: var(--accent-2); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .container { max-width: 1120px; margin: 0 auto; padding: 24px; }
    header { position: sticky; top: 0; backdrop-filter: blur(6px); background: color-mix(in oklab, var(--bg) 80%, transparent); border-bottom:1px solid var(--border); z-index: 10; }
    .nav { display:flex; align-items:center; gap:16px; padding: 12px 24px; }
    .nav .brand { font-weight: 700; letter-spacing: 0.2px; }
    .nav a { color: var(--text); opacity: 0.9; }
    .nav .spacer { flex:1; }
    .hero { background: linear-gradient(120deg, color-mix(in oklab, var(--accent) 25%, transparent), transparent 70%); border-bottom:1px solid var(--border); }
    .hero .wrap { padding: 56px 24px; }
    h1 { font-size: clamp(28px, 4vw, 44px); line-height: 1.1; margin: 0 0 12px; }
    p.lead { font-size: clamp(16px, 2.2vw, 20px); color: var(--muted); margin: 0; }
    .cta { display:flex; gap:12px; margin-top: 18px; flex-wrap: wrap; }
    .btn { display:inline-flex; align-items:center; gap:10px; font-weight:600; border:1px solid var(--border); padding:10px 14px; border-radius:10px; background:var(--card); color:var(--text); }
    .btn.primary { background: var(--accent); color: #081a12; border-color: color-mix(in oklab, var(--accent) 60%, var(--border)); }
    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 980px) { .grid.cols-2 { grid-template-columns: 1fr 1fr; } }
    section { padding: 36px 24px; border-bottom:1px solid var(--border); }
    .card { background: var(--card); border:1px solid var(--border); border-radius: 12px; padding: 18px; }
    h2 { margin: 0 0 12px; font-size: 22px; }
    .muted { color: var(--muted); }
    figure { margin: 0; }
    img { max-width: 100%; height: auto;  border-radius: 10px; }
    .tabs { display:flex; gap:6px; margin-bottom: 12px; }
    .tab { padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:var(--card); cursor:pointer; font-weight:600; color:var(--muted); }
    .tab.active { color: var(--text); box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--accent) 60%, var(--border)); }
    .two-col { display:grid; grid-template-columns: 1fr; gap:16px; }
    @media (min-width: 980px) { .two-col { grid-template-columns: 1.1fr 0.9fr; } }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background: color-mix(in oklab, var(--card) 70%, var(--bg)); border:1px solid var(--border); padding:2px 6px; border-radius: 6px; }
    footer { padding: 24px; color: var(--muted); }
    .tiny { font-size: 12px; }
    details { background: var(--card); border:1px solid var(--border); padding:12px; border-radius:10px; }
    summary { cursor: pointer; font-weight: 700; }
  .bar{background:color-mix(in oklab, var(--card) 70%, var(--bg));border:1px solid var(--border);border-radius:6px;overflow:hidden;margin-top:6px;}
.chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
.chip{display:inline-flex;align-items:center;gap:6px;font-weight:600;font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card);color:var(--text)}
.chip.good{outline:2px solid rgba(61,220,151,.35)}
.chip.warn{outline:2px solid rgba(231,111,81,.35)}
.chip.env-dev{outline:2px dashed rgba(138,180,248,.35)}
.chip.env-stage{outline:2px dashed rgba(255,214,102,.35)}
.chip.env-prod{outline:2px dashed rgba(127,209,174,.35)}
.hidden{display:none}
</style>
<style>
/* --- Anchor Patch: remove image outlines/boxes --- */
img { border: none !important; outline: none !important; box-shadow: none !important; background: transparent !important; }
figure img { border: none !important; }
figure { border: none !important; }
</style>
<style>
/* ---- RC/RA High-Contrast Controls Patch ---- */
:root{--rc-brand:#111827;--rc-ink:#0f172a;--rc-accent:#4f46e5;}
@media (prefers-color-scheme: dark){:root{--rc-brand:#e6e6ea;--rc-ink:#e6e6ea;--rc-accent:#8ab4f8;}}
button, .btn, a[role="button"], input[type="button"], input[type="submit"]{
  display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
  padding:10px 14px !important; border-radius:12px !important;
  border:3px solid var(--rc-brand, #111827) !important;
  background: var(--rc-brand, #111827) !important; color:#fff !important;
  font-weight:800 !important; letter-spacing:.2px; cursor:pointer;
}
button:hover, .btn:hover, a[role="button"]:hover{ filter:brightness(1.06) }
button:focus-visible, .btn:focus-visible, a[role="button"]:focus-visible{
  outline:3px solid var(--rc-accent, #4f46e5) !important; outline-offset:2px;
}
/* safe visible tab buttons */
.tab, .pill, .chip{ border-width:2px !important }
</style>
</head>
<body>
  <header>
    <nav class="nav container">
      <div class="brand">RA/RC Benchmark</div>
      <a href="#overview">Overview</a>
      <a class="btn" id="btnSeePipeline" href="#pipeline">Pipeline</a>
      <a href="#comparison">Comparison</a>
      <a href="#downloads">Downloads</a>
      <a href="#contact">Contact</a>
      <a href="#cockpit">Cockpit</a>
      <div class="spacer"></div>


  
</div>
      <button class="btn" id="modeBtn" title="Toggle View">Investor View</button>
    
      
    </nav>
  </header>

  <div class="hero">
    <div class="container wrap">
      <h1>

<div id="fileControls" style="margin-top:12px;">
  
  
  <label class="btn">

  <label class="btn">

</div>

Logic‑Per‑Dollar (LPD): The Scalar Benchmark for Trustworthy AI</h1>
    
    
<div id="stateChips" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
  <span class="chip" id="chipEnv">Env: —</span>
  <span class="chip" id="chipVmin">v_min: —</span>
  <span class="chip" id="chipLpdmin">lpd_min: —</span>
</div>
<style>
  .chip { background: var(--card); border:1px solid var(--border); border-radius:12px; padding:4px 10px; font-size:0.8em; }
  .chip.green { border-color:#3ddc97; color:#3ddc97; }
  .chip.red { border-color:#e76f51; color:#e76f51; }
  .chip.amber { border-color:#f4a261; color:#f4a261; }
.chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
.chip{display:inline-flex;align-items:center;gap:6px;font-weight:600;font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card);color:var(--text)}
.chip.good{outline:2px solid rgba(61,220,151,.35)}
.chip.warn{outline:2px solid rgba(231,111,81,.35)}
.chip.env-dev{outline:2px dashed rgba(138,180,248,.35)}
.chip.env-stage{outline:2px dashed rgba(255,214,102,.35)}
.chip.env-prod{outline:2px dashed rgba(127,209,174,.35)}
.hidden{display:none}
</style>

      <p class="lead">RA/RC + MCP standardizes reasoning ROI with a single, auditable metric backed by SLRC governance.</p>
<div id="importExportInline" style="display:flex; gap:8px; flex-wrap:wrap; margin-top:14px;">
  <button class="btn" id="btnExportPolicy" title="Download current policy.yaml">Export Policy</button>
  <button class="btn" id="btnImportPolicy" title="Import policy.yaml">Import Policy</button>
  <input type="file" id="fileImportPolicy" accept=".yaml,.yml,.txt" class="hidden" />
  <button class="btn" id="btnExportTraces" title="Download current traces.jsonl">Export Traces</button>
  <button class="btn" id="btnImportTraces" title="Import Traces .jsonl">Import Traces</button>
  <input type="file" id="fileImportTraces" accept=".jsonl" class="hidden" />
</div>







      <div class="cta">
        <a class="btn primary" href="RA_RC_Benchmark_Pack.pdf">Download PDF</a>
        <a class="btn" href="RA_RC_Benchmark_Pack.md">MD for Developers</a>
        
        
        
      </div>
    </div>
  </div>

  <main class="container">
    <section id="overview" class="two-col">
      <div class="card">
        <h2>Why this matters</h2>
        <p>Traditional AI benchmarks (MMLU, MLPerf) score static abilities—accuracy or speed. Enterprises need proof of <strong>verifiable, cost‑efficient reasoning</strong> they can <em>buy, audit, and refund if needed</em>.</p>
        <div class="tabs">
          <div class="tab active" data-tab="investor">Investor</div>
          <div class="tab" data-tab="technical">Technical / Governance</div>
        </div>
        <div id="investor" class="tabpane">
          <ul>
            <li><strong>u★</strong> (Gold Truth Anchor) grounds quality.</li>
            <li><strong>ValueScore (v)</strong> measures alignment to u★.</li>
            <li><strong>LPD</strong> (Logic‑Per‑Dollar) normalizes value by cost.</li>
            <li><strong>SLRC</strong> enforces refunds with traceable contracts.</li>
          </ul>
          <p class="muted">We are to reasoning what MLPerf is to compute—auditable, cost‑normalized, enforceable.</p>
        </div>
        <div id="technical" class="tabpane" style="display:none">
          <ul>
            <li><strong>u★</strong> = SME‑vetted centroid embedding (ground truth vector).</li>
            <li><strong>v</strong> = cosine gain to u★, risk‑penalized; <span class="kbd">v = cos(u, u★) − baseline</span></li>
            <li><strong>LPD</strong> = <span class="kbd">v / cost</span>; floors τ tuned via ROC on historical traces.</li>
            <li><strong>SLRC</strong> = YAML thresholds; <span class="kbd">/replay/{'{id}'} </span> for determinism; run_log is append‑only.</li>
          </ul>
        </div>
      </div>
      <div class="card">
        <h2>README (preview)</h2>
        <p class="tiny muted">Excerpt from README.md:</p>
        <pre class="tiny" style="white-space:pre-wrap; max-height: 320px; overflow: auto;">
# RA/RC Benchmark – Logic-Per-Dollar for Trustworthy AI

This repository defines **RA/RC + MCP as the industry benchmark for reasoning ROI**.  
It introduces a **scalar, auditable metric (LPD)** – Logic-Per-Dollar – to measure **verifiable, cost-effective reasoning**.

---

## **Why This Matters**
Traditional AI benchmarks (MMLU, MLPerf) measure **static abilities** (accuracy, speed).  
They don’t answer the real enterprise question:

&gt; **“Did this reasoning deliver reliable, cost-efficient value I can trust and pay for?”**

RA/RC changes that.

---

## **Pipeline Overview**
![Pipeline Diagram](RA_RC_Pipeline_Diagram.png)

**Flow:**
1. **SME Golds → u★ (Truth Anchor)** – Ground-truth reasoning quality.  
2. **RRP Loop (Draft→Critique→Revise)** – Structured reasoning process.  
3. **ValueScore (v)** – Alignment to u★ (semantic fidelity).  
4. **Logic-Per-Dollar (LPD)** – ROI scalar (value ÷ cost).  
5. **SLRC Enforcement** – Refunds + auditable governance.

---

</pre>
        <div class="cta"><a class="btn" href="README.md">Open full README.md</a></div>
      </div>
    </section>

    <section id="pipeline" class="grid cols-2">
      <div class="card">
        <h2>Pipeline</h2>
        <figure>
          <img src="RA_RC_Pipeline_Diagram.png" alt="RA/RC Pipeline Diagram" / loading="lazy decoding="async"
          <figcaption class="tiny muted">SME Golds → u★ → RRP (Draft→Critique→Revise) → ValueScore v → LPD → SLRC</figcaption>
        </figure>
      </div>
      <div class="card">
        <h2>How to read it</h2>
        <ol>
          <li><strong>Ground truth</strong>: SMEs curate gold paragraphs to form <em>u★</em>.</li>
          <li><strong>Structured loop</strong>: Generator/Detector separation across phases.</li>
          <li><strong>ValueScore (v)</strong>: Semantic fidelity to u★ with risk penalties.</li>
          <li><strong>LPD</strong>: <span class="kbd">v ÷ cost</span> gives an ROI scalar.</li>
          <li><strong>SLRC</strong>: Refunds if floors are breached; everything is auditable.</li>
        </ol>
      </div>
    </section>

    <section id="comparison" class="grid cols-2">
      <div class="card">
        <h2>Benchmark Comparison</h2>
        <figure>
          <img src="RA_RC_Benchmark_Comparison.png" alt="Benchmark Comparison Table" / loading="lazy decoding="async"
        </figure>
      </div>
      <div class="card">
        <h2>Summary</h2>
        <ul>
          <li><strong>Accuracy →</strong> u★ alignment (v)</li>
          <li><strong>Efficiency →</strong> LPD (value per dollar)</li>
          <li><strong>Compliance →</strong> SLRC (refunds by contract)</li>
          <li><strong>Reproducibility →</strong> Append‑only run_log and deterministic replay</li>
        </ul>
      </div>
    </section>

    
    
    <section id="miniDash" class="grid">
      <div class="card">
        <h2>Mini Dashboard</h2>
        <p class="tiny muted">Derived from loaded traces (auto-loads sample on open). Updates when traces change.</p>
        <div class="grid cols-2" style="gap:12px;">
          <div class="card" style="padding:12px;">
            <div class="tiny muted"><span data-doc="economics#lpd">LPD</span> (avg)</div>
            <div id="kpiLPD" style="font-weight:700; font-size:20px;">–</div>
            <div class="bar"><div id="barLPD" style="height:8px; border-radius:6px;"></div></div>
          </div>
          <div class="card" style="padding:12px;">
            <div class="tiny muted"><span data-doc="economics#v">ValueScore v</span> (avg)</div>
            <div id="kpiV" style="font-weight:700; font-size:20px;">–</div>
            <div class="bar"><div id="barV" style="height:8px; border-radius:6px;"></div></div>
          </div>
          <div class="card" style="padding:12px;">
            <div class="tiny muted"><span data-doc="economics#sigma">σ</span> (avg variance)</div>
            <div id="kpiSigma" style="font-weight:700; font-size:20px;">–</div>
            <div class="bar"><div id="barSigma" style="height:8px; border-radius:6px;"></div></div>
          </div>
          <div class="card" style="padding:12px;">
            <div class="tiny muted">Refund Rate</div>
            <div id="kpiRefund" style="font-weight:700; font-size:20px;">–</div>
            <div class="bar"><div id="barRefund" style="height:8px; border-radius:6px;"></div></div>
          </div>
        </div>
      </div>
    </section>

    <section id="roc" class="grid">
      <div class="card">
        <h2>ROC Sweep (Threshold Tuning)</h2>
        <p class="muted">Visualize threshold impact using traces. <em>Positive</em> = passes (refund=false). <em>Negative</em> = refunds.</p>
        <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
          <label>Metric:</label>
          <select id="rocMetric" class="btn">
            <option value="lpd">LPD</option>
            <option value="v">ValueScore (v)</option>
          </select>
          <label>Steps:</label><input id="rocSteps" type="number" min="5" max="100" value="25" class="btn" style="width:80px;" /><label style="margin-left:12px;">Margin model:</label><input type="checkbox" id="useMarginModel" class="btn" /><label class="tiny muted">Rev (R)</label><input id="revPerAccept" type="number" step="0.01" value="1.00" class="btn" style="width:90px;" /><label class="tiny muted">Cost (C)</label><input id="costPerReject" type="number" step="0.01" value="0.50" class="btn" style="width:90px;" />
          <input id="rocSteps" type="number" min="5" max="100" value="25" class="btn" style="width:80px;" />
          <button class="btn" id="btnRunROC">Run Sweep</button><button class="btn" id="btnExportROC">Export CSV</button><label class="tiny muted" style="margin-left:8px">Set τ =</label><input id="rocThrManual" type="number" step="0.001" class="btn" style="width:120px" placeholder="thr value" /><button class="btn" id="btnApplyThresholdToPolicy">Apply to Policy</button><button class="btn primary" id="btnSuggestKnee">Suggest Profit-Knee</button>
          <button class="btn" id="btnUseBestThr">Use Best Threshold → Policy Editor</button>

        </div>
        <canvas id="rocCanvas" width="640" height="360" style="margin-top:12px; border:1px solid var(--border); border-radius:10px; background:var(--card);"></canvas>
        <details style="margin-top:8px;">
          <summary>ROC Table (TPR/FPR by threshold)</summary>
          <div style="overflow:auto; max-height:220px;">
            <table id="rocTable" style="width:100%; border-collapse:collapse;">
              <thead><tr><th>thr</th><th>TPR</th><th>FPR</th><th>Accept%</th><th>Refund%</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </details>
      </div>
    </section>

    <section id="downloads" class="grid">
      <div class="card">
        <h2>Downloads</h2>
        <ul>
          <li><a href="RA_RC_Benchmark_Pack.pdf">RA_RC_Benchmark_Pack.pdf</a> — Investor + Technical explainer</li>
          <li><a href="RA_RC_Benchmark_Pack.md">RA_RC_Benchmark_Pack.md</a> — Developer‑friendly version</li>
          <li><a href="RA_RC_Pipeline_Diagram.png">RA_RC_Pipeline_Diagram.png</a> — Pipeline visual</li>
          <li><a href="RA_RC_Benchmark_Comparison.png">RA_RC_Benchmark_Comparison.png</a> — Comparison visual</li>
          <li><a href="README.md">README.md</a> — Web README</li>
        </ul>
      </div>
      <div class="card">
        <h2>Try it next</h2>
        <p class="muted">Hook this into your live cockpit by exposing <span class="kbd">/detector/eval</span>, <span class="kbd">/policy</span>, and <span class="kbd">/replay/{'{id}'}</span> endpoints. Wire LPD &amp; τ floors to your Grafana dashboard.</p>
        <details>
          <summary>Suggested routes</summary>
          <ul class="tiny">
            <li><span class="kbd">GET /status</span> — health</li>
            <li><span class="kbd">POST /run</span> — Draft→Critique→Revise</li>
            <li><span class="kbd">POST /detector/eval</span> — compute v, LPD, risk tags</li>
            <li><span class="kbd">GET /policy</span> + <span class="kbd">PUT /policy</span> — SLRC floors (τ)</li>
            <li><span class="kbd">GET /replay/{'{id}'}</span> — deterministic replay</li>
          </ul>
        </details>
      </div>
    </section>

    
    <section id="walkthrough" class="grid">
      <div class="card">
        <h2>Investor Walkthrough (Demo Flow)</h2>
        <p>This simulates the RA/RC cockpit routes to showcase how Logic-Per-Dollar (LPD) and SLRC enforcement work:</p>
        <div class="cta">
          <button class="btn primary" onclick="mockRun()">Run RRP Loop</button>
          <button class="btn" onclick="mockEval()">Evaluate (v, LPD)</button>
          <button class="btn" onclick="mockPolicy()">View Policy</button>
          <button class="btn" onclick="mockReplay()">Replay Session</button>
        </div>
        <pre id="mockOutput" style="background:var(--card); border:1px solid var(--border); padding:10px; border-radius:8px; margin-top:12px; max-height:300px; overflow:auto;">
Click a button to simulate response...</pre>
      </div>
    </section>

    
    <section id="walkthrough" class="grid">
      <div class="card">
        <h2>Investor Walkthrough (Live/Mock)</h2>
        <p class="muted">Simulate the end‑to‑end flow or point at your live API. If a live request fails, the mock payload will be shown.</p>
        <div class="two-col">
          <style>.sparkline{border:1px solid var(--border);border-radius:8px;background:var(--card);}.bar{background:color-mix(in oklab, var(--card) 70%, var(--bg));border:1px solid var(--border);border-radius:6px;overflow:hidden;margin-top:6px;}
.chips{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
.chip{display:inline-flex;align-items:center;gap:6px;font-weight:600;font-size:12px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:var(--card);color:var(--text)}
.chip.good{outline:2px solid rgba(61,220,151,.35)}
.chip.warn{outline:2px solid rgba(231,111,81,.35)}
.chip.env-dev{outline:2px dashed rgba(138,180,248,.35)}
.chip.env-stage{outline:2px dashed rgba(255,214,102,.35)}
.chip.env-prod{outline:2px dashed rgba(127,209,174,.35)}
.hidden{display:none}
</style>
          <div>
            <label class="tiny muted">Base URL</label><br/>
            <input id="baseUrl" placeholder="https://api.yourdomain.com" style="width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--card); color:var(--text);" />
            <div style="margin-top:8px; display:flex; gap:8px; align-items:center;">
              <label class="tiny muted">Mode:</label>
              <select id="mode" class="btn" style="padding:8px 10px;">
                <option value="mock">Mock</option>
                <option value="live">Live</option>
              </select>
              <span class="tiny muted">Headers auto‑include <span class="kbd">Content-Type: application/json</span></span>
            </div>
            <div class="cta" style="margin-top:12px;">
              <button class="btn primary" id="btnRun">POST /run</button>
              <button class="btn" id="btnEval">POST /detector/eval</button>
              <button class="btn" id="btnGetPolicy">GET /policy</button>
              <button class="btn" id="btnPutPolicy">PUT /policy (τ)</button>
              <button class="btn" id="btnReplay">GET /replay/&lbrace;id&rbrace;</button>
            
            <div style="margin-top:12px;">
              <label class="tiny muted">Traces (JSONL):</label>
              <div class="cta">
                <input type="file" id="tracesFile" accept=".jsonl" class="btn" />
                <button class="btn" id="btnLoadSample">Load sample_traces.jsonl</button>
                <button class="btn" id="btnClearTraces">Clear</button><button class="btn" id="btnDownloadTraces">Download Traces</button>
              </div>
              <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:8px;"><canvas id="spark" class="sparkline" width="640" height="120"></canvas><canvas id="hist" class="sparkline" width="640" height="120"></canvas></div>
              <canvas id="histLPD" width="640" height="120" style="margin-top:8px; border:1px solid var(--border); border-radius:8px; background:var(--card);"></canvas>

              <details style="margin-top:10px;">
                <summary>Traces Table</summary>
                <div style="overflow:auto; max-height:260px;">
                  <table id="tracesTable" style="width:100%; border-collapse:collapse;">
                    <thead>
                      <tr>
                        <th>ID</th><th>v</th><th>LPD</th><th>σ</th><th>d</th><th>Refund?</th><th>Cost</th><th>Time</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </details>
            </div>

            <details style="margin-top:10px;">
              <summary>Sample payloads</summary>
              <pre class="tiny" id="samplePayloads" style="white-space:pre-wrap;"></pre>
            </details>
          </div>
          <div>
            <label class="tiny muted">Response</label>
            <pre id="resp" style="white-space:pre-wrap; min-height: 280px; max-height: 420px; overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:12px;"></pre>
<div id="schemaStatus" class="tiny" style="margin-top:8px; padding:8px; border:1px solid var(--border); border-radius:8px;"></div>
<details style="margin-top:8px;"><summary>Response (highlighted with schema issues)</summary>
<pre id="respHL" style="white-space:pre-wrap; min-height: 160px; max-height: 320px; overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:8px; padding:12px;"></pre>
</details>
          </div>
        </div>
      </div>
    </section>

    <section id="contact" class="grid">
      <div class="card">
        <h2>Contact / Integration</h2>
        <p>Partnerships, pilots, or Marketplace listing: <a href="mailto:info@rc-rc.ai">info@rc-rc.ai</a></p>
        <p class="tiny muted">© RC/RA Labs — Reasoning‑as‑a‑Service. SLRC‑governed. LPD‑metered.</p>
      </div>
    </section>

    <section id="policyEditorSec" class="grid">
      <div class="card">
        <h2>Policy Editor (τ floors) <span class="help-chip" data-doc="governance#tau" style="margin-left:8px; cursor:help;">?</span></h2>
        <p class="muted">Edit SLRC floors and preview a diff before applying.</p>
        <div id="cockpitGate" class="muted tiny" style="margin:6px 0 10px;">Pro Mode is OFF. Toggle it to load cockpit and sync state.</div><div class="cta" id="cockpitControls" style="margin-bottom:8px; display:none;">
          <button class="btn" id="btnLoadPolicy">Load policy.yaml</button>
          <button class="btn" id="btnPreviewDiff">Preview diff</button>
          <button class="btn primary" id="btnApplyPolicy">PUT /policy</button>
        </div>
        <div class="two-col">
          <textarea id="policyEditor" style="width:100%; min-height:280px; padding:12px; background:var(--card); border:1px solid var(--border); border-radius:10px; color:var(--text);" placeholder="# Edit policy.yaml here..."></textarea>
          <pre id="policyDiff" style="white-space:pre-wrap; min-height:280px; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px;"></pre>
        </div>
      </div>
    </section>

    
    <section id="proToggle" class="grid">
      <div class="card">
        <h2>Pro Mode</h2>
        <p class="muted">Toggle advanced governance cockpit features. Default: OFF for investor-friendly view.</p>
        <label class="switch">
          <input type="checkbox" id="proModeSwitch">
          <span class="slider round"></span>
        </label>
      </div>
    </section>

    <section id="cockpit" class="grid">
      <div class="card">
        <h2>Governance Cockpit (Pro) <label class="tiny muted" style="margin-left:12px;">Pro Mode</label> <input type="checkbox" id="proModeToggle" class="btn" /> <label class="tiny muted" style="margin-left:12px;">Telemetry URL</label> <select id="envSwitch" style="margin-right:8px;"><option value="dev">Dev</option><option value="stage">Stage</option><option value="prod">Prod</option></select><input id="telemetryUrl" placeholder="https://telemetry.yourdomain.com/ingest"  style="padding:6px 8px; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--text); width:340px;" /> <button class="btn" id="btnTelemetryPing" style="margin-left:8px;">Ping</button> <span class="tiny muted" id="telemetryStatus"></span></h2>
        <p class="muted">This embeds the full <em>RC/RA Governance Cockpit</em> demo. Use the quick actions below or interact inside the cockpit.</p>
        <div id="cockpitGate" class="muted tiny" style="margin:6px 0 10px;">Pro Mode is OFF. Toggle it to load cockpit and sync state.</div><div class="cta" id="cockpitControls" style="margin-bottom:8px; display:none;">
          <button class="btn" id="bridgeRun">Run Eval</button>
          <button class="btn" id="bridgePolicySave">Policy Save</button>
          <button class="btn" id="bridgePDF">Generate PDF</button>
          <a class="btn" href="cockpit_embed.html" target="_blank">Open Cockpit in new tab</a><button class="btn" id="bridgeResetTau" title="Reset τ to original floors">Reset τ</button><button class="btn" id="btnTelemetryTest" title="Send a test ping to telemetry endpoint">Telemetry Test</button>
        </div>
        <iframe id="cockpitFrame" style="display:none" style="display:none;" src="cockpit_embed.html" style="width:100%; height:900px; border:1px solid var(--border); border-radius:10px; background:var(--card)" src="data:text/html;base64,PCFkb2N0eXBlIGh0bWw+CjxodG1sIGxhbmc9ImVuIj4KPGhlYWQ+CiAgPG1ldGEgY2hhcnNldD0idXRmLTgiIC8+CiAgPG1ldGEgbmFtZT0idmlld3BvcnQiIGNvbnRlbnQ9IndpZHRoPWRldmljZS13aWR0aCwgaW5pdGlhbC1zY2FsZT0xIiAvPgogIDxiYXNlIHRhcmdldD0iX3NlbGYiPjx0aXRsZT5SQy9SQSBSZXZhbXBlZCBEZW1vIOKAlCBHb3Zlcm5hbmNlIENvY2twaXQ8L3RpdGxlPgogIDxzdHlsZT4KICAgIDpyb290IHsgLS1iZzojMGUxMTE2Oy0tY2FyZDojMTUxYTIyOy0tdGV4dDojZThlZWY3Oy0tbXV0ZWQ6IzlmYjBjMDstLWFjY2VudDojNWJkNmZmOy0tZ29vZDojNThkNjhkOy0tYmFkOiNmZjZiNmI7LS13YXJuOiNmZmQzNGQ7LS1zaGFkb3c6MCAxMHB4IDMwcHggcmdiYSgwLDAsMCwwLjM1KTstLXJhZGl1czoxMnB4OyB9CiAgICBodG1sLGJvZHl7YmFja2dyb3VuZDp2YXIoLS1iZyk7Y29sb3I6dmFyKC0tdGV4dCk7bWFyZ2luOjA7Zm9udDoxNXB4LzEuNSBzeXN0ZW0tdWksLWFwcGxlLXN5c3RlbSxTZWdvZSBVSSxSb2JvdG8sSW50ZXIsSGVsdmV0aWNhLEFyaWFsLHNhbnMtc2VyaWZ9CiAgICBoZWFkZXJ7ZGlzcGxheTpmbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtqdXN0aWZ5LWNvbnRlbnQ6c3BhY2UtYmV0d2VlbjtwYWRkaW5nOjE2cHggMjRweDtib3JkZXItYm90dG9tOjFweCBzb2xpZCAjMjMyYTMzO3Bvc2l0aW9uOnN0aWNreTt0b3A6MDtiYWNrZ3JvdW5kOnJnYmEoMTQsMTcsMjIsMC45KTtiYWNrZHJvcC1maWx0ZXI6Ymx1cig4cHgpO3otaW5kZXg6NTB9CiAgICBoZWFkZXIgaDF7Zm9udC1zaXplOjE2cHg7bWFyZ2luOjA7bGV0dGVyLXNwYWNpbmc6LjVweH0KICAgIC5iYWRnZXtwYWRkaW5nOjNweCA4cHg7Ym9yZGVyLXJhZGl1czo5OTlweDtiYWNrZ3JvdW5kOiMyMDI3MzQ7Y29sb3I6dmFyKC0tbXV0ZWQpO2ZvbnQtc2l6ZToxMnB4fQogICAgLmNvbnRhaW5lcnttYXgtd2lkdGg6MTIwMHB4O21hcmdpbjowIGF1dG87cGFkZGluZzoyNHB4fQogICAgLnJvd3tkaXNwbGF5OmZsZXg7Z2FwOjE2cHg7ZmxleC13cmFwOndyYXB9CiAgICAuY2FyZHtiYWNrZ3JvdW5kOnZhcigtLWNhcmQpO2JvcmRlcjoxcHggc29saWQgIzIzMmEzMztib3JkZXItcmFkaXVzOnZhcigtLXJhZGl1cyk7Ym94LXNoYWRvdzp2YXIoLS1zaGFkb3cpfQogICAgLnBhbmVse3BhZGRpbmc6MTZweH0KICAgIC5ncmlkLTJ7ZGlzcGxheTpncmlkO2dyaWQtdGVtcGxhdGUtY29sdW1uczpyZXBlYXQoMixtaW5tYXgoMCwxZnIpKTtnYXA6MTZweH0KICAgIC5ncmlkLTN7ZGlzcGxheTpncmlkO2dyaWQtdGVtcGxhdGUtY29sdW1uczpyZXBlYXQoMyxtaW5tYXgoMCwxZnIpKTtnYXA6MTZweH0KICAgIC50YWJze2Rpc3BsYXk6ZmxleDtnYXA6OHB4O2ZsZXgtd3JhcDp3cmFwfQogICAgLnRhYntwYWRkaW5nOjhweCAxMnB4O2JvcmRlci1yYWRpdXM6MTBweDtib3JkZXI6MXB4IHNvbGlkICMyYjM0NDE7YmFja2dyb3VuZDojMTYxYzI1O2NvbG9yOnZhcigtLW11dGVkKTtjdXJzb3I6cG9pbnRlcn0KICAgIC50YWIuYWN0aXZle2NvbG9yOnZhcigtLXRleHQpO2JvcmRlci1jb2xvcjp2YXIoLS1hY2NlbnQpO2JveC1zaGFkb3c6MCAwIDAgMnB4IHJnYmEoOTEsMjE0LDI1NSwwLjE1KSBpbnNldH0KICAgIHRleHRhcmVhLGlucHV0LHNlbGVjdHt3aWR0aDoxMDAlO2JhY2tncm91bmQ6IzBmMTMxYTtib3JkZXI6MXB4IHNvbGlkICMyYjM0NDE7Y29sb3I6dmFyKC0tdGV4dCk7Ym9yZGVyLXJhZGl1czo4cHg7cGFkZGluZzoxMHB4fQogICAgYnV0dG9ue2JhY2tncm91bmQ6bGluZWFyLWdyYWRpZW50KDE4MGRlZywjNWJkNmZmLCMzYWEyYzQpO2NvbG9yOiMwMDEwMTk7cGFkZGluZzoxMHB4IDE0cHg7Ym9yZGVyOjA7Ym9yZGVyLXJhZGl1czoxMHB4O2N1cnNvcjpwb2ludGVyO2ZvbnQtd2VpZ2h0OjYwMH0KICAgIGJ1dHRvbi5naG9zdHtiYWNrZ3JvdW5kOiMxYTIxMmQ7Y29sb3I6dmFyKC0tdGV4dCk7Ym9yZGVyOjFweCBzb2xpZCAjMmIzNDQxfQogICAgLmtwaXtkaXNwbGF5OmZsZXg7YWxpZ24taXRlbXM6Y2VudGVyO2dhcDo4cHg7cGFkZGluZzo4cHggMTJweDtib3JkZXItcmFkaXVzOjEwcHg7YmFja2dyb3VuZDojMTAxNjIwO2JvcmRlcjoxcHggc29saWQgIzJiMzQ0MX0KICAgIC5rcGkgLnZhbHVle2ZvbnQtd2VpZ2h0OjcwMH0KICAgIC5waWxse3BhZGRpbmc6MnB4IDhweDtib3JkZXItcmFkaXVzOjk5OXB4O2ZvbnQtc2l6ZToxMnB4O2JvcmRlcjoxcHggc29saWQgIzJiMzQ0MTtiYWNrZ3JvdW5kOiMxMDE2MjA7Y29sb3I6dmFyKC0tbXV0ZWQpfQogICAgLm9re2NvbG9yOnZhcigtLWdvb2QpfSAuYmFke2NvbG9yOnZhcigtLWJhZCl9IC53YXJue2NvbG9yOnZhcigtLXdhcm4pfQogICAgcHJle3doaXRlLXNwYWNlOnByZS13cmFwO3dvcmQtYnJlYWs6YnJlYWstd29yZDtiYWNrZ3JvdW5kOiMwZjEzMWE7cGFkZGluZzoxMnB4O2JvcmRlci1yYWRpdXM6MTBweDtib3JkZXI6MXB4IHNvbGlkICMyYjM0NDF9CiAgICAuZm9vdGVye2NvbG9yOnZhcigtLW11dGVkKTt0ZXh0LWFsaWduOmNlbnRlcjtwYWRkaW5nOjI0cHh9CiAgICAuaGlkZGVue2Rpc3BsYXk6bm9uZSAhaW1wb3J0YW50fQogICAgLmlubGluZXtkaXNwbGF5OmlubGluZS1mbGV4O2FsaWduLWl0ZW1zOmNlbnRlcjtnYXA6OHB4fQogICAgLmZsZXh7ZGlzcGxheTpmbGV4O2dhcDo4cHg7YWxpZ24taXRlbXM6Y2VudGVyO2ZsZXgtd3JhcDp3cmFwfQogICAgLnJpZ2h0e21hcmdpbi1sZWZ0OmF1dG99IC5lZGl0b3J7bWluLWhlaWdodDoyNDBweH0gLnNwbGl0e2Rpc3BsYXk6Z3JpZDtncmlkLXRlbXBsYXRlLWNvbHVtbnM6MWZyIDFmcjtnYXA6MTZweH0KICAgIC5zbWFsbHtmb250LXNpemU6MTJweDtjb2xvcjp2YXIoLS1tdXRlZCl9IGF7Y29sb3I6dmFyKC0tYWNjZW50KTt0ZXh0LWRlY29yYXRpb246bm9uZX0KICA8L3N0eWxlPgo8L2hlYWQ+Cjxib2R5Pgo8aGVhZGVyIGNsYXNzPSJjYXJkIj4KICA8aDE+UkMvUkEgUmV2YW1wZWQgRGVtbyDigKIgPHNwYW4gY2xhc3M9ImJhZGdlIj5TdGl0Y2jigJFLaXTCoHYxMiBVSSDigKIgQ29uc3VsdGluZyBNb2RlPC9zcGFuPjwvaDE+CiAgPGRpdiBjbGFzcz0iZmxleCI+CiAgICA8bGFiZWwgY2xhc3M9InBpbGwgaW5saW5lIj48aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJ0b2dnbGVNb2NrIiBjaGVja2VkIC8+IE1vY2sgbW9kZTwvbGFiZWw+CiAgICA8bGFiZWwgY2xhc3M9InBpbGwgaW5saW5lIj48aW5wdXQgdHlwZT0iY2hlY2tib3giIGlkPSJ0b2dnbGVDb25zdWx0aW5nIiAvPiBDb25zdWx0aW5nIE1vZGU8L2xhYmVsPgogICAgPGEgY2xhc3M9InBpbGwiIGhyZWY9Ii4vcmVwb3J0Lmh0bWwiIHRhcmdldD0iX2JsYW5rIj7wn5OEIFJlcG9ydCBUZW1wbGF0ZTwvYT4KICAgIDxhIGNsYXNzPSJwaWxsIiBocmVmPSIuLi9kb2NzL2RlbW9fbmF2X0lOVkVTVE9SX0NPTUJJTkVELm1kIiB0YXJnZXQ9Il9ibGFuayI+8J+TmCBJbnZlc3RvciBXYWxrdGhyb3VnaDwvYT4KICA8L2Rpdj4KPC9oZWFkZXI+Cgo8ZGl2IGNsYXNzPSJjb250YWluZXIiPgogIDxkaXYgY2xhc3M9InRhYnMiPgogICAgPGRpdiBjbGFzcz0idGFiIGFjdGl2ZSIgZGF0YS10YWI9InBsYXlncm91bmQiPlBsYXlncm91bmQ8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InRhYiIgZGF0YS10YWI9ImdvdmVybmFuY2UiPkdvdmVybmFuY2U8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InRhYiIgZGF0YS10YWI9InUtc3RhciI+VeKYhSBMYWI8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InRhYiIgZGF0YS10YWI9InJvYyI+Uk9DICYgRmxvb3JzPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJ0YWIiIGRhdGEtdGFiPSJwb2xpY3kiPlBvbGljeSBFZGl0b3I8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InRhYiIgZGF0YS10YWI9InBkZiI+UERGIEdlbmVyYXRvcjwvZGl2PgogICAgPGRpdiBjbGFzcz0idGFiIiBkYXRhLXRhYj0iYXBpIj5BUEkgQ29uc29sZTwvZGl2PgogIDwvZGl2PgoKICA8c2VjdGlvbiBjbGFzcz0iY2FyZCBwYW5lbCIgaWQ9InRhYi1wbGF5Z3JvdW5kIj4KICAgIDxkaXYgY2xhc3M9ImdyaWQtMiI+CiAgICAgIDxkaXY+CiAgICAgICAgPGgzPkRyYWZ0IOKGkiBDcml0aXF1ZSDihpIgUmV2aXNlIChjbGllbnQtc2lkZSBsb29wKTwvaDM+CiAgICAgICAgPHRleHRhcmVhIGlkPSJpbnB1dFRleHQiIHJvd3M9IjEwIiBwbGFjZWhvbGRlcj0iUGFzdGUgYSBwcm9tcHQgb3IgYnVzaW5lc3MgcXVlc3Rpb24gdG8gZXZhbHVhdGUuLi4iPjwvdGV4dGFyZWE+CiAgICAgICAgPGRpdiBjbGFzcz0iZmxleCI+CiAgICAgICAgICA8YnV0dG9uIGlkPSJidG5SdW4iPlJ1biBFdmFsdWF0aW9uPC9idXR0b24+CiAgICAgICAgICA8YnV0dG9uIGlkPSJidG5SZXNldCIgY2xhc3M9Imdob3N0Ij5SZXNldDwvYnV0dG9uPgogICAgICAgICAgPHNwYW4gY2xhc3M9InNtYWxsIj5SdW5zIGFnYWluc3QgL2FwaS9kZXRlY3Rvci9ldmFsIGluIEFQSSBtb2RlOyBvdGhlcndpc2UgdXNlcyB0aGUgaW7igJFicm93c2VyIGRldGVjdG9yLjwvc3Bhbj4KICAgICAgICA8L2Rpdj4KICAgICAgPC9kaXY+CiAgICAgIDxkaXY+CiAgICAgICAgPGgzPlJlc3VsdDwvaDM+CiAgICAgICAgPGRpdiBjbGFzcz0iZ3JpZC0zIj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImtwaSI+djogPHNwYW4gaWQ9ImtwaVYiIGNsYXNzPSJ2YWx1ZSI+4oCUPC9zcGFuPjwvZGl2PgogICAgICAgICAgPGRpdiBjbGFzcz0ia3BpIj7PgzogPHNwYW4gaWQ9ImtwaVNpZ21hIiBjbGFzcz0idmFsdWUiPuKAlDwvc3Bhbj48L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImtwaSI+ZGVwdGg6IDxzcGFuIGlkPSJrcGlEZXB0aCIgY2xhc3M9InZhbHVlIj7igJQ8L3NwYW4+PC9kaXY+CiAgICAgICAgICA8ZGl2IGNsYXNzPSJrcGkiPmNvc3Q6IDxzcGFuIGlkPSJrcGlDb3N0IiBjbGFzcz0idmFsdWUiPuKAlDwvc3Bhbj48L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImtwaSI+TFBEOiA8c3BhbiBpZD0ia3BpTFBEIiBjbGFzcz0idmFsdWUiPuKAlDwvc3Bhbj48L2Rpdj4KICAgICAgICAgIDxkaXYgY2xhc3M9ImtwaSI+dl9uZXQ6IDxzcGFuIGlkPSJrcGlWTmV0IiBjbGFzcz0idmFsdWUiPuKAlDwvc3Bhbj48L2Rpdj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJmbGV4Ij4KICAgICAgICAgIDxzcGFuIGlkPSJwYXNzQmFkZ2UiIGNsYXNzPSJwaWxsIj5TTFJDOiDigJQ8L3NwYW4+CiAgICAgICAgICA8c3BhbiBjbGFzcz0icGlsbCIgaWQ9ImZsb29yc05vdyI+Zmxvb3JzOiDigJQ8L3NwYW4+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPGRldGFpbHMgc3R5bGU9Im1hcmdpbi10b3A6MTJweDsiPgogICAgICAgICAgPHN1bW1hcnk+SlNPTjwvc3VtbWFyeT4KICAgICAgICAgIDxwcmUgaWQ9Impzb25PdXQiPjwvcHJlPgogICAgICAgIDwvZGV0YWlscz4KICAgICAgICA8ZGV0YWlscz4KICAgICAgICAgIDxzdW1tYXJ5PlJpc2sgVGFnczwvc3VtbWFyeT4KICAgICAgICAgIDxkaXYgaWQ9InJpc2tUYWdzIj48L2Rpdj4KICAgICAgICA8L2RldGFpbHM+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgPC9zZWN0aW9uPgoKICA8c2VjdGlvbiBjbGFzcz0iY2FyZCBwYW5lbCBoaWRkZW4iIGlkPSJ0YWItZ292ZXJuYW5jZSI+CiAgICA8ZGl2IGNsYXNzPSJzcGxpdCI+CiAgICAgIDxkaXY+CiAgICAgICAgPGgzPlNMUkMgU25hcHNob3Q8L2gzPgogICAgICAgIDxkaXYgaWQ9ImdvdmVybmFuY2VTbmFwc2hvdCI+PC9kaXY+CiAgICAgICAgPHAgY2xhc3M9InNtYWxsIj5TaG93cyBmbG9vcnMgdnMgbWVhc3VyZW1lbnQgZm9yIGxhc3QgcnVuLCB3aXRoIHBhc3MvZmFpbCByZWFzb25zLjwvcD4KICAgICAgPC9kaXY+CiAgICAgIDxkaXY+CiAgICAgICAgPGgzPlJ1biBMb2cgKGxhdGVzdCA1KTwvaDM+CiAgICAgICAgPHByZSBpZD0icnVuTG9nIj48L3ByZT4KICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICA8L3NlY3Rpb24+CgogIDxzZWN0aW9uIGNsYXNzPSJjYXJkIHBhbmVsIGhpZGRlbiIgaWQ9InRhYi11LXN0YXIiPgogICAgPGRpdiBjbGFzcz0ic3BsaXQiPgogICAgICA8ZGl2PgogICAgICAgIDxoMz5Hb2xkIFBhcmFncmFwaHMgKHXimIUpIOKAlCBEZW1vPC9oMz4KICAgICAgICA8dGV4dGFyZWEgaWQ9ImdvbGRTZXQiIGNsYXNzPSJlZGl0b3IiIHBsYWNlaG9sZGVyPSJPbmUgZ29sZCBwYXJhZ3JhcGggcGVyIGxpbmUuLi4iPjwvdGV4dGFyZWE+CiAgICAgICAgPGRpdiBjbGFzcz0iZmxleCI+CiAgICAgICAgICA8YnV0dG9uIGlkPSJidG5NYWtlVVN0YXIiPk1ha2UgdeKYhTwvYnV0dG9uPgogICAgICAgICAgPGJ1dHRvbiBpZD0iYnRuU2NvcmUiIGNsYXNzPSJnaG9zdCI+U2NvcmUgQ3VycmVudCBEcmFmdCB2cyB14piFPC9idXR0b24+CiAgICAgICAgPC9kaXY+CiAgICAgICAgPHAgY2xhc3M9InNtYWxsIj5EZXRlcm1pbmlzdGljIHRveSBlbWJlZGRpbmcgKDM4NC1kIHRyaWdyYW0gaGFzaCkgZm9yIGRlbW8gcmVwcm9kdWNpYmlsaXR5LjwvcD4KICAgICAgPC9kaXY+CiAgICAgIDxkaXY+CiAgICAgICAgPGgzPnXimIUgJiBHYWluPC9oMz4KICAgICAgICA8cHJlIGlkPSJ1c3Rhck91dCI+PC9wcmU+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgPC9zZWN0aW9uPgoKICA8c2VjdGlvbiBjbGFzcz0iY2FyZCBwYW5lbCBoaWRkZW4iIGlkPSJ0YWItcm9jIj4KICAgIDxkaXYgY2xhc3M9InNwbGl0Ij4KICAgICAgPGRpdj4KICAgICAgICA8aDM+Uk9DIFN3ZWVwIChzeW50aGV0aWMpPC9oMz4KICAgICAgICA8cCBjbGFzcz0ic21hbGwiPlNpbXVsYXRlIExQRCBkaXN0cmlidXRpb25zIGFuZCBwcm9wb3NlIM+EIGZsb29yIHVwZGF0ZXMuPC9wPgogICAgICAgIDxkaXYgY2xhc3M9ImZsZXgiPgogICAgICAgICAgPGJ1dHRvbiBpZD0iYnRuUnVuUk9DIj5SdW4gUk9DIFN3ZWVwPC9idXR0b24+CiAgICAgICAgICA8YnV0dG9uIGlkPSJidG5BcHBseVRhdSIgY2xhc3M9Imdob3N0Ij5BcHBseSBQcm9wb3NlZCBGbG9vcnM8L2J1dHRvbj4KICAgICAgICA8L2Rpdj4KICAgICAgICA8cHJlIGlkPSJyb2NPdXQiPjwvcHJlPgogICAgICA8L2Rpdj4KICAgICAgPGRpdj4KICAgICAgICA8aDM+Q3VycmVudCBGbG9vcnM8L2gzPgogICAgICAgIDxwcmUgaWQ9ImZsb29yc091dCI+PC9wcmU+CiAgICAgIDwvZGl2PgogICAgPC9kaXY+CiAgPC9zZWN0aW9uPgoKICA8c2VjdGlvbiBjbGFzcz0iY2FyZCBwYW5lbCBoaWRkZW4iIGlkPSJ0YWItcG9saWN5Ij4KICAgIDxkaXYgY2xhc3M9InNwbGl0Ij4KICAgICAgPGRpdj4KICAgICAgICA8aDM+cG9saWN5LnlhbWw8L2gzPgogICAgICAgIDx0ZXh0YXJlYSBpZD0icG9saWN5RWRpdG9yIiBjbGFzcz0iZWRpdG9yIiBwbGFjZWhvbGRlcj0iRWRpdCBZQU1MLi4uIj48L3RleHRhcmVhPgogICAgICAgIDxkaXYgY2xhc3M9ImZsZXgiPgogICAgICAgICAgPGJ1dHRvbiBpZD0iYnRuUG9saWN5U2F2ZSI+U2F2ZSAoUE9TVCAvYXBpL3BvbGljeSk8L2J1dHRvbj4KICAgICAgICAgIDxidXR0b24gaWQ9ImJ0blBvbGljeVJlbG9hZCIgY2xhc3M9Imdob3N0Ij5SZWxvYWQ8L2J1dHRvbj4KICAgICAgICAgIDxsYWJlbCBjbGFzcz0icGlsbCBpbmxpbmUiPjxzcGFuIGNsYXNzPSJzbWFsbCI+U2lnbmF0dXJlOjwvc3Bhbj48aW5wdXQgaWQ9InNpZ0tleSIgcGxhY2Vob2xkZXI9IkRFTU9fT05MWSIvPjwvbGFiZWw+CiAgICAgICAgPC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8ZGl2PgogICAgICAgIDxoMz5BdWRpdDwvaDM+CiAgICAgICAgPHByZSBpZD0icG9saWN5QXVkaXQiPjwvcHJlPgogICAgICA8L2Rpdj4KICAgIDwvZGl2PgogIDwvc2VjdGlvbj4KCiAgPHNlY3Rpb24gY2xhc3M9ImNhcmQgcGFuZWwgaGlkZGVuIiBpZD0idGFiLXBkZiI+CiAgICA8aDM+R2VuZXJhdGUgTXVsdGnigJFTZWN0aW9uIFJlcG9ydCAoUERGKTwvaDM+CiAgICA8cCBjbGFzcz0ic21hbGwiPlVzZXMgL2FwaS9wZGYvZ2VuZXJhdGUgaW4gQVBJIG1vZGU7IGZhbGxzIGJhY2sgdG8gY2xpZW504oCRc2lkZSBtYXJrdXAgY2FwdHVyZSBpbiBNb2NrIG1vZGUuPC9wPgogICAgPGRpdiBjbGFzcz0iZmxleCI+CiAgICAgIDxidXR0b24gaWQ9ImJ0blBERiI+R2VuZXJhdGUgUERGPC9idXR0b24+CiAgICAgIDxidXR0b24gaWQ9ImJ0bkludmVzdG9yUERGIiBjbGFzcz0iZ2hvc3QiPkludmVzdG9yIFJ1bnRocm91Z2ggUERGPC9idXR0b24+CiAgICAgIDxhIGlkPSJwZGZEb3dubG9hZCIgY2xhc3M9InBpbGwgaGlkZGVuIiBkb3dubG9hZD0icmNyYV9yZXBvcnQucGRmIj5Eb3dubG9hZCByZWFkeTwvYT4KICAgIDwvZGl2PgogICAgPHByZSBpZD0icGRmU3RhdHVzIj48L3ByZT4KICA8L3NlY3Rpb24+CgogIDxzZWN0aW9uIGNsYXNzPSJjYXJkIHBhbmVsIGhpZGRlbiIgaWQ9InRhYi1hcGkiPgogICAgPGgzPkFQSSBDb25zb2xlPC9oMz4KICAgIDxwIGNsYXNzPSJzbWFsbCI+UXVpY2sgY2FsbHMgdG8gZGVtbyBlbmRwb2ludHMuPC9wPgogICAgPGRpdiBjbGFzcz0iZ3JpZC0zIj4KICAgICAgPGJ1dHRvbiBjbGFzcz0iZ2hvc3QiIGRhdGEtY2FsbD0iR0VUIC9hcGkvcG9saWN5Ij5HRVQgL2FwaS9wb2xpY3k8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBjbGFzcz0iZ2hvc3QiIGRhdGEtY2FsbD0iUE9TVCAvYXBpL3BvbGljeSI+UE9TVCAvYXBpL3BvbGljeTwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJnaG9zdCIgZGF0YS1jYWxsPSJQT1NUIC9hcGkvZGV0ZWN0b3IvZXZhbCI+UE9TVCAvYXBpL2RldGVjdG9yL2V2YWw8L2J1dHRvbj4KICAgICAgPGJ1dHRvbiBjbGFzcz0iZ2hvc3QiIGRhdGEtY2FsbD0iUE9TVCAvYXBpL3JvYy9zd2VlcCI+UE9TVCAvYXBpL3JvYy9zd2VlcDwvYnV0dG9uPgogICAgICA8YnV0dG9uIGNsYXNzPSJnaG9zdCIgZGF0YS1jYWxsPSJQT1NUIC9hcGkvcGRmL2ludmVzdG9yX3J1bnRocm91Z2giPlBPU1QgL2FwaS9wZGYvaW52ZXN0b3JfcnVudGhyb3VnaDwvYnV0dG9uPgogICAgPC9kaXY+CiAgICA8cHJlIGlkPSJhcGlPdXQiPjwvcHJlPgogIDwvc2VjdGlvbj4KCiAgPGRpdiBjbGFzcz0iZm9vdGVyIHNtYWxsIj5MUEQg4oCiIFNMUkMg4oCiIFJSUCDigJQgR292ZXJuYW5jZeKAkWdyYWRlIFJlYXNvbmluZy4gwqkgUkMvUkEgTGFiczwvZGl2Pgo8L2Rpdj4KCjxzY3JpcHQ+CmNvbnN0IHRhYnMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcudGFiJyk7CmNvbnN0IHBhbmVscyA9IHsKICBwbGF5Z3JvdW5kOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFiLXBsYXlncm91bmQnKSwKICBnb3Zlcm5hbmNlOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFiLWdvdmVybmFuY2UnKSwKICAndS1zdGFyJzogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhYi11LXN0YXInKSwKICByb2M6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWItcm9jJyksCiAgcG9saWN5OiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGFiLXBvbGljeScpLAogIHBkZjogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RhYi1wZGYnKSwKICBhcGk6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0YWItYXBpJyksCn07CnRhYnMuZm9yRWFjaCh0ID0+IHQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgdGFicy5mb3JFYWNoKHggPT4geC5jbGFzc0xpc3QucmVtb3ZlKCdhY3RpdmUnKSk7CiAgdC5jbGFzc0xpc3QuYWRkKCdhY3RpdmUnKTsKICBPYmplY3QudmFsdWVzKHBhbmVscykuZm9yRWFjaChwID0+IHAuY2xhc3NMaXN0LmFkZCgnaGlkZGVuJykpOwogIHBhbmVsc1t0LmRhdGFzZXQudGFiXS5jbGFzc0xpc3QucmVtb3ZlKCdoaWRkZW4nKTsKfSkpOwoKbGV0IGxhc3RSZXN1bHQgPSBudWxsOwpsZXQgcnVuTG9nID0gW107Cgpjb25zdCBtb2NrVG9nZ2xlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RvZ2dsZU1vY2snKTsKY29uc3QgY29uc3VsdFRvZ2dsZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0b2dnbGVDb25zdWx0aW5nJyk7CmNvbnN0IGZsb29yc05vdyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmbG9vcnNOb3cnKTsKY29uc3QganNvbk91dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdqc29uT3V0Jyk7CmNvbnN0IHJpc2tUYWdzRWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmlza1RhZ3MnKTsKY29uc3QgcGFzc0JhZGdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Bhc3NCYWRnZScpOwpjb25zdCBydW5Mb2dFbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdydW5Mb2cnKTsKY29uc3QgZ292ZXJuYW5jZVNuYXBzaG90ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2dvdmVybmFuY2VTbmFwc2hvdCcpOwpjb25zdCBwb2xpY3lFZGl0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncG9saWN5RWRpdG9yJyk7CmNvbnN0IHBvbGljeUF1ZGl0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BvbGljeUF1ZGl0Jyk7CmNvbnN0IGZsb29yc091dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmbG9vcnNPdXQnKTsKY29uc3QgcGRmU3RhdHVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BkZlN0YXR1cycpOwpjb25zdCBwZGZEb3dubG9hZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwZGZEb3dubG9hZCcpOwpjb25zdCBhcGlPdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBpT3V0Jyk7CmNvbnN0IGtWID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2twaVYnKTsKY29uc3Qga1NpZ21hID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2twaVNpZ21hJyk7CmNvbnN0IGtEZXB0aCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdrcGlEZXB0aCcpOwpjb25zdCBrQ29zdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdrcGlDb3N0Jyk7CmNvbnN0IGtMUEQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgna3BpTFBEJyk7CmNvbnN0IGtWTmV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2twaVZOZXQnKTsKCmZ1bmN0aW9uIGhhc2hUcmlncmFtRW1iZWRkaW5nKHRleHQpIHsKICBjb25zdCBkaW0gPSAzODQ7CiAgY29uc3QgdiA9IG5ldyBBcnJheShkaW0pLmZpbGwoMCk7CiAgY29uc3QgcyA9ICh0ZXh0IHx8ICcnKS50b0xvd2VyQ2FzZSgpOwogIGZvciAobGV0IGk9MDsgaSA8IHMubGVuZ3RoLTI7IGkrKykgewogICAgY29uc3QgdHJpZyA9IHMuc2xpY2UoaSwgaSszKTsKICAgIGxldCBoID0gMDsKICAgIGZvciAobGV0IGo9MDsgajx0cmlnLmxlbmd0aDsgaisrKSBoID0gKChoPDw1KS1oKSArIHRyaWcuY2hhckNvZGVBdChqKTsKICAgIGNvbnN0IGlkeCA9IE1hdGguYWJzKGgpICUgZGltOwogICAgdltpZHhdICs9IDE7CiAgfQogIGNvbnN0IG5vcm0gPSBNYXRoLnNxcnQodi5yZWR1Y2UoKGEsYik9PmErYipiLDApKSB8fCAxOwogIHJldHVybiB2Lm1hcCh4ID0+IHggLyBub3JtKTsKfQpmdW5jdGlvbiBjb3NpbmUoYSxiKXsgbGV0IGQ9MDsgZm9yKGxldCBpPTA7aTxhLmxlbmd0aDtpKyspIGQrPWFbaV0qYltpXTsgcmV0dXJuIGQ7IH0KCmxldCB1U3RhciA9IG51bGw7CmZ1bmN0aW9uIG1ha2VVU3RhcihwYXJhZ3JhcGhzKSB7CiAgY29uc3QgbGluZXMgPSBwYXJhZ3JhcGhzLnNwbGl0KC9cbisvKS5tYXAocyA9PiBzLnRyaW0oKSkuZmlsdGVyKEJvb2xlYW4pOwogIGlmICghbGluZXMubGVuZ3RoKSByZXR1cm4gbnVsbDsKICBjb25zdCBkaW0gPSAzODQ7CiAgY29uc3QgYWNjID0gbmV3IEFycmF5KGRpbSkuZmlsbCgwKTsKICBsaW5lcy5mb3JFYWNoKGxpbmUgPT4gewogICAgY29uc3QgZSA9IGhhc2hUcmlncmFtRW1iZWRkaW5nKGxpbmUpOwogICAgZm9yIChsZXQgaT0wO2k8ZGltO2krKykgYWNjW2ldICs9IGVbaV07CiAgfSk7CiAgY29uc3Qgbm9ybSA9IE1hdGguc3FydChhY2MucmVkdWNlKChhLGIpPT5hK2IqYiwwKSkgfHwgMTsKICByZXR1cm4gYWNjLm1hcCh4ID0+IHggLyBub3JtKTsKfQoKZnVuY3Rpb24gZGV0ZWN0Umlza3ModGV4dCwgb3BlcmF0b3JzLCBwZWRhZ29neSkgewogIGNvbnN0IHRhZ3MgPSBbXTsKICBjb25zdCBhZGQgPSAoaWQsIGNvbmYpID0+IHRhZ3MucHVzaCh7aWQsIGNvbmY6IE1hdGgubWF4KDAsIE1hdGgubWluKDEsIGNvbmYpKX0pOwogIHRyeSB7CiAgICAob3BlcmF0b3JzPy5yaXNrX3RhZ3MgfHwgW10pLmZvckVhY2gocnQgPT4gewogICAgICBjb25zdCByZSA9IG5ldyBSZWdFeHAocnQucGF0dGVybiwgJ2knKTsgaWYgKHJlLnRlc3QodGV4dCkpIGFkZChydC5pZCwgTWF0aC5taW4oMSwocnQud2VpZ2h0fHwwLjEpKzAuMSkpOwogICAgfSk7CiAgfSBjYXRjaChlKXt9CiAgdHJ5IHsKICAgIChwZWRhZ29neT8ub3BlcmF0b3JzIHx8IFtdKS5mb3JFYWNoKG9wID0+IHsKICAgICAgY29uc3QgcmUgPSBuZXcgUmVnRXhwKG9wLnBhdHRlcm4sICdpJyk7IGlmIChyZS50ZXN0KHRleHQpKSBhZGQob3AuaWQsIE1hdGgubWluKDEsKG9wLnBlbmFsdHl8fDAuMDUpKzAuMSkpOwogICAgfSk7CiAgfSBjYXRjaChlKXt9CiAgaWYgKGNvbnN1bHRUb2dnbGUuY2hlY2tlZCkgewogICAgaWYgKC8oaGFuZFwtd2F2ZXxoYW5kd2F2ZXxpdCBkZXBlbmRzKS9pLnRlc3QodGV4dCkpIGFkZCgnY29uc3VsdGluZ19oYW5kd2F2ZScsIDAuNik7CiAgICBpZiAoLyhiZXN0IHByYWN0aWNlcykvaS50ZXN0KHRleHQpKSBhZGQoJ2dlbmVyaWNfYmVzdF9wcmFjdGljZXMnLCAwLjQpOwogIH0KICByZXR1cm4gdGFnczsKfQoKZnVuY3Rpb24gYXBwbHlGbG9vcnMobSwgZmxvb3JzKXsKICBjb25zdCByZWFzb25zID0gW107CiAgY29uc3QgcGFzcyA9IChtLnZfbmV0ID49IGZsb29ycy52X21pbiAmJiBtLmxwZCA+PSBmbG9vcnMubHBkX21pbiAmJiBtLnNpZ21hIDw9IGZsb29ycy5zaWdtYV9tYXggJiYgbS5kZXB0aCA+PSBmbG9vcnMuZGVwdGhfbWluKTsKICBpZiAobS52X25ldCA8IGZsb29ycy52X21pbikgcmVhc29ucy5wdXNoKGB2X25ldCAke20udl9uZXQudG9GaXhlZCgzKX0gPCB2X21pbiAke2Zsb29ycy52X21pbn1gKTsKICBpZiAobS5scGQgICA8IGZsb29ycy5scGRfbWluKSByZWFzb25zLnB1c2goYExQRCAke20ubHBkLnRvRml4ZWQoMil9IDwgbHBkX21pbiAke2Zsb29ycy5scGRfbWlufWApOwogIGlmIChtLnNpZ21hID4gZmxvb3JzLnNpZ21hX21heCkgcmVhc29ucy5wdXNoKGDPgyAke20uc2lnbWEudG9GaXhlZCgzKX0gPiBzaWdtYV9tYXggJHtmbG9vcnMuc2lnbWFfbWF4fWApOwogIGlmIChtLmRlcHRoIDwgZmxvb3JzLmRlcHRoX21pbikgcmVhc29ucy5wdXNoKGBkZXB0aCAke20uZGVwdGh9IDwgZGVwdGhfbWluICR7Zmxvb3JzLmRlcHRoX21pbn1gKTsKICByZXR1cm4geyBwYXNzLCByZWFzb25zIH07Cn0KY29uc3QgREVGQVVMVF9GTE9PUlMgPSB7IHZfbWluOjAuODQsIGxwZF9taW46MS4zMCwgc2lnbWFfbWF4OjAuMjIsIGRlcHRoX21pbjoyIH07Cgphc3luYyBmdW5jdGlvbiBsb2FkUG9saWN5KCl7CiAgaWYgKG1vY2tUb2dnbGUuY2hlY2tlZCl7CiAgICBjb25zdCByYXcgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgncG9saWN5WWFtbCcpOwogICAgaWYgKHJhdyl7IHBvbGljeUVkaXRvci52YWx1ZSA9IHJhdzsgfQogICAgZWxzZSB7CiAgICAgIGNvbnN0IHR4dCA9IGF3YWl0IChhd2FpdCBmZXRjaCgnLi4vcG9saWN5LnlhbWwnKSkudGV4dCgpOwogICAgICBwb2xpY3lFZGl0b3IudmFsdWUgPSB0eHQ7CiAgICB9CiAgICBmbG9vcnNPdXQudGV4dENvbnRlbnQgPSBleHRyYWN0Rmxvb3JzRnJvbVlhbWwocG9saWN5RWRpdG9yLnZhbHVlKTsKICAgIHJldHVybjsKICB9CiAgY29uc3QgciA9IGF3YWl0IGZldGNoKCcvYXBpL3BvbGljeScpOyBjb25zdCBqID0gYXdhaXQgci5qc29uKCk7CiAgcG9saWN5RWRpdG9yLnZhbHVlID0gai55YW1sIHx8ICcnOyBmbG9vcnNPdXQudGV4dENvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShqLmZsb29ycywgbnVsbCwgMik7CiAgcG9saWN5QXVkaXQudGV4dENvbnRlbnQgPSAoai5hdWRpdHx8W10pLm1hcChhID0+IGDigKIgJHthLnRzfSAke2EuYWN0b3J9ICR7YS5tc2d9YCkuam9pbignXG4nKTsKfQoKZnVuY3Rpb24gZXh0cmFjdEZsb29yc0Zyb21ZYW1sKHlhbWwpewogIGNvbnN0IGxpbmVzID0gKHlhbWx8fCcnKS5zcGxpdCgvXG4vKTsgY29uc3QgbyA9IHsuLi5ERUZBVUxUX0ZMT09SU307CiAgbGluZXMuZm9yRWFjaChsaW5lPT57IGNvbnN0IG0gPSBsaW5lLnRyaW0oKS5tYXRjaCgvXih2X21pbnxscGRfbWlufHNpZ21hX21heHxkZXB0aF9taW4pOlxzKihbMC05Ll0rKS8pOyBpZihtKSBvW21bMV1dPU51bWJlcihtWzJdKTsgfSk7CiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG8sIG51bGwsIDIpOwp9CmZ1bmN0aW9uIHBhcnNlWWFtbEZsb29ycyh5YW1sKXsgdHJ5eyByZXR1cm4gSlNPTi5wYXJzZShleHRyYWN0Rmxvb3JzRnJvbVlhbWwoeWFtbCkpOyB9IGNhdGNoKGUpeyByZXR1cm4gREVGQVVMVF9GTE9PUlM7IH0gfQoKYXN5bmMgZnVuY3Rpb24gbG9hZE9wcygpewogIGNvbnN0IG9wcyA9IGF3YWl0IChhd2FpdCBmZXRjaCgnLi4vb3BlcmF0b3JzLnlhbWwnKSkudGV4dCgpOwogIGNvbnN0IHBlZCA9IGF3YWl0IChhd2FpdCBmZXRjaCgnLi4vcGVkYWdvZ3lfcmlza19vcGVyYXRvcnMueWFtbCcpKS50ZXh0KCk7CiAgY29uc3QgcGFyc2VPcHMgPSAocmF3KSA9PiB7CiAgICBjb25zdCBibG9ja3MgPSBbXTsgbGV0IGN1cnJlbnQ9bnVsbDsKICAgIHJhdy5zcGxpdCgvXG4vKS5mb3JFYWNoKGxpbmU9PnsKICAgICAgaWYgKC9eLVxzKmlkOi9pLnRlc3QobGluZSkpeyBpZiAoY3VycmVudCkgYmxvY2tzLnB1c2goY3VycmVudCk7IGN1cnJlbnQgPSB7aWQ6IGxpbmUuc3BsaXQoJzonKVsxXS50cmltKCl9OyB9CiAgICAgIGVsc2UgaWYgKC9wYXR0ZXJuOi9pLnRlc3QobGluZSkgJiYgY3VycmVudCl7IGN1cnJlbnQucGF0dGVybiA9IGxpbmUuc3BsaXQoJzonLDIpWzFdLnRyaW0oKS5yZXBsYWNlKC9eWyInXXxbIiddJC9nLCcnKTsgfQogICAgICBlbHNlIGlmICgvKHdlaWdodHxwZW5hbHR5KTovaS50ZXN0KGxpbmUpICYmIGN1cnJlbnQpeyBjb25zdCBrPWxpbmUuc3BsaXQoJzonKVswXS50cmltKCk7IGNvbnN0IHY9cGFyc2VGbG9hdChsaW5lLnNwbGl0KCc6JylbMV0pOyBjdXJyZW50W2tdPWlzTmFOKHYpPzAuMTp2OyB9CiAgICB9KTsKICAgIGlmIChjdXJyZW50KSBibG9ja3MucHVzaChjdXJyZW50KTsKICAgIGlmICgvcGVkYWdvZ3kvaS50ZXN0KHJhdykpIHJldHVybiB7b3BlcmF0b3JzOiBibG9ja3N9OwogICAgcmV0dXJuIHtyaXNrX3RhZ3M6IGJsb2Nrc307CiAgfTsKICByZXR1cm4geyBvcGVyYXRvcnM6IHBhcnNlT3BzKG9wcyksIHBlZGFnb2d5OiBwYXJzZU9wcyhwZWQpIH07Cn0KCi8vIFJ1biBFdmFsCmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5SdW4nKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpID0+IHsKICBjb25zdCB0ZXh0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2lucHV0VGV4dCcpLnZhbHVlIHx8ICdEZW1vIGlucHV0IGZvciBldmFsdWF0aW9uJzsKICBjb25zdCB7b3BlcmF0b3JzLCBwZWRhZ29neX0gPSBhd2FpdCBsb2FkT3BzKCk7CiAgbGV0IHJlc3VsdDsKICBpZiAobW9ja1RvZ2dsZS5jaGVja2VkKXsKICAgIHJlc3VsdCA9IGF3YWl0IGxvY2FsRXZhbHVhdGUodGV4dCwgb3BlcmF0b3JzLCBwZWRhZ29neSk7CiAgfSBlbHNlIHsKICAgIGNvbnN0IHIgPSBhd2FpdCBmZXRjaCgnL2FwaS9kZXRlY3Rvci9ldmFsJywgeyBtZXRob2Q6J1BPU1QnLCBoZWFkZXJzOnsnQ29udGVudC1UeXBlJzonYXBwbGljYXRpb24vanNvbid9LCBib2R5OiBKU09OLnN0cmluZ2lmeSh7dGV4dCwgY29udGV4dDogY29uc3VsdFRvZ2dsZS5jaGVja2VkPydjb25zdWx0aW5nJzonZ2VuZXJhbCd9KSB9KTsKICAgIHJlc3VsdCA9IGF3YWl0IHIuanNvbigpOwogIH0KICBsYXN0UmVzdWx0ID0gcmVzdWx0OyBydW5Mb2cudW5zaGlmdCh7dHM6bmV3IERhdGUoKS50b0lTT1N0cmluZygpLCByZXN1bHR9KTsgcnVuTG9nID0gcnVuTG9nLnNsaWNlKDAsNSk7CiAgcmVuZGVyUmVzdWx0KHJlc3VsdCk7IHJlbmRlckdvdmVybmFuY2UoKTsKfSk7Cgpkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuUmVzZXQnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW5wdXRUZXh0JykudmFsdWU9Jyc7CiAgW2tWLGtTaWdtYSxrRGVwdGgsa0Nvc3Qsa0xQRCxrVk5ldF0uZm9yRWFjaChlbD0+ZWwudGV4dENvbnRlbnQ9J+KAlCcpOwogIGpzb25PdXQudGV4dENvbnRlbnQ9Jyc7IHJpc2tUYWdzRWwuaW5uZXJIVE1MPScnOyBwYXNzQmFkZ2UudGV4dENvbnRlbnQ9J1NMUkM6IOKAlCc7Cn0pOwoKYXN5bmMgZnVuY3Rpb24gbG9jYWxFdmFsdWF0ZSh0ZXh0LCBvcGVyYXRvcnMsIHBlZGFnb2d5KXsKICBjb25zdCBlID0gaGFzaFRyaWdyYW1FbWJlZGRpbmcodGV4dCk7CiAgY29uc3QgYmFzZSA9IHVTdGFyIHx8IG5ldyBBcnJheSgzODQpLmZpbGwoMC4wKTsKICBjb25zdCB2ID0gTWF0aC5tYXgoMCwgTWF0aC5taW4oMSwgY29zaW5lKGUsIGJhc2UpIHx8IDAuNDIpKTsKICBjb25zdCB0YWdzID0gZGV0ZWN0Umlza3ModGV4dCwgb3BlcmF0b3JzLCBwZWRhZ29neSk7CiAgY29uc3QgcGVuYWx0eSA9IHRhZ3MucmVkdWNlKChhLHQpPT4gYSArICh0LmNvbmZ8fDApKjAuMDUsIDApOwogIGNvbnN0IHZfbmV0ID0gTWF0aC5tYXgoMCwgdiAtIHBlbmFsdHkpOwogIGNvbnN0IGxlbiA9ICh0ZXh0fHwnJykubGVuZ3RoIHx8IDE7CiAgY29uc3Qgc2lnbWEgPSBNYXRoLm1pbigwLjksIE1hdGguYWJzKE1hdGguc2luKGxlbi85NykpICogMC4zKTsKICBjb25zdCBkZXB0aCA9IE1hdGgubWluKDUsIE1hdGguZmxvb3IoKCh0ZXh0Lm1hdGNoKC9cbnxcKnxcLXxcZCtcLi9nKXx8W10pLmxlbmd0aCkvNCkrMSk7CiAgY29uc3QgY29zdCA9IDAuMDAyICsgbGVuICogMC4wMDAwMDI7CiAgY29uc3QgbHBkID0gY29zdD4wID8gdl9uZXQgLyBjb3N0IDogMDsKICBjb25zdCBmbG9vcnMgPSBwYXJzZVlhbWxGbG9vcnMocG9saWN5RWRpdG9yLnZhbHVlfHwnJyk7CiAgY29uc3QgZ2F0ZSA9IGFwcGx5Rmxvb3JzKHt2X25ldCwgc2lnbWEsIGRlcHRoLCBscGR9LCBmbG9vcnMpOwogIHJldHVybiB7IHYsIHZfbmV0LCBzaWdtYSwgZGVwdGgsIGNvc3QsIGxwZCwgcGFzczogZ2F0ZS5wYXNzLCByZWFzb25zOiBnYXRlLnJlYXNvbnMsIHRhZ3MgfTsKfQpmdW5jdGlvbiByZW5kZXJSZXN1bHQocil7CiAga1YudGV4dENvbnRlbnQgPSByLnYudG9GaXhlZCgzKTsga1NpZ21hLnRleHRDb250ZW50ID0gci5zaWdtYS50b0ZpeGVkKDMpOyBrRGVwdGgudGV4dENvbnRlbnQgPSBTdHJpbmcoci5kZXB0aCk7CiAga0Nvc3QudGV4dENvbnRlbnQgPSAnJCcrci5jb3N0LnRvRml4ZWQoNCk7IGtMUEQudGV4dENvbnRlbnQgPSByLmxwZC50b0ZpeGVkKDIpOyBrVk5ldC50ZXh0Q29udGVudCA9IHIudl9uZXQudG9GaXhlZCgzKTsKICBqc29uT3V0LnRleHRDb250ZW50ID0gSlNPTi5zdHJpbmdpZnkociwgbnVsbCwgMik7CiAgcmlza1RhZ3NFbC5pbm5lckhUTUwgPSAoci50YWdzfHxbXSkubWFwKHQ9PmA8c3BhbiBjbGFzcz0icGlsbCI+JHt0LmlkfSAoJHt0LmNvbmYudG9GaXhlZCgyKX0pPC9zcGFuPmApLmpvaW4oJyAnKTsKICBwYXNzQmFkZ2UudGV4dENvbnRlbnQgPSAnU0xSQzogJyArIChyLnBhc3MgPyAnUEFTUyDinIUnIDogJ0ZBSUwg4p2MJyk7CiAgcGFzc0JhZGdlLmNsYXNzTmFtZSA9ICdwaWxsICcgKyAoci5wYXNzID8gJ29rJyA6ICdiYWQnKTsKICBjb25zdCBmbG9vcnMgPSBwYXJzZVlhbWxGbG9vcnMocG9saWN5RWRpdG9yLnZhbHVlfHwnJyk7CiAgZmxvb3JzTm93LnRleHRDb250ZW50ID0gYGZsb29yczogdj49JHtmbG9vcnMudl9taW59LCBMPj0ke2Zsb29ycy5scGRfbWlufSwgz4M8PSR7Zmxvb3JzLnNpZ21hX21heH0sIGQ+PSR7Zmxvb3JzLmRlcHRoX21pbn1gOwp9CmZ1bmN0aW9uIHJlbmRlckdvdmVybmFuY2UoKXsKICBydW5Mb2dFbC50ZXh0Q29udGVudCA9IHJ1bkxvZy5tYXAoeCA9PiBgJHt4LnRzfSDigJQgTFBEICR7eC5yZXN1bHQubHBkLnRvRml4ZWQoMil9IOKAoiAke3gucmVzdWx0LnBhc3M/J1BBU1MnOidGQUlMJ31gKS5qb2luKCdcbicpOwogIGlmICghbGFzdFJlc3VsdCl7IGdvdmVybmFuY2VTbmFwc2hvdC50ZXh0Q29udGVudD0nTm8gcnVucyB5ZXQuJzsgcmV0dXJuOyB9CiAgY29uc3QgZmxvb3JzID0gcGFyc2VZYW1sRmxvb3JzKHBvbGljeUVkaXRvci52YWx1ZXx8JycpOwogIGNvbnN0IHIgPSBsYXN0UmVzdWx0OwogIGdvdmVybmFuY2VTbmFwc2hvdC50ZXh0Q29udGVudCA9IFsKICAgIGB2X25ldDogJHtyLnZfbmV0LnRvRml4ZWQoMyl9IHZzIHZfbWluICR7Zmxvb3JzLnZfbWlufWAsCiAgICBgTFBEOiAke3IubHBkLnRvRml4ZWQoMil9IHZzIGxwZF9taW4gJHtmbG9vcnMubHBkX21pbn1gLAogICAgYM+DOiAke3Iuc2lnbWEudG9GaXhlZCgzKX0gdnMgc2lnbWFfbWF4ICR7Zmxvb3JzLnNpZ21hX21heH1gLAogICAgYGRlcHRoOiAke3IuZGVwdGh9IHZzIGRlcHRoX21pbiAke2Zsb29ycy5kZXB0aF9taW59YCwKICAgIGBQQVNTOiAke3IucGFzc30gJHtyLnJlYXNvbnM/Lmxlbmd0aD8gJ+KAoiByZWFzb25zOiAnICsgci5yZWFzb25zLmpvaW4oJzsgJykgOiAnJ31gCiAgXS5qb2luKCdcbicpOwp9CgovLyBV4piFIGFjdGlvbnMKZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bk1ha2VVU3RhcicpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogIGNvbnN0IGdvbGRTZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZ29sZFNldCcpLnZhbHVlIHx8ICdMb2dpYy1wZXItRG9sbGFyIHRpZXMgdmFsdWUgdG8gY29zdFxuU0xSQyByZWZ1bmRzIGVuZm9yY2UgZmxvb3JzJzsKICB1U3RhciA9IG1ha2VVU3Rhcihnb2xkU2V0KTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndXN0YXJPdXQnKS50ZXh0Q29udGVudCA9IHVTdGFyID8gYHXimIUgcmVhZHkgKGRpbTogJHt1U3Rhci5sZW5ndGh9KWAgOiAnTm8gZ29sZHMnOwp9KTsKZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0blNjb3JlJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgY29uc3QgdGV4dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbnB1dFRleHQnKS52YWx1ZTsKICBpZiAoIXVTdGFyIHx8ICF0ZXh0KSByZXR1cm47CiAgY29uc3QgZSA9IGhhc2hUcmlncmFtRW1iZWRkaW5nKHRleHQpOwogIGNvbnN0IHYgPSBNYXRoLm1heCgwLCBNYXRoLm1pbigxLCBjb3NpbmUoZSwgdVN0YXIpKSk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3VzdGFyT3V0JykudGV4dENvbnRlbnQgPSBgY29zaW5lKHRleHQsdeKYhSkgPSAke3YudG9GaXhlZCgzKX1gOwp9KTsKCi8vIFJPQwpkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuUnVuUk9DJykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7CiAgaWYgKG1vY2tUb2dnbGUuY2hlY2tlZCl7CiAgICBjb25zdCBzaW1zID0gQXJyYXkuZnJvbSh7bGVuZ3RoOjIwMH0sIChfLGkpPT4gTWF0aC5tYXgoMC4yLCAyLjAgKyBNYXRoLnNpbihpLzcpKjAuNSArIChNYXRoLnJhbmRvbSgpLTAuNSkqMC42KSk7CiAgICBjb25zdCBzb3J0ZWQgPSBzaW1zLnNsaWNlKCkuc29ydCgoYSxiKT0+YS1iKTsKICAgIGNvbnN0IHA3NSA9IHNvcnRlZFtNYXRoLmZsb29yKDAuNzUqc29ydGVkLmxlbmd0aCldOwogICAgY29uc3QgZmxvb3JzID0gcGFyc2VZYW1sRmxvb3JzKHBvbGljeUVkaXRvci52YWx1ZXx8JycpOwogICAgY29uc3QgcHJvcG9zYWwgPSB7Li4uZmxvb3JzLCBscGRfbWluOiBNYXRoLm1heChmbG9vcnMubHBkX21pbiwgTnVtYmVyKHA3NS50b0ZpeGVkKDIpKSl9OwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JvY091dCcpLnRleHRDb250ZW50ID0gSlNPTi5zdHJpbmdpZnkoeyBzYW1wbGVzOiBzaW1zLnNsaWNlKDAsMTApKycuLi4nLCBwcm9wb3NlZDogcHJvcG9zYWwsIG5vdGU6ICdLbmVl4omIUDc1IGhldXJpc3RpYyAoZGVtbyknIH0sIG51bGwsIDIpOwogIH0gZWxzZSB7CiAgICBjb25zdCByID0gYXdhaXQgZmV0Y2goJy9hcGkvcm9jL3N3ZWVwJywgeyBtZXRob2Q6J1BPU1QnIH0pOwogICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JvY091dCcpLnRleHRDb250ZW50ID0gYXdhaXQgci50ZXh0KCk7CiAgfQp9KTsKZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bkFwcGx5VGF1JykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKSA9PiB7CiAgdHJ5ewogICAgY29uc3QgZmxvb3JzID0gSlNPTi5wYXJzZShkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncm9jT3V0JykudGV4dENvbnRlbnR8fCd7fScpLnByb3Bvc2VkOwogICAgaWYgKCFmbG9vcnMpIHJldHVybjsKICAgIGNvbnN0IHJhdyA9IHBvbGljeUVkaXRvci52YWx1ZTsKICAgIGNvbnN0IHVwZGF0ZWQgPSByYXcucmVwbGFjZSgvKGxwZF9taW46XHMqKShbMC05Ll0rKS8sIGAkMSR7Zmxvb3JzLmxwZF9taW59YCk7CiAgICBwb2xpY3lFZGl0b3IudmFsdWUgPSB1cGRhdGVkOyBmbG9vcnNPdXQudGV4dENvbnRlbnQgPSBleHRyYWN0Rmxvb3JzRnJvbVlhbWwodXBkYXRlZCk7CiAgfWNhdGNoKGUpe30KfSk7CgovLyBQb2xpY3kgZWRpdG9yCmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5Qb2xpY3lSZWxvYWQnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGxvYWRQb2xpY3kpOwpkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuUG9saWN5U2F2ZScpLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgYXN5bmMgKCkgPT4gewogIGNvbnN0IHlhbWwgPSBwb2xpY3lFZGl0b3IudmFsdWU7CiAgaWYgKG1vY2tUb2dnbGUuY2hlY2tlZCl7CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgncG9saWN5WWFtbCcsIHlhbWwpOwogICAgcG9saWN5QXVkaXQudGV4dENvbnRlbnQgPSAocG9saWN5QXVkaXQudGV4dENvbnRlbnQgfHwgJycpICsgYFxu4oCiICR7bmV3IERhdGUoKS50b0lTT1N0cmluZygpfSBsb2NhbCBERU1PIGVkaXRlZCBwb2xpY3lgOwogICAgZmxvb3JzT3V0LnRleHRDb250ZW50ID0gZXh0cmFjdEZsb29yc0Zyb21ZYW1sKHlhbWwpOwogICAgcmV0dXJuOwogIH0KICBjb25zdCBzaWcgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2lnS2V5JykudmFsdWUgfHwgJyc7CiAgY29uc3QgciA9IGF3YWl0IGZldGNoKCcvYXBpL3BvbGljeScsIHsgbWV0aG9kOidQT1NUJywgaGVhZGVyczp7J0NvbnRlbnQtVHlwZSc6J2FwcGxpY2F0aW9uL2pzb24nLCdYLVNpZ25hdHVyZSc6c2lnfSwgYm9keTogSlNPTi5zdHJpbmdpZnkoeyB5YW1sIH0pIH0pOwogIGFwaU91dC50ZXh0Q29udGVudCA9IGF3YWl0IHIudGV4dCgpOyBhd2FpdCBsb2FkUG9saWN5KCk7Cn0pOwoKLy8gUERGCmRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5QREYnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpID0+IHsKICBwZGZTdGF0dXMudGV4dENvbnRlbnQgPSAnR2VuZXJhdGluZy4uLic7CiAgaWYgKG1vY2tUb2dnbGUuY2hlY2tlZCl7CiAgICBjb25zdCBibG9iID0gbmV3IEJsb2IoW2BSQy9SQSBSZXBvcnRcblxuTGFzdCBSZXN1bHQ6XG4ke2pzb25PdXQudGV4dENvbnRlbnR9YF0sIHt0eXBlOidhcHBsaWNhdGlvbi9wZGYnfSk7CiAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOyBwZGZEb3dubG9hZC5ocmVmID0gdXJsOyBwZGZEb3dubG9hZC5jbGFzc0xpc3QucmVtb3ZlKCdoaWRkZW4nKTsgcGRmU3RhdHVzLnRleHRDb250ZW50PSdDbGllbnQtc2lkZSBQREYgcGxhY2Vob2xkZXIgcmVhZHkuJzsgcmV0dXJuOwogIH0KICBjb25zdCByID0gYXdhaXQgZmV0Y2goJy9hcGkvcGRmL2dlbmVyYXRlJywgeyBtZXRob2Q6J1BPU1QnLCBoZWFkZXJzOnsnQ29udGVudC1UeXBlJzonYXBwbGljYXRpb24vanNvbid9LCBib2R5OiBKU09OLnN0cmluZ2lmeSh7IHRpdGxlOidSQy9SQSBSZXBvcnQnLCBkYXRhOiBsYXN0UmVzdWx0fHx7fSB9KSB9KTsKICBpZiAoIXIub2speyBwZGZTdGF0dXMudGV4dENvbnRlbnQgPSAnU2VydmVyIFBERiBmYWlsZWQuJzsgcmV0dXJuOyB9CiAgY29uc3QgYmxvYiA9IGF3YWl0IHIuYmxvYigpOyBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOyBwZGZEb3dubG9hZC5ocmVmID0gdXJsOyBwZGZEb3dubG9hZC5jbGFzc0xpc3QucmVtb3ZlKCdoaWRkZW4nKTsgcGRmU3RhdHVzLnRleHRDb250ZW50PSdTZXJ2ZXIgUERGIHJlYWR5Lic7Cn0pOwpkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuSW52ZXN0b3JQREYnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGFzeW5jICgpID0+IHsKICBwZGZTdGF0dXMudGV4dENvbnRlbnQgPSAnR2VuZXJhdGluZyBJbnZlc3RvciBSdW50aHJvdWdoLi4uJzsKICBpZiAobW9ja1RvZ2dsZS5jaGVja2VkKXsKICAgIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbJ0ludmVzdG9yIFJ1bnRocm91Z2ggKG1vY2spJ10sIHt0eXBlOidhcHBsaWNhdGlvbi9wZGYnfSk7CiAgICBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOyBwZGZEb3dubG9hZC5ocmVmID0gdXJsOyBwZGZEb3dubG9hZC5jbGFzc0xpc3QucmVtb3ZlKCdoaWRkZW4nKTsgcGRmU3RhdHVzLnRleHRDb250ZW50PSdDbGllbnQtc2lkZSBwbGFjZWhvbGRlciBQREYgcmVhZHkuJzsgcmV0dXJuOwogIH0KICBjb25zdCByID0gYXdhaXQgZmV0Y2goJy9hcGkvcGRmL2ludmVzdG9yX3J1bnRocm91Z2gnLCB7IG1ldGhvZDonUE9TVCcgfSk7CiAgY29uc3QgYmxvYiA9IGF3YWl0IHIuYmxvYigpOyBjb25zdCB1cmwgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpOyBwZGZEb3dubG9hZC5ocmVmID0gdXJsOyBwZGZEb3dubG9hZC5jbGFzc0xpc3QucmVtb3ZlKCdoaWRkZW4nKTsgcGRmU3RhdHVzLnRleHRDb250ZW50PSdJbnZlc3RvciBQREYgcmVhZHkuJzsKfSk7CgovLyBBUEkgY29uc29sZQpkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCcjdGFiLWFwaSBbZGF0YS1jYWxsXScpLmZvckVhY2goYnRuID0+IHsKICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBhc3luYyAoKSA9PiB7CiAgICBjb25zdCBjYWxsID0gYnRuLmdldEF0dHJpYnV0ZSgnZGF0YS1jYWxsJyk7CiAgICBpZiAobW9ja1RvZ2dsZS5jaGVja2VkKXsgYXBpT3V0LnRleHRDb250ZW50ID0gJ01vY2sgbW9kZSDigJQgbm8gc2VydmVyIHJlcXVlc3RzIG1hZGUuJzsgcmV0dXJuOyB9CiAgICBpZiAoY2FsbCA9PT0gJ0dFVCAvYXBpL3BvbGljeScpeyBjb25zdCByID0gYXdhaXQgZmV0Y2goJy9hcGkvcG9saWN5Jyk7IGFwaU91dC50ZXh0Q29udGVudCA9IGF3YWl0IHIudGV4dCgpOyB9CiAgICBlbHNlIGlmIChjYWxsID09PSAnUE9TVCAvYXBpL3BvbGljeScpeyBjb25zdCBwYXlsb2FkID0geyB5YW1sOiBwb2xpY3lFZGl0b3IudmFsdWUgfTsgY29uc3QgciA9IGF3YWl0IGZldGNoKCcvYXBpL3BvbGljeScsIHttZXRob2Q6J1BPU1QnLCBoZWFkZXJzOnsnQ29udGVudC1UeXBlJzonYXBwbGljYXRpb24vanNvbicsJ1gtU2lnbmF0dXJlJzooZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NpZ0tleScpLnZhbHVlfHwnJyl9LCBib2R5OiBKU09OLnN0cmluZ2lmeShwYXlsb2FkKX0pOyBhcGlPdXQudGV4dENvbnRlbnQgPSBhd2FpdCByLnRleHQoKTsgfQogICAgZWxzZSBpZiAoY2FsbCA9PT0gJ1BPU1QgL2FwaS9kZXRlY3Rvci9ldmFsJyl7IGNvbnN0IHBheWxvYWQgPSB7IHRleHQ6IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdpbnB1dFRleHQnKS52YWx1ZSB8fCAnRGVtbyBldmFsJyB9OyBjb25zdCByID0gYXdhaXQgZmV0Y2goJy9hcGkvZGV0ZWN0b3IvZXZhbCcsIHttZXRob2Q6J1BPU1QnLCBoZWFkZXJzOnsnQ29udGVudC1UeXBlJzonYXBwbGljYXRpb24vanNvbid9LCBib2R5OiBKU09OLnN0cmluZ2lmeShwYXlsb2FkKX0pOyBhcGlPdXQudGV4dENvbnRlbnQgPSBhd2FpdCByLnRleHQoKTsgfQogICAgZWxzZSBpZiAoY2FsbCA9PT0gJ1BPU1QgL2FwaS9yb2Mvc3dlZXAnKXsgY29uc3QgciA9IGF3YWl0IGZldGNoKCcvYXBpL3JvYy9zd2VlcCcsIHttZXRob2Q6J1BPU1QnfSk7IGFwaU91dC50ZXh0Q29udGVudCA9IGF3YWl0IHIudGV4dCgpOyB9CiAgICBlbHNlIGlmIChjYWxsID09PSAnUE9TVCAvYXBpL3BkZi9pbnZlc3Rvcl9ydW50aHJvdWdoJyl7IGNvbnN0IHIgPSBhd2FpdCBmZXRjaCgnL2FwaS9wZGYvaW52ZXN0b3JfcnVudGhyb3VnaCcsIHttZXRob2Q6J1BPU1QnfSk7IGFwaU91dC50ZXh0Q29udGVudCA9IGF3YWl0IHIudGV4dCgpOyB9CiAgfSk7Cn0pOwoKKGFzeW5jICgpID0+IHsgYXdhaXQgbG9hZFBvbGljeSgpOyB9KSgpOwo8L3NjcmlwdD4KCjxzY3JpcHQ+CiAgLy8gUmVjZWl2ZXIgZm9yIHBhcmVudCBwYWdlIGJyaWRnZQogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgKGUpPT57CiAgICBpZiAoIWUgfHwgIWUuZGF0YSkgcmV0dXJuOwogICAgY29uc3QgZCA9IGUuZGF0YTsKICAgIGZ1bmN0aW9uIGFjayhhY3Rpb24peyB0cnkgeyBwYXJlbnQucG9zdE1lc3NhZ2UoeyB0eXBlOidjb2NrcGl0OmFjaycsIGFjdGlvbiB9LCAnKicpOyB9IGNhdGNoKF8pe30gfQogICAgaWYgKGQudHlwZSA9PT0gJ2NvY2twaXQ6cnVuJyl7CiAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5SdW4nKTsgaWYoYnRuKXsgYnRuLmNsaWNrKCk7IGFjaygncnVuJyk7IH0KICAgIH0gZWxzZSBpZiAoZC50eXBlID09PSAnY29ja3BpdDpwb2xpY3k6c2F2ZScpewogICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuUG9saWN5U2F2ZScpOyBpZihidG4peyBidG4uY2xpY2soKTsgYWNrKCdwb2xpY3k6c2F2ZScpOyB9CiAgICB9IGVsc2UgaWYgKGQudHlwZSA9PT0gJ2NvY2twaXQ6cGRmJyl7CiAgICAgIGNvbnN0IGJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5QREYnKTsgaWYoYnRuKXsgYnRuLmNsaWNrKCk7IGFjaygncGRmJyk7IH0KICAgIH0KICB9KTsKPC9zY3JpcHQ+CgoKPHNjcmlwdD4KICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIChlKT0+ewogICAgaWYgKCFlIHx8ICFlLmRhdGEpIHJldHVybjsKICAgIGNvbnN0IGQgPSBlLmRhdGE7CiAgICBpZiAoZC50eXBlID09PSAnYW5jaG9yOnN0YXRlJyl7CiAgICAgIGlmKGQudHJhY2VzKXsgd2luZG93LmNvY2twaXRUcmFjZXMgPSBkLnRyYWNlczsgY29uc29sZS5sb2coJ0xvYWRlZCBhbmNob3IgdHJhY2VzJywgZC50cmFjZXMubGVuZ3RoKTsgfQogICAgICBpZihkLnBvbGljeSl7IHdpbmRvdy5jb2NrcGl0UG9saWN5ID0gZC5wb2xpY3k7IGNvbnNvbGUubG9nKCdMb2FkZWQgYW5jaG9yIHBvbGljeScpOyB9CiAgICAgIC8vIFRyaWdnZXIgVUkgcmVmcmVzaCBpZiBuZWVkZWQKICAgICAgaWYodHlwZW9mIHVwZGF0ZURhc2hQbHVzPT09J2Z1bmN0aW9uJykgdXBkYXRlRGFzaFBsdXMoKTsKICAgIH0KICB9KTsKCiAgZnVuY3Rpb24gZW1pdE1ldHJpY1VwZGF0ZSh2LGxwZCxzaWdtYSxyZWZ1bmRSYXRlKXsKICAgIHRyeSB7IHBhcmVudC5wb3N0TWVzc2FnZSh7dHlwZTonY29ja3BpdDptZXRyaWM6dXBkYXRlJywgdiwgbHBkLCBzaWdtYSwgcmVmdW5kUmF0ZX0sICcqJyk7IH0gY2F0Y2goXykge30KICB9CiAgZnVuY3Rpb24gZW1pdFBvbGljeVVwZGF0ZSh5YW1sKXsKICAgIHRyeSB7IHBhcmVudC5wb3N0TWVzc2FnZSh7dHlwZTonY29ja3BpdDpwb2xpY3k6dXBkYXRlJywgeWFtbH0sICcqJyk7IH0gY2F0Y2goXykge30KICB9CgogIC8vIEV4YW1wbGUgaG9va3M6IGNhbGwgZW1pdE1ldHJpY1VwZGF0ZSB3aGVuIGRhc2hib2FyZCB1cGRhdGVzCiAgaWYodHlwZW9mIHVwZGF0ZURhc2hQbHVzPT09J2Z1bmN0aW9uJyl7CiAgICBjb25zdCBfb2xkVXBkYXRlID0gdXBkYXRlRGFzaFBsdXM7CiAgICB1cGRhdGVEYXNoUGx1cyA9IGZ1bmN0aW9uKCl7CiAgICAgIF9vbGRVcGRhdGUoKTsKICAgICAgY29uc3QgdiA9IHdpbmRvdy50cmFjZXM/LnJlZHVjZSgoYSxiKT0+YStiLnYsMCkvKHdpbmRvdy50cmFjZXM/Lmxlbmd0aHx8MSk7CiAgICAgIGNvbnN0IGxwZCA9IHdpbmRvdy50cmFjZXM/LnJlZHVjZSgoYSxiKT0+YStiLmxwZCwwKS8od2luZG93LnRyYWNlcz8ubGVuZ3RofHwxKTsKICAgICAgY29uc3Qgc2lnbWEgPSB3aW5kb3cudHJhY2VzPy5yZWR1Y2UoKGEsYik9PmErYi5zaWdtYSwwKS8od2luZG93LnRyYWNlcz8ubGVuZ3RofHwxKTsKICAgICAgY29uc3QgcmVmdW5kUmF0ZSA9ICh3aW5kb3cudHJhY2VzPy5maWx0ZXIodD0+dC5yZWZ1bmQpLmxlbmd0aCB8fCAwKS8od2luZG93LnRyYWNlcz8ubGVuZ3RofHwxKTsKICAgICAgZW1pdE1ldHJpY1VwZGF0ZSh2LGxwZCxzaWdtYSxyZWZ1bmRSYXRlKTsKICAgIH07CiAgfQoKICAvLyBFeGFtcGxlIGhvb2s6IGNhbGwgZW1pdFBvbGljeVVwZGF0ZSB3aGVuIFBVVCAvcG9saWN5IGlzIGFwcGxpZWQKICBpZih0eXBlb2YgYXBwbHlQb2xpY3k9PT0nZnVuY3Rpb24nKXsKICAgIGNvbnN0IF9vbGRBcHBseSA9IGFwcGx5UG9saWN5OwogICAgYXBwbHlQb2xpY3kgPSBhc3luYyBmdW5jdGlvbigpewogICAgICBhd2FpdCBfb2xkQXBwbHkoKTsKICAgICAgY29uc3QgdHh0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BvbGljeUVkaXRvcicpPy52YWx1ZSB8fCAnJzsKICAgICAgZW1pdFBvbGljeVVwZGF0ZSh0eHQpOwogICAgfTsKICB9Cjwvc2NyaXB0PgoKCjxzY3JpcHQ+CiAgLy8gLS0tIENvY2twaXQgU0RLOiBzdGF0ZSBzeW5jICsgdGVsZW1ldHJ5IGVtaXQgLS0tCiAgKGZ1bmN0aW9uKCl7CiAgICBmdW5jdGlvbiBlbWl0KHR5cGUsIHBheWxvYWQpeyB0cnl7IHBhcmVudC5wb3N0TWVzc2FnZSh7IHR5cGUsIC4uLnBheWxvYWQgfSwgJyonKTsgfWNhdGNoKF8pe30gfQoKICAgIGFzeW5jIGZ1bmN0aW9uIGxvYWRUcmFjZXNBcnJheShhcnIpewogICAgICB0cnkgewogICAgICAgIC8vIFByZWZlcnJlZDogc2V0IHdpbmRvdy50cmFjZXMgYW5kIHRyaWdnZXIgcmUtcmVuZGVyIGhvb2tzIGlmIHByZXNlbnQKICAgICAgICB3aW5kb3cudHJhY2VzID0gQXJyYXkuaXNBcnJheShhcnIpID8gYXJyIDogW107CiAgICAgICAgY29uc3QgZXZ0ID0gbmV3IEV2ZW50KCd0cmFjZXM6dXBkYXRlZCcpOyB3aW5kb3cuZGlzcGF0Y2hFdmVudChldnQpOwogICAgICAgIC8vIElmIHRoZXJlJ3MgYSByZW5kZXJUYWJsZSBmdW5jdGlvbiAoYXMgaW4gcHJldmlvdXMgYnVpbGRzKSwgY2FsbCBpdAogICAgICAgIGlmICh0eXBlb2YgcmVuZGVyVGFibGUgPT09ICdmdW5jdGlvbicpIHJlbmRlclRhYmxlKCk7CiAgICAgICAgaWYgKHR5cGVvZiByZW5kZXJTcGFya2xpbmUgPT09ICdmdW5jdGlvbicpIHJlbmRlclNwYXJrbGluZSgpOwogICAgICAgIGlmICh0eXBlb2YgcmVuZGVySGlzdG9ncmFtID09PSAnZnVuY3Rpb24nKSByZW5kZXJIaXN0b2dyYW0oKTsKICAgICAgICBlbWl0KCd0ZWxlbWV0cnknLCB7IGV2ZW50OiAndHJhY2VzX2xvYWRlZCcsIGRhdGE6IHsgbjogd2luZG93LnRyYWNlcy5sZW5ndGggfSB9KTsKICAgICAgICAvLyBBbHNvIGVtaXQgbWV0cmljcyBzbmFwc2hvdAogICAgICAgIHRyeSB7CiAgICAgICAgICBjb25zdCBscGRBcnIgPSB3aW5kb3cudHJhY2VzLm1hcCh0PT50LmxwZCkuZmlsdGVyKHg9PnR5cGVvZiB4PT09J251bWJlcicpOwogICAgICAgICAgY29uc3QgdkFyciA9IHdpbmRvdy50cmFjZXMubWFwKHQ9PnQudikuZmlsdGVyKHg9PnR5cGVvZiB4PT09J251bWJlcicpOwogICAgICAgICAgY29uc3QgcmVmdW5kUmF0ZSA9IHdpbmRvdy50cmFjZXMuZmlsdGVyKHQ9PnQucmVmdW5kKS5sZW5ndGggLyBNYXRoLm1heCgxLCB3aW5kb3cudHJhY2VzLmxlbmd0aCk7CiAgICAgICAgICBjb25zdCBtZXRyaWNzID0geyBhdmdfbHBkOiBscGRBcnIucmVkdWNlKChhLGIpPT5hK2IsMCkvTWF0aC5tYXgoMSxscGRBcnIubGVuZ3RoKSwgYXZnX3Y6IHZBcnIucmVkdWNlKChhLGIpPT5hK2IsMCkvTWF0aC5tYXgoMSx2QXJyLmxlbmd0aCksIHJlZnVuZF9yYXRlOiByZWZ1bmRSYXRlIH07CiAgICAgICAgICBlbWl0KCd0ZWxlbWV0cnknLCB7IGV2ZW50OiAnbWV0cmljcycsIGRhdGE6IG1ldHJpY3MgfSk7CiAgICAgICAgICBlbWl0KCdjb2NrcGl0Om1ldHJpY3MnLCB7IG1ldHJpY3MgfSk7CiAgICAgICAgfSBjYXRjaChfKXt9CiAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICBjb25zb2xlLndhcm4oJ0ZhaWxlZCB0byBsb2FkIHRyYWNlcyBhcnJheScsIGUpOwogICAgICB9CiAgICB9CgogICAgZnVuY3Rpb24gc2V0UG9saWN5KHRleHQpewogICAgICBjb25zdCBlZGl0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncG9saWN5RWRpdG9yJyk7CiAgICAgIGlmIChlZGl0b3IpIHsKICAgICAgICBlZGl0b3IudmFsdWUgPSB0ZXh0IHx8ICcnOwogICAgICAgIC8vIElmIHByZXZpZXdEaWZmIGlzIGF2YWlsYWJsZSwgcmVmcmVzaAogICAgICAgIHRyeSB7IGlmICh0eXBlb2YgcHJldmlld0RpZmYgPT09ICdmdW5jdGlvbicpIHByZXZpZXdEaWZmKCk7IH0gY2F0Y2goXyl7fQogICAgICAgIGVtaXQoJ3RlbGVtZXRyeScsIHsgZXZlbnQ6ICdwb2xpY3lfbG9hZGVkJywgZGF0YTogeyBieXRlczogKHRleHR8fCcnKS5sZW5ndGggfSB9KTsKICAgICAgfSBlbHNlIHsKICAgICAgICAvLyBzdG9yZSBmb3IgbGF0ZXIKICAgICAgICB3aW5kb3cuX3BlbmRpbmdQb2xpY3kgPSB0ZXh0IHx8ICcnOwogICAgICB9CiAgICB9CgogICAgLy8gUGF0Y2ggYXBwbHlQb2xpY3kgKGlmIGV4aXN0cykgdG8gZW1pdCB1cGRhdGVzCiAgICBjb25zdCB0cnlQYXRjaFBvbGljeUFwcGx5ID0gKCkgPT4gewogICAgICBjb25zdCBidG5BcHBseSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5BcHBseVBvbGljeScpIHx8IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5QdXRQb2xpY3knKTsKICAgICAgaWYgKGJ0bkFwcGx5ICYmICFidG5BcHBseS5kYXRhc2V0Ll9wYXRjaGVkKSB7CiAgICAgICAgYnRuQXBwbHkuZGF0YXNldC5fcGF0Y2hlZCA9ICcxJzsKICAgICAgICBidG5BcHBseS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsICgpID0+IHsKICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnN0IGVkaXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwb2xpY3lFZGl0b3InKTsKICAgICAgICAgICAgY29uc3QgcG9saWN5ID0gZWRpdG9yID8gZWRpdG9yLnZhbHVlIDogJyc7CiAgICAgICAgICAgIGVtaXQoJ3RlbGVtZXRyeScsIHsgZXZlbnQ6ICdwb2xpY3lfYXBwbGllZCcsIGRhdGE6IHsgYnl0ZXM6IHBvbGljeS5sZW5ndGggfSB9KTsKICAgICAgICAgICAgZW1pdCgnY29ja3BpdDpwb2xpY3k6dXBkYXRlZCcsIHsgcG9saWN5IH0pOwogICAgICAgICAgfSBjYXRjaChfKXt9CiAgICAgICAgfSk7CiAgICAgIH0KICAgIH07CiAgICBkb2N1bWVudC5hZGRFdmVudExpc3RlbmVyKCdET01Db250ZW50TG9hZGVkJywgdHJ5UGF0Y2hQb2xpY3lBcHBseSk7CiAgICBzZXRUaW1lb3V0KHRyeVBhdGNoUG9saWN5QXBwbHksIDgwMCk7CgogICAgLy8gTGlzdGVuIGZvciBzdGF0ZSBzeW5jCiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIChlKT0+ewogICAgICBjb25zdCBkID0gZT8uZGF0YTsgaWYgKCFkKSByZXR1cm47CiAgICAgIGlmIChkLnR5cGUgPT09ICdzdGF0ZTpzeW5jJykgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KGQudHJhY2VzKSkgbG9hZFRyYWNlc0FycmF5KGQudHJhY2VzKTsKICAgICAgICBpZiAodHlwZW9mIGQucG9saWN5ID09PSAnc3RyaW5nJykgc2V0UG9saWN5KGQucG9saWN5KTsKICAgICAgfQogICAgfSk7CgogICAgLy8gRXhwb3NlIGJyaWRnZSBmb3IgcGFyZW50IGlmIG5lZWRlZAogICAgd2luZG93LkNvY2twaXRCcmlkZ2UgPSB7IGxvYWRUcmFjZXNBcnJheSwgc2V0UG9saWN5IH07CiAgfSkoKTsKPC9zY3JpcHQ+CgoKPHNjcmlwdD4KKGZ1bmN0aW9uKCl7CiAgbGV0IG9yaWdpbmFsUG9saWN5U25hcHNob3QgPSAnJzsKCiAgZnVuY3Rpb24gc2F2ZU9yaWdpbmFsUG9saWN5KCkgewogICAgY29uc3QgZWRpdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BvbGljeUVkaXRvcicpOwogICAgb3JpZ2luYWxQb2xpY3lTbmFwc2hvdCA9IGVkaXRvciA/IGVkaXRvci52YWx1ZSA6ICcnOwogIH0KCiAgZnVuY3Rpb24gcmVzZXRUYXUoKSB7CiAgICBjb25zdCBlZGl0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncG9saWN5RWRpdG9yJyk7CiAgICBpZiAoZWRpdG9yICYmIG9yaWdpbmFsUG9saWN5U25hcHNob3QpIHsKICAgICAgZWRpdG9yLnZhbHVlID0gb3JpZ2luYWxQb2xpY3lTbmFwc2hvdDsKICAgICAgaWYgKHR5cGVvZiBwcmV2aWV3RGlmZiA9PT0gJ2Z1bmN0aW9uJykgcHJldmlld0RpZmYoKTsKICAgICAgdHJ5IHsgcGFyZW50LnBvc3RNZXNzYWdlKHsgdHlwZTogJ2NvY2twaXQ6cG9saWN5OnJlc2V0JywgcG9saWN5OiBvcmlnaW5hbFBvbGljeVNuYXBzaG90IH0sICcqJyk7IH0gY2F0Y2goXyl7fQogICAgfQogIH0KCiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsICgpID0+IHsKICAgIHNhdmVPcmlnaW5hbFBvbGljeSgpOwogICAgY29uc3QgYnRuUmVzZXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuUmVzZXRUYXUnKTsKICAgIGlmIChidG5SZXNldCkgYnRuUmVzZXQuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCByZXNldFRhdSk7CiAgfSk7CgogIC8vIFBhdGNoIGFwcGx5UG9saWN5IHRvIGFsc28gbm90aWZ5IHBhcmVudCBvZiB1cGRhdGVkIHBvbGljeQogIGNvbnN0IGJ0bkFwcGx5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bkFwcGx5UG9saWN5JykgfHwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0blB1dFBvbGljeScpOwogIGlmIChidG5BcHBseSAmJiAhYnRuQXBwbHkuZGF0YXNldC5fcGF0Y2hlZF9iYWNrc3luYykgewogICAgYnRuQXBwbHkuZGF0YXNldC5fcGF0Y2hlZF9iYWNrc3luYyA9ICcxJzsKICAgIGJ0bkFwcGx5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKCkgPT4gewogICAgICB0cnkgewogICAgICAgIGNvbnN0IGVkaXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwb2xpY3lFZGl0b3InKTsKICAgICAgICBjb25zdCBwb2xpY3kgPSBlZGl0b3IgPyBlZGl0b3IudmFsdWUgOiAnJzsKICAgICAgICBwYXJlbnQucG9zdE1lc3NhZ2UoeyB0eXBlOiAnY29ja3BpdDpwb2xpY3k6dXBkYXRlZCcsIHBvbGljeSB9LCAnKicpOwogICAgICB9IGNhdGNoKF8pe30KICAgIH0pOwogIH0KCiAgLy8gV2hlbiB0cmFjZXMgdXBkYXRlIGluc2lkZSBjb2NrcGl0LCBwdXNoIHRvIHBhcmVudCBhcyB3ZWxsCiAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3RyYWNlczp1cGRhdGVkJywgKCkgPT4gewogICAgdHJ5IHsKICAgICAgcGFyZW50LnBvc3RNZXNzYWdlKHsgdHlwZTogJ2NvY2twaXQ6dHJhY2VzOnVwZGF0ZWQnLCB0cmFjZXM6IHdpbmRvdy50cmFjZXMgfHwgW10gfSwgJyonKTsKICAgIH0gY2F0Y2goXyl7fQogIH0pOwp9KSgpOwo8L3NjcmlwdD4KCgo8c2NyaXB0PgogIChmdW5jdGlvbigpewogICAgZnVuY3Rpb24gZW1pdCh0eXBlLCBwYXlsb2FkKXsgdHJ5eyBwYXJlbnQucG9zdE1lc3NhZ2UoeyB0eXBlLCAuLi5wYXlsb2FkIH0sICcqJyk7IH1jYXRjaChfKXt9IH0KCiAgICAvLyBDYXB0dXJlIG9yaWdpbmFsIGZsb29ycyBmcm9tIGZpcnN0LWxvYWRlZCBwb2xpY3kKICAgIGxldCBvcmlnaW5hbFBvbGljeVRleHQgPSBudWxsOwoKICAgIGZ1bmN0aW9uIHBhcnNlRmxvb3JzKHRleHQpewogICAgICBjb25zdCBtdiA9ICh0ZXh0fHwnJykubWF0Y2goL3ZfbWluOlxzKihbMC05Ll0rKS8pOwogICAgICBjb25zdCBtbCA9ICh0ZXh0fHwnJykubWF0Y2goL2xwZF9taW46XHMqKFswLTkuXSspLyk7CiAgICAgIHJldHVybiB7IHZfbWluOiBtdiA/IHBhcnNlRmxvYXQobXZbMV0pIDogbnVsbCwgbHBkX21pbjogbWwgPyBwYXJzZUZsb2F0KG1sWzFdKSA6IG51bGwgfTsKICAgIH0KCiAgICBmdW5jdGlvbiBzZXRQb2xpY3kodGV4dCl7CiAgICAgIGNvbnN0IGVkaXRvciA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwb2xpY3lFZGl0b3InKTsKICAgICAgaWYgKGVkaXRvcikgewogICAgICAgIGVkaXRvci52YWx1ZSA9IHRleHQgfHwgJyc7CiAgICAgICAgdHJ5IHsgaWYgKHR5cGVvZiBwcmV2aWV3RGlmZiA9PT0gJ2Z1bmN0aW9uJykgcHJldmlld0RpZmYoKTsgfSBjYXRjaChfKXt9CiAgICAgICAgaWYgKCFvcmlnaW5hbFBvbGljeVRleHQpIG9yaWdpbmFsUG9saWN5VGV4dCA9IHRleHQgfHwgJyc7CiAgICAgIH0gZWxzZSB7CiAgICAgICAgd2luZG93Ll9wZW5kaW5nUG9saWN5ID0gdGV4dCB8fCAnJzsKICAgICAgICBpZiAoIW9yaWdpbmFsUG9saWN5VGV4dCkgb3JpZ2luYWxQb2xpY3lUZXh0ID0gdGV4dCB8fCAnJzsKICAgICAgfQogICAgfQoKICAgIC8vIEJhY2stc3luYyBzdGF0ZSB0byBwYXJlbnQKICAgIGZ1bmN0aW9uIHB1c2hTdGF0ZSgpewogICAgICBjb25zdCBlZGl0b3IgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncG9saWN5RWRpdG9yJyk7CiAgICAgIGNvbnN0IHBvbGljeSA9IGVkaXRvciA/IGVkaXRvci52YWx1ZSA6ICh3aW5kb3cuX3BlbmRpbmdQb2xpY3kgfHwgJycpOwogICAgICBjb25zdCB0cmFjZXMgPSBBcnJheS5pc0FycmF5KHdpbmRvdy50cmFjZXMpID8gd2luZG93LnRyYWNlcyA6IFtdOwogICAgICBlbWl0KCdzdGF0ZTp1cGRhdGUnLCB7IHBvbGljeSwgdHJhY2VzIH0pOwogICAgfQoKICAgIC8vIFJlc2V0IM+EIHRvIG9yaWdpbmFsIGZsb29ycwogICAgZnVuY3Rpb24gcmVzZXRUYXUoKXsKICAgICAgaWYgKCFvcmlnaW5hbFBvbGljeVRleHQpIHJldHVybjsKICAgICAgY29uc3QgZWRpdG9yID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3BvbGljeUVkaXRvcicpOwogICAgICBpZiAoIWVkaXRvcikgcmV0dXJuOwogICAgICAvLyBSZXBsYWNlIHZfbWluIGFuZCBscGRfbWluIHdpdGggb3JpZ2luYWwgdmFsdWVzCiAgICAgIGNvbnN0IG9yaWcgPSBwYXJzZUZsb29ycyhvcmlnaW5hbFBvbGljeVRleHQpOwogICAgICBsZXQgY3VyID0gZWRpdG9yLnZhbHVlIHx8ICcnOwogICAgICBpZiAob3JpZy52X21pbiAhPT0gbnVsbCkgY3VyID0gY3VyLnJlcGxhY2UoL3ZfbWluOlxzKlswLTkuXSsvLCAndl9taW46ICcgKyBvcmlnLnZfbWluLnRvRml4ZWQoMykpOwogICAgICBpZiAob3JpZy5scGRfbWluICE9PSBudWxsKSBjdXIgPSBjdXIucmVwbGFjZSgvbHBkX21pbjpccypbMC05Ll0rLywgJ2xwZF9taW46ICcgKyBvcmlnLmxwZF9taW4udG9GaXhlZCgyKSk7CiAgICAgIGVkaXRvci52YWx1ZSA9IGN1cjsKICAgICAgdHJ5IHsgaWYgKHR5cGVvZiBwcmV2aWV3RGlmZiA9PT0gJ2Z1bmN0aW9uJykgcHJldmlld0RpZmYoKTsgfSBjYXRjaChfKXt9CiAgICAgIC8vIFJlLXJlbmRlciB2aXN1YWxzIGlmIHByZXNlbnQKICAgICAgdHJ5IHsgaWYgKHR5cGVvZiByZW5kZXJTcGFya2xpbmUgPT09ICdmdW5jdGlvbicpIHJlbmRlclNwYXJrbGluZSgpOyBpZiAodHlwZW9mIHJlbmRlckhpc3RvZ3JhbSA9PT0gJ2Z1bmN0aW9uJykgcmVuZGVySGlzdG9ncmFtKCk7IH0gY2F0Y2goXyl7fQogICAgICBlbWl0KCd0ZWxlbWV0cnknLCB7IGV2ZW50OiAndGF1X3Jlc2V0JywgZGF0YTogeyBvcmlnOiBvcmlnIH0gfSk7CiAgICAgIHB1c2hTdGF0ZSgpOwogICAgfQoKICAgIC8vIFBhdGNoIEFwcGx5IFBvbGljeSB0byBwdXNoIHN0YXRlCiAgICBjb25zdCBwYXRjaEFwcGx5ID0gKCkgPT4gewogICAgICBjb25zdCBidG4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuQXBwbHlQb2xpY3knKSB8fCBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuUHV0UG9saWN5Jyk7CiAgICAgIGlmIChidG4gJiYgIWJ0bi5kYXRhc2V0Ll9wYXRjaGVkMikgewogICAgICAgIGJ0bi5kYXRhc2V0Ll9wYXRjaGVkMiA9ICcxJzsKICAgICAgICBidG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+IHsKICAgICAgICAgIC8vIHNsaWdodCBkZWxheSB0byBhbGxvdyBlZGl0b3IgY2hhbmdlCiAgICAgICAgICBzZXRUaW1lb3V0KHB1c2hTdGF0ZSwgMzAwKTsKICAgICAgICB9KTsKICAgICAgfQogICAgICBjb25zdCBidG5SdW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYnRuUnVuJyk7CiAgICAgIGlmIChidG5SdW4gJiYgIWJ0blJ1bi5kYXRhc2V0Ll9wYXRjaGVkMikgewogICAgICAgIGJ0blJ1bi5kYXRhc2V0Ll9wYXRjaGVkMiA9ICcxJzsKICAgICAgICBidG5SdW4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoKT0+IHsKICAgICAgICAgIC8vIHB1c2ggbWV0cmljcyBzb29uIGFmdGVyIHJ1biAoaWYgYW55KQogICAgICAgICAgc2V0VGltZW91dCgoKT0+IGVtaXQoJ3RlbGVtZXRyeScsIHsgZXZlbnQ6ICdydW5faW52b2tlZCcgfSksIDUwKTsKICAgICAgICB9KTsKICAgICAgfQogICAgfTsKICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBwYXRjaEFwcGx5KTsKICAgIHNldFRpbWVvdXQocGF0Y2hBcHBseSwgODAwKTsKCiAgICAvLyBMaXN0ZW4gZm9yIHBhcmVudCBtZXNzYWdlcwogICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ21lc3NhZ2UnLCAoZSk9PnsKICAgICAgY29uc3QgZCA9IGU/LmRhdGE7IGlmICghZCkgcmV0dXJuOwogICAgICBpZiAoZC50eXBlID09PSAnY29ja3BpdDpyZXNldF90YXUnKSB7CiAgICAgICAgcmVzZXRUYXUoKTsKICAgICAgfSBlbHNlIGlmIChkLnR5cGUgPT09ICdlbnY6dXBkYXRlJykgewogICAgICAgIC8vIE9wdGlvbmFsbHkgYXBwbHkgZW52IHRvIEFQSSBiYXNlIFVSTCBpbnB1dCBpZiBwcmVzZW50CiAgICAgICAgY29uc3QgYmFzZSA9IGQuYXBpQmFzZTsKICAgICAgICBjb25zdCBpbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdiYXNlVXJsJykgfHwgZG9jdW1lbnQucXVlcnlTZWxlY3RvcignaW5wdXQjYmFzZVVybCcpOwogICAgICAgIGlmIChpbnB1dCAmJiB0eXBlb2YgYmFzZSA9PT0gJ3N0cmluZycpIGlucHV0LnZhbHVlID0gYmFzZTsKICAgICAgICBlbWl0KCd0ZWxlbWV0cnknLCB7IGV2ZW50OiAnZW52X3VwZGF0ZScsIGRhdGE6IHsgYXBpQmFzZTogYmFzZXx8bnVsbCB9IH0pOwogICAgICB9IGVsc2UgaWYgKGQudHlwZSA9PT0gJ3N0YXRlOnN5bmMnKSB7CiAgICAgICAgaWYgKHR5cGVvZiBkLnBvbGljeSA9PT0gJ3N0cmluZycpIHNldFBvbGljeShkLnBvbGljeSk7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZC50cmFjZXMpKSB7IHdpbmRvdy50cmFjZXMgPSBkLnRyYWNlczsgdHJ5IHsgaWYgKHR5cGVvZiByZW5kZXJUYWJsZT09PSdmdW5jdGlvbicpIHJlbmRlclRhYmxlKCk7IGlmICh0eXBlb2YgcmVuZGVyU3BhcmtsaW5lPT09J2Z1bmN0aW9uJykgcmVuZGVyU3BhcmtsaW5lKCk7IGlmICh0eXBlb2YgcmVuZGVySGlzdG9ncmFtPT09J2Z1bmN0aW9uJykgcmVuZGVySGlzdG9ncmFtKCk7IH0gY2F0Y2goXyl7fSB9CiAgICAgIH0KICAgIH0pOwoKICAgIC8vIEV4cG9zZSBmb3IgcGFyZW50CiAgICB3aW5kb3cuQ29ja3BpdEJyaWRnZTIgPSB7IHJlc2V0VGF1LCBwdXNoU3RhdGUsIHNldFBvbGljeSB9OwogIH0pKCk7Cjwvc2NyaXB0PgoKCjxzY3JpcHQ+Ci8vIENvY2twaXREb2NQb3BvdmVyczogbGlnaHR3ZWlnaHQgcG9wb3ZlcnMgKyByb3V0ZSB0byBwYXJlbnQgZHJhd2VyCihmdW5jdGlvbigpewogIC8vIFNtYWxsIHRvb2x0aXAKICBsZXQgdGlwOwogIGZ1bmN0aW9uIGVuc3VyZVRpcCgpewogICAgaWYgKHRpcCkgcmV0dXJuOwogICAgdGlwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICB0aXAuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnOwogICAgdGlwLnN0eWxlLm1heFdpZHRoID0gJzM2MHB4JzsKICAgIHRpcC5zdHlsZS5iYWNrZ3JvdW5kID0gJ3ZhcigtLWNhcmQsICMxMTEpJzsKICAgIHRpcC5zdHlsZS5ib3JkZXIgPSAnMXB4IHNvbGlkIHZhcigtLWJvcmRlciwgIzMzMyknOwogICAgdGlwLnN0eWxlLmJvcmRlclJhZGl1cyA9ICcxMHB4JzsKICAgIHRpcC5zdHlsZS5wYWRkaW5nID0gJzEwcHggMTJweCc7CiAgICB0aXAuc3R5bGUuYm94U2hhZG93ID0gJzAgOHB4IDI0cHggcmdiYSgwLDAsMCwuMjQpJzsKICAgIHRpcC5zdHlsZS56SW5kZXggPSAxMDAwMDsKICAgIHRpcC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnOwogICAgdGlwLnN0eWxlLmNvbG9yID0gJ3ZhcigtLXRleHQsICNlYWVhZWEpJzsKICAgIHRpcC5pbm5lckhUTUwgPSAnPGRpdiBjbGFzcz0idGlueSIgaWQ9ImNkcEJvZHkiPjwvZGl2PjxkaXYgc3R5bGU9Im1hcmdpbi10b3A6OHB4Ij48YSBocmVmPSIjIiBjbGFzcz0iYnRuIHRpbnkiIGlkPSJjZHBNb3JlIj5SZWFkIG1vcmUg4oaSPC9hPjwvZGl2Pic7CiAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRpcCk7CiAgfQogIGNvbnN0IFBSSU1FUlMgPSB7CiAgICAnZWNvbm9taWNzI2xwZCc6IHt0OidMUEQg4oCUIExvZ2ljLXBlci1Eb2xsYXInLCBiOidXaGF0OiBzY2FsYXIgb2YgZXBpc3RlbWljIHZhbHVlIHBlciB1bml0IGNvc3QuIFdoeTogZW5zdXJlcyBwYXltZW50IG9ubHkgZm9yIHVzZWZ1bCByZWFzb25pbmcuIEhvdzogVmFsdWVTY29yZSAoY29zaW5lIHRvIHXimIUpIMO3IGNvc3Q7IGFkanVzdGVkIGJ5IExHRC4nfSwKICAgICdlY29ub21pY3MjbGdkJzoge3Q6J0xHRCDigJQgTGVhcm5pbmcgR2FpbiBwZXIgRG9sbGFyJywgYjonV2hhdDogbGVhcm5pbmcgaW1wcm92ZW1lbnQgcGVyIGNvc3QuIFdoeTogcHJvdGVjdHMgUk9JIGV2ZW4gd2hlbiB2IGlzIHN0YWJsZS4gSG93OiDiiIZjb21wZXRlbmN5IMO3IGNvc3QsIGZvbGRlZCBpbnRvIExQRCBhcyBtdWx0aXBsaWVyL2Zsb29yLid9LAogICAgJ2Vjb25vbWljcyN2JzogICB7dDondiDigJQgVmFsdWVTY29yZScsIGI6J1doYXQ6IHNlbWFudGljIGZpZGVsaXR5IHRvIHXimIUuIFdoeTogYW5jaG9ycyBjb3JyZWN0bmVzcyB0byBTTUUgdHJ1dGguIEhvdzogY29zaW5lKHUsIHXimIUpIG1pbnVzIGJhc2VsaW5lLCBwZW5hbGl6ZWQgYnkgcmlza3MuJ30sCiAgICAnZWNvbm9taWNzI3NpZ21hJzoge3Q6J8+DIOKAlCBWYXJpYW5jZScsIGI6J1doYXQ6IHN0YWJpbGl0eSBvZiBvdXRjb21lcy4gV2h5OiBndWFyZHMgYWdhaW5zdCBmbGFreSByZWFzb25pbmcuIEhvdzogcm9sbGluZyBzdGRkZXYgYWNyb3NzIHJ1bnM7IGVuZm9yY2VkIHdpdGggz4NfbWF4IGZsb29yLid9LAogICAgJ2dvdmVybmFuY2UjdGF1Jzoge3Q6J8+EIOKAlCBGbG9vcnMgKFNMUkMpJywgYjonV2hhdDogbWluaW11bSBhY2NlcHRhYmxlIHRocmVzaG9sZHMuIFdoeTogZGV0ZXJtaW5pc3RpYyByZWZ1bmRzIGFuZCBzYWZldHkuIEhvdzogWUFNTCBmbG9vcnMgKHZfbWluLCBscGRfbWluLCDPg19tYXgsIGRfbWluKSB0dW5lZCB2aWEgUk9DLid9LAogICAgJ3BlZGFnb2d5I21pcy10YXJnZXRlZC1kaWZmaWN1bHR5Jzoge3Q6J1BlZGFnb2d5OiBtaXMtdGFyZ2V0ZWQtZGlmZmljdWx0eScsIGI6J0V4YW1wbGU6IGNvbnRlbnQgdG9vIGhhcmQvZWFzeSBmb3IgWlBEIOKGkiB2YWx1ZSBjb2xsYXBzZS4gTWl0aWdhdGlvbjogYWRqdXN0IHNjYWZmb2xkaW5nOyBwZW5hbGl6ZWQgaW4gdi4nfQogIH07CiAgZnVuY3Rpb24gc2hvd1RpcCh0YXJnZXQsIGtleSl7CiAgICBlbnN1cmVUaXAoKTsKICAgIGNvbnN0IGRhdGEgPSBQUklNRVJTW2tleV07IGlmICghZGF0YSkgcmV0dXJuOwogICAgY29uc3QgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjZHBCb2R5Jyk7CiAgICBjb25zdCBtb3JlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NkcE1vcmUnKTsKICAgIGJvZHkuaW5uZXJIVE1MID0gJzxzdHJvbmc+JytkYXRhLnQrJzwvc3Ryb25nPjxicj4nK2RhdGEuYjsKICAgIGNvbnN0IHJlY3QgPSB0YXJnZXQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7CiAgICB0aXAuc3R5bGUubGVmdCA9IE1hdGgubWluKHJlY3QubGVmdCwgd2luZG93LmlubmVyV2lkdGggLSAzODApICsgJ3B4JzsKICAgIHRpcC5zdHlsZS50b3AgPSAocmVjdC5ib3R0b20gKyA2KSArICdweCc7CiAgICB0aXAuc3R5bGUuZGlzcGxheSA9ICdibG9jayc7CiAgICBtb3JlLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICB0cnkgeyBwYXJlbnQucG9zdE1lc3NhZ2UoeyB0eXBlOidkb2NzOm9wZW4nLCBhbmNob3I6JyMnKyhrZXkuc3BsaXQoJyMnKVsxXXx8J292ZXJ2aWV3JykgfSwgJyonKTsgfSBjYXRjaChfKSB7fQogICAgICB0aXAuc3R5bGUuZGlzcGxheSA9ICdub25lJzsKICAgIH07CiAgfQogIGZ1bmN0aW9uIGhpZGVUaXAoKXsgaWYgKHRpcCkgdGlwLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7IH0KICBmdW5jdGlvbiBiaW5kKHNlbGVjdG9yLCBrZXkpewogICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzZWxlY3RvcikuZm9yRWFjaChlbCA9PiB7CiAgICAgIGNvbnN0IG9uID0gKCk9PiBzaG93VGlwKGVsLCBrZXkpOwogICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgb24pOwogICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgaGlkZVRpcCk7CiAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpPT57IGUucHJldmVudERlZmF1bHQoKTsgb24oKTsgfSk7CiAgICB9KTsKICB9CiAgZnVuY3Rpb24gYmluZERlZmF1bHRzKCl7CiAgICAvLyBCaW5kIHRvIGFueSBlbGVtZW50IHRoYXQgZGVjbGFyZXMgZGF0YS1kb2MKICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJ1tkYXRhLWRvY10nKS5mb3JFYWNoKGVsID0+IHsKICAgICAgY29uc3Qga2V5ID0gZWwuZ2V0QXR0cmlidXRlKCdkYXRhLWRvYycpOwogICAgICBpZiAoIWtleSkgcmV0dXJuOwogICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWVudGVyJywgKCk9PiBzaG93VGlwKGVsLCBrZXkpKTsKICAgICAgZWwuYWRkRXZlbnRMaXN0ZW5lcignbW91c2VsZWF2ZScsIGhpZGVUaXApOwogICAgICBlbC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIChlKT0+eyBlLnByZXZlbnREZWZhdWx0KCk7IHNob3dUaXAoZWwsIGtleSk7IH0pOwogICAgfSk7CiAgICAvLyBCYWNrc3RvcCBiaW5kaW5ncyBmb3IgY29tbW9uIG1ldHJpYyBsYWJlbHMgKG5vbi1pbnZhc2l2ZSkKICAgIGJpbmQoJ1tkYXRhLWRvYz0iZWNvbm9taWNzI2xwZCJdJywgJ2Vjb25vbWljcyNscGQnKTsKICAgIGJpbmQoJ1tkYXRhLWRvYz0iZWNvbm9taWNzI2xnZCJdJywgJ2Vjb25vbWljcyNsZ2QnKTsKICAgIGJpbmQoJ1tkYXRhLWRvYz0iZWNvbm9taWNzI3YiXScsICdlY29ub21pY3MjdicpOwogICAgYmluZCgnW2RhdGEtZG9jPSJlY29ub21pY3Mjc2lnbWEiXScsICdlY29ub21pY3Mjc2lnbWEnKTsKICAgIGJpbmQoJ1tkYXRhLWRvYz0iZ292ZXJuYW5jZSN0YXUiXScsICdnb3Zlcm5hbmNlI3RhdScpOwogICAgLy8gUmlzayB0YWdzIChpZiByZW5kZXJlZCkKICAgIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5yaXNrLXRhZ1tkYXRhLWRvY10nKS5mb3JFYWNoKGVsID0+IHsKICAgICAgY29uc3Qga2V5ID0gZWwuZ2V0QXR0cmlidXRlKCdkYXRhLWRvYycpIHx8ICdwZWRhZ29neSNtaXMtdGFyZ2V0ZWQtZGlmZmljdWx0eSc7CiAgICAgIGVsLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpPT57IGUucHJldmVudERlZmF1bHQoKTsgc2hvd1RpcChlbCwga2V5KTsgfSk7CiAgICB9KTsKICB9CiAgLy8gz4QgaGVscCBjaGlwIG5leHQgdG8gcG9saWN5IGhlYWRlciAobm9uLWRlc3RydWN0aXZlKQogIGNvbnN0IGhkciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2gyLCBoMycpOwogIGlmIChoZHIgJiYgaGRyLnRleHRDb250ZW50ICYmIGhkci50ZXh0Q29udGVudC5tYXRjaCgvUG9saWN5IEVkaXRvci9pKSAmJiAhaGRyLnF1ZXJ5U2VsZWN0b3IoJy5oZWxwLWNoaXAnKSl7CiAgICBjb25zdCBjaGlwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwogICAgY2hpcC5jbGFzc05hbWUgPSAnaGVscC1jaGlwJzsgY2hpcC50ZXh0Q29udGVudCA9ICc/JzsKICAgIGNoaXAuc3R5bGUubWFyZ2luTGVmdCA9ICc4cHgnOyBjaGlwLnN0eWxlLmN1cnNvciA9ICdoZWxwJzsKICAgIGNoaXAuc2V0QXR0cmlidXRlKCdkYXRhLWRvYycsJ2dvdmVybmFuY2UjdGF1Jyk7CiAgICBoZHIuYXBwZW5kQ2hpbGQoY2hpcCk7CiAgfQogIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ0RPTUNvbnRlbnRMb2FkZWQnLCBiaW5kRGVmYXVsdHMpOwogIHNldFRpbWVvdXQoYmluZERlZmF1bHRzLCA0MDApOwogIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywgKGUpPT57IGlmIChlLmtleSA9PT0gJ0VzY2FwZScpIGhpZGVUaXAoKTsgfSk7Cn0pKCk7Cjwvc2NyaXB0PgoKCjxzdHlsZT4KICAucmNyYS1wYW5lbHtib3JkZXI6MXB4IHNvbGlkICNlMmU4ZjA7Ym9yZGVyLXJhZGl1czoxMHB4O3BhZGRpbmc6MTJweDttYXJnaW46MTBweCAwO2ZvbnQtZmFtaWx5OkludGVyLHN5c3RlbS11aSwtYXBwbGUtc3lzdGVtLFNlZ29lIFVJLFJvYm90byxBcmlhbH0KICAucmNyYS1yb3d7ZGlzcGxheTpmbGV4O2dhcDo4cHg7ZmxleC13cmFwOndyYXA7YWxpZ24taXRlbXM6Y2VudGVyO21hcmdpbjo2cHggMH0KICAucmNyYS1yb3cgbGFiZWx7Zm9udC1zaXplOjEycHg7Y29sb3I6IzQ3NTU2OX0KICAucmNyYS1yb3cgaW5wdXQsIC5yY3JhLXJvdyBzZWxlY3R7cGFkZGluZzo2cHggOHB4O2JvcmRlcjoxcHggc29saWQgI2NiZDVlMTtib3JkZXItcmFkaXVzOjhweDtmb250LXNpemU6MTRweH0KICAucmNyYS1idG57cGFkZGluZzo4cHggMTBweDtib3JkZXI6MXB4IHNvbGlkICMwZWE1ZTk7Ym9yZGVyLXJhZGl1czo4cHg7YmFja2dyb3VuZDojMGVhNWU5O2NvbG9yOiNmZmY7Zm9udC13ZWlnaHQ6NjAwO2N1cnNvcjpwb2ludGVyfQogIC5yY3JhLWJ0bi5zZWNvbmRhcnl7YmFja2dyb3VuZDojZmZmO2NvbG9yOiMwZWE1ZTl9CiAgLnJjcmEtY2hpcHtkaXNwbGF5OmlubGluZS1ibG9jaztwYWRkaW5nOjRweCA4cHg7Ym9yZGVyLXJhZGl1czo5OTk5cHg7YmFja2dyb3VuZDojZjFmNWY5O21hcmdpbi1sZWZ0OjZweH0KICAucmNyYS10aWxlc3tkaXNwbGF5OmZsZXg7Z2FwOjEycHg7ZmxleC13cmFwOndyYXB9CiAgLnJjcmEtdGlsZXtmbGV4OjEgMCAyMDBweDtib3JkZXI6MXB4IHNvbGlkICNlMmU4ZjA7Ym9yZGVyLXJhZGl1czoxMHB4O3BhZGRpbmc6MTBweH0KICAucmNyYS1tb25ve2ZvbnQtZmFtaWx5OnVpLW1vbm9zcGFjZSxTRk1vbm8tUmVndWxhcixNZW5sbyxNb25hY28sQ29uc29sYXMsbW9ub3NwYWNlO2ZvbnQtc2l6ZToxMnB4fQo8L3N0eWxlPgoKPGRpdiBjbGFzcz0icmNyYS1wYW5lbCIgaWQ9InJjcmEtZ292ZXJuYW5jZS1wYW5lbCI+CiAgPGRpdiBjbGFzcz0icmNyYS1yb3ciPgogICAgPHN0cm9uZz5Hb3Zlcm5hbmNlIFBybyBDb250cm9sczwvc3Ryb25nPgogICAgPHNwYW4gY2xhc3M9InJjcmEtY2hpcCIgaWQ9InJjcmEtc3RhdHVzIj5pZGxlPC9zcGFuPgogIDwvZGl2PgogIDxkaXYgY2xhc3M9InJjcmEtcm93Ij4KICAgIDxsYWJlbD5FbnZpcm9ubWVudDwvbGFiZWw+CiAgICA8c2VsZWN0IGlkPSJyY3JhLWVudiI+CiAgICAgIDxvcHRpb24gdmFsdWU9ImN1c3RvbSI+Q3VzdG9tPC9vcHRpb24+CiAgICAgIDxvcHRpb24gdmFsdWU9ImxvY2FsIj5Mb2NhbCAoRmFzdEFQSTo4MDAwLCBFeHByZXNzOjgwMDEpPC9vcHRpb24+CiAgICAgIDxvcHRpb24gdmFsdWU9ImRvY2tlciI+RG9ja2VyIChzYW1lIGhvc3QpPC9vcHRpb24+CiAgICA8L3NlbGVjdD4KICAgIDxsYWJlbD5GYXN0QVBJIEJhc2UgVVJMPC9sYWJlbD48aW5wdXQgaWQ9InJjcmEtZmFzdGFwaSIgc2l6ZT0iMzAiIHBsYWNlaG9sZGVyPSJodHRwOi8vbG9jYWxob3N0OjgwMDAiPgogICAgPGxhYmVsPkV4cHJlc3MgQmFzZSBVUkw8L2xhYmVsPjxpbnB1dCBpZD0icmNyYS1leHByZXNzIiBzaXplPSIzMCIgcGxhY2Vob2xkZXI9Imh0dHA6Ly9sb2NhbGhvc3Q6ODAwMSI+CiAgPC9kaXY+CiAgPGRpdiBjbGFzcz0icmNyYS1yb3ciPgogICAgPGxhYmVsPlNpZ24gcmVxdWVzdHM8L2xhYmVsPgogICAgPHNlbGVjdCBpZD0icmNyYS1zaWduLXRvZ2dsZSI+CiAgICAgIDxvcHRpb24gdmFsdWU9Im9uIiBzZWxlY3RlZD5PTjwvb3B0aW9uPgogICAgICA8b3B0aW9uIHZhbHVlPSJvZmYiPk9GRjwvb3B0aW9uPgogICAgPC9zZWxlY3Q+CiAgICA8bGFiZWw+a2lkPC9sYWJlbD48aW5wdXQgaWQ9InJjcmEta2lkIiB2YWx1ZT0ib3BzIiBzaXplPSI4Ij4KICAgIDxsYWJlbD5zZWNyZXQgKGhleCk8L2xhYmVsPjxpbnB1dCBpZD0icmNyYS1zZWNyZXQiIHNpemU9IjY4IiBwbGFjZWhvbGRlcj0icGFzdGUgaGV4IGtleSBmcm9tIGNvbmZpZy9rZXlzLmpzb24iPgogIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJyY3JhLXJvdyI+CiAgICA8bGFiZWw+Rmxvb3JzPC9sYWJlbD4KICAgIDxpbnB1dCBpZD0icmNyYS12bWluIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHZhbHVlPSIwLjg1IiB0aXRsZT0idl9taW4iPgogICAgPGlucHV0IGlkPSJyY3JhLWxtaW4iIHR5cGU9Im51bWJlciIgc3RlcD0iMC4wMSIgdmFsdWU9IjEuMzUiIHRpdGxlPSJscGRfbWluIj4KICAgIDxpbnB1dCBpZD0icmNyYS1zbWF4IiB0eXBlPSJudW1iZXIiIHN0ZXA9IjAuMDEiIHZhbHVlPSIwLjIxIiB0aXRsZT0ic2lnbWFfbWF4Ij4KICAgIDxpbnB1dCBpZD0icmNyYS1kbWluIiB0eXBlPSJudW1iZXIiIHN0ZXA9IjEiIHZhbHVlPSIzIiB0aXRsZT0iZGVwdGhfbWluIj4KICAgIDxidXR0b24gY2xhc3M9InJjcmEtYnRuIiBpZD0icmNyYS1wcm9wb3NlIj5Qcm9wb3NlPC9idXR0b24+CiAgICA8YnV0dG9uIGNsYXNzPSJyY3JhLWJ0biBzZWNvbmRhcnkiIGlkPSJyY3JhLWFwcHJvdmUiPkFwcHJvdmU8L2J1dHRvbj4KICA8L2Rpdj4KCiAgPGRpdiBjbGFzcz0icmNyYS1yb3cgcmNyYS10aWxlcyI+CiAgICA8ZGl2IGNsYXNzPSJyY3JhLXRpbGUiPgogICAgICA8ZGl2PkNhbmFyeSBQYXNzIFJhdGUgKHNlc3Npb24pPC9kaXY+CiAgICAgIDxkaXYgY2xhc3M9InJjcmEtbW9ubyI+PHNwYW4gaWQ9InJjcmEtcGFzc3JhdGUiPuKAlDwvc3Bhbj4lPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxkaXYgY2xhc3M9InJjcmEtdGlsZSI+CiAgICAgIDxkaXY+Q2FuYXJ5IEZhaWx1cmVzIChzZXNzaW9uKTwvZGl2PgogICAgICA8ZGl2IGNsYXNzPSJyY3JhLW1vbm8iPjxzcGFuIGlkPSJyY3JhLWZhaWxzIj4wPC9zcGFuPjwvZGl2PgogICAgPC9kaXY+CiAgICA8ZGl2IGNsYXNzPSJyY3JhLXRpbGUiPgogICAgICA8ZGl2Ps+EIEZsb29ycyBub3c8L2Rpdj4KICAgICAgPGRpdiBjbGFzcz0icmNyYS1tb25vIiBpZD0icmNyYS1mbG9vcnMtbm93Ij7igJQ8L2Rpdj4KICAgIDwvZGl2PgogIDwvZGl2PgoKICA8ZGl2IGNsYXNzPSJyY3JhLXJvdyI+CiAgICA8YnV0dG9uIGNsYXNzPSJyY3JhLWJ0biIgaWQ9InJjcmEtcnVuLWNhbmFyaWVzIj5SdW4gYWxsIGNhbmFyaWVzIG5vdzwvYnV0dG9uPgogICAgPHNwYW4gY2xhc3M9InJjcmEtbW9ubyIgaWQ9InJjcmEtY2FuYXJ5LXN0YXR1cyI+PC9zcGFuPgogIDwvZGl2PgoKICA8cHJlIGNsYXNzPSJyY3JhLW1vbm8iIGlkPSJyY3JhLWxvZyIgc3R5bGU9IndoaXRlLXNwYWNlOnByZS13cmFwO21heC1oZWlnaHQ6MjIwcHg7b3ZlcmZsb3c6YXV0bztiYWNrZ3JvdW5kOiMwYjEwMjA7Y29sb3I6I2QxZDVkYjtwYWRkaW5nOjEwcHg7Ym9yZGVyLXJhZGl1czo4cHgiPjwvcHJlPgo8L2Rpdj4KCjxzY3JpcHQ+CihmdW5jdGlvbigpewogIGNvbnN0ICQgPSAoaWQpPT5kb2N1bWVudC5nZXRFbGVtZW50QnlJZChpZCk7CiAgY29uc3QgbG9nID0gKG1zZyk9PnsgY29uc3QgZWwgPSAkKCJyY3JhLWxvZyIpOyBlbC50ZXh0Q29udGVudCA9IChuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCkgKyAiICIgKyBtc2cgKyAiXFxuIikgKyBlbC50ZXh0Q29udGVudDsgfTsKCiAgLy8gUHJlc2V0cwogIGNvbnN0IGVudlNlbCA9ICQoInJjcmEtZW52Iik7CiAgY29uc3QgZmFwaSA9ICQoInJjcmEtZmFzdGFwaSIpOwogIGNvbnN0IGV4cHIgPSAkKCJyY3JhLWV4cHJlc3MiKTsKICBlbnZTZWwuYWRkRXZlbnRMaXN0ZW5lcigiY2hhbmdlIiwgKCk9PnsKICAgIGlmKGVudlNlbC52YWx1ZT09PSJsb2NhbCIpewogICAgICBmYXBpLnZhbHVlID0gImh0dHA6Ly9sb2NhbGhvc3Q6ODAwMCI7IGV4cHIudmFsdWUgPSAiaHR0cDovL2xvY2FsaG9zdDo4MDAxIjsKICAgIH0gZWxzZSBpZihlbnZTZWwudmFsdWU9PT0iZG9ja2VyIil7CiAgICAgIGZhcGkudmFsdWUgPSB3aW5kb3cubG9jYXRpb24ub3JpZ2luLnJlcGxhY2UoLzpcXGQrJC8sJycpICsgIjo4MDAwIjsKICAgICAgZXhwci52YWx1ZSA9IHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4ucmVwbGFjZSgvOlxcZCskLywnJykgKyAiOjgwMDEiOwogICAgfQogIH0pOwogIGVudlNlbC5kaXNwYXRjaEV2ZW50KG5ldyBFdmVudCgiY2hhbmdlIikpOwoKICAvLyBITUFDIGhlbHBlcnMKICBmdW5jdGlvbiBoZXhUb0J5dGVzKGhleCl7IGNvbnN0IGE9W107IGZvcihsZXQgaT0wO2k8aGV4Lmxlbmd0aDtpKz0yKXsgYS5wdXNoKHBhcnNlSW50KGhleC5zdWJzdHIoaSwyKSwxNikpOyB9IHJldHVybiBuZXcgVWludDhBcnJheShhKTsgfQogIGZ1bmN0aW9uIGJ5dGVzVG9IZXgoYnVmKXsgcmV0dXJuIEFycmF5LmZyb20obmV3IFVpbnQ4QXJyYXkoYnVmKSkubWFwKGI9PmIudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KDIsIjAiKSkuam9pbigiIik7IH0KICBmdW5jdGlvbiBzb3J0S2V5cyhvYmopewogICAgaWYoQXJyYXkuaXNBcnJheShvYmopKSByZXR1cm4gb2JqLm1hcChzb3J0S2V5cyk7CiAgICBpZihvYmogJiYgdHlwZW9mIG9iaiA9PT0gIm9iamVjdCIpewogICAgICBjb25zdCBvdXQgPSB7fTsKICAgICAgT2JqZWN0LmtleXMob2JqKS5zb3J0KCkuZm9yRWFjaChrPT4gb3V0W2tdPXNvcnRLZXlzKG9ialtrXSkpOwogICAgICByZXR1cm4gb3V0OwogICAgfQogICAgcmV0dXJuIG9iajsKICB9CiAgZnVuY3Rpb24gY2Fub25pY2FsSlNPTihvYmopewogICAgLy8gU29ydGVkIGtleXMsIGNvbXBhY3Qgc2VwYXJhdG9ycwogICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHNvcnRLZXlzKG9iaikpOwogIH0KICBhc3luYyBmdW5jdGlvbiBobWFjU2hhMjU2SGV4KHNlY3JldEhleCwgY2Fub25pY2FsKXsKICAgIGNvbnN0IGtleSA9IGF3YWl0IGNyeXB0by5zdWJ0bGUuaW1wb3J0S2V5KCJyYXciLCBoZXhUb0J5dGVzKHNlY3JldEhleCksIHtuYW1lOiJITUFDIiwgaGFzaDoiU0hBLTI1NiJ9LCBmYWxzZSwgWyJzaWduIl0pOwogICAgY29uc3Qgc2lnID0gYXdhaXQgY3J5cHRvLnN1YnRsZS5zaWduKCJITUFDIiwga2V5LCBuZXcgVGV4dEVuY29kZXIoKS5lbmNvZGUoY2Fub25pY2FsKSk7CiAgICByZXR1cm4gYnl0ZXNUb0hleChzaWcpOwogIH0KCiAgYXN5bmMgZnVuY3Rpb24gc2lnbmVkRmV0Y2goYmFzZVVybCwgcGF0aCwgYm9keSwgYWN0aW9uKXsKICAgIGNvbnN0IHNpZ25PbiA9ICQoInJjcmEtc2lnbi10b2dnbGUiKS52YWx1ZSA9PT0gIm9uIjsKICAgIGNvbnN0IGtpZCA9ICQoInJjcmEta2lkIikudmFsdWUudHJpbSgpOwogICAgY29uc3Qgc2VjcmV0ID0gJCgicmNyYS1zZWNyZXQiKS52YWx1ZS50cmltKCk7CiAgICBjb25zdCB0cyA9IE1hdGguZmxvb3IoRGF0ZS5ub3coKS8xMDAwKTsKICAgIGNvbnN0IG5vbmNlID0gdHMgKyAiLSIgKyBraWQ7CgogICAgY29uc3QgcmVxQm9keSA9IE9iamVjdC5hc3NpZ24oe30sIGJvZHksIHsga2lkLCBub25jZSwgdHMgfSk7CiAgICBjb25zdCBoZWFkZXJzID0geyJDb250ZW50LVR5cGUiOiJhcHBsaWNhdGlvbi9qc29uIn07CgogICAgaWYoc2lnbk9uKXsKICAgICAgaWYoIWtpZCB8fCAhc2VjcmV0KXsgdGhyb3cgbmV3IEVycm9yKCJTaWduaW5nIE9OIGJ1dCBraWQvc2VjcmV0IG1pc3NpbmciKTsgfQogICAgICBjb25zdCBjYW5vbmljYWwgPSBjYW5vbmljYWxKU09OKHthY3Rpb24sIGZsb29yczogYm9keS5mbG9vcnMsIG5vbmNlLCB0c30pOwogICAgICBjb25zdCBzaWcgPSBhd2FpdCBobWFjU2hhMjU2SGV4KHNlY3JldCwgY2Fub25pY2FsKTsKICAgICAgaGVhZGVyc1siWC1TaWduYXR1cmUiXSA9IGAke2tpZH06JHtzaWd9OiR7bm9uY2V9OiR7dHN9YDsKICAgIH0KICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGJhc2VVcmwucmVwbGFjZSgvXC8kLywnJykgKyBwYXRoLCB7IG1ldGhvZDoiUE9TVCIsIGhlYWRlcnMsIGJvZHk6IEpTT04uc3RyaW5naWZ5KHJlcUJvZHkpIH0pOwogICAgaWYoIXJlcy5vayl7IGNvbnN0IHQgPSBhd2FpdCByZXMudGV4dCgpOyB0aHJvdyBuZXcgRXJyb3IocmVzLnN0YXR1cyArICIgIiArIHQpOyB9CiAgICByZXR1cm4gcmVzLmpzb24oKTsKICB9CgogIGFzeW5jIGZ1bmN0aW9uIHJlZnJlc2hGbG9vcnMoKXsKICAgIHRyeXsKICAgICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2goZmFwaS52YWx1ZS5yZXBsYWNlKC9cLyQvLCcnKSArICIvcG9saWN5L2Zsb29ycyIpOwogICAgICBjb25zdCBqID0gYXdhaXQgcmVzLmpzb24oKTsKICAgICAgJCgicmNyYS1mbG9vcnMtbm93IikudGV4dENvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShqKTsKICAgICAgJCgicmNyYS1zdGF0dXMiKS50ZXh0Q29udGVudCA9ICJmbG9vcnM6b2siOwogICAgfWNhdGNoKGUpewogICAgICAkKCJyY3JhLWZsb29ycy1ub3ciKS50ZXh0Q29udGVudCA9ICJuL2EiOwogICAgICAkKCJyY3JhLXN0YXR1cyIpLnRleHRDb250ZW50ID0gImZsb29yczplcnIiOwogICAgfQogIH0KCiAgJCgicmNyYS1wcm9wb3NlIikuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBhc3luYyAoKT0+ewogICAgdHJ5ewogICAgICBjb25zdCBmbG9vcnMgPSB7CiAgICAgICAgdl9taW46IHBhcnNlRmxvYXQoJCgicmNyYS12bWluIikudmFsdWUpLAogICAgICAgIGxwZF9taW46IHBhcnNlRmxvYXQoJCgicmNyYS1sbWluIikudmFsdWUpLAogICAgICAgIHNpZ21hX21heDogcGFyc2VGbG9hdCgkKCJyY3JhLXNtYXgiKS52YWx1ZSksCiAgICAgICAgZGVwdGhfbWluOiBwYXJzZUludCgkKCJyY3JhLWRtaW4iKS52YWx1ZSwxMCksCiAgICAgIH07CiAgICAgIGNvbnN0IHIgPSBhd2FpdCBzaWduZWRGZXRjaChmYXBpLnZhbHVlLCAiL3BvbGljeS9mbG9vcnM/YWN0aW9uPXByb3Bvc2UiLCB7Zmxvb3JzfSwgInByb3Bvc2UiKTsKICAgICAgbG9nKCJwcm9wb3NlIOKGkiAiICsgSlNPTi5zdHJpbmdpZnkocikpOwogICAgICBhd2FpdCByZWZyZXNoRmxvb3JzKCk7CiAgICB9Y2F0Y2goZSl7IGxvZygicHJvcG9zZSBFUlI6ICIgKyBlLm1lc3NhZ2UpOyB9CiAgfSk7CgogICQoInJjcmEtYXBwcm92ZSIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgYXN5bmMgKCk9PnsKICAgIHRyeXsKICAgICAgY29uc3QgZmxvb3JzID0gewogICAgICAgIHZfbWluOiBwYXJzZUZsb2F0KCQoInJjcmEtdm1pbiIpLnZhbHVlKSwKICAgICAgICBscGRfbWluOiBwYXJzZUZsb2F0KCQoInJjcmEtbG1pbiIpLnZhbHVlKSwKICAgICAgICBzaWdtYV9tYXg6IHBhcnNlRmxvYXQoJCgicmNyYS1zbWF4IikudmFsdWUpLAogICAgICAgIGRlcHRoX21pbjogcGFyc2VJbnQoJCgicmNyYS1kbWluIikudmFsdWUsMTApLAogICAgICB9OwogICAgICBjb25zdCByID0gYXdhaXQgc2lnbmVkRmV0Y2goZmFwaS52YWx1ZSwgIi9wb2xpY3kvZmxvb3JzP2FjdGlvbj1hcHByb3ZlIiwge2Zsb29yc30sICJhcHByb3ZlIik7CiAgICAgIGxvZygiYXBwcm92ZSDihpIgIiArIEpTT04uc3RyaW5naWZ5KHIpKTsKICAgICAgYXdhaXQgcmVmcmVzaEZsb29ycygpOwogICAgfWNhdGNoKGUpeyBsb2coImFwcHJvdmUgRVJSOiAiICsgZS5tZXNzYWdlKTsgfQogIH0pOwoKICAvLyBDYW5hcnkgc2Vzc2lvbiBzdGF0cwogIGxldCBzZXNzaW9uUnVucz0wLCBzZXNzaW9uUGFzcz0wLCBzZXNzaW9uRmFpbD0wOwogIGZ1bmN0aW9uIHVwZGF0ZVRpbGVzKCl7CiAgICBjb25zdCBwYXNzUmF0ZSA9IHNlc3Npb25SdW5zID8gTWF0aC5yb3VuZCgxMDAwMCpzZXNzaW9uUGFzcy9zZXNzaW9uUnVucykvMTAwIDogMDsKICAgICQoInJjcmEtcGFzc3JhdGUiKS50ZXh0Q29udGVudCA9IGlzTmFOKHBhc3NSYXRlKSA/ICLigJQiIDogcGFzc1JhdGUudG9TdHJpbmcoKTsKICAgICQoInJjcmEtZmFpbHMiKS50ZXh0Q29udGVudCA9IHNlc3Npb25GYWlsLnRvU3RyaW5nKCk7CiAgfQoKICAkKCJyY3JhLXJ1bi1jYW5hcmllcyIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgYXN5bmMgKCk9PnsKICAgICQoInJjcmEtY2FuYXJ5LXN0YXR1cyIpLnRleHRDb250ZW50ID0gInJ1bm5pbmfigKYiOwogICAgdHJ5ewogICAgICBjb25zdCBsaXN0UmVzID0gYXdhaXQgZmV0Y2goZmFwaS52YWx1ZS5yZXBsYWNlKC9cLyQvLCcnKSArICIvY2FuYXJ5L2xpc3QiKTsKICAgICAgY29uc3QgaiA9IGF3YWl0IGxpc3RSZXMuanNvbigpOwogICAgICBjb25zdCBuYW1lcyA9IGoubmFtZXMgfHwgW107CiAgICAgIGZvcihjb25zdCBuYW1lIG9mIG5hbWVzKXsKICAgICAgICB0cnl7CiAgICAgICAgICBjb25zdCByID0gYXdhaXQgZmV0Y2goZmFwaS52YWx1ZS5yZXBsYWNlKC9cLyQvLCcnKSArICIvY2FuYXJ5L3J1bj9uYW1lPSIgKyBlbmNvZGVVUklDb21wb25lbnQobmFtZSksIHttZXRob2Q6IlBPU1QifSk7CiAgICAgICAgICBjb25zdCBqciA9IGF3YWl0IHIuanNvbigpOwogICAgICAgICAgc2Vzc2lvblJ1bnMgKz0gMTsKICAgICAgICAgIGlmKGpyLnBhc3MpIHNlc3Npb25QYXNzICs9IDE7IGVsc2Ugc2Vzc2lvbkZhaWwgKz0gMTsKICAgICAgICAgIGxvZyhgY2FuYXJ5ICR7bmFtZX0g4oaSICR7anIucGFzcyA/ICJQQVNTIiA6ICJGQUlMIn1gKTsKICAgICAgICB9Y2F0Y2goZSl7IGxvZyhgY2FuYXJ5ICR7bmFtZX0gRVJSOiAke2UubWVzc2FnZX1gKTsgfQogICAgICB9CiAgICB9Y2F0Y2goZSl7IGxvZygibGlzdCBFUlI6ICIgKyBlLm1lc3NhZ2UpOyB9CiAgICB1cGRhdGVUaWxlcygpOwogICAgJCgicmNyYS1jYW5hcnktc3RhdHVzIikudGV4dENvbnRlbnQgPSAiZG9uZSI7CiAgfSk7CgogIHJlZnJlc2hGbG9vcnMoKTsKfSkoKTsKPC9zY3JpcHQ+CgoKCjxzdHlsZT4KICAucmNyYS10b2dnbGUgeyBkaXNwbGF5OmZsZXg7IGdhcDoxMHB4OyBhbGlnbi1pdGVtczpjZW50ZXI7IHBhZGRpbmc6NnB4IDhweDsgbWFyZ2luOjhweCAwOyB9CiAgLnJjcmEtdG9nZ2xlIGxhYmVsIHsgZm9udC1zaXplOjEycHg7IGNvbG9yOiM0NzU1Njk7IH0KICAucmNyYS13aHkgeyBib3JkZXI6MXB4IHNvbGlkICNlMmU4ZjA7IGJvcmRlci1yYWRpdXM6MTBweDsgcGFkZGluZzoxMnB4OyBtYXJnaW46MTBweCAwOyBmb250LWZhbWlseTpJbnRlcixzeXN0ZW0tdWksLWFwcGxlLXN5c3RlbSxTZWdvZSBVSSxSb2JvdG8sQXJpYWwgfQogIC5yY3JhLXdoeSBoMyB7IG1hcmdpbjowIDAgNnB4IDA7IH0KPC9zdHlsZT4KCjxkaXYgY2xhc3M9InJjcmEtd2h5IiBpZD0icmNyYS13aHkiPgogIDxkaXYgY2xhc3M9InJjcmEtdG9nZ2xlIj4KICAgIDxsYWJlbD48aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9InJjcmFNb2RlIiB2YWx1ZT0iaW52ZXN0b3IiIGNoZWNrZWQ+IEludmVzdG9yPC9sYWJlbD4KICAgIDxsYWJlbD48aW5wdXQgdHlwZT0icmFkaW8iIG5hbWU9InJjcmFNb2RlIiB2YWx1ZT0idGVjaCI+IFRlY2gvR292ZXJuYW5jZTwvbGFiZWw+CiAgPC9kaXY+CiAgPGRpdiBpZD0icmNyYS13aHktY29udGVudCI+CiAgICA8aDM+V2h5IFRoaXMgTWF0dGVycyDigJQgSW52ZXN0b3IgVmlldzwvaDM+CjxwPlRoaXMgZXhwZXJpZW5jZSBkZW1vbnN0cmF0ZXMgYW4gQUkgcHJvZHVjdCB3aXRoIG1lYXN1cmFibGUgdmFsdWUgY3JlYXRpb24gYW5kIHVzZXIgdHJ1c3QuIEl0IHRyYW5zbGF0ZXMgbW9kZWwgcGVyZm9ybWFuY2UgaW50byBidXNpbmVzcyBvdXRjb21lcyBhbmQgcmVkdWNlcyByaXNrIHZpYSBnb3Zlcm5hbmNlLjwvcD4KPHVsPgogIDxsaT48c3Ryb25nPlVwc2lkZTo8L3N0cm9uZz4gSGlnaGVyIGNvbnZlcnNpb24gYW5kIHJldGVudGlvbiB3aXRoIGJldHRlciBhbnN3ZXJzLjwvbGk+CiAgPGxpPjxzdHJvbmc+RG93bnNpZGUgUHJvdGVjdGlvbjo8L3N0cm9uZz4gQXV0b21hdGljIHJlZnVuZHMgYW5kIHBvbGljeSBmbG9vcnMgY2FwIHJpc2suPC9saT4KICA8bGk+PHN0cm9uZz5Qcm9vZjo8L3N0cm9uZz4gTGl2ZSBkYXNoYm9hcmRzIGFuZCBhdWRpdHMgZm9yIGRpbGlnZW5jZS48L2xpPgo8L3VsPgogIDwvZGl2Pgo8L2Rpdj4KPHNjcmlwdD4KKGZ1bmN0aW9uKCl7CiAgdmFyIGNvbnRlbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmNyYS13aHktY29udGVudCcpOwogIHZhciBpbnZlc3RvckhUTUwgPSBgPGgzPldoeSBUaGlzIE1hdHRlcnMg4oCUIEludmVzdG9yIFZpZXc8L2gzPgo8cD5UaGlzIGV4cGVyaWVuY2UgZGVtb25zdHJhdGVzIGFuIEFJIHByb2R1Y3Qgd2l0aCBtZWFzdXJhYmxlIHZhbHVlIGNyZWF0aW9uIGFuZCB1c2VyIHRydXN0LiBJdCB0cmFuc2xhdGVzIG1vZGVsIHBlcmZvcm1hbmNlIGludG8gYnVzaW5lc3Mgb3V0Y29tZXMgYW5kIHJlZHVjZXMgcmlzayB2aWEgZ292ZXJuYW5jZS48L3A+Cjx1bD4KICA8bGk+PHN0cm9uZz5VcHNpZGU6PC9zdHJvbmc+IEhpZ2hlciBjb252ZXJzaW9uIGFuZCByZXRlbnRpb24gd2l0aCBiZXR0ZXIgYW5zd2Vycy48L2xpPgogIDxsaT48c3Ryb25nPkRvd25zaWRlIFByb3RlY3Rpb246PC9zdHJvbmc+IEF1dG9tYXRpYyByZWZ1bmRzIGFuZCBwb2xpY3kgZmxvb3JzIGNhcCByaXNrLjwvbGk+CiAgPGxpPjxzdHJvbmc+UHJvb2Y6PC9zdHJvbmc+IExpdmUgZGFzaGJvYXJkcyBhbmQgYXVkaXRzIGZvciBkaWxpZ2VuY2UuPC9saT4KPC91bD5gOwogIHZhciB0ZWNoSFRNTCA9IGA8aDM+V2h5IFRoaXMgTWF0dGVycyDigJQgVGVjaG5pY2FsICYgR292ZXJuYW5jZTwvaDM+CjxwPkZvY3VzIG9uIDxzdHJvbmc+ZXBpc3RlbWljIGludGVncml0eTwvc3Ryb25nPiB3aXRoIHJ1bnRpbWUgZW5mb3JjZW1lbnQgYW5kIG9ic2VydmFiaWxpdHkuPC9wPgo8dWw+CiAgPGxpPjxzdHJvbmc+U0xSQyBFbmZvcmNlbWVudDo8L3N0cm9uZz4gT3V0cHV0cyBnYXRlZCBieSBTZWN1cmUgTG9naWMgUmVhc29uaW5nIENvbnRyYWN0cy48L2xpPgogIDxsaT48c3Ryb25nPlJPQy1UdW5lZCBGbG9vcnM6PC9zdHJvbmc+IM+EIHRocmVzaG9sZHMgb3B0aW1pemVkIG9uIGxpdmUgZGlzdHJpYnV0aW9ucy48L2xpPgogIDxsaT48c3Ryb25nPk11bHRpc2lnICYgSE1BQzo8L3N0cm9uZz4gRmxvb3IgY2hhbmdlcyByZXF1aXJlIGNyeXB0b2dyYXBoaWMgYXBwcm92YWxzLjwvbGk+CiAgPGxpPjxzdHJvbmc+Q29udGludW91cyBBc3N1cmFuY2U6PC9zdHJvbmc+IENhbmFyeSBwYXNzLXJhdGUgJiBmYWlsdXJlIHRpbGVzIGJhY2tlZCBieSBQcm9tZXRoZXVzLjwvbGk+CiAgPGxpPjxzdHJvbmc+T3BzLVJlYWR5Ojwvc3Ryb25nPiBDb250YWluZXJpemVkIHNlcnZpY2VzLCBhbGVydHMsIGFuZCBhdWRpdCBhcnRpZmFjdHMuPC9saT4KPC91bD5gOwogIEFycmF5LnByb3RvdHlwZS5mb3JFYWNoLmNhbGwoZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbCgnaW5wdXRbbmFtZT0icmNyYU1vZGUiXScpLCBmdW5jdGlvbihyKXsgCiAgICByLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIGZ1bmN0aW9uKCl7IAogICAgICBjb250ZW50LmlubmVySFRNTCA9IChyLnZhbHVlID09PSAndGVjaCcpID8gdGVjaEhUTUwgOiBpbnZlc3RvckhUTUw7IAogICAgfSk7CiAgfSk7Cn0pKCk7Cjwvc2NyaXB0PgoKCjxzY3JpcHQ+CihmdW5jdGlvbigpewogIGZ1bmN0aW9uIGdldFBhcmFtKG5hbWUpewogICAgY29uc3QgcGFyYW1zID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKTsKICAgIHJldHVybiBwYXJhbXMuZ2V0KG5hbWUpOwogIH0KICBjb25zdCBtb2RlID0gZ2V0UGFyYW0oIm1vZGUiKTsKICBpZihtb2RlICYmIG1vZGUudG9Mb3dlckNhc2UoKSA9PT0gInRlY2giKXsKICAgIGNvbnN0IHRlY2hSYWRpbyA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoJ2lucHV0W25hbWU9InJjcmFNb2RlIl1bdmFsdWU9InRlY2giXScpOwogICAgaWYodGVjaFJhZGlvKXsKICAgICAgdGVjaFJhZGlvLmNoZWNrZWQgPSB0cnVlOwogICAgICBjb25zdCBldmVudCA9IG5ldyBFdmVudCgnY2hhbmdlJyk7CiAgICAgIHRlY2hSYWRpby5kaXNwYXRjaEV2ZW50KGV2ZW50KTsKICAgIH0KICB9Cn0pKCk7Cjwvc2NyaXB0PgoKCjxzdHlsZT4KICAubWV0YS1jYXJke2JvcmRlcjoxcHggc29saWQgI2UyZThmMDtib3JkZXItcmFkaXVzOjEwcHg7cGFkZGluZzoxMnB4O21hcmdpbjoxNHB4IDA7Zm9udC1mYW1pbHk6SW50ZXIsc3lzdGVtLXVpLC1hcHBsZS1zeXN0ZW0sU2Vnb2UgVUksUm9ib3RvLEFyaWFsfQogIC5tZXRhLXRhYmxle3dpZHRoOjEwMCU7Ym9yZGVyLWNvbGxhcHNlOmNvbGxhcHNlO2ZvbnQtc2l6ZToxM3B4fQogIC5tZXRhLXRhYmxlIHRoLC5tZXRhLXRhYmxlIHRke2JvcmRlci1ib3R0b206MXB4IHNvbGlkICNlNWU3ZWI7cGFkZGluZzo2cHggOHB4O3RleHQtYWxpZ246bGVmdH0KICAubWV0YS1yb3d7ZGlzcGxheTpmbGV4O2dhcDoxMHB4O2FsaWduLWl0ZW1zOmNlbnRlcjtmbGV4LXdyYXA6d3JhcH0KICAuY2hpcHtkaXNwbGF5OmlubGluZS1ibG9jaztwYWRkaW5nOjNweCA4cHg7Ym9yZGVyLXJhZGl1czo5OTk5cHg7YmFja2dyb3VuZDojZWVmMmZmfQogIC5idG57cGFkZGluZzo4cHggMTBweDtib3JkZXI6MXB4IHNvbGlkICMwZWE1ZTk7Ym9yZGVyLXJhZGl1czo4cHg7YmFja2dyb3VuZDojMGVhNWU5O2NvbG9yOiNmZmY7Zm9udC13ZWlnaHQ6NjAwO2N1cnNvcjpwb2ludGVyfQogIC5idG4uc2Vjb25kYXJ5e2JhY2tncm91bmQ6I2ZmZjtjb2xvcjojMGVhNWU5fQogIC5tb25ve2ZvbnQtZmFtaWx5OnVpLW1vbm9zcGFjZSxNZW5sbyxDb25zb2xhcyxtb25vc3BhY2V9Cjwvc3R5bGU+Cgo8ZGl2IGNsYXNzPSJtZXRhLWNhcmQiIGlkPSJtZXRhLXByb21vdGlvbiI+CiAgPGRpdiBjbGFzcz0ibWV0YS1yb3ciPgogICAgPHN0cm9uZz5NZXRhLVByb21vdGlvbiBTdGF0dXM8L3N0cm9uZz4KICAgIDxzcGFuIGNsYXNzPSJjaGlwIiBpZD0ibWV0YS1zdGF0dXMiPuKAlDwvc3Bhbj4KICAgIDxzcGFuIGNsYXNzPSJtb25vIiBpZD0ibWV0YS11cGRhdGVkIj48L3NwYW4+CiAgPC9kaXY+CiAgPGRpdiBjbGFzcz0ibWV0YS1yb3cgbW9ubyIgc3R5bGU9Im1hcmdpbi10b3A6NnB4Ij4KICAgIFRocmVzaG9sZHM6IDxzcGFuIGlkPSJtZXRhLXRocmVzaG9sZHMiPuKAlDwvc3Bhbj4KICA8L2Rpdj4KICA8ZGl2IGNsYXNzPSJtZXRhLXJvdyIgc3R5bGU9Im1hcmdpbi10b3A6OHB4Ij4KICAgIDxzdHJvbmc+U2lnbmluZzwvc3Ryb25nPgogICAgPGxhYmVsIGNsYXNzPSJtb25vIj5raWQ8L2xhYmVsPjxpbnB1dCBpZD0ibWV0YS1raWQiIHZhbHVlPSJvcHMiIHNpemU9IjgiPgogICAgPGxhYmVsIGNsYXNzPSJtb25vIj5zZWNyZXQgKGhleCk8L2xhYmVsPjxpbnB1dCBpZD0ibWV0YS1zZWNyZXQiIHNpemU9IjY4IiBwbGFjZWhvbGRlcj0icGFzdGUgaGV4IGtleSI+CiAgICA8bGFiZWwgY2xhc3M9Im1vbm8iPnNpZ248L2xhYmVsPgogICAgPHNlbGVjdCBpZD0ibWV0YS1zaWduLXRvZ2dsZSI+PG9wdGlvbiB2YWx1ZT0ib24iIHNlbGVjdGVkPk9OPC9vcHRpb24+PG9wdGlvbiB2YWx1ZT0ib2ZmIj5PRkY8L29wdGlvbj48L3NlbGVjdD4KICA8L2Rpdj4KCiAgPHRhYmxlIGNsYXNzPSJtZXRhLXRhYmxlIiBpZD0ibWV0YS10YWJsZSIgc3R5bGU9Im1hcmdpbi10b3A6OHB4Ij4KICAgIDx0aGVhZD4KICAgICAgPHRyPjx0aD5BcnRpZmFjdDwvdGg+PHRoPlZhbHVlU2NvcmU8L3RoPjx0aD5MUEQ8L3RoPjx0aD5TdGF0dXM8L3RoPjx0aD5IYXNoPC90aD48L3RyPgogICAgPC90aGVhZD4KICAgIDx0Ym9keSBpZD0ibWV0YS10Ym9keSI+PC90Ym9keT4KICA8L3RhYmxlPgogIDxkaXYgY2xhc3M9Im1ldGEtcm93IiBzdHlsZT0ibWFyZ2luLXRvcDoxMHB4Ij4KICAgIDxidXR0b24gY2xhc3M9ImJ0biIgaWQ9ImJ0bi1wcm9tb3RlIj5Qcm9tb3RlIFJlbGVhc2U8L2J1dHRvbj48YnV0dG9uIGNsYXNzPSJidG4gc2Vjb25kYXJ5IiBpZD0iYnRuLWluZ2VzdCI+SW5nZXN0IFJlc3VsdHM8L2J1dHRvbj48YnV0dG9uIGNsYXNzPSJidG4gc2Vjb25kYXJ5IiBpZD0iYnRuLWFnZ3JlZ2F0ZSI+QWdncmVnYXRlIE5vdzwvYnV0dG9uPgogICAgPGJ1dHRvbiBjbGFzcz0iYnRuIHNlY29uZGFyeSIgaWQ9ImJ0bi1yZXRlc3QiPlRyaWdnZXIgUmUtVGVzdDwvYnV0dG9uPgogICAgPGJ1dHRvbiBjbGFzcz0iYnRuIHNlY29uZGFyeSIgaWQ9ImJ0bi1leHBvcnQiPkV4cG9ydCBFdmlkZW5jZTwvYnV0dG9uPgogIDwvZGl2PgogIDxwcmUgY2xhc3M9Im1vbm8iIGlkPSJtZXRhLWxvZyIgc3R5bGU9IndoaXRlLXNwYWNlOnByZS13cmFwO21heC1oZWlnaHQ6MTgwcHg7b3ZlcmZsb3c6YXV0bztiYWNrZ3JvdW5kOiMwYjEwMjA7Y29sb3I6I2QxZDVkYjtwYWRkaW5nOjEwcHg7Ym9yZGVyLXJhZGl1czo4cHg7bWFyZ2luLXRvcDoxMHB4Ij48L3ByZT4KPC9kaXY+Cgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICBjb25zdCAkID0gaWQgPT4gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOwogIGNvbnN0IGxvZyA9IG1zZyA9PiB7IGNvbnN0IGVsID0gJCgibWV0YS1sb2ciKTsgZWwudGV4dENvbnRlbnQgPSAobmV3IERhdGUoKS50b0lTT1N0cmluZygpKyIgIittc2crIlxuIikgKyBlbC50ZXh0Q29udGVudDsgfTsKCiAgYXN5bmMgZnVuY3Rpb24gZmV0Y2hKU09OKHVybCwgb3B0cyl7CiAgICBjb25zdCByID0gYXdhaXQgZmV0Y2godXJsLCBvcHRzfHx7fSk7CiAgICBpZighci5vayl7IHRocm93IG5ldyBFcnJvcihyLnN0YXR1cysiICIrYXdhaXQgci50ZXh0KCkpOyB9CiAgICByZXR1cm4gci5qc29uKCk7CiAgfQoKCiAgLy8gSE1BQyBoZWxwZXJzCiAgZnVuY3Rpb24gaGV4VG9CeXRlcyhoZXgpeyBjb25zdCBhPVtdOyBmb3IobGV0IGk9MDtpPGhleC5sZW5ndGg7aSs9Mil7IGEucHVzaChwYXJzZUludChoZXguc3Vic3RyKGksMiksMTYpKTsgfSByZXR1cm4gbmV3IFVpbnQ4QXJyYXkoYSk7IH0KICBmdW5jdGlvbiBieXRlc1RvSGV4KGJ1Zil7IHJldHVybiBBcnJheS5mcm9tKG5ldyBVaW50OEFycmF5KGJ1ZikpLm1hcChiPT5iLnRvU3RyaW5nKDE2KS5wYWRTdGFydCgyLCIwIikpLmpvaW4oIiIpOyB9CiAgZnVuY3Rpb24gc29ydEtleXMob2JqKXsKICAgIGlmKEFycmF5LmlzQXJyYXkob2JqKSkgcmV0dXJuIG9iai5tYXAoc29ydEtleXMpOwogICAgaWYob2JqICYmIHR5cGVvZiBvYmo9PT0ib2JqZWN0Iil7IGNvbnN0IG91dD17fTsgT2JqZWN0LmtleXMob2JqKS5zb3J0KCkuZm9yRWFjaChrPT4gb3V0W2tdPXNvcnRLZXlzKG9ialtrXSkpOyByZXR1cm4gb3V0OyB9CiAgICByZXR1cm4gb2JqOwogIH0KICBmdW5jdGlvbiBjYW5vbmljYWxKU09OKG9iail7IHJldHVybiBKU09OLnN0cmluZ2lmeShzb3J0S2V5cyhvYmopKTsgfQogIGFzeW5jIGZ1bmN0aW9uIGhtYWNTaGEyNTZIZXgoc2VjcmV0SGV4LCBjYW5vbmljYWwpewogICAgY29uc3Qga2V5ID0gYXdhaXQgY3J5cHRvLnN1YnRsZS5pbXBvcnRLZXkoInJhdyIsIGhleFRvQnl0ZXMoc2VjcmV0SGV4KSwge25hbWU6IkhNQUMiLCBoYXNoOiJTSEEtMjU2In0sIGZhbHNlLCBbInNpZ24iXSk7CiAgICBjb25zdCBzaWcgPSBhd2FpdCBjcnlwdG8uc3VidGxlLnNpZ24oIkhNQUMiLCBrZXksIG5ldyBUZXh0RW5jb2RlcigpLmVuY29kZShjYW5vbmljYWwpKTsKICAgIHJldHVybiBieXRlc1RvSGV4KHNpZyk7CiAgfQogIGFzeW5jIGZ1bmN0aW9uIHNpZ25lZEZldGNoKGJhc2VVcmwsIHBhdGgsIGJvZHksIGFjdGlvbil7CiAgICBjb25zdCBraWQgPSAoZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoIm1ldGEta2lkIil8fHt9KS52YWx1ZSB8fCAib3BzIjsKICAgIGNvbnN0IHNlY3JldCA9IChkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgibWV0YS1zZWNyZXQiKXx8e30pLnZhbHVlIHx8ICIiOwogICAgY29uc3Qgc2lnbk9uID0gKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCJtZXRhLXNpZ24tdG9nZ2xlIil8fHt9KS52YWx1ZSAhPT0gIm9mZiI7CiAgICBjb25zdCB0cyA9IE1hdGguZmxvb3IoRGF0ZS5ub3coKS8xMDAwKTsKICAgIGNvbnN0IG5vbmNlID0gdHMgKyAiLSIgKyBraWQ7CiAgICBjb25zdCByZXFCb2R5ID0gT2JqZWN0LmFzc2lnbih7fSwgYm9keSwgeyBraWQsIG5vbmNlLCB0cyB9KTsKICAgIGNvbnN0IGhlYWRlcnMgPSB7IkNvbnRlbnQtVHlwZSI6ImFwcGxpY2F0aW9uL2pzb24ifTsKICAgIGlmKHNpZ25Pbil7CiAgICAgIGlmKCFzZWNyZXQpIHRocm93IG5ldyBFcnJvcigiU2lnbmluZyBlbmFibGVkIGJ1dCBzZWNyZXQgaXMgZW1wdHkiKTsKICAgICAgY29uc3QgY2Fub25pY2FsID0gY2Fub25pY2FsSlNPTih7YWN0aW9uLCAuLi5ib2R5LCBub25jZSwgdHN9KTsKICAgICAgY29uc3Qgc2lnID0gYXdhaXQgaG1hY1NoYTI1NkhleChzZWNyZXQsIGNhbm9uaWNhbCk7CiAgICAgIGhlYWRlcnNbIlgtU2lnbmF0dXJlIl0gPSBgJHtraWR9OiR7c2lnfToke25vbmNlfToke3RzfWA7CiAgICB9CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChiYXNlVXJsLnJlcGxhY2UoL1wvJC8sJycpICsgcGF0aCwgeyBtZXRob2Q6IlBPU1QiLCBoZWFkZXJzLCBib2R5OiBKU09OLnN0cmluZ2lmeShyZXFCb2R5KSB9KTsKICAgIGlmKCFyZXMub2speyBjb25zdCB0ID0gYXdhaXQgcmVzLnRleHQoKTsgdGhyb3cgbmV3IEVycm9yKHJlcy5zdGF0dXMgKyAiICIgKyB0KTsgfQogICAgcmV0dXJuIHJlcy5qc29uKCk7CiAgfQoKICBhc3luYyBmdW5jdGlvbiByZWZyZXNoTWV0YSgpewogICAgdHJ5ewogICAgICBjb25zdCBiYXNlID0gKHdpbmRvdy5SQ1JBX0ZBU1RBUElfQkFTRSB8fCAiaHR0cDovL2xvY2FsaG9zdDo4MDAwIikucmVwbGFjZSgvXC8kLywgIiIpOwogICAgICBjb25zdCBqID0gYXdhaXQgZmV0Y2hKU09OKGJhc2UgKyAiL21ldGFfcHJvbW90aW9uL3N0YXR1cyIpOwogICAgICAkKCJtZXRhLXN0YXR1cyIpLnRleHRDb250ZW50ID0gai5vdmVyYWxsX3N0YXR1cyB8fCAiVU5LTk9XTiI7CiAgICAgICQoIm1ldGEtdXBkYXRlZCIpLnRleHRDb250ZW50ID0gai5sYXN0X3VwZGF0ZWQgfHwgIiI7CiAgICAgIGNvbnN0IHRoID0gai50aHJlc2hvbGRzIHx8IHt9OwogICAgICAkKCJtZXRhLXRocmVzaG9sZHMiKS50ZXh0Q29udGVudCA9IGB24omlJHt0aC52X21pbn0sIExQROKJpSR7dGgubHBkX21pbn0sIM+D4omkJHt0aC5zaWdtYV9tYXh9LCBk4omlJHt0aC5kZXB0aF9taW59YDsKICAgICAgY29uc3QgdGJvZHkgPSAkKCJtZXRhLXRib2R5Iik7IHRib2R5LmlubmVySFRNTCA9ICIiOwogICAgICAoai5hcnRpZmFjdHN8fFtdKS5mb3JFYWNoKGEgPT4gewogICAgICAgIGNvbnN0IHRyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidHIiKTsKICAgICAgICB0ci5pbm5lckhUTUwgPSBgPHRkPiR7YS5pZH08L3RkPjx0ZD4ke2EuVmFsdWVTY29yZT8udG9GaXhlZD8uKDIpID8/IGEuVmFsdWVTY29yZX08L3RkPjx0ZD4ke2EuTFBEPy50b0ZpeGVkPy4oMikgPz8gYS5MUER9PC90ZD48dGQ+JHthLnN0YXR1c308L3RkPjx0ZD4ke2EuaGFzaHx8IiJ9PC90ZD5gOwogICAgICAgIHRib2R5LmFwcGVuZENoaWxkKHRyKTsKICAgICAgfSk7CiAgICAgIGxvZygic3RhdHVzIHJlZnJlc2hlZCIpOwogICAgfWNhdGNoKGUpeyBsb2coIkVSUiByZWZyZXNoOiAiICsgZS5tZXNzYWdlKTsgfQogIH0KCiAgJCgiYnRuLXByb21vdGUiKS5hZGRFdmVudExpc3RlbmVyKCJjbGljayIsIGFzeW5jICgpPT57CiAgICB0cnl7CiAgICAgIGNvbnN0IGJhc2UgPSAod2luZG93LlJDUkFfRkFTVEFQSV9CQVNFIHx8ICJodHRwOi8vbG9jYWxob3N0OjgwMDAiKS5yZXBsYWNlKC9cLyQvLCAiIik7CiAgICAgIGNvbnN0IGJvZHkgPSB7IHBlcmltZXRlcl9pZDogInJlbGVhc2VfMjAyNV8wOCIsIHJlcXVlc3RlcjogInFhX2xlYWQiLCBub3RlOiAiQ29ja3BpdCBwcm9tb3RlIiB9OwogICAgICBjb25zdCByID0gYXdhaXQgc2lnbmVkRmV0Y2goYmFzZSwgIi9tZXRhX3Byb21vdGlvbi9wcm9tb3RlIiwgYm9keSwgInByb21vdGUiKTsKICAgICAgbG9nKCJwcm9tb3RlIOKGkiAiICsgSlNPTi5zdHJpbmdpZnkocikpOwogICAgICBhd2FpdCByZWZyZXNoTWV0YSgpOwogICAgfWNhdGNoKGUpeyBsb2coIkVSUiBwcm9tb3RlOiAiICsgZS5tZXNzYWdlKTsgfQogIH0pOwoKICAkKCJidG4tcmV0ZXN0IikuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBhc3luYyAoKT0+eyBsb2coInJlLXRlc3QgdHJpZ2dlcmVkIChzdHViKSIpOyB9KTsKICAkKCJidG4tZXhwb3J0IikuYWRkRXZlbnRMaXN0ZW5lcigiY2xpY2siLCBhc3luYyAoKT0+eyBsb2coImV4cG9ydCByZXF1ZXN0ZWQgKHN0dWIpIik7IH0pOwoKICAvLyBFeHBvc2UgYSBzaW1wbGUgd2F5IHRvIHNldCBiYXNlIFVSTCBmcm9tIG91dHNpZGUgKG9wdGlvbmFsKQogIHdpbmRvdy5zZXRSY3JhRmFzdGFwaUJhc2UgPSAodXJsKT0+eyB3aW5kb3cuUkNSQV9GQVNUQVBJX0JBU0UgPSB1cmw7IHJlZnJlc2hNZXRhKCk7IH07CgoKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYnRuLWluZ2VzdCIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgYXN5bmMgKCk9PnsKICAgIHRyeXsKICAgICAgY29uc3QgYmFzZSA9ICh3aW5kb3cuUkNSQV9GQVNUQVBJX0JBU0UgfHwgImh0dHA6Ly9sb2NhbGhvc3Q6ODAwMCIpLnJlcGxhY2UoL1wvJC8sICIiKTsKICAgICAgY29uc3QgcGF5bG9hZCA9IHsgcGVyaW1ldGVyX2lkOiAicmVsZWFzZV8yMDI1XzA4IiwgYXJ0aWZhY3RzOlsKICAgICAgICB7ImlkIjoiY29udHJhY3RfdjIubWQiLCJWYWx1ZVNjb3JlIjowLjkyLCJMUEQiOjEuNTIsInN0YXR1cyI6IlBBU1MiLCJoYXNoIjoiNGUxZjdjIn0sCiAgICAgICAgeyJpZCI6InBvbGljeS55YW1sIiwiVmFsdWVTY29yZSI6MC44OCwiTFBEIjoxLjM0LCJzdGF0dXMiOiJQQVNTIiwiaGFzaCI6ImE5YzJiMSJ9LAogICAgICAgIHsiaWQiOiJzdW1tYXJ5LnBkZiIsIlZhbHVlU2NvcmUiOjAuODMsIkxQRCI6MS4yOCwic3RhdHVzIjoiRkFJTCIsImhhc2giOiI2ZDRiMmEifQogICAgICBdfTsKICAgICAgY29uc3QgciA9IGF3YWl0IGZldGNoSlNPTihiYXNlICsgIi9tZXRhX3Byb21vdGlvbi9pbmdlc3QiLCB7bWV0aG9kOiJQT1NUIiwgaGVhZGVyczp7IkNvbnRlbnQtVHlwZSI6ImFwcGxpY2F0aW9uL2pzb24ifSwgYm9keTogSlNPTi5zdHJpbmdpZnkocGF5bG9hZCl9KTsKICAgICAgbG9nKCJpbmdlc3Qg4oaSICIgKyBKU09OLnN0cmluZ2lmeShyKSk7IGF3YWl0IHJlZnJlc2hNZXRhKCk7CiAgICB9Y2F0Y2goZSl7IGxvZygiRVJSIGluZ2VzdDogIiArIGUubWVzc2FnZSk7IH0KICB9KTsKICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgiYnRuLWFnZ3JlZ2F0ZSIpLmFkZEV2ZW50TGlzdGVuZXIoImNsaWNrIiwgYXN5bmMgKCk9PnsKICAgIHRyeXsKICAgICAgY29uc3QgYmFzZSA9ICh3aW5kb3cuUkNSQV9GQVNUQVBJX0JBU0UgfHwgImh0dHA6Ly9sb2NhbGhvc3Q6ODAwMCIpLnJlcGxhY2UoL1wvJC8sICIiKTsKICAgICAgY29uc3QgcGF5bG9hZCA9IHsgcGVyaW1ldGVyX2lkOiAicmVsZWFzZV8yMDI1XzA4IiwgYXJ0aWZhY3RzOlsKICAgICAgICB7ImlkIjoiY29udHJhY3RfdjIubWQiLCJvdXRwdXQiOiIuLi4iLCAiY29udGV4dF9pZCI6ImMxIn0sCiAgICAgICAgeyJpZCI6InBvbGljeS55YW1sIiwgICAgIm91dHB1dCI6Ii4uLiIsICJjb250ZXh0X2lkIjoiYzEifSwKICAgICAgICB7ImlkIjoic3VtbWFyeS5wZGYiLCAgICAib3V0cHV0IjoiLi4uIiwgImNvbnRleHRfaWQiOiJjMSJ9CiAgICAgIF19OwogICAgICBjb25zdCByID0gYXdhaXQgZmV0Y2hKU09OKGJhc2UgKyAiL21ldGFfcHJvbW90aW9uL2FnZ3JlZ2F0ZSIsIHttZXRob2Q6IlBPU1QiLCBoZWFkZXJzOnsiQ29udGVudC1UeXBlIjoiYXBwbGljYXRpb24vanNvbiJ9LCBib2R5OiBKU09OLnN0cmluZ2lmeShwYXlsb2FkKX0pOwogICAgICBsb2coImFnZ3JlZ2F0ZSDihpIgIiArIEpTT04uc3RyaW5naWZ5KHIpKTsgYXdhaXQgcmVmcmVzaE1ldGEoKTsKICAgIH1jYXRjaChlKXsgbG9nKCJFUlIgYWdncmVnYXRlOiAiICsgZS5tZXNzYWdlKTsgfQogIH0pOwoKICByZWZyZXNoTWV0YSgpOwp9KSgpOwo8L3NjcmlwdD4KCgo8ZGl2IGlkPSJkb2NJY29ucyIgc3R5bGU9InBvc2l0aW9uOmZpeGVkOyB0b3A6OHB4OyByaWdodDo4cHg7IGRpc3BsYXk6ZmxleDsgZ2FwOjhweDsgei1pbmRleDo5OTk5ODsgcG9pbnRlci1ldmVudHM6bm9uZTsiPgogIDxidXR0b24gaWQ9ImRvY0hlbHBJY29uIiBjbGFzcz0iYnRuIHRpbnkiIHRpdGxlPSJDb250ZXh0IEhlbHAgKFNoaWZ0Kz8pIiBhcmlhLWxhYmVsPSJDb250ZXh0IEhlbHAiIHN0eWxlPSJwb2ludGVyLWV2ZW50czphdXRvOyBvcGFjaXR5Oi45OyI+PzwvYnV0dG9uPgogIDxidXR0b24gaWQ9ImRvY0RvY3NJY29uIiBjbGFzcz0iYnRuIHRpbnkiIHRpdGxlPSJEb2NzIEluZGV4IiBhcmlhLWxhYmVsPSJEb2NzIEluZGV4IiBzdHlsZT0icG9pbnRlci1ldmVudHM6YXV0bzsgb3BhY2l0eTouOTsiPvCfk4Q8L2J1dHRvbj4KPC9kaXY+CjxzY3JpcHQ+KGZ1bmN0aW9uKCl7Y29uc3QgaD1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZG9jSGVscEljb24nKTtjb25zdCBkPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkb2NEb2NzSWNvbicpO2Z1bmN0aW9uIG9wZW5Eb2NzKGEpe3RyeXtwYXJlbnQucG9zdE1lc3NhZ2Uoe3R5cGU6J2RvY3M6b3BlbicsYW5jaG9yOmF8fCcjb3ZlcnZpZXcnfSwnKicpO31jYXRjaChfKXt9fWgmJmguYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLChlKT0+e2UucHJldmVudERlZmF1bHQoKTsgaWYod2luZG93Lm9wZW5Db250ZXh0RG9jcykgd2luZG93Lm9wZW5Db250ZXh0RG9jcygpOyBlbHNlIG9wZW5Eb2NzKCcjb3ZlcnZpZXcnKTt9KTsgZCYmZC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsKGUpPT57ZS5wcmV2ZW50RGVmYXVsdCgpOyBvcGVuRG9jcygnI292ZXJ2aWV3Jyk7fSk7fSkoKTs8L3NjcmlwdD4KCgo8c2NyaXB0PgooZnVuY3Rpb24oKXsKICBpZiAod2luZG93Ll9fQ1RYX0hFTFBfVjFfXykgcmV0dXJuOyB3aW5kb3cuX19DVFhfSEVMUF9WMV9fID0gdHJ1ZTsKICBmdW5jdGlvbiBpc1Zpc2libGUoZWwpeyBpZighZWwpIHJldHVybiBmYWxzZTsgY29uc3QgY3M9Z2V0Q29tcHV0ZWRTdHlsZShlbCk7IGlmKGNzLmRpc3BsYXk9PT0nbm9uZSd8fGNzLnZpc2liaWxpdHk9PT0naGlkZGVuJ3x8Y3Mub3BhY2l0eT09PScwJykgcmV0dXJuIGZhbHNlOyBjb25zdCByPWVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpOyByZXR1cm4gci53aWR0aD4wJiZyLmhlaWdodD4wOyB9CiAgZnVuY3Rpb24gJChzKXsgcmV0dXJuIGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3Iocyk7IH0gZnVuY3Rpb24gJGFsbChzKXsgcmV0dXJuIEFycmF5LmZyb20oZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChzKSk7IH0KICBmdW5jdGlvbiBnZXRDb250ZXh0QW5jaG9yKCl7CiAgICBjb25zdCB0YWdnZWQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1jb2NrcGl0LWNvbnRleHRdJyk7CiAgICBpZiAodGFnZ2VkKXsgY29uc3QgdiA9IHRhZ2dlZC5nZXRBdHRyaWJ1dGUoJ2RhdGEtY29ja3BpdC1jb250ZXh0Jyk7IGlmKC9eIyhvdmVydmlld3xwZWRhZ29neXxlY29ub21pY3N8Z292ZXJuYW5jZSkkLy50ZXN0KHYpKSByZXR1cm4gdjsgfQogICAgY29uc3QgZ292SGRyID0gJGFsbCgnaDEsaDIsaDMsLnNlY3Rpb24tdGl0bGUnKS5maW5kKGggPT4gL1BvbGljeVxzKkVkaXRvcnzPhHx0YXV8U0xSQ3xmbG9vcnMvaS50ZXN0KGgudGV4dENvbnRlbnR8fCcnKSk7IGlmIChnb3ZIZHIgJiYgaXNWaXNpYmxlKGdvdkhkcikpIHJldHVybiAnI2dvdmVybmFuY2UnOwogICAgY29uc3QgZWNvbkhpdCA9ICRhbGwoJ2gxLGgyLGgzLC5zZWN0aW9uLXRpdGxlLC5jYXJkIC50aXRsZSwjcm9jUGFuZWwnKS5maW5kKGggPT4gL1JPQ3x0aHJlc2hvbGR8a25lZXxwcm9maXR8TFBEfExHRC9pLnRlc3QoKGgudGV4dENvbnRlbnR8fCcnKSArICcgJyArIChoLmlkfHwnJykpKTsgaWYgKGVjb25IaXQgJiYgaXNWaXNpYmxlKGVjb25IaXQpKSByZXR1cm4gJyNlY29ub21pY3MnOwogICAgY29uc3Qgcmlza0VsID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignLnJpc2stdGFnJykgfHwgJGFsbCgnaDEsaDIsaDMsLnNlY3Rpb24tdGl0bGUnKS5maW5kKGggPT4gL1BlZGFnb2d5fFJpc2t8WlBEfFNjYWZmb2xkL2kudGVzdChoLnRleHRDb250ZW50fHwnJykpOyBpZiAocmlza0VsICYmIChyaXNrRWwuY2xhc3NMaXN0Py5jb250YWlucz8uKCdyaXNrLXRhZycpIHx8IGlzVmlzaWJsZShyaXNrRWwpKSkgcmV0dXJuICcjcGVkYWdvZ3knOwogICAgcmV0dXJuICcjb3ZlcnZpZXcnOwogIH0KICBmdW5jdGlvbiBvcGVuUGFyZW50KGFuY2hvcil7IHRyeXsgcGFyZW50LnBvc3RNZXNzYWdlKHt0eXBlOidkb2NzOm9wZW4nLCBhbmNob3I6YW5jaG9yfHwnI292ZXJ2aWV3J30sICcqJyk7IH1jYXRjaChfKXsgfSB9CiAgY29uc3QgaGVscEJ0biA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkb2NIZWxwSWNvbicpOyBjb25zdCBkb2NzQnRuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RvY0RvY3NJY29uJyk7CiAgaGVscEJ0biAmJiBoZWxwQnRuLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpPT57IGUucHJldmVudERlZmF1bHQoKTsgb3BlblBhcmVudChnZXRDb250ZXh0QW5jaG9yKCkpOyB9KTsKICBkb2NzQnRuICYmIGRvY3NCdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCAoZSk9PnsgZS5wcmV2ZW50RGVmYXVsdCgpOyBvcGVuUGFyZW50KCcjb3ZlcnZpZXcnKTsgfSk7CiAgd2luZG93Lm9wZW5Db250ZXh0RG9jcyA9IGZ1bmN0aW9uKCl7IG9wZW5QYXJlbnQoZ2V0Q29udGV4dEFuY2hvcigpKTsgfTsKICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigna2V5ZG93bicsIChlKT0+eyBpZihlLnNoaWZ0S2V5ICYmIGUua2V5PT09Jz8nKXsgZS5wcmV2ZW50RGVmYXVsdCgpOyBvcGVuUGFyZW50KGdldENvbnRleHRBbmNob3IoKSk7IH0gfSk7Cn0pKCk7Cjwvc2NyaXB0PgoKCjxkaXYgaWQ9ImFib3V0QnRuV3JhcCIgc3R5bGU9InBvc2l0aW9uOmZpeGVkOyB0b3A6OHB4OyByaWdodDo1NHB4OyB6LWluZGV4Ojk5OTk4OyI+CiAgPGJ1dHRvbiBpZD0iYWJvdXRPcGVuQnRuIiBjbGFzcz0iYnRuIHRpbnkiIHRpdGxlPSJBYm91dCAvIFByaWNpbmcgLyBQcm9vZiIgYXJpYS1sYWJlbD0iQWJvdXQgLyBQcmljaW5nIC8gUHJvb2YiIHN0eWxlPSJvcGFjaXR5Oi45OyI+QWJvdXQ8L2J1dHRvbj4KPC9kaXY+CgoKPGRpdiBpZD0iYWJvdXRQYW5lbCIgc3R5bGU9InBvc2l0aW9uOmZpeGVkOyB0b3A6MDsgcmlnaHQ6LTUyMHB4OyB3aWR0aDo1MDBweDsgaGVpZ2h0OjEwMHZoOyBiYWNrZ3JvdW5kOnZhcigtLWNhcmQsIzExMSk7IGNvbG9yOnZhcigtLXRleHQsI2VlZSk7IGJvcmRlci1sZWZ0OjFweCBzb2xpZCB2YXIoLS1ib3JkZXIsIzMzMyk7IGJveC1zaGFkb3c6LThweCAwIDI0cHggcmdiYSgwLDAsMCwuMjQpOyB0cmFuc2l0aW9uOnJpZ2h0IC4yNXMgZWFzZTsgei1pbmRleDo5OTk5NzsgZGlzcGxheTpmbGV4OyBmbGV4LWRpcmVjdGlvbjpjb2x1bW47Ij4KICA8ZGl2IHN0eWxlPSJkaXNwbGF5OmZsZXg7IGFsaWduLWl0ZW1zOmNlbnRlcjsganVzdGlmeS1jb250ZW50OnNwYWNlLWJldHdlZW47IHBhZGRpbmc6MTBweCAxMnB4OyBib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIsIzMzMyk7Ij4KICAgIDxzdHJvbmc+QWJvdXQ6IE1ldHJpY3MsIFByaWNpbmcgJiBQcm9vZjwvc3Ryb25nPgogICAgPGRpdj48YnV0dG9uIGNsYXNzPSJidG4gdGlueSIgaWQ9ImFib3V0Q2xvc2VCdG4iPkNsb3NlPC9idXR0b24+PC9kaXY+CiAgPC9kaXY+CiAgPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4OyBnYXA6NnB4OyBwYWRkaW5nOjhweCAxMHB4OyBib3JkZXItYm90dG9tOjFweCBzb2xpZCB2YXIoLS1ib3JkZXIsIzMzMyk7Ij4KICAgIDxidXR0b24gY2xhc3M9ImJ0biB0aW55IiBkYXRhLXN1YnRhYj0ib3ZlcnZpZXciPk92ZXJ2aWV3PC9idXR0b24+CiAgICA8YnV0dG9uIGNsYXNzPSJidG4gdGlueSIgZGF0YS1zdWJ0YWI9InBlZGFnb2d5Ij5QZWRhZ29neTwvYnV0dG9uPgogICAgPGJ1dHRvbiBjbGFzcz0iYnRuIHRpbnkiIGRhdGEtc3VidGFiPSJlY29ub21pY3MiPkVjb25vbWljczwvYnV0dG9uPgogIDwvZGl2PgogIDxkaXYgaWQ9ImFib3V0Q29udGVudCIgc3R5bGU9ImZsZXg6MTsgb3ZlcmZsb3c6YXV0bzsgcGFkZGluZzoxMnB4OyI+CiAgICA8c2VjdGlvbiBkYXRhLXRhYj0ib3ZlcnZpZXciPgogICAgICA8aDM+V2h5IHRoZXNlIG1ldHJpY3MgZXhpc3Q8L2gzPgogICAgICA8cD5XZSBqb2luIHBlZGFnb2d5IHF1YWxpdHkgd2l0aCBlY29ub21pYyBST0kgc28gZXZlcnkgcnVuIGlzIGJvdGggPGVtPmVkdWNhdGlvbmFsbHkgc291bmQ8L2VtPiBhbmQgPGVtPndvcnRoIHBheWluZyBmb3I8L2VtPi4gU2VlIHRoZSBJbnRlZ3JhdGlvbiBNYXAgaW5zaWRlIHRoZSBEb2NzIERyYXdlciBmb3IgdGhlIGZ1bGwgZmxvdy48L3A+CiAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbjo4cHggMDsiPjxidXR0b24gY2xhc3M9ImJ0biB0aW55IiBpZD0ib3BlbkRvY3NPdmVydmlldyI+T3BlbiBEb2NzIOKGkiBPdmVydmlldzwvYnV0dG9uPjwvZGl2PgogICAgICA8aHI+PGg0PlByaWNpbmcgKHNuYXBzaG90KTwvaDQ+CiAgICAgIDxkaXYgaWQ9InByaWNpbmdTbmFwc2hvdCIgY2xhc3M9ImdyaWQiIHN0eWxlPSJkaXNwbGF5OmdyaWQ7IGdyaWQtdGVtcGxhdGUtY29sdW1uczoxZnIgMWZyOyBnYXA6OHB4OyI+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZCIgc3R5bGU9InBhZGRpbmc6OHB4OyI+PGRpdiBjbGFzcz0idGlueSBtdXRlZCI+RGV2ZWxvcGVyPC9kaXY+PGRpdiBjbGFzcz0ic3RhdCIgaWQ9InByaWNlRGV2Ij4kOTkvbW8gKyAkMC4wMDUvZXZhbDwvZGl2PjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQiIHN0eWxlPSJwYWRkaW5nOjhweDsiPjxkaXYgY2xhc3M9InRpbnkgbXV0ZWQiPkVudGVycHJpc2U8L2Rpdj48ZGl2IGNsYXNzPSJzdGF0IiBpZD0icHJpY2VFbnQiPiQyLDUwMC9tbyArICQwLjAwMy9ldmFsPC9kaXY+PC9kaXY+CiAgICAgIDwvZGl2PgogICAgICA8cCBjbGFzcz0idGlueSBtdXRlZCI+T3ZlcnJpZGUgdmlhIFVSTCBwYXJhbXM6IDxjb2RlPj9kZXZfbW9udGg9MTI5JmRldl9ldmFsPTAuMDA2JmVudF9tb250aD0zNTAwJmVudF9ldmFsPTAuMDAyNTwvY29kZT48L3A+CiAgICAgIDxocj48aDQ+UHJvb2YgaG9va3M8L2g0PgogICAgICA8cD5HZW5lcmF0ZSBhbiBldmlkZW5jZSBidW5kbGUgZnJvbSB0aGUgY3VycmVudCBzZXNzaW9uICjPhCBmbG9vcnMsIG1ldHJpY3Mgc25hcHNob3QsIHRpbWVzdGFtcCksIGFuZCBvcHRpb25hbGx5IHB1c2ggYSBzaWduZWQgbWV0YS1wcm9tb3Rpb24gbWFya2VyIHVwc3RyZWFtLjwvcD4KICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTpmbGV4OyBnYXA6OHB4OyBmbGV4LXdyYXA6d3JhcDsiPjxidXR0b24gY2xhc3M9ImJ0biIgaWQ9ImJ0bkV2aWRlbmNlIj5HZW5lcmF0ZSBFdmlkZW5jZSBCdW5kbGU8L2J1dHRvbj48YnV0dG9uIGNsYXNzPSJidG4iIGlkPSJidG5QdWJsaXNoUHJvb2YiPk1ldGHigJFQcm9tb3Rpb246IFB1Ymxpc2ggUHJvb2Y8L2J1dHRvbj48L2Rpdj4KICAgICAgPGRpdiBpZD0icHJvb2ZTdGF0dXMiIGNsYXNzPSJ0aW55IG11dGVkIiBzdHlsZT0ibWFyZ2luLXRvcDo4cHg7Ij48L2Rpdj4KICAgIDwvc2VjdGlvbj4KICAgIDxzZWN0aW9uIGRhdGEtdGFiPSJwZWRhZ29neSIgc3R5bGU9ImRpc3BsYXk6bm9uZTsiPgogICAgICA8aDM+UGVkYWdvZ3k8L2gzPgogICAgICA8cD5SaXNrIG9wZXJhdG9ycyAoZS5nLiwgbWlz4oCRdGFyZ2V0ZWTigJFkaWZmaWN1bHR5LCBvdmVyL3VuZGVy4oCRc2NhZmZvbGQpIGFkanVzdCBWYWx1ZVNjb3JlIDxjb2RlPnY8L2NvZGU+IGJlZm9yZSBmbG9vcnMgYXJlIGFwcGxpZWQsIGVuc3VyaW5nIFpQRCBmaXQgYW5kIGxlYXJuaW5nIGludGVncml0eS48L3A+CiAgICAgIDx1bD48bGk+Q2xpY2sgcmlzayB0YWdzIGluIHRoZSBjb2NrcGl0IHRvIHNlZSBwcmltZXJzOyB1c2Ug4oCcUmVhZCBtb3Jl4oCdIHRvIGp1bXAgdG8gZG9jcy48L2xpPjxsaT5BbmNob3JzICYgZ29sZCB2ZWN0b3JzICh14piFKSBlc3RhYmxpc2ggb2JqZWN0aXZlIGFsaWdubWVudC48L2xpPjwvdWw+CiAgICAgIDxkaXYgc3R5bGU9Im1hcmdpbjo4cHggMDsiPjxidXR0b24gY2xhc3M9ImJ0biB0aW55IiBpZD0ib3BlbkRvY3NQZWRhZ29neSI+T3BlbiBEb2NzIOKGkiBQZWRhZ29neTwvYnV0dG9uPjwvZGl2PgogICAgPC9zZWN0aW9uPgogICAgPHNlY3Rpb24gZGF0YS10YWI9ImVjb25vbWljcyIgc3R5bGU9ImRpc3BsYXk6bm9uZTsiPgogICAgICA8aDM+RWNvbm9taWNzPC9oMz4KICAgICAgPHA+TFBEIChMb2dpY+KAkXBlcuKAkURvbGxhcikgY29tYmluZXMgVmFsdWVTY29yZSBhbmQgY29zdCwgbW9kZXJhdGVkIGJ5IExHRCAoTGVhcm5pbmcgR2Fpbi8kKS4gRmxvb3JzICjPhCkgZW5mb3JjZSByZWZ1bmRzIHdoZW4gdmFsdWUgZGlwcyBiZWxvdyB0aGUgdGhyZXNob2xkLjwvcD4KICAgICAgPGRpdiBzdHlsZT0iZGlzcGxheTpncmlkOyBncmlkLXRlbXBsYXRlLWNvbHVtbnM6MWZyIDFmcjsgZ2FwOjEwcHg7IG1hcmdpbjo4cHggMDsiPgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQiIHN0eWxlPSJwYWRkaW5nOjhweDsiPjxkaXYgY2xhc3M9InRpbnkgbXV0ZWQiPs+ELnZfbWluPC9kaXY+PGRpdiBpZD0idGF1X3YiIGNsYXNzPSJzdGF0Ij7igJQ8L2Rpdj48L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSJjYXJkIiBzdHlsZT0icGFkZGluZzo4cHg7Ij48ZGl2IGNsYXNzPSJ0aW55IG11dGVkIj7PhC5scGRfbWluPC9kaXY+PGRpdiBpZD0idGF1X2xwZCIgY2xhc3M9InN0YXQiPuKAlDwvZGl2PjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQiIHN0eWxlPSJwYWRkaW5nOjhweDsiPjxkaXYgY2xhc3M9InRpbnkgbXV0ZWQiPs+ELnNpZ21hX21heDwvZGl2PjxkaXYgaWQ9InRhdV9zaWdtYSIgY2xhc3M9InN0YXQiPuKAlDwvZGl2PjwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQiIHN0eWxlPSJwYWRkaW5nOjhweDsiPjxkaXYgY2xhc3M9InRpbnkgbXV0ZWQiPs+ELmRlcHRoX21pbjwvZGl2PjxkaXYgaWQ9InRhdV9kZXB0aCIgY2xhc3M9InN0YXQiPuKAlDwvZGl2PjwvZGl2PgogICAgICA8L2Rpdj4KICAgICAgPGRpdiBzdHlsZT0ibWFyZ2luOjhweCAwOyI+PGJ1dHRvbiBjbGFzcz0iYnRuIHRpbnkiIGlkPSJvcGVuRG9jc0Vjb25vbWljcyI+T3BlbiBEb2NzIOKGkiBFY29ub21pY3M8L2J1dHRvbj48L2Rpdj4KICAgIDwvc2VjdGlvbj4KICA8L2Rpdj4KPC9kaXY+CgoKPHNjcmlwdD4KKGZ1bmN0aW9uKCl7CiAgaWYgKHdpbmRvdy5fX0FCT1VUX0NUUkxfXykgcmV0dXJuOyB3aW5kb3cuX19BQk9VVF9DVFJMX18gPSB0cnVlOwogIGNvbnN0IHBhbmVsPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhYm91dFBhbmVsJyksIG9wZW5CdG49ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Fib3V0T3BlbkJ0bicpLCBjbG9zZUJ0bj1kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYWJvdXRDbG9zZUJ0bicpOwogIGNvbnN0IHRhYnM9QXJyYXkuZnJvbShkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCdbZGF0YS1zdWJ0YWJdJykpLCBzZWN0aW9ucz1BcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJyNhYm91dENvbnRlbnQgW2RhdGEtdGFiXScpKTsKICBmdW5jdGlvbiBzZXRUYWIobil7IHNlY3Rpb25zLmZvckVhY2gocz0+IHMuc3R5bGUuZGlzcGxheSA9IChzLmdldEF0dHJpYnV0ZSgnZGF0YS10YWInKT09PW4/J2Jsb2NrJzonbm9uZScpKTsgdGFicy5mb3JFYWNoKHQ9PiB0LmNsYXNzTGlzdC50b2dnbGUoJ2FjdGl2ZScsIHQuZ2V0QXR0cmlidXRlKCdkYXRhLXN1YnRhYicpPT09bikpOyB9CiAgZnVuY3Rpb24gb3BlbigpeyBwYW5lbC5zdHlsZS5yaWdodD0nMCc7IH0gZnVuY3Rpb24gY2xvc2UoKXsgcGFuZWwuc3R5bGUucmlnaHQ9Jy01MjBweCc7IH0gc2V0VGFiKCdvdmVydmlldycpOwogIG9wZW5CdG4mJm9wZW5CdG4uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLChlKT0+e2UucHJldmVudERlZmF1bHQoKTtvcGVuKCk7fSk7IGNsb3NlQnRuJiZjbG9zZUJ0bi5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsKGUpPT57ZS5wcmV2ZW50RGVmYXVsdCgpO2Nsb3NlKCk7fSk7IHRhYnMuZm9yRWFjaCh0PT4gdC5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsKCk9PiBzZXRUYWIodC5nZXRBdHRyaWJ1dGUoJ2RhdGEtc3VidGFiJykpKSk7IHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdrZXlkb3duJywoZSk9PnsgaWYoZS5rZXk9PT0nRXNjYXBlJykgY2xvc2UoKTsgfSk7CgogIC8vIFByaWNpbmcgdmlhIFVSTCBwYXJhbXMKICBmdW5jdGlvbiBxKGssZil7IHRyeXtjb25zdCB1PW5ldyBVUkwod2luZG93LmxvY2F0aW9uLmhyZWYpOyByZXR1cm4gdS5zZWFyY2hQYXJhbXMuZ2V0KGspfHxmO31jYXRjaChfKXtyZXR1cm4gZjt9IH0KICBjb25zdCBkZXZNb250aD1wYXJzZUZsb2F0KHEoJ2Rldl9tb250aCcsJzk5JykpLCBkZXZFdmFsPXBhcnNlRmxvYXQocSgnZGV2X2V2YWwnLCcwLjAwNScpKSwgZW50TW9udGg9cGFyc2VGbG9hdChxKCdlbnRfbW9udGgnLCcyNTAwJykpLCBlbnRFdmFsPXBhcnNlRmxvYXQocSgnZW50X2V2YWwnLCcwLjAwMycpKTsKICBjb25zdCBEPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmljZURldicpLCBFPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdwcmljZUVudCcpOyBpZihEKSBELnRleHRDb250ZW50PWAkJHtkZXZNb250aH0vbW8gKyAkJHtkZXZFdmFsfS9ldmFsYDsgaWYoRSkgRS50ZXh0Q29udGVudD1gJCR7ZW50TW9udGh9L21vICsgJCR7ZW50RXZhbH0vZXZhbGA7CgogIC8vIM+EIGZyb20gcGFyZW50CiAgY29uc3QgdGF1PXt2X21pbjon4oCUJyxscGRfbWluOifigJQnLHNpZ21hX21heDon4oCUJyxkZXB0aF9taW46J+KAlCd9OyBmdW5jdGlvbiByKCl7IGNvbnN0IG09KGlkLHYpPT57Y29uc3QgZWw9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoaWQpOyBpZihlbCkgZWwudGV4dENvbnRlbnQ9djt9OyBtKCd0YXVfdicsdGF1LnZfbWluKTsgbSgndGF1X2xwZCcsdGF1LmxwZF9taW4pOyBtKCd0YXVfc2lnbWEnLHRhdS5zaWdtYV9tYXgpOyBtKCd0YXVfZGVwdGgnLHRhdS5kZXB0aF9taW4pOyB9IHIoKTsKICB0cnl7IHBhcmVudC5wb3N0TWVzc2FnZSh7dHlwZTondGF1OnJlcXVlc3QnfSwgJyonKTsgfWNhdGNoKF8pe30KICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsKGUpPT57Y29uc3QgZD1lJiZlLmRhdGE7IGlmKCFkKSByZXR1cm47IGlmKGQudHlwZT09PSd0YXU6cmVzcG9uc2UnJiZkLmZsb29ycyl7T2JqZWN0LmFzc2lnbih0YXUsZC5mbG9vcnMpOyByKCk7fX0pOwoKICAvLyBFdmlkZW5jZSArIHB1Ymxpc2gKICBmdW5jdGlvbiBkb3dubG9hZChmbix0eHQpeyBjb25zdCBhPWRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsgYS5ocmVmPVVSTC5jcmVhdGVPYmplY3RVUkwobmV3IEJsb2IoW3R4dF0se3R5cGU6J2FwcGxpY2F0aW9uL2pzb24nfSkpOyBhLmRvd25sb2FkPWZuOyBhLmNsaWNrKCk7IHNldFRpbWVvdXQoKCk9PlVSTC5yZXZva2VPYmplY3RVUkwoYS5ocmVmKSw4MDApOyB9CiAgZnVuY3Rpb24gbm93KCl7IHRyeXtyZXR1cm4gbmV3IERhdGUoKS50b0lTT1N0cmluZygpO31jYXRjaChfKXtyZXR1cm4gU3RyaW5nKERhdGUubm93KCkpO30gfQogIGZ1bmN0aW9uIHQoZWwpeyByZXR1cm4gZWwgPyBlbC50ZXh0Q29udGVudC50cmltKCkgOiAn4oCUJzsgfQogIGZ1bmN0aW9uIHNuYXAoKXsgcmV0dXJuIHsgdDogbm93KCksIHRhdTp7Li4udGF1fSwgbWV0cmljczp7IHZfYXZnOnQoZG9jdW1lbnQucXVlcnlTZWxlY3RvcignW2RhdGEtZG9jPVwiZWNvbm9taWNzI3ZcIl0nKSksIGxwZF9hdmc6dChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1kb2M9XCJlY29ub21pY3MjbHBkXCJdJykpLCBzaWdtYV9hdmc6dChkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCdbZGF0YS1kb2M9XCJlY29ub21pY3Mjc2lnbWFcIl0nKSkgfSwgcHJpY2luZzp7ZGV2TW9udGgsZGV2RXZhbCxlbnRNb250aCxlbnRFdmFsfSB9OyB9CiAgY29uc3QgZXY9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2J0bkV2aWRlbmNlJyksIHBiPWRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdidG5QdWJsaXNoUHJvb2YnKSwgcHM9ZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3Byb29mU3RhdHVzJyk7CiAgZXYmJmV2LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywoKT0+eyBjb25zdCBkYXRhPXNuYXAoKTsgZG93bmxvYWQoJ2V2aWRlbmNlX2J1bmRsZS5qc29uJywgSlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDIpKTsgcHMmJihwcy50ZXh0Q29udGVudD0nRXZpZGVuY2UgYnVuZGxlIGdlbmVyYXRlZC4nKTsgfSk7CiAgcGImJnBiLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywoKT0+eyBjb25zdCBkYXRhPXNuYXAoKTsgbGV0IG9rPWZhbHNlOyB0cnl7IHBhcmVudC5wb3N0TWVzc2FnZSh7dHlwZTonbWV0YTpwdWJsaXNoJywgcGF5bG9hZDpkYXRhfSwgJyonKTsgb2s9dHJ1ZTsgfWNhdGNoKF8peyB9IHBzJiYocHMudGV4dENvbnRlbnQgPSBvayA/ICdQdWJsaXNoIHJlcXVlc3Qgc2VudCB0byBwYXJlbnQuJyA6ICdGYWlsZWQgdG8gc2VuZCBwdWJsaXNoIHJlcXVlc3QuJyk7IH0pOwoKICAvLyBEb2Mgc2hvcnRjdXRzCiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ29wZW5Eb2NzT3ZlcnZpZXcnKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCgpPT57IHRyeXsgcGFyZW50LnBvc3RNZXNzYWdlKHt0eXBlOidkb2NzOm9wZW4nLCBhbmNob3I6JyNvdmVydmlldyd9LCAnKicpOyB9Y2F0Y2goXyl7IH0gfSk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ29wZW5Eb2NzUGVkYWdvZ3knKT8uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCgpPT57IHRyeXsgcGFyZW50LnBvc3RNZXNzYWdlKHt0eXBlOidkb2NzOm9wZW4nLCBhbmNob3I6JyNwZWRhZ29neSd9LCAnKicpOyB9Y2F0Y2goXyl7IH0gfSk7CiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ29wZW5Eb2NzRWNvbm9taWNzJyk/LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywoKT0+eyB0cnl7IHBhcmVudC5wb3N0TWVzc2FnZSh7dHlwZTonZG9jczpvcGVuJywgYW5jaG9yOicjZWNvbm9taWNzJ30sICcqJyk7IH1jYXRjaChfKXsgfSB9KTsKfSkoKTsKPC9zY3JpcHQ+Cgo8L2JvZHk+PC9odG1sPgo=" ></iframe>
      
<div id="cockpitInlineHost" style="display:none;"></div>
</div>
    </section>

    <section id="docs-metrics" class="grid">
      <div class="card">
        <h2>Docs → Metrics</h2>
        <p class="muted">Investor-ready documentation for pedagogy-backed ROI and governance.</p>
        <div class="cta" style="gap:10px; display:flex; flex-wrap:wrap;">
          <a class="btn" href="docs/metrics/README.md" target="_blank">Open README.md</a>
          <a class="btn" href="docs/metrics/integration_map.svg" target="_blank">View Integration Map</a>
          <a class="btn" href="../docs_metrics_bundle.zip" target="_blank">Download Bundle (.zip)</a>
        </div>
      </div>
    </section>
    
  </main>

  <footer class="container tiny">
    Built as a demo mockup page. Drop this folder onto any static host (GitHub Pages, Netlify, S3) to serve.
  </footer>

  <script>
    // Margin-weighted knee option
    function computeKnee(metric, steps) {
      if (!window.traces || window.traces.length === 0) return null;
      const vals = window.traces.map(t => t[metric]).filter(v => typeof v === 'number');
      const minV = Math.min(...vals), maxV = Math.max(...vals);
      const thrList = Array.from({length: steps}, (_,i)=> minV + (i/(steps-1))*(maxV-minV));

      const useMargin = document.getElementById('useMarginModel')?.checked;
      const R = parseFloat(document.getElementById('revPerAccept')?.value || '1.0');
      const C = parseFloat(document.getElementById('costPerReject')?.value || '0.5');

      let best = { thr: null, score: -Infinity, tpr:0, fpr:1, accept:0, refund:1 };
      thrList.forEach(thr => {
        let tp=0, fp=0, tn=0, fn=0;
        for (const t of window.traces) {
          const predPass = (t[metric] >= thr);
          const actualPass = !t.refund;
          if (predPass && actualPass) tp++;
          else if (predPass && !actualPass) fp++;
          else if (!predPass && !actualPass) tn++;
          else fn++;
        }
        const total = window.traces.length || 1;
        const accept = (tp+fp)/total;
        const reject = (tn+fn)/total;

        const baseScore = accept - reject;
        const marginScore = (R * accept) - (C * reject);
        const score = useMargin ? marginScore : baseScore;

        const tpr = (tp + fn) ? tp/(tp+fn) : 0;
        const fpr = (fp + tn) ? fp/(fp+tn) : 0;
        if (score > best.score) best = { thr, score, tpr, fpr, accept, refund: reject, R, C, useMargin };
      });
      return best;
    }

    // Update readout to show margin model details
    if (typeof btnSuggestKnee !== 'undefined' && btnSuggestKnee) {
      btnSuggestKnee.addEventListener('click', () => {
        const metric = document.getElementById('rocMetric').value;
        const steps = Math.max(10, Math.min(100, parseInt(document.getElementById('rocSteps').value || '25',10)));
        const knee = computeKnee(metric, steps);
        if (!knee || !isFinite(knee.thr)) {
          kneeReadout.textContent = 'No knee suggestion (insufficient traces).';
          suggestedKnee = null;
          return;
        }
        suggestedKnee = { metric, ...knee };
        if (knee.useMargin) {
          kneeReadout.textContent = `Knee (${metric}) ≈ ${metric==='lpd' ? knee.thr.toFixed(2) : knee.thr.toFixed(3)} | score=R*accept−C*reject=${knee.score.toFixed(3)} (R=${knee.R}, C=${knee.C}) · TPR=${knee.tpr.toFixed(2)} FPR=${knee.fpr.toFixed(2)} Accept=${(knee.accept*100).toFixed(0)}% Reject=${(knee.refund*100).toFixed(0)}%`;
        } else {
          kneeReadout.textContent = `Knee (${metric}) ≈ ${metric==='lpd' ? knee.thr.toFixed(2) : knee.thr.toFixed(3)} | score=accept−reject=${knee.score.toFixed(3)} · TPR=${knee.tpr.toFixed(2)} FPR=${knee.fpr.toFixed(2)} Accept=${(knee.accept*100).toFixed(0)}% Reject=${(knee.refund*100).toFixed(0)}%`;
        }
        // visualize proposed floor as current
        if (metric === 'lpd') currentFloors.lpd_min = knee.thr;
        else currentFloors.v_min = knee.thr;
        renderSparkline();
        renderHistogram();
      });
    }

    // --- Bridge to Cockpit iframe ---
    (function(){
      const frame = document.getElementById('cockpitFrame');
      const run = document.getElementById('bridgeRun');
      const save = document.getElementById('bridgePolicySave');
      const pdf = document.getElementById('bridgePDF');
      function send(msg){ if(frame && frame.contentWindow) frame.contentWindow.postMessage(msg, '*'); }
      run?.addEventListener('click', ()=> send({ type:'cockpit:run' }));
      save?.addEventListener('click', ()=> send({ type:'cockpit:policy:save' }));
      pdf?.addEventListener('click', ()=> send({ type:'cockpit:pdf' }));
      window.addEventListener('message', (e)=>{
        if (!e || !e.data) return;
        if (e.data.type === 'cockpit:ack') {
          console.log('Cockpit ack:', e.data.action);
        }
      });
    })();

  </script>
<script>
    // --- Pro Mode Toggle ---
    (function(){
      const proSwitch = document.getElementById('proModeSwitch');
      const cockpitFrame = document.getElementById('cockpitFrame');
      proSwitch?.addEventListener('change', ()=>{
        cockpitFrame.style.display = proSwitch.checked ? 'block' : 'none';
      });
    })();

    // --- State sync: send traces & policy to cockpit on Pro Mode ON ---
    function getAnchorTraces(){ return window.anchorTraces || []; }
    function getAnchorPolicy(){ return window.anchorPolicy || ''; }

    (function(){
      const cockpitFrame = document.getElementById('cockpitFrame');
      const proSwitch = document.getElementById('proModeSwitch');
      function sendState(){
        if (cockpitFrame && cockpitFrame.contentWindow){
          cockpitFrame.contentWindow.postMessage({ 
            type: 'anchor:state',
            traces: getAnchorTraces(),
            policy: getAnchorPolicy()
          }, '*');
        }
      }
      proSwitch?.addEventListener('change', ()=>{ if(proSwitch.checked) setTimeout(sendState, 500); });
      window.updateAnchorState = sendState;
    })();

    // --- Telemetry hooks ---
    function sendTelemetry(event, payload){
      fetch('/telemetry', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({event, payload, ts: new Date().toISOString()})
      }).catch(()=>{});
    }
    window.addEventListener('message', (e)=>{
      if (!e || !e.data) return;
      const d = e.data;
      if (d.type === 'cockpit:metric:update'){
        sendTelemetry('metric', d);
      } else if (d.type === 'cockpit:policy:update'){
        sendTelemetry('policy_update', d);
      }
    });
</script><script>
    // --- Pro Mode gate + State Sync + Telemetry Bridge ---
    (function(){
      const proToggle = document.getElementById('proModeToggle');
      const gate = document.getElementById('cockpitGate');
      const controls = document.getElementById('cockpitControls');
      const iframe = document.getElementById('cockpitFrame');
      const tUrl = document.getElementById('telemetryUrl');
      const tStatus = document.getElementById('telemetryStatus');

      function setGate(on){
        if (on) {
          gate.textContent = 'Pro Mode is ON.';
          controls.style.display = '';
          iframe.style.display = '';
          // Kick state sync after slight delay (allow iframe to boot)
          setTimeout(syncStateToCockpit, 600);
        } else {
          gate.textContent = 'Pro Mode is OFF. Toggle it to load cockpit and sync state.';
          controls.style.display = 'none';
          iframe.style.display = 'none';
        }
      }

      proToggle?.addEventListener('change', (e)=> setGate(!!e.target.checked));
      // Restore from localStorage
      try { const saved = localStorage.getItem('proMode'); if (saved === '1'){ proToggle.checked = true; } } catch(_){}
      setGate(!!proToggle?.checked);

      async function fetchText(url){ const res = await fetch(url); return await res.text(); }
      async function fetchJSONL(url){
        const res = await fetch(url); const text = await res.text();
        return text.trim().split('\n').filter(Boolean).map(line => JSON.parse(line));
      }

      async function syncStateToCockpit(){
        if (!iframe?.contentWindow) return;
        // try to gather anchor policy & traces; fallback to local files if present
        let policy = '';
        let traces = [];
        try { policy = await fetchText('policy.yaml'); } catch(_){}
        try { traces = await fetchJSONL('sample_traces.jsonl'); } catch(_){}

        // send
        iframe.contentWindow.postMessage({ type: 'state:sync', policy, traces }, '*');
      }

      // Telemetry bridge: child -> parent -> fetch to endpoint
      window.addEventListener('message', async (e)=> {
        const d = e?.data; if (!d) return;
        if (d.type === 'telemetry') {
          const endpoint = tUrl?.value?.trim();
          if (!endpoint) { console.log('Telemetry (no endpoint set):', d.event, d.data); return; }
          try {
            const res = await fetch(endpoint, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ts: new Date().toISOString(), event: d.event, data: d.data })
            });
            tStatus.textContent = res.ok ? 'sent ✓' : ('error ' + res.status);
            setTimeout(()=> tStatus.textContent = '', 2000);
          } catch (err) {
            tStatus.textContent = 'send failed';
            console.warn('Telemetry send failed', err);
          }
        } else if (d.type === 'cockpit:policy:updated') {
          // Optionally mirror to anchor (if anchor has its own editor, update it here)
          console.log('Policy updated in cockpit:', (d.policy||'').slice(0,80));
        } else if (d.type === 'cockpit:metrics') {
          console.log('Metrics from cockpit:', d.metrics);
        }
      });

      // Persist pro mode & telemetry URL
      try {
        if (tUrl) {
          const saved = localStorage.getItem('telemetryUrl'); if (saved) tUrl.value = saved;
          tUrl.addEventListener('change', ()=> localStorage.setItem('telemetryUrl', tUrl.value));
        }
        proToggle?.addEventListener('change', ()=> localStorage.setItem('proMode', proToggle.checked ? '1':'0'));
      } catch(_){}
    })();
</script>
<script>
(function(){
  const env = document.getElementById('envSwitch');
  const tUrl = document.getElementById('telemetryUrl');
  const ping = document.getElementById('btnTelemetryPing');
  const tStatus = document.getElementById('telemetryStatus');

  const endpoints = {
    dev: 'https://dev.telemetry.local/ingest',
    stage: 'https://stage.telemetry.local/ingest',
    prod: 'https://prod.telemetry.yourdomain.com/ingest'
  };

  function applyEnv() {
    const val = env?.value || 'dev';
    if (endpoints[val]) {
      tUrl.value = endpoints[val];
      try { localStorage.setItem('telemetryUrl', tUrl.value); } catch(_){}
    }
  }
  env?.addEventListener('change', applyEnv);
  applyEnv();

  ping?.addEventListener('click', async () => {
    const url = tUrl?.value?.trim();
    if (!url) return;
    try {
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ts:new Date().toISOString(), event:'ping', data:{} }) });
      tStatus.textContent = res.ok ? 'ping ✓' : ('ping error ' + res.status);
      setTimeout(()=> tStatus.textContent='', 2000);
    } catch(err) {
      tStatus.textContent = 'ping failed';
    }
  });

  // Back-sync reception: traces/policy updates from cockpit
  window.addEventListener('message', (e) => {
    const d = e?.data; if (!d) return;
    if (d.type === 'cockpit:policy:updated') {
      console.log('Anchor got updated policy (len):', (d.policy||'').length);
    } else if (d.type === 'cockpit:policy:reset') {
      console.log('Anchor policy reset to original.');
    } else if (d.type === 'cockpit:traces:updated') {
      console.log('Anchor got updated traces (n):', (d.traces||[]).length);
    }
  });
})();
</script>

<script>
    (function(){
      const frame = document.getElementById('cockpitFrame');
      const resetTau = document.getElementById('bridgeResetTau');
      const tUrl = document.getElementById('telemetryUrl');
      const btnTest = document.getElementById('btnTelemetryTest');
      const envSel = document.getElementById('envSwitch');
      const tStatus = document.getElementById('telemetryStatus');

      function send(msg){ if(frame && frame.contentWindow) frame.contentWindow.postMessage(msg, '*'); }

      // Reset τ
      resetTau?.addEventListener('click', ()=> send({ type:'cockpit:reset_tau' }));

      // Telemetry Test Ping
      btnTest?.addEventListener('click', async ()=>{
        const endpoint = tUrl?.value?.trim();
        if (!endpoint) { alert('Set a Telemetry URL first'); return; }
        try {
          const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ts: new Date().toISOString(), event: 'test_ping', data: { hello: 'world' } })
          });
          tStatus.textContent = res.ok ? 'test ✓' : ('test error ' + res.status);
          setTimeout(()=> tStatus.textContent = '', 2000);
        } catch (e) {
          tStatus.textContent = 'test failed';
          console.warn('Telemetry test failed', e);
        }
      });

      // Environment switcher presets
      const PRESETS = {
        dev: { telemetry: 'https://telemetry.dev.local/ingest', api: 'https://api.dev.local' },
        stage: { telemetry: 'https://telemetry.stage.local/ingest', api: 'https://api.stage.local' },
        prod: { telemetry: 'https://telemetry.yourdomain.com/ingest', api: 'https://api.yourdomain.com' }
      };
      envSel?.addEventListener('change', ()=>{
        const p = PRESETS[envSel.value];
        if (p) {
          if (tUrl) tUrl.value = p.telemetry;
          // send api base to cockpit
          send({ type:'env:update', apiBase: p.api });
          try { localStorage.setItem('envPreset', envSel.value); localStorage.setItem('telemetryUrl', p.telemetry); } catch(_){}
        }
      });
      // Restore env preset
      try {
        const savedEnv = localStorage.getItem('envPreset');
        if (savedEnv && envSel) {
          envSel.value = savedEnv;
          const evt = new Event('change'); envSel.dispatchEvent(evt);
        }
      } catch(_){}
    })();
</script><script>
    (function(){
      window.addEventListener('message', (e)=>{
        const d = e?.data; if (!d) return;
        if (d.type === 'state:update') {
          try {
            if (d.policy) localStorage.setItem('policy.cached', d.policy);
            if (Array.isArray(d.traces)) localStorage.setItem('traces.cached', JSON.stringify(d.traces));
          } catch(_){}
        }
      });
    })();
</script><script>
    // ---- Chips, Export/Import, Telemetry wiring ----
    (function(){
      // Utility
      function getEl(id){ return document.getElementById(id); }
      function getTelemetryUrl(){ return (getEl('telemetryUrl') && getEl('telemetryUrl').value.trim()) || ''; }
      function sendTelemetry(event, data){
        const url = getTelemetryUrl();
        if (!url) return;
        fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ts: new Date().toISOString(), event, data }) }).catch(()=>{});
      }
      function download(filename, text){
        const blob = new Blob([text], {type: 'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = filename; a.click(); URL.revokeObjectURL(url);
      }
      function parseFloorsFromPolicy(text){
        const mv = (text||'').match(/v_min:\s*([0-9.]+)/);
        const ml = (text||'').match(/lpd_min:\s*([0-9.]+)/);
        return { v_min: mv ? parseFloat(mv[1]) : null, lpd_min: ml ? parseFloat(ml[1]) : null };
      }
      function updateEnvChip(){
        const envSel = getEl('envSwitch');
        const chip = getEl('chipEnv');
        if (!chip || !envSel) return;
        const val = envSel.value || 'dev';
        chip.textContent = 'Env: ' + val;
        chip.classList.remove('env-dev','env-stage','env-prod');
        chip.classList.add('env-' + val);
        sendTelemetry('env_chip_update', { env: val });
      }
      function updateTauChips(policyText){
        const { v_min, lpd_min } = parseFloorsFromPolicy(policyText||'');
        const vEl = getEl('chipVmin'), lEl = getEl('chipLPDmin');
        const vRec = 0.840, lRec = 1.30;
        if (vEl){
          vEl.textContent = 'τ v_min: ' + (v_min===null ? '—' : v_min.toFixed(3));
          vEl.classList.remove('good','warn'); 
          if (v_min===null){/*noop*/} else { vEl.classList.add(v_min>=vRec ? 'good':'warn'); }
        }
        if (lEl){
          lEl.textContent = 'τ lpd_min: ' + (lpd_min===null ? '—' : lpd_min.toFixed(2));
          lEl.classList.remove('good','warn'); 
          if (lpd_min===null){/*noop*/} else { lEl.classList.add(lpd_min>=lRec ? 'good':'warn'); }
        }
        sendTelemetry('floors_chip_update', { v_min, lpd_min });
      }
      function policyCached(){ try { return localStorage.getItem('policy.cached') || ''; } catch(_){ return ''; } }
      function tracesCached(){ try { const raw = localStorage.getItem('traces.cached'); return raw ? JSON.parse(raw) : []; } catch(_){ return []; } }
      function setPolicyCached(text){ try { localStorage.setItem('policy.cached', text||''); } catch(_){ } }
      function setTracesCached(arr){ try { localStorage.setItem('traces.cached', JSON.stringify(arr||[])); } catch(_){ } }
      function postToCockpit(msg){
        const frame = getEl('cockpitFrame');
        if (frame && frame.contentWindow) frame.contentWindow.postMessage(msg, '*');
      }

      // Initial chip state
      try { updateEnvChip(); } catch(_){}
      try { updateTauChips(policyCached()); } catch(_){}

      // Listen for env changes (already wired, we just piggyback)
      const envSel = getEl('envSwitch');
      envSel && envSel.addEventListener('change', updateEnvChip);

      // Listen for back-sync from cockpit to refresh chips and cache
      window.addEventListener('message', (e)=>{
        const d = e?.data; if (!d) return;
        if (d.type === 'state:update') {
          if (typeof d.policy === 'string') { setPolicyCached(d.policy); updateTauChips(d.policy); }
          if (Array.isArray(d.traces)) { setTracesCached(d.traces); }
        } else if (d.type === 'cockpit:policy:updated') {
          if (typeof d.policy === 'string') { setPolicyCached(d.policy); updateTauChips(d.policy); }
        } else if (d.type === 'telemetry' && d.event === 'tau_reset') {
          // After reset tau, refresh chips from cached policy (already updated by cockpit)
          updateTauChips(policyCached());
        }
      });

      // EXPORTS
      getEl('btnExportPolicy')?.addEventListener('click', async ()=>{
        let text = policyCached();
        if (!text) {
          try { text = await (await fetch('policy.yaml')).text(); } catch(_){}
        }
        if (!text) text = '# (no policy found)\n';
        download('policy.yaml', text);
        sendTelemetry('policy_export', { bytes: text.length });
      });
      getEl('btnExportTraces')?.addEventListener('click', async ()=>{
        let arr = tracesCached();
        if (!arr.length){
          try { const txt = await (await fetch('sample_traces.jsonl')).text(); arr = txt.trim().split('\n').filter(Boolean).map(line => JSON.parse(line)); } catch(_){}
        }
        const text = arr.map(o => JSON.stringify(o)).join('\n') + '\n';
        download('traces.jsonl', text);
        sendTelemetry('traces_export', { n: arr.length });
      });

      // IMPORTS
      const filePol = getEl('fileImportPolicy');
      const fileTr = getEl('fileImportTraces');
      getEl('btnImportPolicy')?.addEventListener('click', ()=> filePol && filePol.click());
      getEl('btnImportTraces')?.addEventListener('click', ()=> fileTr && fileTr.click());

      filePol && filePol.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          const text = String(reader.result||'');
          setPolicyCached(text);
          updateTauChips(text);
          postToCockpit({ type: 'state:sync', policy: text });
          sendTelemetry('policy_import', { bytes: text.length, name: f.name });
        };
        reader.readAsText(f);
        e.target.value = '';
      });

      fileTr && fileTr.addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0]; if (!f) return;
        const reader = new FileReader();
        reader.onload = () => {
          const raw = String(reader.result||'');
          const lines = raw.split('\n');
          const arr = [];
          let bad = 0;
          for (const line of lines){
            const s = line.trim(); if (!s) continue;
            try { arr.push(JSON.parse(s)); } catch(_){ bad++; }
          }
          setTracesCached(arr);
          postToCockpit({ type: 'state:sync', traces: arr });
          sendTelemetry('traces_import', { n: arr.length, bad });
        };
        reader.readAsText(f);
        e.target.value = '';
      });

    })();
</script>
<script>
(function(){
  const navBtn = document.getElementById('btnExportPolicyNav');
  const headerBtn = document.getElementById('btnExportPolicy');
  navBtn && headerBtn && navBtn.addEventListener('click', ()=> headerBtn.click());
})();
</script>


<script>
(function(){
  const toggleBtn = document.getElementById('toggleImportExport');
  const panel = document.getElementById('importExportControls');
  if (toggleBtn && panel) {
    toggleBtn.addEventListener('click', ()=>{
      const show = panel.style.display === 'none';
      panel.style.display = show ? 'flex' : 'none';
      toggleBtn.textContent = show ? 'Hide Policy & Traces Controls' : 'Show Policy & Traces Controls';
    });
  }

  const navBtn = document.getElementById('btnExportPolicyNav');
  const headerBtn = document.getElementById('btnExportPolicy');
  if (navBtn && headerBtn) navBtn.addEventListener('click', ()=> headerBtn.click());
})();
</script>





<!-- Docs Drawer -->
<div id="docsDrawer" style="position:fixed; top:0; right:-460px; width:420px; height:100vh; background:var(--card); border-left:1px solid var(--border); box-shadow:-8px 0 24px rgba(0,0,0,.24); transition:right .25s ease; z-index:9999; display:flex; flex-direction:column;">
  <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border);">
    <strong>Docs</strong>
    <div style="display:flex; gap:8px; align-items:center;">
      <select id="docsSection" class="btn tiny" style="padding:6px 8px;">
        <option value="#overview">Overview</option>
        <option value="#pedagogy">Pedagogy</option>
        <option value="#economics">Economics</option>
        <option value="#governance">Governance</option>
      </select>
      <button class="btn tiny" id="docsClose">Close</button>
    </div>
  </div>
  <div id="docsContent" style="flex:1; overflow:auto; padding:12px;"></div>
</div>


<script>
// --- Lightweight Docs Drawer + Markdown Render ---
(function(){
  const drawer = document.getElementById('docsDrawer');
  const content = document.getElementById('docsContent');
  const sectionSel = document.getElementById('docsSection');
  const btnClose = document.getElementById('docsClose');
  const MD_URL = 'docs/metrics/README.md';
  const MAP_URL = 'docs/metrics/integration_map.svg';

  function mdToHtml(md){
    // ultra-light renderer (headings, bold, italics, code, links, lists)
    let h = md
      .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    h = h.replace(/^### (.*)$/gm, '<h3>$1</h3>')
         .replace(/^## (.*)$/gm, '<h2>$1</h2>')
         .replace(/^# (.*)$/gm, '<h1>$1</h1>')
         .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
         .replace(/\*(.+?)\*/g, '<em>$1</em>')
         .replace(/`([^`]+)`/g, '<code class="kbd">$1</code>')
         .replace(/\n- (.+)/g, '<ul><li>$1</li></ul>')
         .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank">$1</a>')
         .replace(/\n{2,}/g, '</p><p>');
    return '<p>' + h + '</p>';
  }

  async function loadDocs(anchor){
    try {
      const res = await fetch(MD_URL);
      const txt = await res.text();
      let html = mdToHtml(txt);
      // Inline the integration map where the image is referenced
      html = html.replace(/<img[^ loading="lazy decoding="async"]*Integration Map[^>]*>/i, `<div style="margin:8px 0;"><object type="image/svg+xml" data="${MAP_URL}" style="width:100%; height:auto; border:1px solid var(--border); border-radius:8px;"></object></div>`);
      content.innerHTML = html;
      if (anchor && typeof anchor === 'string') {
        const el = content.querySelector(anchor);
        if (el) el.scrollIntoView({behavior:'smooth', block:'start'});
      }
    } catch (e) {
      content.innerHTML = '<p class="muted">Could not load docs.</p>';
    }
  }

  function openDrawer(anchor){
    drawer.style.right = '0';
    if (anchor) {
      // update selector if matches
      if (sectionSel) {
        const base = anchor.split('#')[1] ? ('#' + anchor.split('#')[1]) : anchor;
        const opt = Array.from(sectionSel.options).find(o => o.value === base);
        if (opt) sectionSel.value = base;
      }
    }
    loadDocs(anchor);
  }
  function closeDrawer(){ drawer.style.right = '-460px'; }

  window.openDocsDrawer = openDrawer;

  btnClose && btnClose.addEventListener('click', closeDrawer);
  sectionSel && sectionSel.addEventListener('change', ()=> openDrawer(sectionSel.value));

  // Close on ESC
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') closeDrawer(); });

  // Optional: expose a help opener for external callers
  window.openHelpFor = function(section){ openDrawer(section || '#overview'); };
})();
</script>


<script>
// --- Terse Popovers for metrics / risks / tau help chips ---
(function(){
  let tip, tipBody, tipLink;
  function ensureTip(){
    if (tip) return;
    tip = document.createElement('div');
    tip.style.position = 'fixed';
    tip.style.maxWidth = '360px';
    tip.style.background = 'var(--card)';
    tip.style.border = '1px solid var(--border)';
    tip.style.borderRadius = '10px';
    tip.style.padding = '10px 12px';
    tip.style.boxShadow = '0 8px 24px rgba(0,0,0,.24)';
    tip.style.zIndex = 10000;
    tip.style.display = 'none';
    tipBody = document.createElement('div');
    tipBody.className = 'tiny';
    tipLink = document.createElement('div');
    tipLink.style.marginTop = '8px';
    tip.appendChild(tipBody);
    tip.appendChild(tipLink);
    document.body.appendChild(tip);
  }

  const PRIMERS = {
    'economics#lpd': {
      title:'LPD — Logic-per-Dollar',
      body:'What: single scalar of epistemic value per unit cost. Why: ensures you only pay for useful reasoning. How: ValueScore (cosine to u★) divided by run cost; adjusted by LGD.',
    },
    'economics#lgd': {
      title:'LGD — Learning Gain per Dollar',
      body:'What: learning improvement per cost. Why: protects ROI even when v is stable. How: ∆competency / cost, folded into LPD as a multiplier/floor.',
    },
    'economics#v': {
      title:'v — ValueScore',
      body:'What: semantic fidelity to u★. Why: anchors correctness to SME truth. How: cosine(u, u★) minus baseline, penalized by risks.',
    },
    'economics#sigma': {
      title:'σ — Variance',
      body:'What: stability of outcomes. Why: guards against flaky reasoning. How: rolling stddev across runs; enforced with σ_max floor.',
    },
    'governance#tau': {
      title:'τ — Floors (SLRC)',
      body:'What: minimum acceptable thresholds. Why: deterministic refunds and safety. How: YAML floors (v_min, lpd_min, σ_max, d_min) tuned via ROC.',
    },
    'pedagogy#mis-targeted-difficulty': {
      title:'Pedagogy Risk: mis-targeted-difficulty',
      body:'Example: content pitched too high/low for ZPD → value collapse. Mitigation: adjust scaffolding; penalized in v.',
    }
  };

  function showTip(target, key){
    ensureTip();
    const p = PRIMERS[key];
    if (!p) return;
    tipBody.innerHTML = '<strong>' + p.title + '</strong><br>' + p.body;
    tipLink.innerHTML = '<a href="#" class="btn tiny" id="tipReadMore">Read more →</a>';
    const rect = target.getBoundingClientRect();
    tip.style.left = Math.min(rect.left, window.innerWidth - 380) + 'px';
    tip.style.top = (rect.bottom + 6) + 'px';
    tip.style.display = 'block';
    const link = document.getElementById('tipReadMore');
    link.onclick = (e)=>{ e.preventDefault(); window.openDocsDrawer('#' + key.split('#')[1]); hideTip(); };
  }
  function hideTip(){ if (tip) tip.style.display = 'none'; }

  function bind(selector, key){
    document.querySelectorAll(selector).forEach(el => {
      const on = ()=> showTip(el, key);
      const off = hideTip;
      el.addEventListener('mouseenter', on);
      el.addEventListener('mouseleave', off);
      el.addEventListener('click', (e)=>{ e.preventDefault(); on(); });
    });
  }

  window.bindDocPopovers = function(){
    // Metric labels
    bind('[data-doc="economics#lpd"]', 'economics#lpd');
    bind('[data-doc="economics#lgd"]', 'economics#lgd');
    bind('[data-doc="economics#v"]', 'economics#v');
    bind('[data-doc="economics#sigma"]', 'economics#sigma');
    bind('[data-doc="governance#tau"]', 'governance#tau');
    // Risk tags (if present)
    bind('.risk-tag[data-doc]', 'pedagogy#mis-targeted-difficulty');
  };
})();
</script>


<script>
document.addEventListener('DOMContentLoaded', function(){
  if (window.bindDocPopovers) window.bindDocPopovers();
});
</script>


<script>
// Parent listener: open docs drawer when child (cockpit) requests it
window.addEventListener('message', (e)=>{
  try {
    const d = e && e.data; if (!d) return;
    if (d.type === 'docs:open') {
      if (window.openDocsDrawer) window.openDocsDrawer(d.anchor || '#overview');
    }
  } catch(_) {}
});
</script>


<style>
  .rcra-panel{border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin:10px 0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .rcra-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .rcra-row label{font-size:12px;color:#475569}
  .rcra-row input, .rcra-row select{padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px}
  .rcra-btn{padding:8px 10px;border:1px solid #0ea5e9;border-radius:8px;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
  .rcra-btn.secondary{background:#fff;color:#0ea5e9}
  .rcra-chip{display:inline-block;padding:4px 8px;border-radius:9999px;background:#f1f5f9;margin-left:6px}
  .rcra-tiles{display:flex;gap:12px;flex-wrap:wrap}
  .rcra-tile{flex:1 0 200px;border:1px solid #e2e8f0;border-radius:10px;padding:10px}
  .rcra-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
</style>

<div class="rcra-panel" id="rcra-governance-panel">
  <div class="rcra-row">
    <strong>Governance Pro Controls</strong>
    <span class="rcra-chip" id="rcra-status">idle</span>
  </div>
  <div class="rcra-row">
    <label>Environment</label>
    <select id="rcra-env">
      <option value="custom">Custom</option>
      <option value="local">Local (FastAPI:8000, Express:8001)</option>
      <option value="docker">Docker (same host)</option>
    </select>
    <label>FastAPI Base URL</label><input id="rcra-fastapi" size="30" placeholder="http://localhost:8000">
    <label>Express Base URL</label><input id="rcra-express" size="30" placeholder="http://localhost:8001">
  </div>
  <div class="rcra-row">
    <label>Sign requests</label>
    <select id="rcra-sign-toggle">
      <option value="on" selected>ON</option>
      <option value="off">OFF</option>
    </select>
    <label>kid</label><input id="rcra-kid" value="ops" size="8">
    <label>secret (hex)</label><input id="rcra-secret" size="68" placeholder="paste hex key from config/keys.json">
  </div>

  <div class="rcra-row">
    <label>Floors</label>
    <input id="rcra-vmin" type="number" step="0.01" value="0.85" title="v_min">
    <input id="rcra-lmin" type="number" step="0.01" value="1.35" title="lpd_min">
    <input id="rcra-smax" type="number" step="0.01" value="0.21" title="sigma_max">
    <input id="rcra-dmin" type="number" step="1" value="3" title="depth_min">
    <button class="rcra-btn" id="rcra-propose">Propose</button>
    <button class="rcra-btn secondary" id="rcra-approve">Approve</button>
  </div>

  <div class="rcra-row rcra-tiles">
    <div class="rcra-tile">
      <div>Canary Pass Rate (session)</div>
      <div class="rcra-mono"><span id="rcra-passrate">—</span>%</div>
    </div>
    <div class="rcra-tile">
      <div>Canary Failures (session)</div>
      <div class="rcra-mono"><span id="rcra-fails">0</span></div>
    </div>
    <div class="rcra-tile">
      <div>τ Floors now</div>
      <div class="rcra-mono" id="rcra-floors-now">—</div>
    </div>
  </div>

  <div class="rcra-row">
    <button class="rcra-btn" id="rcra-run-canaries">Run all canaries now</button>
    <span class="rcra-mono" id="rcra-canary-status"></span>
  </div>

  <pre class="rcra-mono" id="rcra-log" style="white-space:pre-wrap;max-height:220px;overflow:auto;background:#0b1020;color:#d1d5db;padding:10px;border-radius:8px"></pre>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const log = (msg)=>{ const el = $("rcra-log"); el.textContent = (new Date().toISOString() + " " + msg + "\\n") + el.textContent; };

  // Presets
  const envSel = $("rcra-env");
  const fapi = $("rcra-fastapi");
  const expr = $("rcra-express");
  envSel.addEventListener("change", ()=>{
    if(envSel.value==="local"){
      fapi.value = "http://localhost:8000"; expr.value = "http://localhost:8001";
    } else if(envSel.value==="docker"){
      fapi.value = window.location.origin.replace(/:\\d+$/,'') + ":8000";
      expr.value = window.location.origin.replace(/:\\d+$/,'') + ":8001";
    }
  });
  envSel.dispatchEvent(new Event("change"));

  // HMAC helpers
  function hexToBytes(hex){ const a=[]; for(let i=0;i<hex.length;i+=2){ a.push(parseInt(hex.substr(i,2),16)); } return new Uint8Array(a); }
  function bytesToHex(buf){ return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); }
  function sortKeys(obj){
    if(Array.isArray(obj)) return obj.map(sortKeys);
    if(obj && typeof obj === "object"){
      const out = {};
      Object.keys(obj).sort().forEach(k=> out[k]=sortKeys(obj[k]));
      return out;
    }
    return obj;
  }
  function canonicalJSON(obj){
    // Sorted keys, compact separators
    return JSON.stringify(sortKeys(obj));
  }
  async function hmacSha256Hex(secretHex, canonical){
    const key = await crypto.subtle.importKey("raw", hexToBytes(secretHex), {name:"HMAC", hash:"SHA-256"}, false, ["sign"]);
    const sig = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(canonical));
    return bytesToHex(sig);
  }

  async function signedFetch(baseUrl, path, body, action){
    const signOn = $("rcra-sign-toggle").value === "on";
    const kid = $("rcra-kid").value.trim();
    const secret = $("rcra-secret").value.trim();
    const ts = Math.floor(Date.now()/1000);
    const nonce = ts + "-" + kid;

    const reqBody = Object.assign({}, body, { kid, nonce, ts });
    const headers = {"Content-Type":"application/json"};

    if(signOn){
      if(!kid || !secret){ throw new Error("Signing ON but kid/secret missing"); }
      const canonical = canonicalJSON({action, floors: body.floors, nonce, ts});
      const sig = await hmacSha256Hex(secret, canonical);
      headers["X-Signature"] = `${kid}:${sig}:${nonce}:${ts}`;
    }
    const res = await fetch(baseUrl.replace(/\/$/,'') + path, { method:"POST", headers, body: JSON.stringify(reqBody) });
    if(!res.ok){ const t = await res.text(); throw new Error(res.status + " " + t); }
    return res.json();
  }

  async function refreshFloors(){
    try{
      const res = await fetch(fapi.value.replace(/\/$/,'') + "/policy/floors");
      const j = await res.json();
      $("rcra-floors-now").textContent = JSON.stringify(j);
      $("rcra-status").textContent = "floors:ok";
    }catch(e){
      $("rcra-floors-now").textContent = "n/a";
      $("rcra-status").textContent = "floors:err";
    }
  }

  $("rcra-propose").addEventListener("click", async ()=>{
    try{
      const floors = {
        v_min: parseFloat($("rcra-vmin").value),
        lpd_min: parseFloat($("rcra-lmin").value),
        sigma_max: parseFloat($("rcra-smax").value),
        depth_min: parseInt($("rcra-dmin").value,10),
      };
      const r = await signedFetch(fapi.value, "/policy/floors?action=propose", {floors}, "propose");
      log("propose → " + JSON.stringify(r));
      await refreshFloors();
    }catch(e){ log("propose ERR: " + e.message); }
  });

  $("rcra-approve").addEventListener("click", async ()=>{
    try{
      const floors = {
        v_min: parseFloat($("rcra-vmin").value),
        lpd_min: parseFloat($("rcra-lmin").value),
        sigma_max: parseFloat($("rcra-smax").value),
        depth_min: parseInt($("rcra-dmin").value,10),
      };
      const r = await signedFetch(fapi.value, "/policy/floors?action=approve", {floors}, "approve");
      log("approve → " + JSON.stringify(r));
      await refreshFloors();
    }catch(e){ log("approve ERR: " + e.message); }
  });

  // Canary session stats
  let sessionRuns=0, sessionPass=0, sessionFail=0;
  function updateTiles(){
    const passRate = sessionRuns ? Math.round(10000*sessionPass/sessionRuns)/100 : 0;
    $("rcra-passrate").textContent = isNaN(passRate) ? "—" : passRate.toString();
    $("rcra-fails").textContent = sessionFail.toString();
  }

  $("rcra-run-canaries").addEventListener("click", async ()=>{
    $("rcra-canary-status").textContent = "running…";
    try{
      const listRes = await fetch(fapi.value.replace(/\/$/,'') + "/canary/list");
      const j = await listRes.json();
      const names = j.names || [];
      for(const name of names){
        try{
          const r = await fetch(fapi.value.replace(/\/$/,'') + "/canary/run?name=" + encodeURIComponent(name), {method:"POST"});
          const jr = await r.json();
          sessionRuns += 1;
          if(jr.pass) sessionPass += 1; else sessionFail += 1;
          log(`canary ${name} → ${jr.pass ? "PASS" : "FAIL"}`);
        }catch(e){ log(`canary ${name} ERR: ${e.message}`); }
      }
    }catch(e){ log("list ERR: " + e.message); }
    updateTiles();
    $("rcra-canary-status").textContent = "done";
  });

  refreshFloors();
})();
</script>



<style>
  .rcra-toggle { display:flex; gap:10px; align-items:center; padding:6px 8px; margin:8px 0; }
  .rcra-toggle label { font-size:12px; color:#475569; }
  .rcra-why { border:1px solid #e2e8f0; border-radius:10px; padding:12px; margin:10px 0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial }
  .rcra-why h3 { margin:0 0 6px 0; }
</style>

<div class="rcra-why" id="rcra-why">
  <div class="rcra-toggle">
    <label><input type="radio" name="rcraMode" value="investor" checked> Investor</label>
    <label><input type="radio" name="rcraMode" value="tech"> Tech/Governance</label>
  </div>
  <div id="rcra-why-content">
    <h3>Why This Matters — Investor View</h3>
<p>This experience demonstrates an AI product with measurable value creation and user trust. It translates model performance into business outcomes and reduces risk via governance.</p>
<ul>
  <li><strong>Upside:</strong> Higher conversion and retention with better answers.</li>
  <li><strong>Downside Protection:</strong> Automatic refunds and policy floors cap risk.</li>
  <li><strong>Proof:</strong> Live dashboards and audits for diligence.</li>
</ul>
  </div>
</div>
<script>
(function(){
  var content = document.getElementById('rcra-why-content');
  var investorHTML = `<h3>Why This Matters — Investor View</h3>
<p>This experience demonstrates an AI product with measurable value creation and user trust. It translates model performance into business outcomes and reduces risk via governance.</p>
<ul>
  <li><strong>Upside:</strong> Higher conversion and retention with better answers.</li>
  <li><strong>Downside Protection:</strong> Automatic refunds and policy floors cap risk.</li>
  <li><strong>Proof:</strong> Live dashboards and audits for diligence.</li>
</ul>`;
  var techHTML = `<h3>Why This Matters — Technical & Governance</h3>
<p>Focus on <strong>epistemic integrity</strong> with runtime enforcement and observability.</p>
<ul>
  <li><strong>SLRC Enforcement:</strong> Outputs gated by Secure Logic Reasoning Contracts.</li>
  <li><strong>ROC-Tuned Floors:</strong> τ thresholds optimized on live distributions.</li>
  <li><strong>Multisig & HMAC:</strong> Floor changes require cryptographic approvals.</li>
  <li><strong>Continuous Assurance:</strong> Canary pass-rate & failure tiles backed by Prometheus.</li>
  <li><strong>Ops-Ready:</strong> Containerized services, alerts, and audit artifacts.</li>
</ul>`;
  Array.prototype.forEach.call(document.querySelectorAll('input[name="rcraMode"]'), function(r){ 
    r.addEventListener('change', function(){ 
      content.innerHTML = (r.value === 'tech') ? techHTML : investorHTML; 
    });
  });
})();
</script>


<script>
(function(){
  function getParam(name){
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }
  const mode = getParam("mode");
  if(mode && mode.toLowerCase() === "tech"){
    const techRadio = document.querySelector('input[name="rcraMode"][value="tech"]');
    if(techRadio){
      techRadio.checked = true;
      const event = new Event('change');
      techRadio.dispatchEvent(event);
    }
  }
})();
</script>


<script>
(function(){
  if (window.__DOCS_LOADER_PATCHED__) return; window.__DOCS_LOADER_PATCHED__ = true;
  const BASE = 'docs/metrics';
  const MD_URL = BASE + '/README.md';
  const MAP_SVG = BASE + '/integration_map.svg';
  const drawer = document.getElementById('docsDrawer');
  const content = document.getElementById('docsContent');
  const sel = document.getElementById('docsSection');
  const closeBtn = document.getElementById('docsClose');

  function mdToHtml(md){
    let h = md.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    h = h.replace(/^### (.*)$/gm, '<h3>$1</h3>').replace(/^## (.*)$/gm, '<h2>$1</h2>').replace(/^# (.*)$/gm, '<h1>$1</h1>');
    h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\*(.+?)\*/g, '<em>$1</em>').replace(/`([^`]+)`/g, '<code class="kbd">$1</code>');
    h = h.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank">$1</a>').replace(/(?:^|\n)- (.+)(?=\n|$)/g, function(_, item){ return '\\n<ul><li>'+item+'</li></ul>'; });
    h = '<p>' + h.replace(/\\n{2,}/g, '</p><p>') + '</p>';
    if (!/integration_map\\.(svg|png)/i.test(h)) { h = h.replace('<p>', '<p><div id="__map_here__"></div>'); }
    else { h = h.replace(/<img[^>]*integration_map\\.(png|svg)[^>]*>/i, '<div id="__map_here__"></div>'); }
    return h;
  }

  function ensureAnchors(container){
    ['overview','pedagogy','economics','governance','lpd','lgd','v','sigma','tau'].forEach(id =>{
      if (!container.querySelector('#'+id)){
        const a = document.createElement('div'); a.id = id; a.style.height='1px';
        container.insertBefore(a, container.firstChild);
      }
    });
  }

  async function loadDocs(anchor){
    if (!drawer || !content) return;
    try{
      const res = await fetch(MD_URL);
      const txt = await res.text();
      content.innerHTML = mdToHtml(txt);
      const holder = content.querySelector('#__map_here__') || content;
      const wrap = document.createElement('div');
      wrap.style.margin = '8px 0';
      wrap.innerHTML = '<object type="image/svg+xml" data="'+MAP_SVG+'" style="width:100%;height:auto;border:1px solid var(--border,#333);border-radius:8px;"></object>';
      holder.parentNode.insertBefore(wrap, holder.nextSibling);
      ensureAnchors(content);
      const selAnchor = (anchor && (anchor.startsWith('#') ? anchor : '#'+anchor)) || '#overview';
      const el = content.querySelector(selAnchor);
      if (el) el.scrollIntoView({behavior:'smooth', block:'start'});
    }catch(e){
      content.innerHTML = '<p class="muted">Could not load documentation.</p>';
    }
  }

  window.openDocsDrawer = function(anchor){
    if (!drawer) return;
    drawer.style.right = '0';
    if (sel && anchor){
      const base = anchor.startsWith('#') ? anchor : '#'+anchor;
      const opt = Array.from(sel.options).find(o => o.value === base);
      if (opt) sel.value = base;
    }
    loadDocs(anchor || '#overview');
  };
  window.closeDocsDrawer = function(){ if (drawer) drawer.style.right = '-460px'; };
  closeBtn && closeBtn.addEventListener('click', window.closeDocsDrawer);
  sel && sel.addEventListener('change', ()=> window.openDocsDrawer(sel.value));
  window.addEventListener('keydown', (e)=>{ if (e.key==='Escape') window.closeDocsDrawer(); });

  // Parent-side listener to open drawer when iframe asks
  window.addEventListener('message', (e)=>{
    const d = e && e.data; if (!d) return;
    if (d.type === 'docs:open'){ window.openDocsDrawer(d.anchor || '#overview'); }
  });
})();
</script>


<script>
(function(){
  if (window.__POPOVER_BINDED__) return; window.__POPOVER_BINDED__ = true;
  let tip;
  function ensure(){
    if (tip) return;
    tip = document.createElement('div');
    tip.style.position='fixed'; tip.style.maxWidth='360px';
    tip.style.background='var(--card,#111)'; tip.style.border='1px solid var(--border,#333)';
    tip.style.borderRadius='10px'; tip.style.padding='10px 12px';
    tip.style.boxShadow='0 8px 24px rgba(0,0,0,.24)'; tip.style.zIndex=10000; tip.style.display='none'; tip.style.color='var(--text,#eee)';
    tip.innerHTML = '<div class="tiny" id="pvBody"></div><div style="margin-top:8px"><a href="#" class="btn tiny" id="pvMore">Read more →</a></div>';
    document.body.appendChild(tip);
  }
  const PRIMERS = {
    'economics#lpd': {t:'LPD — Logic-per-Dollar', b:'What: value per unit cost. Why: ties correctness to efficiency. How: ValueScore × LGD ÷ cost; floor: τ.lpd_min.'},
    'economics#lgd': {t:'LGD — Learning Gain per Dollar', b:'What: learning improvement per cost. Why: rewards durable gains. How: ∆competency ÷ cost; used as multiplier/floor.'},
    'economics#v':   {t:'v — ValueScore', b:'What: alignment to truth anchors (u★). Why: objective correctness. How: cosine(u, u★), risk-penalized.'},
    'economics#sigma': {t:'σ — Variance', b:'What: stability of runs. Why: prevents flaky value. How: rolling stddev; constrained by τ.sigma_max.'},
    'governance#tau': {t:'τ — Floors (SLRC)', b:'What: minimum thresholds that trigger refunds. Why: enforceable guarantees. How: floors v_min, lpd_min, sigma_max, depth_min (ROC-tuned).'},
    'pedagogy#mis-targeted-difficulty': {t:'Pedagogy: mis-targeted-difficulty', b:'What: content too hard/easy for ZPD. Why: collapses value. How: detected by operators; penalizes v.'}
  };
  function show(el,key){
    ensure();
    const p = PRIMERS[key]; if (!p) return;
    const body = document.getElementById('pvBody'); const more = document.getElementById('pvMore');
    body.innerHTML = '<strong>'+p.t+'</strong><br>'+p.b;
    const r = el.getBoundingClientRect();
    tip.style.left = Math.min(r.left, window.innerWidth - 380) + 'px';
    tip.style.top = (r.bottom + 6) + 'px';
    tip.style.display = 'block';
    more.onclick = (e)=>{ e.preventDefault(); if (window.openDocsDrawer) window.openDocsDrawer('#'+key.split('#')[1]); tip.style.display='none'; };
  }
  function hide(){ if (tip) tip.style.display='none'; }
  function bindOne(el){ const key = el.getAttribute('data-doc'); if (!key) return;
    el.addEventListener('mouseenter', ()=> show(el,key));
    el.addEventListener('mouseleave', hide);
    el.addEventListener('click', (e)=>{ e.preventDefault(); show(el,key); });
  }
  function bindAll(){ document.querySelectorAll('[data-doc]').forEach(bindOne); }
  if (document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', bindAll); }
  else { bindAll(); }
  setTimeout(bindAll, 400);
  window.addEventListener('keydown', (e)=>{ if (e.key==='Escape') hide(); });
})();
</script>


<script>
(function(){
  if (window.__PARENT_TAU__) return; window.__PARENT_TAU__ = true;
  function readTauFromChips(){
    const floor = { v_min:'—', lpd_min:'—', sigma_max:'—', depth_min:'—' };
    const txt = document.body.innerText || '';
    const m = (re)=> (txt.match(re)||[])[1];
    try {
      floor.v_min   = m(/v[_ ]?min[:\s]+([0-9.]+)/i)    || floor.v_min;
      floor.lpd_min = m(/lpd[_ ]?min[:\s]+([0-9.]+)/i)  || floor.lpd_min;
      floor.sigma_max = m(/sigma[_ ]?max[:\s]+([0-9.]+)/i) || floor.sigma_max;
      floor.depth_min = m(/depth[_ ]?min[:\s]+([0-9.]+)/i) || floor.depth_min;
    } catch(_){}
    return floor;
  }
  window.addEventListener('message', (e)=>{
    const d = e && e.data; if (!d) return;
    if (d.type === 'tau:request'){
      const floors = readTauFromChips();
      try { e.source.postMessage({ type:'tau:response', floors }, '*'); } catch(_) {}
    }
    if (d.type === 'meta:publish'){
      try { e.source.postMessage({ type:'meta:ack', ok:true, t: new Date().toISOString() }, '*'); } catch(_) {}
      console.log('Meta-publish payload (preview):', d.payload);
    }
  });
})();
</script>


<script>
(function(){
  if (window.__INLINE_VISUALS__) return; window.__INLINE_VISUALS__ = true;
  const PIPE_SRC = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4ODAiIGhlaWdodD0iMjYwIiB2aWV3Qm94PSIwIDAgODgwIDI2MCI+CjxzdHlsZT4uYm94e2ZpbGw6I2ZmZjtzdHJva2U6IzU1NTtzdHJva2Utd2lkdGg6MS41O3J4OjEwO3J5OjEwfS50e2ZvbnQ6MTRweCBBcmlhbDtmaWxsOiMyMjI7dGV4dC1hbmNob3I6bWlkZGxlfS5jYXB7Zm9udDoxMnB4IEFyaWFsO2ZpbGw6IzY2Njt0ZXh0LWFuY2hvcjptaWRkbGV9LmFycm93e3N0cm9rZTojODg4O3N0cm9rZS13aWR0aDoyO21hcmtlci1lbmQ6dXJsKCNhKX0uY2hpcHtmb250OjEycHggQXJpYWw7ZmlsbDojMGE1fTwvc3R5bGU+CjxkZWZzPjxtYXJrZXIgaWQ9ImEiIHZpZXdCb3g9IjAgMCAxMCAxMCIgcmVmWD0iMTAiIHJlZlk9IjUiIG1hcmtlclVuaXRzPSJzdHJva2VXaWR0aCIgbWFya2VyV2lkdGg9IjgiIG1hcmtlckhlaWdodD0iOCIgb3JpZW50PSJhdXRvIj48cGF0aCBkPSJNMCwwIEwxMCw1IEwwLDEwIHoiIGZpbGw9IiM4ODgiLz48L21hcmtlcj48L2RlZnM+CjxyZWN0IGNsYXNzPSJib3giIHg9IjIwIiB5PSI4MCIgd2lkdGg9IjE2MCIgaGVpZ2h0PSI3MCIvPjx0ZXh0IGNsYXNzPSJ0IiB4PSIxMDAiIHk9IjExNSI+SW5wdXRzPC90ZXh0Pjx0ZXh0IGNsYXNzPSJjYXAiIHg9IjEwMCIgeT0iMTM1Ij5Qcm9tcHQgKyBBbmNob3JzIHXimIU8L3RleHQ+CjxyZWN0IGNsYXNzPSJib3giIHg9IjIyMCIgeT0iNDAiIHdpZHRoPSIxODAiIGhlaWdodD0iNzAiLz48dGV4dCBjbGFzcz0idCIgeD0iMzEwIiB5PSI3NSI+RHJhZnQ8L3RleHQ+CjxyZWN0IGNsYXNzPSJib3giIHg9IjIyMCIgeT0iMTQwIiB3aWR0aD0iMTgwIiBoZWlnaHQ9IjcwIi8+PHRleHQgY2xhc3M9InQiIHg9IjMxMCIgeT0iMTc1Ij5Dcml0aXF1ZTwvdGV4dD4KPHJlY3QgY2xhc3M9ImJveCIgeD0iNDMwIiB5PSI5MCIgd2lkdGg9IjE4MCIgaGVpZ2h0PSI3MCIvPjx0ZXh0IGNsYXNzPSJ0IiB4PSI1MjAiIHk9IjEyNSI+UmV2aXNlPC90ZXh0Pgo8cmVjdCBjbGFzcz0iYm94IiB4PSI2NDAiIHk9IjMwIiB3aWR0aD0iMjIwIiBoZWlnaHQ9IjgwIi8+PHRleHQgY2xhc3M9InQiIHg9Ijc1MCIgeT0iNjUiPlZhbHVlU2NvcmUgdiAmIExHRDwvdGV4dD4KPHJlY3QgY2xhc3M9ImJveCIgeD0iNjQwIiB5PSIxMzAiIHdpZHRoPSIyMjAiIGhlaWdodD0iMTAwIi8+PHRleHQgY2xhc3M9InQiIHg9Ijc1MCIgeT0iMTY1Ij5MUEQgJiDPhCBGbG9vcnM8L3RleHQ+PHRleHQgY2xhc3M9ImNhcCIgeD0iNzUwIiB5PSIxODUiPlJlZnVuZHMgdmlhIFNMUkM8L3RleHQ+CjxwYXRoIGNsYXNzPSJhcnJvdyIgZD0iTTE4MCwxMTUgTDIyMCw3NSIvPjxwYXRoIGNsYXNzPSJhcnJvdyIgZD0iTTE4MCwxMTUgTDIyMCwxNzUiLz4KPHBhdGggY2xhc3M9ImFycm93IiBkPSJNNDAwLDc1IEw0MzAsMTI1Ii8+PHBhdGggY2xhc3M9ImFycm93IiBkPSJNNDAwLDE3NSBMNDMwLDEyNSIvPgo8cGF0aCBjbGFzcz0iYXJyb3ciIGQ9Ik02MTAsMTI1IEw2NDAsNzAiLz48cGF0aCBjbGFzcz0iYXJyb3ciIGQ9Ik02MTAsMTI1IEw2NDAsMTgwIi8+Cjx0ZXh0IGNsYXNzPSJjaGlwIiB4PSI1MjAiIHk9IjIxMCI+TWV0ZXJlZCBjb2duaXRpb24g4oCiIGF1ZGl0YWJsZSB0cmFjZXM8L3RleHQ+Cjwvc3ZnPg==";
  const MARKET_SRC = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MjAiIGhlaWdodD0iMzYwIiB2aWV3Qm94PSIwIDAgNzIwIDM2MCI+CjxzdHlsZT4uYXhpc3tzdHJva2U6I2JiYjtzdHJva2Utd2lkdGg6MX0gLmxibHtmb250OjEzcHggQXJpYWw7ZmlsbDojNDQ0fSAucHR7ZmlsbDojOTk5fSAucHQze2ZpbGw6IzFhOWI1Zn0gLnRpdGxle2ZvbnQ6MTZweCBBcmlhbDtmaWxsOiMyMjJ9PC9zdHlsZT4KPGxpbmUgY2xhc3M9ImF4aXMiIHgxPSI2MCIgeTE9IjMwMCIgeDI9IjY2MCIgeTI9IjMwMCIvPjxsaW5lIGNsYXNzPSJheGlzIiB4MT0iNjAiIHkxPSI0MCIgeDI9IjYwIiB5Mj0iMzAwIi8+Cjx0ZXh0IGNsYXNzPSJsYmwiIHg9IjM2MCIgeT0iMzMwIj5BdWRpdGFiaWxpdHkgLyBDb21wbGlhbmNlIOKGkjwvdGV4dD48dGV4dCBjbGFzcz0ibGJsIiB4PSIxMCIgeT0iMjAiIHRyYW5zZm9ybT0icm90YXRlKC05MCAxMCwyMCkiPlRydWUgVmFsdWUgcGVyICQg4oaRPC90ZXh0Pgo8Y2lyY2xlIGN4PSIyMjAiIGN5PSIyMDAiIHI9IjkiIGNsYXNzPSJwdCIvPjx0ZXh0IGNsYXNzPSJsYmwiIHg9IjI0MCIgeT0iMjA1Ij5PcGVuQUkgLyBBbnRocm9waWM8L3RleHQ+CjxjaXJjbGUgY3g9IjE0MCIgY3k9IjI1MCIgcj0iOSIgY2xhc3M9InB0Ii8+PHRleHQgY2xhc3M9ImxibCIgeD0iMTYwIiB5PSIyNTUiPkxhbmdDaGFpbjwvdGV4dD4KPGNpcmNsZSBjeD0iNTQwIiBjeT0iOTAiIHI9IjEyIiBjbGFzcz0icHQzIi8+PHRleHQgY2xhc3M9ImxibCIgeD0iNTYwIiB5PSI5NSI+UkMvUkEgKyBNQ1AgKEdvdmVybmVkIFJPSSk8L3RleHQ+Cjx0ZXh0IGNsYXNzPSJ0aXRsZSIgeD0iMzYwIiB5PSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSI+UG9zaXRpb25pbmc6IEdvdmVybmVkIFJlYXNvbmluZyB2cy4gQWx0ZXJuYXRpdmVzPC90ZXh0Pgo8L3N2Zz4=";
  const origOpen = window.openDocsDrawer;
  window.openDocsDrawer = function(anchor){
    if (origOpen) origOpen(anchor);
    setTimeout(()=>{
      try{
        const c = document.getElementById('docsContent'); if (!c) return;
        const ov = c.querySelector('#overview');
        if (ov && !c.querySelector('#__pipeline_img__')){
          const img = document.createElement('img'); img.id='__pipeline_img__'; img.alt='Pipeline Diagram'; img.src=PIPE_SRC;
          img.style.cssText='width:100%;height:auto;border:1px solid var(--border,#333);border-radius:8px;margin:8px 0;';
          ov.parentNode.insertBefore(img, ov.nextSibling);
        }
        const ec = c.querySelector('#economics');
        if (ec && !c.querySelector('#__market_img__')){
          const img2 = document.createElement('img'); img2.id='__market_img__'; img2.alt='Market Position'; img2.src=MARKET_SRC;
          img2.style.cssText='width:100%;height:auto;border:1px solid var(--border,#333);border-radius:8px;margin:8px 0;';
          ec.parentNode.insertBefore(img2, ec.nextSibling);
        }
      }catch(e){}
    }, 60);
  };
})();
</script>


<script>
(function(){
  if (window.__INLINE_VISUALS_OBS__) return; window.__INLINE_VISUALS_OBS__ = true;
  // Reuse existing data URIs if defined; else fall back to embedded ones (filled by previous injector)
  var PIPE_SRC = (window.__PIPE_SRC__) || (function(){ try { return document.querySelector('#__pipeline_img__')?.src; } catch(e){} return null; })();
  var MARKET_SRC = (window.__MARKET_SRC__) || (function(){ try { return document.querySelector('#__market_img__')?.src; } catch(e){} return null; })();

  function ensureDocsImages(){
    var c = document.getElementById('docsContent');
    if (!c) return;
    var ov = c.querySelector('#overview');
    if (ov && !c.querySelector('#__pipeline_img__')){
      var img = document.createElement('img');
      img.id='__pipeline_img__'; img.alt='Pipeline Diagram';
      img.src = PIPE_SRC || ''; img.style.cssText='width:100%;height:auto;border:1px solid var(--border,#333);border-radius:8px;margin:8px 0;';
      if (!img.src){ return; }
      ov.parentNode.insertBefore(img, ov.nextSibling);
    }
    var ec = c.querySelector('#economics');
    if (ec && !c.querySelector('#__market_img__')){
      var img2 = document.createElement('img');
      img2.id='__market_img__'; img2.alt='Market Position';
      img2.src = MARKET_SRC || ''; img2.style.cssText='width:100%;height:auto;border:1px solid var(--border,#333);border-radius:8px;margin:8px 0;';
      if (!img2.src){ return; }
      ec.parentNode.insertBefore(img2, ec.nextSibling);
    }
  }

  // Observe changes in docs content
  var obs = new MutationObserver(function(){ try{ ensureDocsImages(); }catch(e){} });
  function arm(){
    var c = document.getElementById('docsContent');
    if (!c) { setTimeout(arm, 80); return; }
    obs.observe(c, { childList:true, subtree:true });
    setTimeout(ensureDocsImages, 50);
  }
  arm();

  // Also force once when drawer opens (fallback)
  var _openDocsDrawer = window.openDocsDrawer;
  window.openDocsDrawer = function(anchor){
    if (_openDocsDrawer) _openDocsDrawer(anchor);
    setTimeout(ensureDocsImages, 80);
  };
})();
</script>


<script>
(function(){
  if (window.__ABOUT_VISUALS_ON_OPEN__) return; window.__ABOUT_VISUALS_ON_OPEN__ = true;
  function attach(){
    var btn = document.getElementById('aboutOpenBtn');
    if (!btn){ setTimeout(attach, 120); return; }
    btn.addEventListener('click', function(){
      var put = function(id){
        var host = document.getElementById(id);
        if (!host) return;
        if (host.querySelector('img')) return;
        // Reuse images from docs if available
        var p = parent?.document?.getElementById('__pipeline_img__');
        var m = parent?.document?.getElementById('__market_img__');
        if (p){
          var img = new Image(); img.src = p.src; img.alt = 'Pipeline Diagram';
          img.style.cssText='width:100%;height:auto;border:1px solid var(--border,#333);border-radius:8px;';
          host.appendChild(img);
        }
        if (m && id==='aboutEconomicsMarket'){
          var img2 = new Image(); img2.src = m.src; img2.alt = 'Market Position';
          img2.style.cssText='width:100%;height:auto;border:1px solid var(--border,#333);border-radius:8px;';
          host.appendChild(img2);
        }
      };
      setTimeout(function(){ put('aboutOverviewPipeline'); put('aboutEconomicsMarket'); }, 40);
    });
  }
  attach();
})();
</script>


<script>
(function(){
  if (window.__DOCS_FORCE_VISUALS__) return; window.__DOCS_FORCE_VISUALS__ = true;
  const PIPE_SRC = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4ODAiIGhlaWdodD0iMjYwIiB2aWV3Qm94PSIwIDAgODgwIDI2MCI+CjxzdHlsZT4uYm94e2ZpbGw6I2ZmZjtzdHJva2U6IzU1NTtzdHJva2Utd2lkdGg6MS41O3J4OjEwO3J5OjEwfS50e2ZvbnQ6MTRweCBBcmlhbDtmaWxsOiMyMjI7dGV4dC1hbmNob3I6bWlkZGxlfS5jYXB7Zm9udDoxMnB4IEFyaWFsO2ZpbGw6IzY2Njt0ZXh0LWFuY2hvcjptaWRkbGV9LmFycm93e3N0cm9rZTojODg4O3N0cm9rZS13aWR0aDoyO21hcmtlci1lbmQ6dXJsKCNhKX0uY2hpcHtmb250OjEycHggQXJpYWw7ZmlsbDojMGE1fTwvc3R5bGU+CjxkZWZzPjxtYXJrZXIgaWQ9ImEiIHZpZXdCb3g9IjAgMCAxMCAxMCIgcmVmWD0iMTAiIHJlZlk9IjUiIG1hcmtlclVuaXRzPSJzdHJva2VXaWR0aCIgbWFya2VyV2lkdGg9IjgiIG1hcmtlckhlaWdodD0iOCIgb3JpZW50PSJhdXRvIj48cGF0aCBkPSdNMCwwIEwxMCw1IEwwLDEwIHonIGZpbGw9JyM4ODgnLz48L21hcmtlcj48L2RlZnM+CjxyZWN0IGNsYXNzPSdib3gnIHg9JzIwJyB5PSc4MCcgd2lkdGg9JzE2MCcgaGVpZ2h0PSc3MCcvPjx0ZXh0IGNsYXNzPSd0JyB4PScxMDAnIHk9JzExNSc+SW5wdXRzPC90ZXh0Pjx0ZXh0IGNsYXNzPSdjYXAnIHg9JzEwMCcgeT0nMTM1Jz5Qcm9tcHQgKyBBbmNob3JzIHXimIU8L3RleHQ+CjxyZWN0IGNsYXNzPSdib3gnIHg9JzIyMCcgeT0nNDAnIHdpZHRoPScxODAnIGhlaWdodD0nNzAnLz48dGV4dCBjbGFzcz0ndCcgeD0nMzEwJyB5PSc3NSc+RHJhZnQ8L3RleHQ+CjxyZWN0IGNsYXNzPSdib3gnIHg9JzIyMCcgeT0nMTQwJyB3aWR0aD0nMTgwJyBoZWlnaHQ9JzcwJy8+PHRleHQgY2xhc3M9J3QnIHg9JzMxMCcgeT0nMTc1Jz5Dcml0aXF1ZTwvdGV4dD4KPHJlY3QgY2xhc3M9J2JveCcgeD0nNDMwJyB5PSc5MCcgd2lkdGg9JzE4MCcgaGVpZ2h0PSc3MCcvPjx0ZXh0IGNsYXNzPSd0JyB4PSc1MjAnIHk9JzEyNSc+UmV2aXNlPC90ZXh0Pgo8cmVjdCBjbGFzcz0nYm94JyB4PSc2NDAnIHk9JzMwJyB3aWR0aD0nMjIwJyBoZWlnaHQ9JzgwJy8+PHRleHQgY2xhc3M9J3QnIHg9Jzc1MCcgeT0nNjUnPlZhbHVlU2NvcmUgdiAmYW1wOyBMR0Q8L3RleHQ+CjxyZWN0IGNsYXNzPSdib3gnIHg9JzY0MCcgeT0nMTMwJyB3aWR0aD0nMjIwJyBoZWlnaHQ9JzEwMCcvPjx0ZXh0IGNsYXNzPSd0JyB4PSc3NTAnIHk9JzE2NSc+TFBEICZhbXA7IM+EIEZsb29yczwvdGV4dD48dGV4dCBjbGFzcz0nY2FwJyB4PSc3NTAnIHk9JzE4NSc+UmVmdW5kcyB2aWEgU0xSQzwvdGV4dD4KPHBhdGggY2xhc3M9J2Fycm93JyBkPSdNMTgwLDExNSBMMjIwLDc1Jy8+PHBhdGggY2xhc3M9J2Fycm93JyBkPSdNMTgwLDExNSBMMjIwLDE3NScvPgo8cGF0aCBjbGFzcz0nYXJyb3cnIGQ9J000MDAsNzUgTDQzMCwxMjUnLz48cGF0aCBjbGFzcz0nYXJyb3cnIGQ9J000MDAsMTc1IEw0MzAsMTI1Jy8+CjxwYXRoIGNsYXNzPSdhcnJvdycgZD0nTTYxMCwxMjUgTDY0MCw3MCcvPjxwYXRoIGNsYXNzPSdhcnJvdycgZD0nTTYxMCwxMjUgTDY0MCwxODAnLz4KPHRleHQgY2xhc3M9J2NoaXAnIHg9JzUyMCcgeT0nMjEwJz5NZXRlcmVkIGNvZ25pdGlvbiDigKIgYXVkaXRhYmxlIHRyYWNlczwvdGV4dD4KPC9zdmc+', MARKET_SRC = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI3MjAiIGhlaWdodD0iMzYwIiB2aWV3Qm94PSIwIDAgNzIwIDM2MCI+CjxzdHlsZT4uYXhpc3tzdHJva2U6I2JiYjtzdHJva2Utd2lkdGg6MX0gLmxibHtmb250OjEzcHggQXJpYWw7ZmlsbDojNDQ0fSAucHR7ZmlsbDojOTk5fSAucHQze2ZpbGw6IzFhOWI1Zn0gLnRpdGxle2ZvbnQ6MTZweCBBcmlhbDtmaWxsOiMyMjJ9PC9zdHlsZT4KPGxpbmUgY2xhc3M9J2F4aXMnIHgxPSc2MCcgeTE9JzMwMCcgeDI9JzY2MCcgeTI9JzMwMCcvPjxsaW5lIGNsYXNzPSdheGlzJyB4MT0nNjAnIHkxPSc0MCcgeDI9JzYwJyB5Mj0nMzAwJy8+Cjx0ZXh0IGNsYXNzPSdsYmwnIHg9JzM2MCcgeT0nMzMwJz5BdWRpdGFiaWxpdHkgLyBDb21wbGlhbmNlIOKGkjwvdGV4dD48dGV4dCBjbGFzcz0nbGJsJyB4PScxMCcgeT0nMjAnIHRyYW5zZm9ybT0ncm90YXRlKC05MCAxMCwyMCknPlRydWUgVmFsdWUgcGVyICQg4oaRPC90ZXh0Pgo8Y2lyY2xlIGN4PScyMjAnIGN5PScyMDAnIHI9JzknIGNsYXNzPSdwdCcvPjx0ZXh0IGNsYXNzPSdsYmwnIHg9JzI0MCcgeT0nMjA1Jz5PcGVuQUkgLyBBbnRocm9waWM8L3RleHQ+CjxjaXJjbGUgY3g9JzE0MCcgY3k9JzI1MCcgcj0nOScgY2xhc3M9J3B0Jy8+PHRleHQgY2xhc3M9J2xibCcgeD0nMTYwJyB5PScyNTUnPkxhbmdDaGFpbjwvdGV4dD4KPGNpcmNsZSBjeD0nNTQwJyBjeT0nOTAnIHI9JzEyJyBjbGFzcz0ncHQzJy8+PHRleHQgY2xhc3M9J2xibCcgeD0nNTYwJyB5PSc5NSc+UkMvUkEgKyBNQ1AgKEdvdmVybmVkIFJPSSk8L3RleHQ+Cjx0ZXh0IGNsYXNzPSd0aXRsZScgeD0nMzYwJyB5PScyNCcgdGV4dC1hbmNob3I9J21pZGRsZSc+UG9zaXRpb25pbmc6IEdvdmVybmVkIFJlYXNvbmluZyB2cy4gQWx0ZXJuYXRpdmVzPC90ZXh0Pgo8L3N2Zz4=';
  function placeVisuals(){
    const c = document.getElementById('docsContent'); if (!c) return;
    if (!c.querySelector('#__pipeline_img__')){
      const img = document.createElement('img'); img.id='__pipeline_img__'; img.alt='Pipeline Diagram'; img.src=PIPE_SRC;
      img.style.cssText='width:100%;height:auto;border:1px solid var(--border,#333);border-radius:8px;margin:8px 0;';
      c.insertBefore(img, c.firstChild);
    }
    if (!c.querySelector('#__market_img__')){
      const img2 = document.createElement('img'); img2.id='__market_img__'; img2.alt='Market Position'; img2.src=MARKET_SRC;
      img2.style.cssText='width:100%;height:auto;border:1px solid var(--border,#333);border-radius:8px;margin:8px 0;';
      c.insertBefore(img2, c.firstChild.nextSibling);
    }
  }
  // Wrap openDocsDrawer to always place visuals after render
  const o = window.openDocsDrawer;
  window.openDocsDrawer = function(anchor){ if (o) o(anchor); setTimeout(placeVisuals, 50); };
  // If docs already opened earlier, try once now
  document.addEventListener('DOMContentLoaded', ()=> setTimeout(placeVisuals, 200));
})();
</script>

<!-- === Fallback Inline Cockpit Template === -->
<template id="cockpitInlineTpl">

<!-- INLINE MODE SHIM: make cockpit think it's in an iframe by emulating parent.postMessage -->
<script>
(function(){
  if (window.__INLINE_SHIM__) return; window.__INLINE_SHIM__ = true;
  try {
    window.parent = window;
    if (!window.parent.postMessage || window.parent.postMessage._inlineShim !== true){
      const origDispatch = window.dispatchEvent.bind(window);
      window.parent.postMessage = function(msg, _){
        try { origDispatch(new MessageEvent('message', { data: msg, source: window })); } catch (e) { /* ignore */ }
      };
      window.parent.postMessage._inlineShim = true;
    }
  } catch(e){ /* ignore */ }
  window.__inlineChildReceive = function(msg){
    try { window.dispatchEvent(new MessageEvent('message', { data: msg, source: window })); } catch(e){}
  };
})();
</script>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base target="_self"><title>RC/RA Revamped Demo — Governance Cockpit</title>
  <style>
    :root { --bg:#0e1116;--card:#151a22;--text:#e8eef7;--muted:#9fb0c0;--accent:#5bd6ff;--good:#58d68d;--bad:#ff6b6b;--warn:#ffd34d;--shadow:0 10px 30px rgba(0,0,0,0.35);--radius:12px; }
    html,body{background:var(--bg);color:var(--text);margin:0;font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
    header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid #232a33;position:sticky;top:0;background:rgba(14,17,22,0.9);backdrop-filter:blur(8px);z-index:50}
    header h1{font-size:16px;margin:0;letter-spacing:.5px}
    .badge{padding:3px 8px;border-radius:999px;background:#202734;color:var(--muted);font-size:12px}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid #232a33;border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel{padding:16px}
    .grid-2{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    .grid-3{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:16px}
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid #2b3441;background:#161c25;color:var(--muted);cursor:pointer}
    .tab.active{color:var(--text);border-color:var(--accent);box-shadow:0 0 0 2px rgba(91,214,255,0.15) inset}
    textarea,input,select{width:100%;background:#0f131a;border:1px solid #2b3441;color:var(--text);border-radius:8px;padding:10px}
    button{background:linear-gradient(180deg,#5bd6ff,#3aa2c4);color:#001019;padding:10px 14px;border:0;border-radius:10px;cursor:pointer;font-weight:600}
    button.ghost{background:#1a212d;color:var(--text);border:1px solid #2b3441}
    .kpi{display:flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;background:#101620;border:1px solid #2b3441}
    .kpi .value{font-weight:700}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #2b3441;background:#101620;color:var(--muted)}
    .ok{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
    pre{white-space:pre-wrap;word-break:break-word;background:#0f131a;padding:12px;border-radius:10px;border:1px solid #2b3441}
    .footer{color:var(--muted);text-align:center;padding:24px}
    .hidden{display:none !important}
    .inline{display:inline-flex;align-items:center;gap:8px}
    .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .right{margin-left:auto} .editor{min-height:240px} .split{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .small{font-size:12px;color:var(--muted)} a{color:var(--accent);text-decoration:none}
  </style>
<style>
/* ---- RC/RA High-Contrast Controls Patch ---- */
:root{--rc-brand:#111827;--rc-ink:#0f172a;--rc-accent:#4f46e5;}
@media (prefers-color-scheme: dark){:root{--rc-brand:#e6e6ea;--rc-ink:#e6e6ea;--rc-accent:#8ab4f8;}}
button, .btn, a[role="button"], input[type="button"], input[type="submit"]{
  display:inline-flex; align-items:center; justify-content:center; gap:.5rem;
  padding:10px 14px !important; border-radius:12px !important;
  border:3px solid var(--rc-brand, #111827) !important;
  background: var(--rc-brand, #111827) !important; color:#fff !important;
  font-weight:800 !important; letter-spacing:.2px; cursor:pointer;
}
button:hover, .btn:hover, a[role="button"]:hover{ filter:brightness(1.06) }
button:focus-visible, .btn:focus-visible, a[role="button"]:focus-visible{
  outline:3px solid var(--rc-accent, #4f46e5) !important; outline-offset:2px;
}
/* safe visible tab buttons */
.tab, .pill, .chip{ border-width:2px !important }
</style>
</head>
<body>
<header class="card">
  <h1>RC/RA Revamped Demo • <span class="badge">Stitch‑Kit v12 UI • Consulting Mode</span></h1>
  <div class="flex">
    <label class="pill inline"><input type="checkbox" id="toggleMock" checked /> Mock mode</label>
    <label class="pill inline"><input type="checkbox" id="toggleConsulting" /> Consulting Mode</label>
    <a class="pill" href="./report.html" target="_blank">📄 Report Template</a>
    <a class="pill" href="../docs/demo_nav_INVESTOR_COMBINED.md" target="_blank">📘 Investor Walkthrough</a>
  </div>
</header>

<div class="container">
  <div class="tabs">
    <div class="tab active" data-tab="playground">Playground</div>
    <div class="tab" data-tab="governance">Governance</div>
    <div class="tab" data-tab="u-star">U★ Lab</div>
    <div class="tab" data-tab="roc">ROC & Floors</div>
    <div class="tab" data-tab="policy">Policy Editor</div>
    <div class="tab" data-tab="pdf">PDF Generator</div>
    <div class="tab" data-tab="api">API Console</div>
  </div>

  <section class="card panel" id="tab-playground">
    <div class="grid-2">
      <div>
        <h3>Draft → Critique → Revise (client-side loop)</h3>
        <textarea id="inputText" rows="10" placeholder="Paste a prompt or business question to evaluate..."></textarea>
        <div class="flex">
          <button id="btnRun">Run Evaluation</button>
          <button id="btnReset" class="ghost">Reset</button>
          <span class="small">Runs against /api/detector/eval in API mode; otherwise uses the in‑browser detector.</span>
        </div>
      </div>
      <div>
        <h3>Result</h3>
        <div class="grid-3">
          <div class="kpi">v: <span id="kpiV" class="value">—</span></div>
          <div class="kpi">σ: <span id="kpiSigma" class="value">—</span></div>
          <div class="kpi">depth: <span id="kpiDepth" class="value">—</span></div>
          <div class="kpi">cost: <span id="kpiCost" class="value">—</span></div>
          <div class="kpi">LPD: <span id="kpiLPD" class="value">—</span></div>
          <div class="kpi">v_net: <span id="kpiVNet" class="value">—</span></div>
        </div>
        <div class="flex">
          <span id="passBadge" class="pill">SLRC: —</span>
          <span class="pill" id="floorsNow">floors: —</span>
        </div>
        <details style="margin-top:12px;">
          <summary>JSON</summary>
          <pre id="jsonOut"></pre>
        </details>
        <details>
          <summary>Risk Tags</summary>
          <div id="riskTags"></div>
        </details>
      </div>
    </div>
  </section>

  <section class="card panel hidden" id="tab-governance">
    <div class="split">
      <div>
        <h3>SLRC Snapshot</h3>
        <div id="governanceSnapshot"></div>
        <p class="small">Shows floors vs measurement for last run, with pass/fail reasons.</p>
      </div>
      <div>
        <h3>Run Log (latest 5)</h3>
        <pre id="runLog"></pre>
      </div>
    </div>
  </section>

  <section class="card panel hidden" id="tab-u-star">
    <div class="split">
      <div>
        <h3>Gold Paragraphs (u★) — Demo</h3>
        <textarea id="goldSet" class="editor" placeholder="One gold paragraph per line..."></textarea>
        <div class="flex">
          <button id="btnMakeUStar">Make u★</button>
          <button id="btnScore" class="ghost">Score Current Draft vs u★</button>
        </div>
        <p class="small">Deterministic toy embedding (384-d trigram hash) for demo reproducibility.</p>
      </div>
      <div>
        <h3>u★ & Gain</h3>
        <pre id="ustarOut"></pre>
      </div>
    </div>
  </section>

  <section class="card panel hidden" id="tab-roc">
    <div class="split">
      <div>
        <h3>ROC Sweep (synthetic)</h3>
        <p class="small">Simulate LPD distributions and propose τ floor updates.</p>
        <div class="flex">
          <button id="btnRunROC">Run ROC Sweep</button>
          <button id="btnApplyTau" class="ghost">Apply Proposed Floors</button>
        </div>
        <pre id="rocOut"></pre>
      </div>
      <div>
        <h3>Current Floors</h3>
        <pre id="floorsOut"></pre>
      </div>
    </div>
  </section>

  <section class="card panel hidden" id="tab-policy">
    <div class="split">
      <div>
        <h3>policy.yaml</h3>
        <textarea id="policyEditor" class="editor" placeholder="Edit YAML..."></textarea>
        <div class="flex">
          <button id="btnPolicySave">Save (POST /api/policy)</button>
          <button id="btnPolicyReload" class="ghost">Reload</button>
          <label class="pill inline"><span class="small">Signature:</span><input id="sigKey" placeholder="DEMO_ONLY"/></label>
        </div>
      </div>
      <div>
        <h3>Audit</h3>
        <pre id="policyAudit"></pre>
      </div>
    </div>
  </section>

  <section class="card panel hidden" id="tab-pdf">
    <h3>Generate Multi‑Section Report (PDF)</h3>
    <p class="small">Uses /api/pdf/generate in API mode; falls back to client‑side markup capture in Mock mode.</p>
    <div class="flex">
      <button id="btnPDF">Generate PDF</button>
      <button id="btnInvestorPDF" class="ghost">Investor Runthrough PDF</button>
      <a id="pdfDownload" class="pill hidden" download="rcra_report.pdf">Download ready</a>
    </div>
    <pre id="pdfStatus"></pre>
  </section>

  <section class="card panel hidden" id="tab-api">
    <h3>API Console</h3>
    <p class="small">Quick calls to demo endpoints.</p>
    <div class="grid-3">
      <button class="ghost" data-call="GET /api/policy">GET /api/policy</button>
      <button class="ghost" data-call="POST /api/policy">POST /api/policy</button>
      <button class="ghost" data-call="POST /api/detector/eval">POST /api/detector/eval</button>
      <button class="ghost" data-call="POST /api/roc/sweep">POST /api/roc/sweep</button>
      <button class="ghost" data-call="POST /api/pdf/investor_runthrough">POST /api/pdf/investor_runthrough</button>
    </div>
    <pre id="apiOut"></pre>
  </section>

  <div class="footer small">LPD • SLRC • RRP — Governance‑grade Reasoning. © RC/RA Labs</div>
</div>

<script>
const tabs = document.querySelectorAll('.tab');
const panels = {
  playground: document.getElementById('tab-playground'),
  governance: document.getElementById('tab-governance'),
  'u-star': document.getElementById('tab-u-star'),
  roc: document.getElementById('tab-roc'),
  policy: document.getElementById('tab-policy'),
  pdf: document.getElementById('tab-pdf'),
  api: document.getElementById('tab-api'),
};
tabs.forEach(t => t.addEventListener('click', () => {
  tabs.forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  Object.values(panels).forEach(p => p.classList.add('hidden'));
  panels[t.dataset.tab].classList.remove('hidden');
}));

let lastResult = null;
let runLog = [];

const mockToggle = document.getElementById('toggleMock');
const consultToggle = document.getElementById('toggleConsulting');
const floorsNow = document.getElementById('floorsNow');
const jsonOut = document.getElementById('jsonOut');
const riskTagsEl = document.getElementById('riskTags');
const passBadge = document.getElementById('passBadge');
const runLogEl = document.getElementById('runLog');
const governanceSnapshot = document.getElementById('governanceSnapshot');
const policyEditor = document.getElementById('policyEditor');
const policyAudit = document.getElementById('policyAudit');
const floorsOut = document.getElementById('floorsOut');
const pdfStatus = document.getElementById('pdfStatus');
const pdfDownload = document.getElementById('pdfDownload');
const apiOut = document.getElementById('apiOut');
const kV = document.getElementById('kpiV');
const kSigma = document.getElementById('kpiSigma');
const kDepth = document.getElementById('kpiDepth');
const kCost = document.getElementById('kpiCost');
const kLPD = document.getElementById('kpiLPD');
const kVNet = document.getElementById('kpiVNet');

function hashTrigramEmbedding(text) {
  const dim = 384;
  const v = new Array(dim).fill(0);
  const s = (text || '').toLowerCase();
  for (let i=0; i < s.length-2; i++) {
    const trig = s.slice(i, i+3);
    let h = 0;
    for (let j=0; j<trig.length; j++) h = ((h<<5)-h) + trig.charCodeAt(j);
    const idx = Math.abs(h) % dim;
    v[idx] += 1;
  }
  const norm = Math.sqrt(v.reduce((a,b)=>a+b*b,0)) || 1;
  return v.map(x => x / norm);
}
function cosine(a,b){ let d=0; for(let i=0;i<a.length;i++) d+=a[i]*b[i]; return d; }

let uStar = null;
function makeUStar(paragraphs) {
  const lines = paragraphs.split(/\n+/).map(s => s.trim()).filter(Boolean);
  if (!lines.length) return null;
  const dim = 384;
  const acc = new Array(dim).fill(0);
  lines.forEach(line => {
    const e = hashTrigramEmbedding(line);
    for (let i=0;i<dim;i++) acc[i] += e[i];
  });
  const norm = Math.sqrt(acc.reduce((a,b)=>a+b*b,0)) || 1;
  return acc.map(x => x / norm);
}

function detectRisks(text, operators, pedagogy) {
  const tags = [];
  const add = (id, conf) => tags.push({id, conf: Math.max(0, Math.min(1, conf))});
  try {
    (operators?.risk_tags || []).forEach(rt => {
      const re = new RegExp(rt.pattern, 'i'); if (re.test(text)) add(rt.id, Math.min(1,(rt.weight||0.1)+0.1));
    });
  } catch(e){}
  try {
    (pedagogy?.operators || []).forEach(op => {
      const re = new RegExp(op.pattern, 'i'); if (re.test(text)) add(op.id, Math.min(1,(op.penalty||0.05)+0.1));
    });
  } catch(e){}
  if (consultToggle.checked) {
    if (/(hand\-wave|handwave|it depends)/i.test(text)) add('consulting_handwave', 0.6);
    if (/(best practices)/i.test(text)) add('generic_best_practices', 0.4);
  }
  return tags;
}

function applyFloors(m, floors){
  const reasons = [];
  const pass = (m.v_net >= floors.v_min && m.lpd >= floors.lpd_min && m.sigma <= floors.sigma_max && m.depth >= floors.depth_min);
  if (m.v_net < floors.v_min) reasons.push(`v_net ${m.v_net.toFixed(3)} < v_min ${floors.v_min}`);
  if (m.lpd   < floors.lpd_min) reasons.push(`LPD ${m.lpd.toFixed(2)} < lpd_min ${floors.lpd_min}`);
  if (m.sigma > floors.sigma_max) reasons.push(`σ ${m.sigma.toFixed(3)} > sigma_max ${floors.sigma_max}`);
  if (m.depth < floors.depth_min) reasons.push(`depth ${m.depth} < depth_min ${floors.depth_min}`);
  return { pass, reasons };
}
const DEFAULT_FLOORS = { v_min:0.84, lpd_min:1.30, sigma_max:0.22, depth_min:2 };

async function loadPolicy(){
  if (mockToggle.checked){
    const raw = localStorage.getItem('policyYaml');
    if (raw){ policyEditor.value = raw; }
    else {
      const txt = await (await fetch('../policy.yaml')).text();
      policyEditor.value = txt;
    }
    floorsOut.textContent = extractFloorsFromYaml(policyEditor.value);
    return;
  }
  const r = await fetch('/api/policy'); const j = await r.json();
  policyEditor.value = j.yaml || ''; floorsOut.textContent = JSON.stringify(j.floors, null, 2);
  policyAudit.textContent = (j.audit||[]).map(a => `• ${a.ts} ${a.actor} ${a.msg}`).join('\n');
}

function extractFloorsFromYaml(yaml){
  const lines = (yaml||'').split(/\n/); const o = {...DEFAULT_FLOORS};
  lines.forEach(line=>{ const m = line.trim().match(/^(v_min|lpd_min|sigma_max|depth_min):\s*([0-9.]+)/); if(m) o[m[1]]=Number(m[2]); });
  return JSON.stringify(o, null, 2);
}
function parseYamlFloors(yaml){ try{ return JSON.parse(extractFloorsFromYaml(yaml)); } catch(e){ return DEFAULT_FLOORS; } }

async function loadOps(){
  const ops = await (await fetch('../operators.yaml')).text();
  const ped = await (await fetch('../pedagogy_risk_operators.yaml')).text();
  const parseOps = (raw) => {
    const blocks = []; let current=null;
    raw.split(/\n/).forEach(line=>{
      if (/^-\s*id:/i.test(line)){ if (current) blocks.push(current); current = {id: line.split(':')[1].trim()}; }
      else if (/pattern:/i.test(line) && current){ current.pattern = line.split(':',2)[1].trim().replace(/^["']|["']$/g,''); }
      else if (/(weight|penalty):/i.test(line) && current){ const k=line.split(':')[0].trim(); const v=parseFloat(line.split(':')[1]); current[k]=isNaN(v)?0.1:v; }
    });
    if (current) blocks.push(current);
    if (/pedagogy/i.test(raw)) return {operators: blocks};
    return {risk_tags: blocks};
  };
  return { operators: parseOps(ops), pedagogy: parseOps(ped) };
}

// Run Eval
document.getElementById('btnRun').addEventListener('click', async () => {
  const text = document.getElementById('inputText').value || 'Demo input for evaluation';
  const {operators, pedagogy} = await loadOps();
  let result;
  if (mockToggle.checked){
    result = await localEvaluate(text, operators, pedagogy);
  } else {
    const r = await fetch('/api/detector/eval', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({text, context: consultToggle.checked?'consulting':'general'}) });
    result = await r.json();
  }
  lastResult = result; runLog.unshift({ts:new Date().toISOString(), result}); runLog = runLog.slice(0,5);
  renderResult(result); renderGovernance();
});

document.getElementById('btnReset').addEventListener('click', () => {
  document.getElementById('inputText').value='';
  [kV,kSigma,kDepth,kCost,kLPD,kVNet].forEach(el=>el.textContent='—');
  jsonOut.textContent=''; riskTagsEl.innerHTML=''; passBadge.textContent='SLRC: —';
});

async function localEvaluate(text, operators, pedagogy){
  const e = hashTrigramEmbedding(text);
  const base = uStar || new Array(384).fill(0.0);
  const v = Math.max(0, Math.min(1, cosine(e, base) || 0.42));
  const tags = detectRisks(text, operators, pedagogy);
  const penalty = tags.reduce((a,t)=> a + (t.conf||0)*0.05, 0);
  const v_net = Math.max(0, v - penalty);
  const len = (text||'').length || 1;
  const sigma = Math.min(0.9, Math.abs(Math.sin(len/97)) * 0.3);
  const depth = Math.min(5, Math.floor(((text.match(/\n|\*|\-|\d+\./g)||[]).length)/4)+1);
  const cost = 0.002 + len * 0.000002;
  const lpd = cost>0 ? v_net / cost : 0;
  const floors = parseYamlFloors(policyEditor.value||'');
  const gate = applyFloors({v_net, sigma, depth, lpd}, floors);
  return { v, v_net, sigma, depth, cost, lpd, pass: gate.pass, reasons: gate.reasons, tags };
}
function renderResult(r){
  kV.textContent = r.v.toFixed(3); kSigma.textContent = r.sigma.toFixed(3); kDepth.textContent = String(r.depth);
  kCost.textContent = '$'+r.cost.toFixed(4); kLPD.textContent = r.lpd.toFixed(2); kVNet.textContent = r.v_net.toFixed(3);
  jsonOut.textContent = JSON.stringify(r, null, 2);
  riskTagsEl.innerHTML = (r.tags||[]).map(t=>`<span class="pill">${t.id} (${t.conf.toFixed(2)})</span>`).join(' ');
  passBadge.textContent = 'SLRC: ' + (r.pass ? 'PASS ✅' : 'FAIL ❌');
  passBadge.className = 'pill ' + (r.pass ? 'ok' : 'bad');
  const floors = parseYamlFloors(policyEditor.value||'');
  floorsNow.textContent = `floors: v>=${floors.v_min}, L>=${floors.lpd_min}, σ<=${floors.sigma_max}, d>=${floors.depth_min}`;
}
function renderGovernance(){
  runLogEl.textContent = runLog.map(x => `${x.ts} — LPD ${x.result.lpd.toFixed(2)} • ${x.result.pass?'PASS':'FAIL'}`).join('\n');
  if (!lastResult){ governanceSnapshot.textContent='No runs yet.'; return; }
  const floors = parseYamlFloors(policyEditor.value||'');
  const r = lastResult;
  governanceSnapshot.textContent = [
    `v_net: ${r.v_net.toFixed(3)} vs v_min ${floors.v_min}`,
    `LPD: ${r.lpd.toFixed(2)} vs lpd_min ${floors.lpd_min}`,
    `σ: ${r.sigma.toFixed(3)} vs sigma_max ${floors.sigma_max}`,
    `depth: ${r.depth} vs depth_min ${floors.depth_min}`,
    `PASS: ${r.pass} ${r.reasons?.length? '• reasons: ' + r.reasons.join('; ') : ''}`
  ].join('\n');
}

// U★ actions
document.getElementById('btnMakeUStar').addEventListener('click', () => {
  const goldSet = document.getElementById('goldSet').value || 'Logic-per-Dollar ties value to cost\nSLRC refunds enforce floors';
  uStar = makeUStar(goldSet);
  document.getElementById('ustarOut').textContent = uStar ? `u★ ready (dim: ${uStar.length})` : 'No golds';
});
document.getElementById('btnScore').addEventListener('click', () => {
  const text = document.getElementById('inputText').value;
  if (!uStar || !text) return;
  const e = hashTrigramEmbedding(text);
  const v = Math.max(0, Math.min(1, cosine(e, uStar)));
  document.getElementById('ustarOut').textContent = `cosine(text,u★) = ${v.toFixed(3)}`;
});

// ROC
document.getElementById('btnRunROC').addEventListener('click', async () => {
  if (mockToggle.checked){
    const sims = Array.from({length:200}, (_,i)=> Math.max(0.2, 2.0 + Math.sin(i/7)*0.5 + (Math.random()-0.5)*0.6));
    const sorted = sims.slice().sort((a,b)=>a-b);
    const p75 = sorted[Math.floor(0.75*sorted.length)];
    const floors = parseYamlFloors(policyEditor.value||'');
    const proposal = {...floors, lpd_min: Math.max(floors.lpd_min, Number(p75.toFixed(2)))};
    document.getElementById('rocOut').textContent = JSON.stringify({ samples: sims.slice(0,10)+'...', proposed: proposal, note: 'Knee≈P75 heuristic (demo)' }, null, 2);
  } else {
    const r = await fetch('/api/roc/sweep', { method:'POST' });
    document.getElementById('rocOut').textContent = await r.text();
  }
});
document.getElementById('btnApplyTau').addEventListener('click', () => {
  try{
    const floors = JSON.parse(document.getElementById('rocOut').textContent||'{}').proposed;
    if (!floors) return;
    const raw = policyEditor.value;
    const updated = raw.replace(/(lpd_min:\s*)([0-9.]+)/, `$1${floors.lpd_min}`);
    policyEditor.value = updated; floorsOut.textContent = extractFloorsFromYaml(updated);
  }catch(e){}
});

// Policy editor
document.getElementById('btnPolicyReload').addEventListener('click', loadPolicy);
document.getElementById('btnPolicySave').addEventListener('click', async () => {
  const yaml = policyEditor.value;
  if (mockToggle.checked){
    localStorage.setItem('policyYaml', yaml);
    policyAudit.textContent = (policyAudit.textContent || '') + `\n• ${new Date().toISOString()} local DEMO edited policy`;
    floorsOut.textContent = extractFloorsFromYaml(yaml);
    return;
  }
  const sig = document.getElementById('sigKey').value || '';
  const r = await fetch('/api/policy', { method:'POST', headers:{'Content-Type':'application/json','X-Signature':sig}, body: JSON.stringify({ yaml }) });
  apiOut.textContent = await r.text(); await loadPolicy();
});

// PDF
document.getElementById('btnPDF').addEventListener('click', async () => {
  pdfStatus.textContent = 'Generating...';
  if (mockToggle.checked){
    const blob = new Blob([`RC/RA Report\n\nLast Result:\n${jsonOut.textContent}`], {type:'application/pdf'});
    const url = URL.createObjectURL(blob); pdfDownload.href = url; pdfDownload.classList.remove('hidden'); pdfStatus.textContent='Client-side PDF placeholder ready.'; return;
  }
  const r = await fetch('/api/pdf/generate', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title:'RC/RA Report', data: lastResult||{} }) });
  if (!r.ok){ pdfStatus.textContent = 'Server PDF failed.'; return; }
  const blob = await r.blob(); const url = URL.createObjectURL(blob); pdfDownload.href = url; pdfDownload.classList.remove('hidden'); pdfStatus.textContent='Server PDF ready.';
});
document.getElementById('btnInvestorPDF').addEventListener('click', async () => {
  pdfStatus.textContent = 'Generating Investor Runthrough...';
  if (mockToggle.checked){
    const blob = new Blob(['Investor Runthrough (mock)'], {type:'application/pdf'});
    const url = URL.createObjectURL(blob); pdfDownload.href = url; pdfDownload.classList.remove('hidden'); pdfStatus.textContent='Client-side placeholder PDF ready.'; return;
  }
  const r = await fetch('/api/pdf/investor_runthrough', { method:'POST' });
  const blob = await r.blob(); const url = URL.createObjectURL(blob); pdfDownload.href = url; pdfDownload.classList.remove('hidden'); pdfStatus.textContent='Investor PDF ready.';
});

// API console
document.querySelectorAll('#tab-api [data-call]').forEach(btn => {
  btn.addEventListener('click', async () => {
    const call = btn.getAttribute('data-call');
    if (mockToggle.checked){ apiOut.textContent = 'Mock mode — no server requests made.'; return; }
    if (call === 'GET /api/policy'){ const r = await fetch('/api/policy'); apiOut.textContent = await r.text(); }
    else if (call === 'POST /api/policy'){ const payload = { yaml: policyEditor.value }; const r = await fetch('/api/policy', {method:'POST', headers:{'Content-Type':'application/json','X-Signature':(document.getElementById('sigKey').value||'')}, body: JSON.stringify(payload)}); apiOut.textContent = await r.text(); }
    else if (call === 'POST /api/detector/eval'){ const payload = { text: document.getElementById('inputText').value || 'Demo eval' }; const r = await fetch('/api/detector/eval', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}); apiOut.textContent = await r.text(); }
    else if (call === 'POST /api/roc/sweep'){ const r = await fetch('/api/roc/sweep', {method:'POST'}); apiOut.textContent = await r.text(); }
    else if (call === 'POST /api/pdf/investor_runthrough'){ const r = await fetch('/api/pdf/investor_runthrough', {method:'POST'}); apiOut.textContent = await r.text(); }
  });
});

(async () => { await loadPolicy(); })();
<\/script>

<script>
  // Receiver for parent page bridge
  window.addEventListener('message', (e)=>{
    if (!e || !e.data) return;
    const d = e.data;
    function ack(action){ try { parent.postMessage({ type:'cockpit:ack', action }, '*'); } catch(_){} }
    if (d.type === 'cockpit:run'){
      const btn = document.getElementById('btnRun'); if(btn){ btn.click(); ack('run'); }
    } else if (d.type === 'cockpit:policy:save'){
      const btn = document.getElementById('btnPolicySave'); if(btn){ btn.click(); ack('policy:save'); }
    } else if (d.type === 'cockpit:pdf'){
      const btn = document.getElementById('btnPDF'); if(btn){ btn.click(); ack('pdf'); }
    }
  });
<\/script>


<script>
  window.addEventListener('message', (e)=>{
    if (!e || !e.data) return;
    const d = e.data;
    if (d.type === 'anchor:state'){
      if(d.traces){ window.cockpitTraces = d.traces; console.log('Loaded anchor traces', d.traces.length); }
      if(d.policy){ window.cockpitPolicy = d.policy; console.log('Loaded anchor policy'); }
      // Trigger UI refresh if needed
      if(typeof updateDashPlus==='function') updateDashPlus();
    }
  });

  function emitMetricUpdate(v,lpd,sigma,refundRate){
    try { parent.postMessage({type:'cockpit:metric:update', v, lpd, sigma, refundRate}, '*'); } catch(_) {}
  }
  function emitPolicyUpdate(yaml){
    try { parent.postMessage({type:'cockpit:policy:update', yaml}, '*'); } catch(_) {}
  }

  // Example hooks: call emitMetricUpdate when dashboard updates
  if(typeof updateDashPlus==='function'){
    const _oldUpdate = updateDashPlus;
    updateDashPlus = function(){
      _oldUpdate();
      const v = window.traces?.reduce((a,b)=>a+b.v,0)/(window.traces?.length||1);
      const lpd = window.traces?.reduce((a,b)=>a+b.lpd,0)/(window.traces?.length||1);
      const sigma = window.traces?.reduce((a,b)=>a+b.sigma,0)/(window.traces?.length||1);
      const refundRate = (window.traces?.filter(t=>t.refund).length || 0)/(window.traces?.length||1);
      emitMetricUpdate(v,lpd,sigma,refundRate);
    };
  }

  // Example hook: call emitPolicyUpdate when PUT /policy is applied
  if(typeof applyPolicy==='function'){
    const _oldApply = applyPolicy;
    applyPolicy = async function(){
      await _oldApply();
      const txt = document.getElementById('policyEditor')?.value || '';
      emitPolicyUpdate(txt);
    };
  }
<\/script>


<script>
  // --- Cockpit SDK: state sync + telemetry emit ---
  (function(){
    function emit(type, payload){ try{ parent.postMessage({ type, ...payload }, '*'); }catch(_){} }

    async function loadTracesArray(arr){
      try {
        // Preferred: set window.traces and trigger re-render hooks if present
        window.traces = Array.isArray(arr) ? arr : [];
        const evt = new Event('traces:updated'); window.dispatchEvent(evt);
        // If there's a renderTable function (as in previous builds), call it
        if (typeof renderTable === 'function') renderTable();
        if (typeof renderSparkline === 'function') renderSparkline();
        if (typeof renderHistogram === 'function') renderHistogram();
        emit('telemetry', { event: 'traces_loaded', data: { n: window.traces.length } });
        // Also emit metrics snapshot
        try {
          const lpdArr = window.traces.map(t=>t.lpd).filter(x=>typeof x==='number');
          const vArr = window.traces.map(t=>t.v).filter(x=>typeof x==='number');
          const refundRate = window.traces.filter(t=>t.refund).length / Math.max(1, window.traces.length);
          const metrics = { avg_lpd: lpdArr.reduce((a,b)=>a+b,0)/Math.max(1,lpdArr.length), avg_v: vArr.reduce((a,b)=>a+b,0)/Math.max(1,vArr.length), refund_rate: refundRate };
          emit('telemetry', { event: 'metrics', data: metrics });
          emit('cockpit:metrics', { metrics });
        } catch(_){}
      } catch (e) {
        console.warn('Failed to load traces array', e);
      }
    }

    function setPolicy(text){
      const editor = document.getElementById('policyEditor');
      if (editor) {
        editor.value = text || '';
        // If previewDiff is available, refresh
        try { if (typeof previewDiff === 'function') previewDiff(); } catch(_){}
        emit('telemetry', { event: 'policy_loaded', data: { bytes: (text||'').length } });
      } else {
        // store for later
        window._pendingPolicy = text || '';
      }
    }

    // Patch applyPolicy (if exists) to emit updates
    const tryPatchPolicyApply = () => {
      const btnApply = document.getElementById('btnApplyPolicy') || document.getElementById('btnPutPolicy');
      if (btnApply && !btnApply.dataset._patched) {
        btnApply.dataset._patched = '1';
        btnApply.addEventListener('click', () => {
          try {
            const editor = document.getElementById('policyEditor');
            const policy = editor ? editor.value : '';
            emit('telemetry', { event: 'policy_applied', data: { bytes: policy.length } });
            emit('cockpit:policy:updated', { policy });
          } catch(_){}
        });
      }
    };
    document.addEventListener('DOMContentLoaded', tryPatchPolicyApply);
    setTimeout(tryPatchPolicyApply, 800);

    // Listen for state sync
    window.addEventListener('message', (e)=>{
      const d = e?.data; if (!d) return;
      if (d.type === 'state:sync') {
        if (Array.isArray(d.traces)) loadTracesArray(d.traces);
        if (typeof d.policy === 'string') setPolicy(d.policy);
      }
    });

    // Expose bridge for parent if needed
    window.CockpitBridge = { loadTracesArray, setPolicy };
  })();
<\/script>


<script>
(function(){
  let originalPolicySnapshot = '';

  function saveOriginalPolicy() {
    const editor = document.getElementById('policyEditor');
    originalPolicySnapshot = editor ? editor.value : '';
  }

  function resetTau() {
    const editor = document.getElementById('policyEditor');
    if (editor && originalPolicySnapshot) {
      editor.value = originalPolicySnapshot;
      if (typeof previewDiff === 'function') previewDiff();
      try { parent.postMessage({ type: 'cockpit:policy:reset', policy: originalPolicySnapshot }, '*'); } catch(_){}
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    saveOriginalPolicy();
    const btnReset = document.getElementById('btnResetTau');
    if (btnReset) btnReset.addEventListener('click', resetTau);
  });

  // Patch applyPolicy to also notify parent of updated policy
  const btnApply = document.getElementById('btnApplyPolicy') || document.getElementById('btnPutPolicy');
  if (btnApply && !btnApply.dataset._patched_backsync) {
    btnApply.dataset._patched_backsync = '1';
    btnApply.addEventListener('click', () => {
      try {
        const editor = document.getElementById('policyEditor');
        const policy = editor ? editor.value : '';
        parent.postMessage({ type: 'cockpit:policy:updated', policy }, '*');
      } catch(_){}
    });
  }

  // When traces update inside cockpit, push to parent as well
  window.addEventListener('traces:updated', () => {
    try {
      parent.postMessage({ type: 'cockpit:traces:updated', traces: window.traces || [] }, '*');
    } catch(_){}
  });
})();
<\/script>


<script>
  (function(){
    function emit(type, payload){ try{ parent.postMessage({ type, ...payload }, '*'); }catch(_){} }

    // Capture original floors from first-loaded policy
    let originalPolicyText = null;

    function parseFloors(text){
      const mv = (text||'').match(/v_min:\s*([0-9.]+)/);
      const ml = (text||'').match(/lpd_min:\s*([0-9.]+)/);
      return { v_min: mv ? parseFloat(mv[1]) : null, lpd_min: ml ? parseFloat(ml[1]) : null };
    }

    function setPolicy(text){
      const editor = document.getElementById('policyEditor');
      if (editor) {
        editor.value = text || '';
        try { if (typeof previewDiff === 'function') previewDiff(); } catch(_){}
        if (!originalPolicyText) originalPolicyText = text || '';
      } else {
        window._pendingPolicy = text || '';
        if (!originalPolicyText) originalPolicyText = text || '';
      }
    }

    // Back-sync state to parent
    function pushState(){
      const editor = document.getElementById('policyEditor');
      const policy = editor ? editor.value : (window._pendingPolicy || '');
      const traces = Array.isArray(window.traces) ? window.traces : [];
      emit('state:update', { policy, traces });
    }

    // Reset τ to original floors
    function resetTau(){
      if (!originalPolicyText) return;
      const editor = document.getElementById('policyEditor');
      if (!editor) return;
      // Replace v_min and lpd_min with original values
      const orig = parseFloors(originalPolicyText);
      let cur = editor.value || '';
      if (orig.v_min !== null) cur = cur.replace(/v_min:\s*[0-9.]+/, 'v_min: ' + orig.v_min.toFixed(3));
      if (orig.lpd_min !== null) cur = cur.replace(/lpd_min:\s*[0-9.]+/, 'lpd_min: ' + orig.lpd_min.toFixed(2));
      editor.value = cur;
      try { if (typeof previewDiff === 'function') previewDiff(); } catch(_){}
      // Re-render visuals if present
      try { if (typeof renderSparkline === 'function') renderSparkline(); if (typeof renderHistogram === 'function') renderHistogram(); } catch(_){}
      emit('telemetry', { event: 'tau_reset', data: { orig: orig } });
      pushState();
    }

    // Patch Apply Policy to push state
    const patchApply = () => {
      const btn = document.getElementById('btnApplyPolicy') || document.getElementById('btnPutPolicy');
      if (btn && !btn.dataset._patched2) {
        btn.dataset._patched2 = '1';
        btn.addEventListener('click', ()=> {
          // slight delay to allow editor change
          setTimeout(pushState, 300);
        });
      }
      const btnRun = document.getElementById('btnRun');
      if (btnRun && !btnRun.dataset._patched2) {
        btnRun.dataset._patched2 = '1';
        btnRun.addEventListener('click', ()=> {
          // push metrics soon after run (if any)
          setTimeout(()=> emit('telemetry', { event: 'run_invoked' }), 50);
        });
      }
    };
    document.addEventListener('DOMContentLoaded', patchApply);
    setTimeout(patchApply, 800);

    // Listen for parent messages
    window.addEventListener('message', (e)=>{
      const d = e?.data; if (!d) return;
      if (d.type === 'cockpit:reset_tau') {
        resetTau();
      } else if (d.type === 'env:update') {
        // Optionally apply env to API base URL input if present
        const base = d.apiBase;
        const input = document.getElementById('baseUrl') || document.querySelector('input#baseUrl');
        if (input && typeof base === 'string') input.value = base;
        emit('telemetry', { event: 'env_update', data: { apiBase: base||null } });
      } else if (d.type === 'state:sync') {
        if (typeof d.policy === 'string') setPolicy(d.policy);
        if (Array.isArray(d.traces)) { window.traces = d.traces; try { if (typeof renderTable==='function') renderTable(); if (typeof renderSparkline==='function') renderSparkline(); if (typeof renderHistogram==='function') renderHistogram(); } catch(_){} }
      }
    });

    // Expose for parent
    window.CockpitBridge2 = { resetTau, pushState, setPolicy };
  })();
<\/script>


<script>
// CockpitDocPopovers: lightweight popovers + route to parent drawer
(function(){
  // Small tooltip
  let tip;
  function ensureTip(){
    if (tip) return;
    tip = document.createElement('div');
    tip.style.position = 'fixed';
    tip.style.maxWidth = '360px';
    tip.style.background = 'var(--card, #111)';
    tip.style.border = '1px solid var(--border, #333)';
    tip.style.borderRadius = '10px';
    tip.style.padding = '10px 12px';
    tip.style.boxShadow = '0 8px 24px rgba(0,0,0,.24)';
    tip.style.zIndex = 10000;
    tip.style.display = 'none';
    tip.style.color = 'var(--text, #eaeaea)';
    tip.innerHTML = '<div class="tiny" id="cdpBody"></div><div style="margin-top:8px"><a href="#" class="btn tiny" id="cdpMore">Read more →</a></div>';
    document.body.appendChild(tip);
  }
  const PRIMERS = {
    'economics#lpd': {t:'LPD — Logic-per-Dollar', b:'What: scalar of epistemic value per unit cost. Why: ensures payment only for useful reasoning. How: ValueScore (cosine to u★) ÷ cost; adjusted by LGD.'},
    'economics#lgd': {t:'LGD — Learning Gain per Dollar', b:'What: learning improvement per cost. Why: protects ROI even when v is stable. How: ∆competency ÷ cost, folded into LPD as multiplier/floor.'},
    'economics#v':   {t:'v — ValueScore', b:'What: semantic fidelity to u★. Why: anchors correctness to SME truth. How: cosine(u, u★) minus baseline, penalized by risks.'},
    'economics#sigma': {t:'σ — Variance', b:'What: stability of outcomes. Why: guards against flaky reasoning. How: rolling stddev across runs; enforced with σ_max floor.'},
    'governance#tau': {t:'τ — Floors (SLRC)', b:'What: minimum acceptable thresholds. Why: deterministic refunds and safety. How: YAML floors (v_min, lpd_min, σ_max, d_min) tuned via ROC.'},
    'pedagogy#mis-targeted-difficulty': {t:'Pedagogy: mis-targeted-difficulty', b:'Example: content too hard/easy for ZPD → value collapse. Mitigation: adjust scaffolding; penalized in v.'}
  };
  function showTip(target, key){
    ensureTip();
    const data = PRIMERS[key]; if (!data) return;
    const body = document.getElementById('cdpBody');
    const more = document.getElementById('cdpMore');
    body.innerHTML = '<strong>'+data.t+'</strong><br>'+data.b;
    const rect = target.getBoundingClientRect();
    tip.style.left = Math.min(rect.left, window.innerWidth - 380) + 'px';
    tip.style.top = (rect.bottom + 6) + 'px';
    tip.style.display = 'block';
    more.onclick = (e)=>{
      e.preventDefault();
      try { parent.postMessage({ type:'docs:open', anchor:'#'+(key.split('#')[1]||'overview') }, '*'); } catch(_) {}
      tip.style.display = 'none';
    };
  }
  function hideTip(){ if (tip) tip.style.display = 'none'; }
  function bind(selector, key){
    document.querySelectorAll(selector).forEach(el => {
      const on = ()=> showTip(el, key);
      el.addEventListener('mouseenter', on);
      el.addEventListener('mouseleave', hideTip);
      el.addEventListener('click', (e)=>{ e.preventDefault(); on(); });
    });
  }
  function bindDefaults(){
    // Bind to any element that declares data-doc
    document.querySelectorAll('[data-doc]').forEach(el => {
      const key = el.getAttribute('data-doc');
      if (!key) return;
      el.addEventListener('mouseenter', ()=> showTip(el, key));
      el.addEventListener('mouseleave', hideTip);
      el.addEventListener('click', (e)=>{ e.preventDefault(); showTip(el, key); });
    });
    // Backstop bindings for common metric labels (non-invasive)
    bind('[data-doc="economics#lpd"]', 'economics#lpd');
    bind('[data-doc="economics#lgd"]', 'economics#lgd');
    bind('[data-doc="economics#v"]', 'economics#v');
    bind('[data-doc="economics#sigma"]', 'economics#sigma');
    bind('[data-doc="governance#tau"]', 'governance#tau');
    // Risk tags (if rendered)
    document.querySelectorAll('.risk-tag[data-doc]').forEach(el => {
      const key = el.getAttribute('data-doc') || 'pedagogy#mis-targeted-difficulty';
      el.addEventListener('click', (e)=>{ e.preventDefault(); showTip(el, key); });
    });
  }
  // τ help chip next to policy header (non-destructive)
  const hdr = document.querySelector('h2, h3');
  if (hdr && hdr.textContent && hdr.textContent.match(/Policy Editor/i) && !hdr.querySelector('.help-chip')){
    const chip = document.createElement('span');
    chip.className = 'help-chip'; chip.textContent = '?';
    chip.style.marginLeft = '8px'; chip.style.cursor = 'help';
    chip.setAttribute('data-doc','governance#tau');
    hdr.appendChild(chip);
  }
  document.addEventListener('DOMContentLoaded', bindDefaults);
  setTimeout(bindDefaults, 400);
  window.addEventListener('keydown', (e)=>{ if (e.key === 'Escape') hideTip(); });
})();
<\/script>


<style>
  .rcra-panel{border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin:10px 0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .rcra-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .rcra-row label{font-size:12px;color:#475569}
  .rcra-row input, .rcra-row select{padding:6px 8px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px}
  .rcra-btn{padding:8px 10px;border:1px solid #0ea5e9;border-radius:8px;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
  .rcra-btn.secondary{background:#fff;color:#0ea5e9}
  .rcra-chip{display:inline-block;padding:4px 8px;border-radius:9999px;background:#f1f5f9;margin-left:6px}
  .rcra-tiles{display:flex;gap:12px;flex-wrap:wrap}
  .rcra-tile{flex:1 0 200px;border:1px solid #e2e8f0;border-radius:10px;padding:10px}
  .rcra-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px}
</style>

<div class="rcra-panel" id="rcra-governance-panel">
  <div class="rcra-row">
    <strong>Governance Pro Controls</strong>
    <span class="rcra-chip" id="rcra-status">idle</span>
  </div>
  <div class="rcra-row">
    <label>Environment</label>
    <select id="rcra-env">
      <option value="custom">Custom</option>
      <option value="local">Local (FastAPI:8000, Express:8001)</option>
      <option value="docker">Docker (same host)</option>
    </select>
    <label>FastAPI Base URL</label><input id="rcra-fastapi" size="30" placeholder="http://localhost:8000">
    <label>Express Base URL</label><input id="rcra-express" size="30" placeholder="http://localhost:8001">
  </div>
  <div class="rcra-row">
    <label>Sign requests</label>
    <select id="rcra-sign-toggle">
      <option value="on" selected>ON</option>
      <option value="off">OFF</option>
    </select>
    <label>kid</label><input id="rcra-kid" value="ops" size="8">
    <label>secret (hex)</label><input id="rcra-secret" size="68" placeholder="paste hex key from config/keys.json">
  </div>

  <div class="rcra-row">
    <label>Floors</label>
    <input id="rcra-vmin" type="number" step="0.01" value="0.85" title="v_min">
    <input id="rcra-lmin" type="number" step="0.01" value="1.35" title="lpd_min">
    <input id="rcra-smax" type="number" step="0.01" value="0.21" title="sigma_max">
    <input id="rcra-dmin" type="number" step="1" value="3" title="depth_min">
    <button class="rcra-btn" id="rcra-propose">Propose</button>
    <button class="rcra-btn secondary" id="rcra-approve">Approve</button>
  </div>

  <div class="rcra-row rcra-tiles">
    <div class="rcra-tile">
      <div>Canary Pass Rate (session)</div>
      <div class="rcra-mono"><span id="rcra-passrate">—</span>%</div>
    </div>
    <div class="rcra-tile">
      <div>Canary Failures (session)</div>
      <div class="rcra-mono"><span id="rcra-fails">0</span></div>
    </div>
    <div class="rcra-tile">
      <div>τ Floors now</div>
      <div class="rcra-mono" id="rcra-floors-now">—</div>
    </div>
  </div>

  <div class="rcra-row">
    <button class="rcra-btn" id="rcra-run-canaries">Run all canaries now</button>
    <span class="rcra-mono" id="rcra-canary-status"></span>
  </div>

  <pre class="rcra-mono" id="rcra-log" style="white-space:pre-wrap;max-height:220px;overflow:auto;background:#0b1020;color:#d1d5db;padding:10px;border-radius:8px"></pre>
</div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const log = (msg)=>{ const el = $("rcra-log"); el.textContent = (new Date().toISOString() + " " + msg + "\\n") + el.textContent; };

  // Presets
  const envSel = $("rcra-env");
  const fapi = $("rcra-fastapi");
  const expr = $("rcra-express");
  envSel.addEventListener("change", ()=>{
    if(envSel.value==="local"){
      fapi.value = "http://localhost:8000"; expr.value = "http://localhost:8001";
    } else if(envSel.value==="docker"){
      fapi.value = window.location.origin.replace(/:\\d+$/,'') + ":8000";
      expr.value = window.location.origin.replace(/:\\d+$/,'') + ":8001";
    }
  });
  envSel.dispatchEvent(new Event("change"));

  // HMAC helpers
  function hexToBytes(hex){ const a=[]; for(let i=0;i<hex.length;i+=2){ a.push(parseInt(hex.substr(i,2),16)); } return new Uint8Array(a); }
  function bytesToHex(buf){ return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); }
  function sortKeys(obj){
    if(Array.isArray(obj)) return obj.map(sortKeys);
    if(obj && typeof obj === "object"){
      const out = {};
      Object.keys(obj).sort().forEach(k=> out[k]=sortKeys(obj[k]));
      return out;
    }
    return obj;
  }
  function canonicalJSON(obj){
    // Sorted keys, compact separators
    return JSON.stringify(sortKeys(obj));
  }
  async function hmacSha256Hex(secretHex, canonical){
    const key = await crypto.subtle.importKey("raw", hexToBytes(secretHex), {name:"HMAC", hash:"SHA-256"}, false, ["sign"]);
    const sig = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(canonical));
    return bytesToHex(sig);
  }

  async function signedFetch(baseUrl, path, body, action){
    const signOn = $("rcra-sign-toggle").value === "on";
    const kid = $("rcra-kid").value.trim();
    const secret = $("rcra-secret").value.trim();
    const ts = Math.floor(Date.now()/1000);
    const nonce = ts + "-" + kid;

    const reqBody = Object.assign({}, body, { kid, nonce, ts });
    const headers = {"Content-Type":"application/json"};

    if(signOn){
      if(!kid || !secret){ throw new Error("Signing ON but kid/secret missing"); }
      const canonical = canonicalJSON({action, floors: body.floors, nonce, ts});
      const sig = await hmacSha256Hex(secret, canonical);
      headers["X-Signature"] = `${kid}:${sig}:${nonce}:${ts}`;
    }
    const res = await fetch(baseUrl.replace(/\/$/,'') + path, { method:"POST", headers, body: JSON.stringify(reqBody) });
    if(!res.ok){ const t = await res.text(); throw new Error(res.status + " " + t); }
    return res.json();
  }

  async function refreshFloors(){
    try{
      const res = await fetch(fapi.value.replace(/\/$/,'') + "/policy/floors");
      const j = await res.json();
      $("rcra-floors-now").textContent = JSON.stringify(j);
      $("rcra-status").textContent = "floors:ok";
    }catch(e){
      $("rcra-floors-now").textContent = "n/a";
      $("rcra-status").textContent = "floors:err";
    }
  }

  $("rcra-propose").addEventListener("click", async ()=>{
    try{
      const floors = {
        v_min: parseFloat($("rcra-vmin").value),
        lpd_min: parseFloat($("rcra-lmin").value),
        sigma_max: parseFloat($("rcra-smax").value),
        depth_min: parseInt($("rcra-dmin").value,10),
      };
      const r = await signedFetch(fapi.value, "/policy/floors?action=propose", {floors}, "propose");
      log("propose → " + JSON.stringify(r));
      await refreshFloors();
    }catch(e){ log("propose ERR: " + e.message); }
  });

  $("rcra-approve").addEventListener("click", async ()=>{
    try{
      const floors = {
        v_min: parseFloat($("rcra-vmin").value),
        lpd_min: parseFloat($("rcra-lmin").value),
        sigma_max: parseFloat($("rcra-smax").value),
        depth_min: parseInt($("rcra-dmin").value,10),
      };
      const r = await signedFetch(fapi.value, "/policy/floors?action=approve", {floors}, "approve");
      log("approve → " + JSON.stringify(r));
      await refreshFloors();
    }catch(e){ log("approve ERR: " + e.message); }
  });

  // Canary session stats
  let sessionRuns=0, sessionPass=0, sessionFail=0;
  function updateTiles(){
    const passRate = sessionRuns ? Math.round(10000*sessionPass/sessionRuns)/100 : 0;
    $("rcra-passrate").textContent = isNaN(passRate) ? "—" : passRate.toString();
    $("rcra-fails").textContent = sessionFail.toString();
  }

  $("rcra-run-canaries").addEventListener("click", async ()=>{
    $("rcra-canary-status").textContent = "running…";
    try{
      const listRes = await fetch(fapi.value.replace(/\/$/,'') + "/canary/list");
      const j = await listRes.json();
      const names = j.names || [];
      for(const name of names){
        try{
          const r = await fetch(fapi.value.replace(/\/$/,'') + "/canary/run?name=" + encodeURIComponent(name), {method:"POST"});
          const jr = await r.json();
          sessionRuns += 1;
          if(jr.pass) sessionPass += 1; else sessionFail += 1;
          log(`canary ${name} → ${jr.pass ? "PASS" : "FAIL"}`);
        }catch(e){ log(`canary ${name} ERR: ${e.message}`); }
      }
    }catch(e){ log("list ERR: " + e.message); }
    updateTiles();
    $("rcra-canary-status").textContent = "done";
  });

  refreshFloors();
})();
<\/script>



<style>
  .rcra-toggle { display:flex; gap:10px; align-items:center; padding:6px 8px; margin:8px 0; }
  .rcra-toggle label { font-size:12px; color:#475569; }
  .rcra-why { border:1px solid #e2e8f0; border-radius:10px; padding:12px; margin:10px 0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial }
  .rcra-why h3 { margin:0 0 6px 0; }
</style>

<div class="rcra-why" id="rcra-why">
  <div class="rcra-toggle">
    <label><input type="radio" name="rcraMode" value="investor" checked> Investor</label>
    <label><input type="radio" name="rcraMode" value="tech"> Tech/Governance</label>
  </div>
  <div id="rcra-why-content">
    <h3>Why This Matters — Investor View</h3>
<p>This experience demonstrates an AI product with measurable value creation and user trust. It translates model performance into business outcomes and reduces risk via governance.</p>
<ul>
  <li><strong>Upside:</strong> Higher conversion and retention with better answers.</li>
  <li><strong>Downside Protection:</strong> Automatic refunds and policy floors cap risk.</li>
  <li><strong>Proof:</strong> Live dashboards and audits for diligence.</li>
</ul>
  </div>
</div>
<script>
(function(){
  var content = document.getElementById('rcra-why-content');
  var investorHTML = `<h3>Why This Matters — Investor View</h3>
<p>This experience demonstrates an AI product with measurable value creation and user trust. It translates model performance into business outcomes and reduces risk via governance.</p>
<ul>
  <li><strong>Upside:</strong> Higher conversion and retention with better answers.</li>
  <li><strong>Downside Protection:</strong> Automatic refunds and policy floors cap risk.</li>
  <li><strong>Proof:</strong> Live dashboards and audits for diligence.</li>
</ul>`;
  var techHTML = `<h3>Why This Matters — Technical & Governance</h3>
<p>Focus on <strong>epistemic integrity</strong> with runtime enforcement and observability.</p>
<ul>
  <li><strong>SLRC Enforcement:</strong> Outputs gated by Secure Logic Reasoning Contracts.</li>
  <li><strong>ROC-Tuned Floors:</strong> τ thresholds optimized on live distributions.</li>
  <li><strong>Multisig & HMAC:</strong> Floor changes require cryptographic approvals.</li>
  <li><strong>Continuous Assurance:</strong> Canary pass-rate & failure tiles backed by Prometheus.</li>
  <li><strong>Ops-Ready:</strong> Containerized services, alerts, and audit artifacts.</li>
</ul>`;
  Array.prototype.forEach.call(document.querySelectorAll('input[name="rcraMode"]'), function(r){ 
    r.addEventListener('change', function(){ 
      content.innerHTML = (r.value === 'tech') ? techHTML : investorHTML; 
    });
  });
})();
<\/script>


<script>
(function(){
  function getParam(name){
    const params = new URLSearchParams(window.location.search);
    return params.get(name);
  }
  const mode = getParam("mode");
  if(mode && mode.toLowerCase() === "tech"){
    const techRadio = document.querySelector('input[name="rcraMode"][value="tech"]');
    if(techRadio){
      techRadio.checked = true;
      const event = new Event('change');
      techRadio.dispatchEvent(event);
    }
  }
})();
<\/script>


<style>
  .meta-card{border:1px solid #e2e8f0;border-radius:10px;padding:12px;margin:14px 0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .meta-table{width:100%;border-collapse:collapse;font-size:13px}
  .meta-table th,.meta-table td{border-bottom:1px solid #e5e7eb;padding:6px 8px;text-align:left}
  .meta-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .chip{display:inline-block;padding:3px 8px;border-radius:9999px;background:#eef2ff}
  .btn{padding:8px 10px;border:1px solid #0ea5e9;border-radius:8px;background:#0ea5e9;color:#fff;font-weight:600;cursor:pointer}
  .btn.secondary{background:#fff;color:#0ea5e9}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
</style>

<div class="meta-card" id="meta-promotion">
  <div class="meta-row">
    <strong>Meta-Promotion Status</strong>
    <span class="chip" id="meta-status">—</span>
    <span class="mono" id="meta-updated"></span>
  </div>
  <div class="meta-row mono" style="margin-top:6px">
    Thresholds: <span id="meta-thresholds">—</span>
  </div>
  <div class="meta-row" style="margin-top:8px">
    <strong>Signing</strong>
    <label class="mono">kid</label><input id="meta-kid" value="ops" size="8">
    <label class="mono">secret (hex)</label><input id="meta-secret" size="68" placeholder="paste hex key">
    <label class="mono">sign</label>
    <select id="meta-sign-toggle"><option value="on" selected>ON</option><option value="off">OFF</option></select>
  </div>

  <table class="meta-table" id="meta-table" style="margin-top:8px">
    <thead>
      <tr><th>Artifact</th><th>ValueScore</th><th>LPD</th><th>Status</th><th>Hash</th></tr>
    </thead>
    <tbody id="meta-tbody"></tbody>
  </table>
  <div class="meta-row" style="margin-top:10px">
    <button class="btn" id="btn-promote">Promote Release</button><button class="btn secondary" id="btn-ingest">Ingest Results</button><button class="btn secondary" id="btn-aggregate">Aggregate Now</button>
    <button class="btn secondary" id="btn-retest">Trigger Re-Test</button>
    <button class="btn secondary" id="btn-export">Export Evidence</button>
  </div>
  <pre class="mono" id="meta-log" style="white-space:pre-wrap;max-height:180px;overflow:auto;background:#0b1020;color:#d1d5db;padding:10px;border-radius:8px;margin-top:10px"></pre>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const log = msg => { const el = $("meta-log"); el.textContent = (new Date().toISOString()+" "+msg+"\n") + el.textContent; };

  async function fetchJSON(url, opts){
    const r = await fetch(url, opts||{});
    if(!r.ok){ throw new Error(r.status+" "+await r.text()); }
    return r.json();
  }


  // HMAC helpers
  function hexToBytes(hex){ const a=[]; for(let i=0;i<hex.length;i+=2){ a.push(parseInt(hex.substr(i,2),16)); } return new Uint8Array(a); }
  function bytesToHex(buf){ return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,"0")).join(""); }
  function sortKeys(obj){
    if(Array.isArray(obj)) return obj.map(sortKeys);
    if(obj && typeof obj==="object"){ const out={}; Object.keys(obj).sort().forEach(k=> out[k]=sortKeys(obj[k])); return out; }
    return obj;
  }
  function canonicalJSON(obj){ return JSON.stringify(sortKeys(obj)); }
  async function hmacSha256Hex(secretHex, canonical){
    const key = await crypto.subtle.importKey("raw", hexToBytes(secretHex), {name:"HMAC", hash:"SHA-256"}, false, ["sign"]);
    const sig = await crypto.subtle.sign("HMAC", key, new TextEncoder().encode(canonical));
    return bytesToHex(sig);
  }
  async function signedFetch(baseUrl, path, body, action){
    const kid = (document.getElementById("meta-kid")||{}).value || "ops";
    const secret = (document.getElementById("meta-secret")||{}).value || "";
    const signOn = (document.getElementById("meta-sign-toggle")||{}).value !== "off";
    const ts = Math.floor(Date.now()/1000);
    const nonce = ts + "-" + kid;
    const reqBody = Object.assign({}, body, { kid, nonce, ts });
    const headers = {"Content-Type":"application/json"};
    if(signOn){
      if(!secret) throw new Error("Signing enabled but secret is empty");
      const canonical = canonicalJSON({action, ...body, nonce, ts});
      const sig = await hmacSha256Hex(secret, canonical);
      headers["X-Signature"] = `${kid}:${sig}:${nonce}:${ts}`;
    }
    const res = await fetch(baseUrl.replace(/\/$/,'') + path, { method:"POST", headers, body: JSON.stringify(reqBody) });
    if(!res.ok){ const t = await res.text(); throw new Error(res.status + " " + t); }
    return res.json();
  }

  async function refreshMeta(){
    try{
      const base = (window.RCRA_FASTAPI_BASE || "http://localhost:8000").replace(/\/$/, "");
      const j = await fetchJSON(base + "/meta_promotion/status");
      $("meta-status").textContent = j.overall_status || "UNKNOWN";
      $("meta-updated").textContent = j.last_updated || "";
      const th = j.thresholds || {};
      $("meta-thresholds").textContent = `v≥${th.v_min}, LPD≥${th.lpd_min}, σ≤${th.sigma_max}, d≥${th.depth_min}`;
      const tbody = $("meta-tbody"); tbody.innerHTML = "";
      (j.artifacts||[]).forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${a.id}</td><td>${a.ValueScore?.toFixed?.(2) ?? a.ValueScore}</td><td>${a.LPD?.toFixed?.(2) ?? a.LPD}</td><td>${a.status}</td><td>${a.hash||""}</td>`;
        tbody.appendChild(tr);
      });
      log("status refreshed");
    }catch(e){ log("ERR refresh: " + e.message); }
  }

  $("btn-promote").addEventListener("click", async ()=>{
    try{
      const base = (window.RCRA_FASTAPI_BASE || "http://localhost:8000").replace(/\/$/, "");
      const body = { perimeter_id: "release_2025_08", requester: "qa_lead", note: "Cockpit promote" };
      const r = await signedFetch(base, "/meta_promotion/promote", body, "promote");
      log("promote → " + JSON.stringify(r));
      await refreshMeta();
    }catch(e){ log("ERR promote: " + e.message); }
  });

  $("btn-retest").addEventListener("click", async ()=>{ log("re-test triggered (stub)"); });
  $("btn-export").addEventListener("click", async ()=>{ log("export requested (stub)"); });

  // Expose a simple way to set base URL from outside (optional)
  window.setRcraFastapiBase = (url)=>{ window.RCRA_FASTAPI_BASE = url; refreshMeta(); };


  document.getElementById("btn-ingest").addEventListener("click", async ()=>{
    try{
      const base = (window.RCRA_FASTAPI_BASE || "http://localhost:8000").replace(/\/$/, "");
      const payload = { perimeter_id: "release_2025_08", artifacts:[
        {"id":"contract_v2.md","ValueScore":0.92,"LPD":1.52,"status":"PASS","hash":"4e1f7c"},
        {"id":"policy.yaml","ValueScore":0.88,"LPD":1.34,"status":"PASS","hash":"a9c2b1"},
        {"id":"summary.pdf","ValueScore":0.83,"LPD":1.28,"status":"FAIL","hash":"6d4b2a"}
      ]};
      const r = await fetchJSON(base + "/meta_promotion/ingest", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
      log("ingest → " + JSON.stringify(r)); await refreshMeta();
    }catch(e){ log("ERR ingest: " + e.message); }
  });
  document.getElementById("btn-aggregate").addEventListener("click", async ()=>{
    try{
      const base = (window.RCRA_FASTAPI_BASE || "http://localhost:8000").replace(/\/$/, "");
      const payload = { perimeter_id: "release_2025_08", artifacts:[
        {"id":"contract_v2.md","output":"...", "context_id":"c1"},
        {"id":"policy.yaml",    "output":"...", "context_id":"c1"},
        {"id":"summary.pdf",    "output":"...", "context_id":"c1"}
      ]};
      const r = await fetchJSON(base + "/meta_promotion/aggregate", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
      log("aggregate → " + JSON.stringify(r)); await refreshMeta();
    }catch(e){ log("ERR aggregate: " + e.message); }
  });

  refreshMeta();
})();
<\/script>


<div id="docIcons" style="position:fixed; top:8px; right:8px; display:flex; gap:8px; z-index:99998; pointer-events:none;">
  <button id="docHelpIcon" class="btn tiny" title="Context Help (Shift+?)" aria-label="Context Help" style="pointer-events:auto; opacity:.9;">?</button>
  <button id="docDocsIcon" class="btn tiny" title="Docs Index" aria-label="Docs Index" style="pointer-events:auto; opacity:.9;">📄</button>
</div>
<script>(function(){const h=document.getElementById('docHelpIcon');const d=document.getElementById('docDocsIcon');function openDocs(a){try{parent.postMessage({type:'docs:open',anchor:a||'#overview'},'*');}catch(_){}}h&&h.addEventListener('click',(e)=>{e.preventDefault(); if(window.openContextDocs) window.openContextDocs(); else openDocs('#overview');}); d&&d.addEventListener('click',(e)=>{e.preventDefault(); openDocs('#overview');});})();<\/script>


<script>
(function(){
  if (window.__CTX_HELP_V1__) return; window.__CTX_HELP_V1__ = true;
  function isVisible(el){ if(!el) return false; const cs=getComputedStyle(el); if(cs.display==='none'||cs.visibility==='hidden'||cs.opacity==='0') return false; const r=el.getBoundingClientRect(); return r.width>0&&r.height>0; }
  function $(s){ return document.querySelector(s); } function $all(s){ return Array.from(document.querySelectorAll(s)); }
  function getContextAnchor(){
    const tagged = document.querySelector('[data-cockpit-context]');
    if (tagged){ const v = tagged.getAttribute('data-cockpit-context'); if(/^#(overview|pedagogy|economics|governance)$/.test(v)) return v; }
    const govHdr = $all('h1,h2,h3,.section-title').find(h => /Policy\s*Editor|τ|tau|SLRC|floors/i.test(h.textContent||'')); if (govHdr && isVisible(govHdr)) return '#governance';
    const econHit = $all('h1,h2,h3,.section-title,.card .title,#rocPanel').find(h => /ROC|threshold|knee|profit|LPD|LGD/i.test((h.textContent||'') + ' ' + (h.id||''))); if (econHit && isVisible(econHit)) return '#economics';
    const riskEl = document.querySelector('.risk-tag') || $all('h1,h2,h3,.section-title').find(h => /Pedagogy|Risk|ZPD|Scaffold/i.test(h.textContent||'')); if (riskEl && (riskEl.classList?.contains?.('risk-tag') || isVisible(riskEl))) return '#pedagogy';
    return '#overview';
  }
  function openParent(anchor){ try{ parent.postMessage({type:'docs:open', anchor:anchor||'#overview'}, '*'); }catch(_){ } }
  const helpBtn = document.getElementById('docHelpIcon'); const docsBtn = document.getElementById('docDocsIcon');
  helpBtn && helpBtn.addEventListener('click', (e)=>{ e.preventDefault(); openParent(getContextAnchor()); });
  docsBtn && docsBtn.addEventListener('click', (e)=>{ e.preventDefault(); openParent('#overview'); });
  window.openContextDocs = function(){ openParent(getContextAnchor()); };
  window.addEventListener('keydown', (e)=>{ if(e.shiftKey && e.key==='?'){ e.preventDefault(); openParent(getContextAnchor()); } });
})();
<\/script>


<div id="aboutBtnWrap" style="position:fixed; top:8px; right:54px; z-index:99998;">
  <button id="aboutOpenBtn" class="btn tiny" title="About / Pricing / Proof" aria-label="About / Pricing / Proof" style="opacity:.9;">About</button>
</div>


<div id="aboutPanel" style="position:fixed; top:0; right:-520px; width:500px; height:100vh; background:var(--card,#111); color:var(--text,#eee); border-left:1px solid var(--border,#333); box-shadow:-8px 0 24px rgba(0,0,0,.24); transition:right .25s ease; z-index:99997; display:flex; flex-direction:column;">
  <div style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--border,#333);">
    <strong>About: Metrics, Pricing & Proof</strong>
    <div><button class="btn tiny" id="aboutCloseBtn">Close</button></div>
  </div>
  <div style="display:flex; gap:6px; padding:8px 10px; border-bottom:1px solid var(--border,#333);">
    <button class="btn tiny" data-subtab="overview">Overview</button>
    <button class="btn tiny" data-subtab="pedagogy">Pedagogy</button>
    <button class="btn tiny" data-subtab="economics">Economics</button>
  </div>
  <div id="aboutContent" style="flex:1; overflow:auto; padding:12px;">
    <section data-tab="overview">
      <h3>Why these metrics exist</h3>
      <p>We join pedagogy quality with economic ROI so every run is both <em>educationally sound</em> and <em>worth paying for</em>. See the Integration Map inside the Docs Drawer for the full flow.</p>
      <div style="margin:8px 0;"><button class="btn tiny" id="openDocsOverview">Open Docs → Overview</button></div>
      <hr><h4>Pricing (snapshot)</h4>
      <div id="pricingSnapshot" class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
        <div class="card" style="padding:8px;"><div class="tiny muted">Developer</div><div class="stat" id="priceDev">$99/mo + $0.005/eval</div></div>
        <div class="card" style="padding:8px;"><div class="tiny muted">Enterprise</div><div class="stat" id="priceEnt">$2,500/mo + $0.003/eval</div></div>
      </div>
      <p class="tiny muted">Override via URL params: <code>?dev_month=129&dev_eval=0.006&ent_month=3500&ent_eval=0.0025</code></p>
      <hr><h4>Proof hooks</h4>
      <p>Generate an evidence bundle from the current session (τ floors, metrics snapshot, timestamp), and optionally push a signed meta-promotion marker upstream.</p>
      <div style="display:flex; gap:8px; flex-wrap:wrap;"><button class="btn" id="btnEvidence">Generate Evidence Bundle</button><button class="btn" id="btnPublishProof">Meta‑Promotion: Publish Proof</button></div>
      <div id="proofStatus" class="tiny muted" style="margin-top:8px;"></div>
    </section>
    <section data-tab="pedagogy" style="display:none;">
      <h3>Pedagogy</h3>
      <p>Risk operators (e.g., mis‑targeted‑difficulty, over/under‑scaffold) adjust ValueScore <code>v</code> before floors are applied, ensuring ZPD fit and learning integrity.</p>
      <ul><li>Click risk tags in the cockpit to see primers; use “Read more” to jump to docs.</li><li>Anchors & gold vectors (u★) establish objective alignment.</li></ul>
      <div style="margin:8px 0;"><button class="btn tiny" id="openDocsPedagogy">Open Docs → Pedagogy</button></div>
    </section>
    <section data-tab="economics" style="display:none;">
      <h3>Economics</h3>
      <p>LPD (Logic‑per‑Dollar) combines ValueScore and cost, moderated by LGD (Learning Gain/$). Floors (τ) enforce refunds when value dips below the threshold.</p>
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:8px 0;">
        <div class="card" style="padding:8px;"><div class="tiny muted">τ.v_min</div><div id="tau_v" class="stat">—</div></div>
        <div class="card" style="padding:8px;"><div class="tiny muted">τ.lpd_min</div><div id="tau_lpd" class="stat">—</div></div>
        <div class="card" style="padding:8px;"><div class="tiny muted">τ.sigma_max</div><div id="tau_sigma" class="stat">—</div></div>
        <div class="card" style="padding:8px;"><div class="tiny muted">τ.depth_min</div><div id="tau_depth" class="stat">—</div></div>
      </div>
      <div style="margin:8px 0;"><button class="btn tiny" id="openDocsEconomics">Open Docs → Economics</button></div>
    </section>
  </div>
</div>


<script>
(function(){
  if (window.__ABOUT_CTRL__) return; window.__ABOUT_CTRL__ = true;
  const panel=document.getElementById('aboutPanel'), openBtn=document.getElementById('aboutOpenBtn'), closeBtn=document.getElementById('aboutCloseBtn');
  const tabs=Array.from(document.querySelectorAll('[data-subtab]')), sections=Array.from(document.querySelectorAll('#aboutContent [data-tab]'));
  function setTab(n){ sections.forEach(s=> s.style.display = (s.getAttribute('data-tab')===n?'block':'none')); tabs.forEach(t=> t.classList.toggle('active', t.getAttribute('data-subtab')===n)); }
  function open(){ panel.style.right='0'; } function close(){ panel.style.right='-520px'; } setTab('overview');
  openBtn&&openBtn.addEventListener('click',(e)=>{e.preventDefault();open();}); closeBtn&&closeBtn.addEventListener('click',(e)=>{e.preventDefault();close();}); tabs.forEach(t=> t.addEventListener('click',()=> setTab(t.getAttribute('data-subtab')))); window.addEventListener('keydown',(e)=>{ if(e.key==='Escape') close(); });

  // Pricing via URL params
  function q(k,f){ try{const u=new URL(window.location.href); return u.searchParams.get(k)||f;}catch(_){return f;} }
  const devMonth=parseFloat(q('dev_month','99')), devEval=parseFloat(q('dev_eval','0.005')), entMonth=parseFloat(q('ent_month','2500')), entEval=parseFloat(q('ent_eval','0.003'));
  const D=document.getElementById('priceDev'), E=document.getElementById('priceEnt'); if(D) D.textContent=`$${devMonth}/mo + $${devEval}/eval`; if(E) E.textContent=`$${entMonth}/mo + $${entEval}/eval`;

  // τ from parent
  const tau={v_min:'—',lpd_min:'—',sigma_max:'—',depth_min:'—'}; function r(){ const m=(id,v)=>{const el=document.getElementById(id); if(el) el.textContent=v;}; m('tau_v',tau.v_min); m('tau_lpd',tau.lpd_min); m('tau_sigma',tau.sigma_max); m('tau_depth',tau.depth_min); } r();
  try{ parent.postMessage({type:'tau:request'}, '*'); }catch(_){}
  window.addEventListener('message',(e)=>{const d=e&&e.data; if(!d) return; if(d.type==='tau:response'&&d.floors){Object.assign(tau,d.floors); r();}});

  // Evidence + publish
  function download(fn,txt){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([txt],{type:'application/json'})); a.download=fn; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800); }
  function now(){ try{return new Date().toISOString();}catch(_){return String(Date.now());} }
  function t(el){ return el ? el.textContent.trim() : '—'; }
  function snap(){ return { t: now(), tau:{...tau}, metrics:{ v_avg:t(document.querySelector('[data-doc=\"economics#v\"]')), lpd_avg:t(document.querySelector('[data-doc=\"economics#lpd\"]')), sigma_avg:t(document.querySelector('[data-doc=\"economics#sigma\"]')) }, pricing:{devMonth,devEval,entMonth,entEval} }; }
  const ev=document.getElementById('btnEvidence'), pb=document.getElementById('btnPublishProof'), ps=document.getElementById('proofStatus');
  ev&&ev.addEventListener('click',()=>{ const data=snap(); download('evidence_bundle.json', JSON.stringify(data,null,2)); ps&&(ps.textContent='Evidence bundle generated.'); });
  pb&&pb.addEventListener('click',()=>{ const data=snap(); let ok=false; try{ parent.postMessage({type:'meta:publish', payload:data}, '*'); ok=true; }catch(_){ } ps&&(ps.textContent = ok ? 'Publish request sent to parent.' : 'Failed to send publish request.'); });

  // Doc shortcuts
  document.getElementById('openDocsOverview')?.addEventListener('click',()=>{ try{ parent.postMessage({type:'docs:open', anchor:'#overview'}, '*'); }catch(_){ } });
  document.getElementById('openDocsPedagogy')?.addEventListener('click',()=>{ try{ parent.postMessage({type:'docs:open', anchor:'#pedagogy'}, '*'); }catch(_){ } });
  document.getElementById('openDocsEconomics')?.addEventListener('click',()=>{ try{ parent.postMessage({type:'docs:open', anchor:'#economics'}, '*'); }catch(_){ } });
})();
<\/script>


<!-- Inline Mode Toggle -->



<script>
(function(){
  if (window.__INLINE_TOGGLE_REMOVED__) return; window.__INLINE_TOGGLE_REMOVED__ = true;
  const iframe = document.getElementById('cockpitFrame');
  const host = document.getElementById('cockpitInlineHost');
  const tpl = document.getElementById('cockpitInlineTpl');
  const btnIframe = document.getElementById('btnUseIframe');
  const btnInline = document.getElementById('btnUseInline');
  const status = document.getElementById('embedStatus');

  function setStatus(msg){ if (status) status.textContent = msg || ''; }

  function useIframe(){
    if (!iframe) return;
    iframe.style.display = 'block';
    if (host) { host.style.display = 'none'; host.innerHTML = ''; }
    setStatus('(iframe)');
    try { localStorage.setItem('embedMode','iframe'); } catch(e){}
  }

  function useInline(){
    if (!host || !tpl) return;
    if (iframe) iframe.style.display = 'none';
    host.style.display = 'block';
    host.innerHTML = '';
    const clone = document.importNode(tpl.content, true);
    host.appendChild(clone);
    setStatus('(inline)');
    try { localStorage.setItem('embedMode','inline'); } catch(e){}
  }

  btnIframe && btnIframe.addEventListener('click', useIframe);
  btnInline && btnInline.addEventListener('click', useInline);

  let switched = false;
  function detectBlockedIframe(){
    try {
      if (!iframe) return;
      const seemsBlocked = !iframe.contentWindow;
      if (seemsBlocked && !switched){
        switched = true;
        useInline();
        setStatus('(auto-switched; iframe blocked)');
        return;
      }
      let acked = false;
      function onMsg(e){ if (e && e.data && e.data.type === 'inline:ack') { acked = true; window.removeEventListener('message', onMsg); } }
      window.addEventListener('message', onMsg);
      try { iframe.contentWindow.postMessage({type:'inline:ping'}, '*'); } catch(e){}
      setTimeout(function(){
        if (!acked && !switched){
          switched = true;
          useInline();
          setStatus('(auto-switched; no iframe ack)');
          window.removeEventListener('message', onMsg);
        }
      }, 800);
    } catch(e){
      if (!switched){
        switched = true;
        useInline();
        setStatus('(auto-switched; error)');
      }
    }
  }

  let saved = null;
  try { saved = localStorage.getItem('embedMode'); } catch(e){}
  if (saved === 'inline') useInline(); else useIframe();

  window.addEventListener('load', ()=> setTimeout(detectBlockedIframe, 300));
})();
</script>


<!-- Self-Test Button -->
<div id="selfTestBtn" style="position:fixed; bottom:16px; left:16px; z-index:10001;">
  <button class="btn tiny" style="padding:8px 10px;">Run Self‑Test</button>
</div>


<!-- Self-Test Panel -->
<div id="selfTestPanel" style="display:none; position:fixed; bottom:60px; left:16px; z-index:10002; width:360px; max-height:60vh; overflow:auto; background:rgba(20,20,20,.92); color:#eee; border:1px solid #333; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);">
  <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid #333;">
    <strong>Anchor ↔ Cockpit Self‑Test</strong>
    <button id="stClose" class="btn tiny">Close</button>
  </div>
  <div id="stLog" style="font-family:system-ui,Segoe UI,Arial; font-size:12.5px; padding:10px 12px; line-height:1.35;"></div>
</div>


<script>
(function(){
  if (window.__SELFTEST__) return; window.__SELFTEST__ = true;
  function el(id){ return document.getElementById(id); }
  function log(html){ const box = el('stLog'); box.innerHTML += html + '<br>'; }
  function status(label, ok, note){
    const s = ok===true ? '🟢' : ok===false ? '🔴' : '🟡';
    log(`<div><b>${s} ${label}</b>${note? ' — ' + note : ''}</div>`);
  }
  function sep(t){ log(`<div style="margin:6px 0; color:#9aa;">— ${t} —</div>`); }

  function openPanel(show){ el('selfTestPanel').style.display = show ? 'block' : 'none'; }
  el('selfTestBtn')?.addEventListener('click', run);
  el('stClose')?.addEventListener('click', ()=> openPanel(false));

  function tryOpenDocs(anchor){
    try{
      window.openDocsDrawer(anchor||'#overview');
      const drawer = document.getElementById('docsDrawer');
      const ok = !!drawer && getComputedStyle(drawer).right === '0px';
      status('Docs Drawer opens', ok, ok?'opened':'drawer closed');
    }catch(e){ status('Docs Drawer opens', false, e.message); }
  }

  function testMode(){
    const iframe = document.getElementById('cockpitFrame');
    const inlineHost = document.getElementById('cockpitInlineHost');
    const iframeVisible = !!(iframe && iframe.style.display !== 'none');
    const inlineVisible = !!(inlineHost && inlineHost.style.display !== 'none' && inlineHost.childElementCount>0);
    let mode = iframeVisible ? 'iframe' : (inlineVisible ? 'inline' : 'unknown');
    status('Embed mode detected', mode!=='unknown', mode);
    return { iframeVisible, inlineVisible, mode };
  }

  function testMessagingRoundtrip(){
    return new Promise((resolve)=>{
      let gotResponse = false;
      function onMsg(e){ if (e && e.data && e.data.type==='tau:response'){ gotResponse = true; window.removeEventListener('message', onMsg); status('τ roundtrip (simulated)', true, 'parent responded'); resolve(true); } }
      window.addEventListener('message', onMsg);
      // Simulate a child asking for τ (parent listener replies to source with tau:response)
      try {
        window.dispatchEvent(new MessageEvent('message', { data: { type:'tau:request' }, source: window }));
        setTimeout(()=>{ if (!gotResponse){ window.removeEventListener('message', onMsg); status('τ roundtrip (simulated)', false, 'no response'); resolve(false); } }, 600);
      } catch(e){ status('τ roundtrip (simulated)', false, e.message); resolve(false); }
    });
  }

  function testMetaPublish(){
    return new Promise((resolve)=>{
      let ack = false;
      function onMsg(e){ if (e && e.data && e.data.type==='meta:ack'){ ack = true; window.removeEventListener('message', onMsg); status('Meta‑publish ACK', true); resolve(true); } }
      window.addEventListener('message', onMsg);
      try{
        // Simulate child sending publish
        window.dispatchEvent(new MessageEvent('message', { data: { type:'meta:publish', payload:{t:'test'} }, source: window }));
        setTimeout(()=>{ if (!ack){ window.removeEventListener('message', onMsg); status('Meta‑publish ACK', false, 'no ack'); resolve(false); } }, 600);
      }catch(e){ status('Meta‑publish ACK', false, e.message); resolve(false); }
    });
  }

  function testTelemetry(){
    return new Promise((resolve)=>{
      let logged = false;
      function onMsg(e){ if (e && e.data && e.data.type==='telemetry'){ logged = true; window.removeEventListener('message', onMsg); status('Telemetry passthrough', true, e.data.event||'event'); resolve(true); } }
      window.addEventListener('message', onMsg);
      try{
        window.dispatchEvent(new MessageEvent('message', { data: { type:'telemetry', event:'selftest', data:{ok:true} }, source: window }));
        setTimeout(()=>{ if (!logged){ window.removeEventListener('message', onMsg); status('Telemetry passthrough', false, 'no event seen'); resolve(false); } }, 600);
      }catch(e){ status('Telemetry passthrough', false, e.message); resolve(false); }
    });
  }

  async function run(){
    el('stLog').innerHTML='';
    openPanel(true);
    sep('Environment');
    const mode = testMode();

    sep('Docs');
    tryOpenDocs('#overview');

    sep('Messaging');
    await testMessagingRoundtrip();
    await testMetaPublish();
    await testTelemetry();

    sep('Next actions');
    log(`<div class="tiny">If iframe is blocked locally, click <b>Inline</b> (bottom‑right) or run: <code>python3 -m http.server 8000</code> then open http://localhost:8000/anchor_all_in_one.html</div>`);
  }
})();
</script>


<!-- Embed Mode Badge -->
<div id="embedModeBadge" style="position:fixed; top:8px; right:8px; z-index:10001; font-size:11px; font-family:system-ui,Segoe UI,Arial; background:rgba(20,20,20,.85); color:#eee; border:1px solid #444; border-radius:6px; padding:3px 6px; cursor:default;">
  <span id="embedModeText">Embed: ?</span>
  <span title="Iframe = embedded via data: URL; Inline = fallback for local/demo use" style="margin-left:4px; color:#aaa;">?</span>
</div>


<script>
(function(){
  if (window.__EMBED_BADGE__) return; window.__EMBED_BADGE__ = true;
  const badge = document.getElementById('embedModeBadge');
  const txt = document.getElementById('embedModeText');
  function setMode(mode, note){
    if (txt) txt.textContent = 'Embed: ' + (mode==='inline' ? 'Inline (Fallback)' : 'Iframe');
    if (note && badge) badge.title = note;
  }
  function detect(){
    const iframe = document.getElementById('cockpitFrame');
    const host = document.getElementById('cockpitInlineHost');
    const iframeVisible = iframe && iframe.style.display !== 'none';
    const inlineVisible = host && host.style.display !== 'none' && host.childElementCount>0;
    const mode = inlineVisible ? 'inline' : (iframeVisible ? 'iframe' : 'unknown');
    setMode(mode, mode==='inline' ? 'Inline mode = fallback for local/demo use' : 'Iframe mode = embedded via data: URL');
  }
  window.addEventListener('load', detect);
  window.addEventListener('message', (e)=>{
    if (e && e.data && e.data.type==='embedModeChanged'){ detect(); }
  });
  detect();
})();
</script>


<script>
(function(){
  if (window.__AUTO_TAG_DEV__) return;
  window.__AUTO_TAG_DEV__ = true;

  function autoTagDevControls() {
    const selectors = [
      '.palette',
      '.dev-controls',
      '#devPalette',
      '[id*="palette"]',
      '[class*="palette"]'
    ];
    document.querySelectorAll(selectors.join(',')).forEach(el => {
      if (!el.hasAttribute('data-dev-controls')) {
        el.setAttribute('data-dev-controls', '');
      }
    });
  }

  // Run immediately and after DOM is ready (covers late mounts)
  try { autoTagDevControls(); } catch(e){}
  document.addEventListener('DOMContentLoaded', autoTagDevControls);
  window.addEventListener('load', autoTagDevControls);
})();
</script>


<!-- RC/RA Evaluator Drawer -->
<style>
#rcDrawerToggle{position:fixed;right:16px;bottom:16px;z-index:9999}
#rcDrawer{position:fixed;right:0;top:0;bottom:0;width:min(520px, 96vw);
  transform:translateX(100%); transition:transform .25s ease; z-index:9998;
  background:rgba(255,255,255,.98); color:#0f172a; border-left:4px solid #111827;
  box-shadow:-12px 0 40px rgba(0,0,0,.22); padding:14px; overflow:auto}
@media (prefers-color-scheme: dark){
  #rcDrawer{background:rgba(15,19,26,.98); color:#e6e6ea; border-left:4px solid #e6e6ea}
}
#rcDrawer.open{transform:none}
#rcDrawer h3{margin:4px 0 8px 0}
#rcDrawer .row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
#rcDrawer .kv{display:grid; grid-template-columns:auto 1fr; gap:6px 10px; font-size:13px}
#rcClose{position:sticky; top:0; float:right}
#rcFloors{border:1px solid #cbd5e1; border-radius:10px; padding:8px; margin-top:8px}
#rcScores{border:1px solid #cbd5e1; border-radius:10px; padding:8px; margin-top:8px}
#rcRaw{white-space:pre-wrap; font-size:12px; border:1px solid #cbd5e1; border-radius:10px; padding:8px; margin-top:8px}
</style>
<button id="rcDrawerToggle" class="btn">Evaluator</button>
<aside id="rcDrawer" aria-hidden="true">
  <button id="rcClose" class="btn">Close</button>
  <h2 style="margin:6px 0 10px 0;">Evaluator</h2>
  <div class="row">
    <div>
      <label style="font-size:12px">Output</label>
      <textarea id="rcOut" rows="8" placeholder="Paste output here…"
        style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px"></textarea>
      <div class="row" style="margin-top:8px">
        <div><label style="font-size:12px">context_id</label><input id="rcCtx" placeholder="demo"
          style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px"/></div>
        <div><label style="font-size:12px">SLRC</label>
          <select id="rcSlrc" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px">
            <option value="default">default</option>
            <option value="strict">strict</option>
            <option value="lenient">lenient</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label style="font-size:12px">Base URL</label>
          <input id="rcBase" placeholder="http://localhost:8080"
            style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px"/>
        </div>
        <div><label style="font-size:12px">Mode</label>
          <select id="rcMode" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px">
            <option value="mock">Mock</option>
            <option value="live">Live</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px">
        <button id="rcRun" class="btn">Run</button>
      </div>
    </div>
    <div>
      <h3>Floors</h3>
      <div id="rcFloors" class="kv"></div>
      <div id="rcScores" class="kv" style="margin-top:8px"></div>
      <div style="margin-top:8px; font-weight:800">Decision: <span id="rcDecision">—</span></div>
      <div id="rcTags" style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap"></div>
    </div>
  </div>
  <h3>Raw</h3>
  <pre id="rcRaw"></pre>
</aside>
<script>
(function(){
  const $=s=>document.querySelector(s);
  let MODE='mock', BASE='';
  const kv = obj => Object.entries(obj).map(([k,v])=>`<div>${k}</div><div><b>${v}</b></div>`).join('');
  function mockFloors(v){ if(v==='strict')return {tau_v:0.86,tau_L:1.35,sigma_max:0.20,d_min:3};
    if(v==='lenient')return {tau_v:0.80,tau_L:1.20,sigma_max:0.26,d_min:2}; return {tau_v:0.84,tau_L:1.30,sigma_max:0.22,d_min:2}; }
  function mockEval(text,f){ const spec=/\b(maybe|might|probably|guess|assume)\b/i.test(text||'');
    const v=spec?0.84:0.89; const v_net=+(v-(spec?0.03:0)).toFixed(3);
    const lpd=+(v_net/0.001).toFixed(3); const sigma=(text||'').toLowerCase().includes('objective')?0.19:0.25;
    const ok=!(v_net<f.tau_v||lpd<f.tau_L||sigma>f.sigma_max||2<f.d_min);
    return {value:{v:+v.toFixed(3),v_net}, lpd:{lpd,lpd_net:lpd}, sigma, depth:2, ok, tags: spec?[{id:'speculative_language',conf:0.12}]:[], raw:{note:'mock'}}; }
  async function api(path, method='POST', body){ const u=`${BASE}${path}`;
    const res=await fetch(u,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})});
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    const ct=res.headers.get('content-type')||''; return ct.includes('json')?res.json():res.text(); }
  function loadFloors(){ const variant=$('#rcSlrc').value||'default';
    if(MODE==='mock'){ $('#rcFloors').innerHTML=kv(mockFloors(variant)); return; }
    api('/slrc/select','POST', variant).then(j=>$('#rcFloors').innerHTML=kv(j.floors||mockFloors(variant)))
      .catch(()=>$('#rcFloors').innerHTML=kv(mockFloors(variant))); }
  async function run(){ const text=$('#rcOut').value||'Objective: win a 30-day pilot with refund-backed SLA.';
    const ctx=$('#rcCtx').value||'demo'; const policy=$('#rcSlrc').value||'default'; const floors = (function(){const el=$('#rcFloors'); try{ return JSON.parse(el.dataset.json||'null'); }catch{return null}})() || mockFloors(policy);
    if(MODE==='mock'){ const r=mockEval(text,floors); render(r); $('#rcRaw').textContent=JSON.stringify(r.raw,null,2); return; }
    try{ const j=await api('/detector/eval','POST',{output:text, context_id:ctx, policy}); render({ value:j.value||{}, lpd:j.lpd||{}, sigma:j.sigma, depth:j.depth, ok:!!j.ok, tags:j.tags||[], raw:j }); $('#rcRaw').textContent=JSON.stringify(j,null,2); }
    catch(e){ const r=mockEval(text,floors); render(r); $('#rcRaw').textContent=JSON.stringify({error:e.message, fallback:'mock'},null,2); } }
  function render(r){ $('#rcScores').innerHTML=kv({v:r.value?.v, v_net:r.value?.v_net, lpd:r.lpd?.lpd, lpd_net:r.lpd?.lpd_net, sigma:r.sigma, d:r.depth});
    $('#rcDecision').innerHTML = r.ok?'<span style="color:#166534">BILL</span>':'<span style="color:#b91c1c">REFUND</span>';
    const tags=r.tags||[]; $('#rcTags').innerHTML = tags.length? tags.map(t=>`<span class="chip">${t.id} (${t.conf||t.weight||''})</span>`).join(' '):'<span class="chip">no tags</span>'; }
  // wire UI
  document.addEventListener('click', (e)=>{
    if(e.target.id==='rcDrawerToggle'){ $('#rcDrawer').classList.add('open'); }
    if(e.target.id==='rcClose'){ $('#rcDrawer').classList.remove('open'); }
    if(e.target.id==='rcRun'){ run(); }
  });
  $('#rcMode').addEventListener('change', e=>{ MODE=e.target.value; loadFloors(); });
  $('#rcBase').addEventListener('change', e=>{ BASE=e.target.value.trim(); });
  $('#rcSlrc').addEventListener('change', loadFloors);
  loadFloors();
})();
</script>

</body></html>

</template>

<!-- Inline Mode Toggle -->



<script>
(function(){
  if (window.__INLINE_TOGGLE_REMOVED__) return; window.__INLINE_TOGGLE_REMOVED__ = true;
  const iframe = document.getElementById('cockpitFrame');
  const host = document.getElementById('cockpitInlineHost');
  const tpl = document.getElementById('cockpitInlineTpl');
  const btnIframe = document.getElementById('btnUseIframe');
  const btnInline = document.getElementById('btnUseInline');
  const status = document.getElementById('embedStatus');

  function setStatus(msg){ if (status) status.textContent = msg || ''; }

  function useIframe(){
    if (!iframe) return;
    iframe.style.display = 'block';
    if (host) { host.style.display = 'none'; host.innerHTML = ''; }
    setStatus('(iframe)');
    try { localStorage.setItem('embedMode','iframe'); } catch(e){}
  }

  function useInline(){
    if (!host || !tpl) return;
    if (iframe) iframe.style.display = 'none';
    host.style.display = 'block';
    host.innerHTML = '';
    const clone = document.importNode(tpl.content, true);
    host.appendChild(clone);
    setStatus('(inline)');
    try { localStorage.setItem('embedMode','inline'); } catch(e){}
  }

  btnIframe && btnIframe.addEventListener('click', useIframe);
  btnInline && btnInline.addEventListener('click', useInline);

  let switched = false;
  function detectBlockedIframe(){
    try {
      if (!iframe) return;
      const seemsBlocked = !iframe.contentWindow;
      if (seemsBlocked && !switched){
        switched = true;
        useInline();
        setStatus('(auto-switched; iframe blocked)');
        return;
      }
      let acked = false;
      function onMsg(e){ if (e && e.data && e.data.type === 'inline:ack') { acked = true; window.removeEventListener('message', onMsg); } }
      window.addEventListener('message', onMsg);
      try { iframe.contentWindow.postMessage({type:'inline:ping'}, '*'); } catch(e){}
      setTimeout(function(){
        if (!acked && !switched){
          switched = true;
          useInline();
          setStatus('(auto-switched; no iframe ack)');
          window.removeEventListener('message', onMsg);
        }
      }, 800);
    } catch(e){
      if (!switched){
        switched = true;
        useInline();
        setStatus('(auto-switched; error)');
      }
    }
  }

  let saved = null;
  try { saved = localStorage.getItem('embedMode'); } catch(e){}
  if (saved === 'inline') useInline(); else useIframe();

  window.addEventListener('load', ()=> setTimeout(detectBlockedIframe, 300));
})();
</script>


<!-- Self-Test Button -->
<div id="selfTestBtn" style="position:fixed; bottom:16px; left:16px; z-index:10001;">
  <button class="btn tiny" style="padding:8px 10px;">Run Self‑Test</button>
</div>


<!-- Self-Test Panel -->
<div id="selfTestPanel" style="display:none; position:fixed; bottom:60px; left:16px; z-index:10002; width:360px; max-height:60vh; overflow:auto; background:rgba(20,20,20,.92); color:#eee; border:1px solid #333; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35);">
  <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 10px; border-bottom:1px solid #333;">
    <strong>Anchor ↔ Cockpit Self‑Test</strong>
    <button id="stClose" class="btn tiny">Close</button>
  </div>
  <div id="stLog" style="font-family:system-ui,Segoe UI,Arial; font-size:12.5px; padding:10px 12px; line-height:1.35;"></div>
</div>


<script>
(function(){
  if (window.__SELFTEST__) return; window.__SELFTEST__ = true;
  function el(id){ return document.getElementById(id); }
  function log(html){ const box = el('stLog'); box.innerHTML += html + '<br>'; }
  function status(label, ok, note){
    const s = ok===true ? '🟢' : ok===false ? '🔴' : '🟡';
    log(`<div><b>${s} ${label}</b>${note? ' — ' + note : ''}</div>`);
  }
  function sep(t){ log(`<div style="margin:6px 0; color:#9aa;">— ${t} —</div>`); }

  function openPanel(show){ el('selfTestPanel').style.display = show ? 'block' : 'none'; }
  el('selfTestBtn')?.addEventListener('click', run);
  el('stClose')?.addEventListener('click', ()=> openPanel(false));

  function tryOpenDocs(anchor){
    try{
      window.openDocsDrawer(anchor||'#overview');
      const drawer = document.getElementById('docsDrawer');
      const ok = !!drawer && getComputedStyle(drawer).right === '0px';
      status('Docs Drawer opens', ok, ok?'opened':'drawer closed');
    }catch(e){ status('Docs Drawer opens', false, e.message); }
  }

  function testMode(){
    const iframe = document.getElementById('cockpitFrame');
    const inlineHost = document.getElementById('cockpitInlineHost');
    const iframeVisible = !!(iframe && iframe.style.display !== 'none');
    const inlineVisible = !!(inlineHost && inlineHost.style.display !== 'none' && inlineHost.childElementCount>0);
    let mode = iframeVisible ? 'iframe' : (inlineVisible ? 'inline' : 'unknown');
    status('Embed mode detected', mode!=='unknown', mode);
    return { iframeVisible, inlineVisible, mode };
  }

  function testMessagingRoundtrip(){
    return new Promise((resolve)=>{
      let gotResponse = false;
      function onMsg(e){ if (e && e.data && e.data.type==='tau:response'){ gotResponse = true; window.removeEventListener('message', onMsg); status('τ roundtrip (simulated)', true, 'parent responded'); resolve(true); } }
      window.addEventListener('message', onMsg);
      // Simulate a child asking for τ (parent listener replies to source with tau:response)
      try {
        window.dispatchEvent(new MessageEvent('message', { data: { type:'tau:request' }, source: window }));
        setTimeout(()=>{ if (!gotResponse){ window.removeEventListener('message', onMsg); status('τ roundtrip (simulated)', false, 'no response'); resolve(false); } }, 600);
      } catch(e){ status('τ roundtrip (simulated)', false, e.message); resolve(false); }
    });
  }

  function testMetaPublish(){
    return new Promise((resolve)=>{
      let ack = false;
      function onMsg(e){ if (e && e.data && e.data.type==='meta:ack'){ ack = true; window.removeEventListener('message', onMsg); status('Meta‑publish ACK', true); resolve(true); } }
      window.addEventListener('message', onMsg);
      try{
        // Simulate child sending publish
        window.dispatchEvent(new MessageEvent('message', { data: { type:'meta:publish', payload:{t:'test'} }, source: window }));
        setTimeout(()=>{ if (!ack){ window.removeEventListener('message', onMsg); status('Meta‑publish ACK', false, 'no ack'); resolve(false); } }, 600);
      }catch(e){ status('Meta‑publish ACK', false, e.message); resolve(false); }
    });
  }

  function testTelemetry(){
    return new Promise((resolve)=>{
      let logged = false;
      function onMsg(e){ if (e && e.data && e.data.type==='telemetry'){ logged = true; window.removeEventListener('message', onMsg); status('Telemetry passthrough', true, e.data.event||'event'); resolve(true); } }
      window.addEventListener('message', onMsg);
      try{
        window.dispatchEvent(new MessageEvent('message', { data: { type:'telemetry', event:'selftest', data:{ok:true} }, source: window }));
        setTimeout(()=>{ if (!logged){ window.removeEventListener('message', onMsg); status('Telemetry passthrough', false, 'no event seen'); resolve(false); } }, 600);
      }catch(e){ status('Telemetry passthrough', false, e.message); resolve(false); }
    });
  }

  async function run(){
    el('stLog').innerHTML='';
    openPanel(true);
    sep('Environment');
    const mode = testMode();

    sep('Docs');
    tryOpenDocs('#overview');

    sep('Messaging');
    await testMessagingRoundtrip();
    await testMetaPublish();
    await testTelemetry();

    sep('Next actions');
    log(`<div class="tiny">If iframe is blocked locally, click <b>Inline</b> (bottom‑right) or run: <code>python3 -m http.server 8000</code> then open http://localhost:8000/anchor_all_in_one.html</div>`);
  }
})();
</script>


<!-- Embed Mode Badge -->
<div id="embedModeBadge" style="position:fixed; top:8px; right:8px; z-index:10001; font-size:11px; font-family:system-ui,Segoe UI,Arial; background:rgba(20,20,20,.85); color:#eee; border:1px solid #444; border-radius:6px; padding:3px 6px; cursor:default;">
  <span id="embedModeText">Embed: ?</span>
  <span title="Iframe = embedded via data: URL; Inline = fallback for local/demo use" style="margin-left:4px; color:#aaa;">?</span>
</div>


<script>
(function(){
  if (window.__EMBED_BADGE__) return; window.__EMBED_BADGE__ = true;
  const badge = document.getElementById('embedModeBadge');
  const txt = document.getElementById('embedModeText');
  function setMode(mode, note){
    if (txt) txt.textContent = 'Embed: ' + (mode==='inline' ? 'Inline (Fallback)' : 'Iframe');
    if (note && badge) badge.title = note;
  }
  function detect(){
    const iframe = document.getElementById('cockpitFrame');
    const host = document.getElementById('cockpitInlineHost');
    const iframeVisible = iframe && iframe.style.display !== 'none';
    const inlineVisible = host && host.style.display !== 'none' && host.childElementCount>0;
    const mode = inlineVisible ? 'inline' : (iframeVisible ? 'iframe' : 'unknown');
    setMode(mode, mode==='inline' ? 'Inline mode = fallback for local/demo use' : 'Iframe mode = embedded via data: URL');
  }
  window.addEventListener('load', detect);
  window.addEventListener('message', (e)=>{
    if (e && e.data && e.data.type==='embedModeChanged'){ detect(); }
  });
  detect();
})();
</script>


<script>
(function(){
  if (window.__AUTO_TAG_DEV__) return;
  window.__AUTO_TAG_DEV__ = true;

  function autoTagDevControls() {
    const selectors = [
      '.palette',
      '.dev-controls',
      '#devPalette',
      '[id*="palette"]',
      '[class*="palette"]'
    ];
    document.querySelectorAll(selectors.join(',')).forEach(el => {
      if (!el.hasAttribute('data-dev-controls')) {
        el.setAttribute('data-dev-controls', '');
      }
    });
  }

  // Run immediately and after DOM is ready (covers late mounts)
  try { autoTagDevControls(); } catch(e){}
  document.addEventListener('DOMContentLoaded', autoTagDevControls);
  window.addEventListener('load', autoTagDevControls);
})();
</script>


<!-- RC/RA Evaluator Drawer -->
<style>
#rcDrawerToggle{position:fixed;right:16px;bottom:16px;z-index:9999}
#rcDrawer{position:fixed;right:0;top:0;bottom:0;width:min(520px, 96vw);
  transform:translateX(100%); transition:transform .25s ease; z-index:9998;
  background:rgba(255,255,255,.98); color:#0f172a; border-left:4px solid #111827;
  box-shadow:-12px 0 40px rgba(0,0,0,.22); padding:14px; overflow:auto}
@media (prefers-color-scheme: dark){
  #rcDrawer{background:rgba(15,19,26,.98); color:#e6e6ea; border-left:4px solid #e6e6ea}
}
#rcDrawer.open{transform:none}
#rcDrawer h3{margin:4px 0 8px 0}
#rcDrawer .row{display:grid; grid-template-columns:1fr 1fr; gap:8px}
#rcDrawer .kv{display:grid; grid-template-columns:auto 1fr; gap:6px 10px; font-size:13px}
#rcClose{position:sticky; top:0; float:right}
#rcFloors{border:1px solid #cbd5e1; border-radius:10px; padding:8px; margin-top:8px}
#rcScores{border:1px solid #cbd5e1; border-radius:10px; padding:8px; margin-top:8px}
#rcRaw{white-space:pre-wrap; font-size:12px; border:1px solid #cbd5e1; border-radius:10px; padding:8px; margin-top:8px}
</style>
<button id="rcDrawerToggle" class="btn">Evaluator</button>
<aside id="rcDrawer" aria-hidden="true">
  <button id="rcClose" class="btn">Close</button>
  <h2 style="margin:6px 0 10px 0;">Evaluator</h2>
  <div class="row">
    <div>
      <label style="font-size:12px">Output</label>
      <textarea id="rcOut" rows="8" placeholder="Paste output here…"
        style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px"></textarea>
      <div class="row" style="margin-top:8px">
        <div><label style="font-size:12px">context_id</label><input id="rcCtx" placeholder="demo"
          style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px"/></div>
        <div><label style="font-size:12px">SLRC</label>
          <select id="rcSlrc" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px">
            <option value="default">default</option>
            <option value="strict">strict</option>
            <option value="lenient">lenient</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <div><label style="font-size:12px">Base URL</label>
          <input id="rcBase" placeholder="http://localhost:8080"
            style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px"/>
        </div>
        <div><label style="font-size:12px">Mode</label>
          <select id="rcMode" style="width:100%; padding:10px; border:1px solid #cbd5e1; border-radius:10px">
            <option value="mock">Mock</option>
            <option value="live">Live</option>
          </select>
        </div>
      </div>
      <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px">
        <button id="rcRun" class="btn">Run</button>
      </div>
    </div>
    <div>
      <h3>Floors</h3>
      <div id="rcFloors" class="kv"></div>
      <div id="rcScores" class="kv" style="margin-top:8px"></div>
      <div style="margin-top:8px; font-weight:800">Decision: <span id="rcDecision">—</span></div>
      <div id="rcTags" style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap"></div>
    </div>
  </div>
  <h3>Raw</h3>
  <pre id="rcRaw"></pre>
</aside>
<script>
(function(){
  const $=s=>document.querySelector(s);
  let MODE='mock', BASE='';
  const kv = obj => Object.entries(obj).map(([k,v])=>`<div>${k}</div><div><b>${v}</b></div>`).join('');
  function mockFloors(v){ if(v==='strict')return {tau_v:0.86,tau_L:1.35,sigma_max:0.20,d_min:3};
    if(v==='lenient')return {tau_v:0.80,tau_L:1.20,sigma_max:0.26,d_min:2}; return {tau_v:0.84,tau_L:1.30,sigma_max:0.22,d_min:2}; }
  function mockEval(text,f){ const spec=/\b(maybe|might|probably|guess|assume)\b/i.test(text||'');
    const v=spec?0.84:0.89; const v_net=+(v-(spec?0.03:0)).toFixed(3);
    const lpd=+(v_net/0.001).toFixed(3); const sigma=(text||'').toLowerCase().includes('objective')?0.19:0.25;
    const ok=!(v_net<f.tau_v||lpd<f.tau_L||sigma>f.sigma_max||2<f.d_min);
    return {value:{v:+v.toFixed(3),v_net}, lpd:{lpd,lpd_net:lpd}, sigma, depth:2, ok, tags: spec?[{id:'speculative_language',conf:0.12}]:[], raw:{note:'mock'}}; }
  async function api(path, method='POST', body){ const u=`${BASE}${path}`;
    const res=await fetch(u,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(body||{})});
    if(!res.ok) throw new Error(res.status+' '+res.statusText);
    const ct=res.headers.get('content-type')||''; return ct.includes('json')?res.json():res.text(); }
  function loadFloors(){ const variant=$('#rcSlrc').value||'default';
    if(MODE==='mock'){ $('#rcFloors').innerHTML=kv(mockFloors(variant)); return; }
    api('/slrc/select','POST', variant).then(j=>$('#rcFloors').innerHTML=kv(j.floors||mockFloors(variant)))
      .catch(()=>$('#rcFloors').innerHTML=kv(mockFloors(variant))); }
  async function run(){ const text=$('#rcOut').value||'Objective: win a 30-day pilot with refund-backed SLA.';
    const ctx=$('#rcCtx').value||'demo'; const policy=$('#rcSlrc').value||'default'; const floors = (function(){const el=$('#rcFloors'); try{ return JSON.parse(el.dataset.json||'null'); }catch{return null}})() || mockFloors(policy);
    if(MODE==='mock'){ const r=mockEval(text,floors); render(r); $('#rcRaw').textContent=JSON.stringify(r.raw,null,2); return; }
    try{ const j=await api('/detector/eval','POST',{output:text, context_id:ctx, policy}); render({ value:j.value||{}, lpd:j.lpd||{}, sigma:j.sigma, depth:j.depth, ok:!!j.ok, tags:j.tags||[], raw:j }); $('#rcRaw').textContent=JSON.stringify(j,null,2); }
    catch(e){ const r=mockEval(text,floors); render(r); $('#rcRaw').textContent=JSON.stringify({error:e.message, fallback:'mock'},null,2); } }
  function render(r){ $('#rcScores').innerHTML=kv({v:r.value?.v, v_net:r.value?.v_net, lpd:r.lpd?.lpd, lpd_net:r.lpd?.lpd_net, sigma:r.sigma, d:r.depth});
    $('#rcDecision').innerHTML = r.ok?'<span style="color:#166534">BILL</span>':'<span style="color:#b91c1c">REFUND</span>';
    const tags=r.tags||[]; $('#rcTags').innerHTML = tags.length? tags.map(t=>`<span class="chip">${t.id} (${t.conf||t.weight||''})</span>`).join(' '):'<span class="chip">no tags</span>'; }
  // wire UI
  document.addEventListener('click', (e)=>{
    if(e.target.id==='rcDrawerToggle'){ $('#rcDrawer').classList.add('open'); }
    if(e.target.id==='rcClose'){ $('#rcDrawer').classList.remove('open'); }
    if(e.target.id==='rcRun'){ run(); }
  });
  $('#rcMode').addEventListener('change', e=>{ MODE=e.target.value; loadFloors(); });
  $('#rcBase').addEventListener('change', e=>{ BASE=e.target.value.trim(); });
  $('#rcSlrc').addEventListener('change', loadFloors);
  loadFloors();
})();
</script>

</body>
</html>
